{"version":3,"file":"core-barcode.umd.min.js","sources":["../../src/core/barcode/barcode.ts"],"sourcesContent":["/**\n * @license\n * Copyright (C) 2018 Gnucoop soc. coop.\n *\n * This file is part of the Advanced JSON forms (ajf).\n *\n * Advanced JSON forms (ajf) is free software: you can redistribute it and/or\n * modify it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the License,\n * or (at your option) any later version.\n *\n * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero\n * General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Advanced JSON forms (ajf).\n * If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {ChangeDetectorRef, EventEmitter, Renderer2, OnDestroy} from '@angular/core';\nimport {ControlValueAccessor} from '@angular/forms';\nimport {BrowserBarcodeReader, Result} from '@zxing/library';\nimport {Observable, from, of, Subscription} from 'rxjs';\nimport {catchError, switchMap, debounceTime} from 'rxjs/operators';\n\nexport abstract class AjfBarcode implements ControlValueAccessor, OnDestroy {\n  readonly codeReader = new BrowserBarcodeReader();\n\n  readonly startDetection = new EventEmitter<void>();\n  readonly startCalculation = new EventEmitter<string>();\n\n  readonly _startDetectionSub: Subscription = Subscription.EMPTY;\n  readonly _startCalculationSub: Subscription = Subscription.EMPTY;\n\n  private _canvas: HTMLCanvasElement;\n  get canvasCtx() {return this._canvas.getContext('2d')!; }\n\n  /**\n   * A html video element created at runtime\n   *\n   * @memberof AjfBarcode\n   */\n  private _video: HTMLVideoElement;\n  get videoSource(): HTMLVideoElement {return this._video; }\n\n  /**\n   * implement the control form value.\n   * rappresent the barcode value.\n   *\n   * @memberof AjfBarcode\n   */\n  private _barcodeValue = '';\n  get value(): string { return this._barcodeValue; }\n  set value(value: string) {\n    if (this._barcodeValue !== value) {\n      this._barcodeValue = value;\n      this._cdr.detectChanges();\n      this._onChangeCallback(value);\n    }\n  }\n\n  private _toggle = 'drop';\n  get toggle() { return this._toggle; }\n  set toggle(val: string) {\n    this._toggle = val;\n  }\n\n  private _onChangeCallback = (_: any) => { };\n  private _onTouchedCallback = () => {};\n\n  constructor(private _cdr: ChangeDetectorRef, private _renderer: Renderer2) {\n    this._init();\n\n    this._startDetectionSub = this.startDetection.asObservable()\n      .pipe(\n          debounceTime(300),\n          switchMap(() => {\n              const data: string = this._getDataFromVideo(this.videoSource);\n              return this._readBarcodeFromData(data);\n          }),\n          catchError((e: Error) => {\n              return of({} as Result);\n          })\n      )\n      .subscribe((result: any) => {\n          if (!result.text) {\n              this.startDetection.emit();\n          } else {\n              this.toggle = 'drop';\n              this.value = result.text;\n          }\n      });\n\n    this._startCalculationSub = this.startCalculation.asObservable()\n      .pipe(\n          switchMap((data: string) => {\n              return this._readBarcodeFromData(data);\n          })\n      ).subscribe((result: any) => {\n          if (result.text) {\n              this.toggle = 'drop';\n              this.value = result.text;\n          }\n      });\n  }\n\n  reset(): void {\n    this.value = '';\n    this._onTouchedCallback();\n  }\n\n  takeSnapshot(): void {\n    this.startDetection.emit();\n  }\n\n  onSelectFile(files: FileList) {\n    if (files != null && files[0]) {\n      let reader = new FileReader();\n\n      reader.readAsDataURL(files[0]);\n      reader.onload = (ev: ProgressEvent) => {\n        const data: string = (ev.target as FileReader).result as string;\n        this.startCalculation.emit(data);\n        this._cdr.detectChanges();\n      };\n    }\n  }\n\n  /** ControlValueAccessor implements */\n  writeValue(value: string) {\n    this._barcodeValue = value;\n  }\n\n  registerOnChange(fn: (value: any) => void): void {\n    this._onChangeCallback = fn;\n  }\n\n  registerOnTouched(fn: () => void): void {\n    this._onTouchedCallback = fn;\n  }\n\n  ngOnDestroy(): void {\n    this._startCalculationSub.unsubscribe();\n    this._startDetectionSub.unsubscribe();\n  }\n\n  private _init(): void {\n    this._initCanvas();\n    this._initVideo();\n  }\n\n  private _initCanvas(): void {\n    this._canvas = this._renderer.createElement('canvas');\n    this._canvas.height = 480;\n    this._canvas.width = 640;\n  }\n\n  private _initVideo(): void {\n    this._video = this._renderer.createElement('video');\n    this._video.height = 480;\n    this._video.width = 640;\n  }\n\n  /**\n   * write a frame of HTMLVideoElement into HTMLCanvasElement and\n   * return the result of toDataURL('image/png')\n   *\n   * @param video\n   * @memberof AjfBarcode\n   */\n  private _getDataFromVideo(video: HTMLVideoElement): string {\n    this.canvasCtx.drawImage(video, 0, 0, 640, 480);\n    return this._canvas.toDataURL('image/png');\n  }\n\n  /**\n   * call @zxing library method with HTMLImageElement as parameter\n   *\n   * @param img\n   * @memberof AjfBarcode\n   */\n  private _readBarcodeFromImage(img: HTMLImageElement): Observable<Result> {\n    return from(this.codeReader.decodeFromImage(img))\n        .pipe(catchError(e => of(e as Result)));\n  }\n\n  /**\n   * build an image by data and call _readBarcodeFromImage\n   *\n   * @param data\n   * @memberof AjfBarcode\n   */\n  private _readBarcodeFromData(data: string): Observable<Result> {\n    const image: HTMLImageElement = this._createImage(data);\n    return this._readBarcodeFromImage(image);\n  }\n\n  /**\n   * build an image by data\n   *\n   * @param data\n   * @memberof AjfBarcode\n   */\n  private _createImage(data: string): HTMLImageElement {\n    const image: HTMLImageElement = this._renderer.createElement('img');\n    if (data !== null && typeof data === 'string') {\n      image.src = data;\n    }\n    return image;\n  }\n}\n"],"names":["Object","defineProperty","AjfBarcode","prototype","this","_canvas","getContext","_video","_barcodeValue","value","_cdr","detectChanges","_onChangeCallback","_toggle","val","reset","_onTouchedCallback","takeSnapshot","startDetection","emit","onSelectFile","files","_this","reader","FileReader","readAsDataURL","onload","ev","data","startCalculation","writeValue","registerOnChange","fn","registerOnTouched","ngOnDestroy","_startCalculationSub","unsubscribe","_startDetectionSub","_init","_initCanvas","_initVideo","_renderer","createElement","height","width","_getDataFromVideo","video","canvasCtx","drawImage","toDataURL","_readBarcodeFromImage","img","from","codeReader","decodeFromImage","pipe","catchError","e","of","_readBarcodeFromData","image","_createImage","src","BrowserBarcodeReader","EventEmitter","Subscription","EMPTY","_","asObservable","debounceTime","switchMap","videoSource","subscribe","result","text","toggle"],"mappings":"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"}