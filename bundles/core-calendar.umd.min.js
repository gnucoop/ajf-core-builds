/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("date-fns")):"function"==typeof define&&define.amd?define("@ajf/core/calendar",["exports","@angular/core","date-fns"],t):t(((e=e||self).ajf=e.ajf||{},e.ajf.core=e.ajf.core||{},e.ajf.core.calendar={}),e.ng.core,e.dateFns)}(this,function(e,r,_){"use strict";function s(e,t,r){return(_.isAfter(e,t)||_.isSameDay(e,t))&&(_.isBefore(e,r)||_.isSameDay(e,r))}function d(e){return["day","week","month","year"].indexOf(e)}var t=(a.prototype.buildView=function(e){var t=e.viewMode,r=e.viewDate;switch(t){case"decade":var a=r.getFullYear(),n=a-a%10+1;return{header:n+" - "+(11+n),headerRow:[],rows:this._decadeCalendarRows(e)};case"year":return{header:""+r.getFullYear(),headerRow:[],rows:this._yearCalendarRows(e)};case"month":return{header:_.format(r,"MMM YYYY"),headerRow:this._monthHeaderRow(e),rows:this._monthCalendarRows(e)}}return{header:"",headerRow:[],rows:[]}},a.prototype.monthBounds=function(e,t){if(!t)return{start:_.startOfMonth(e),end:_.endOfMonth(e)};e=_.getISODay(e)<4?_.endOfISOWeek(e):_.startOfISOWeek(e);var r=_.startOfMonth(e),a=_.endOfMonth(r),n=r.getDay(),i=a.getDay();return(0==n||4<n)&&(r=_.addWeeks(r,1)),0<i&&i<4&&(a=_.subWeeks(a,1)),{start:r=_.startOfISOWeek(r),end:a=_.endOfISOWeek(a)}},a.prototype.getEntryRange=function(e){if("day"===e.type)return{start:new Date(e.date),end:new Date(e.date)};var t=new Date(e.date);return{start:"month"===e.type?_.startOfMonth(t):_.startOfYear(t),end:"month"===e.type?_.endOfMonth(t):_.endOfYear(t)}},a.prototype.isEntrySelected=function(e,t){if(null!=t&&null!=t.startDate&&null!=t.endDate){var r=_.startOfDay(t.startDate),a=_.endOfDay(t.endDate),n=d(t.type),i=d(e.type),o=this.getEntryRange(e);if(i<=n&&s(o.start,r,a)&&s(o.end,r,a))return"full";if(n<i&&s(r,o.start,o.end)&&s(a,o.start,o.end))return"partial"}return"none"},a.prototype.entryLabel=function(e){return"day"===e.type?""+e.date.getDate():"month"===e.type?_.format(e.date,"MMM"):""+e.date.getFullYear()},a.prototype.nextView=function(e,t){return"month"==t?_.addMonths(e,1):"year"==t?_.addYears(e,1):"decade"==t?_.addYears(e,10):e},a.prototype.previousView=function(e,t){return"month"==t?_.subMonths(e,1):"year"==t?_.subYears(e,1):"decade"==t?_.subYears(e,10):e},a.prototype._monthHeaderRow=function(e){var t,r=e.isoMode,a=e.viewDate;t=r?_.setISODay(_.startOfWeek(a),1):_.startOfWeek(a);for(var n=[],i=0;i<7;i++)n.push(_.format(t,"dddd")),t=_.addDays(t,1);return n},a.prototype._decadeCalendarRows=function(e){var t=e.viewDate,r=e.selection,a=t.getFullYear(),n=a-a%10+1,i=_.startOfYear(t);i.setFullYear(n);for(var o=[],s=0;s<4;s++){for(var d=[],c=0;c<3;c++){var h={type:"year",date:new Date(i),selected:"none"};h.selected=this.isEntrySelected(h,r),d.push(h),i=_.addYears(i,1)}o.push(d)}return o},a.prototype._yearCalendarRows=function(e){for(var t=e.viewDate,r=e.selection,a=_.startOfYear(t),n=[],i=0;i<4;i++){for(var o=[],s=0;s<3;s++){var d={type:"month",date:new Date(a),selected:"none"};d.selected=this.isEntrySelected(d,r),o.push(d),a=_.addMonths(a,1)}n.push(o)}return n},a.prototype._monthCalendarRows=function(e){var t=e.viewDate,r=e.selection,a=e.isoMode,n=e.minDate,i=e.maxDate,o=this.monthBounds(t,a),s=new Date(o.start),d=new Date(o.end);a||(s=_.startOfWeek(s),d=_.endOfWeek(d));for(var c=[],h=new Date,l=new Date(s);l<d;){for(var u=[],f=0;f<7;f++){var y=null!=n&&_.isBefore(l,n)||null!=i&&_.isAfter(l,i),p={type:"day",date:new Date(l),selected:"none",highlight:_.format(h,"YYYY-MM-DD")===_.format(l,"YYYY-MM-DD"),disabled:y};p.selected=this.isEntrySelected(p,r),u.push(p),l=_.addDays(l,1)}c.push(u)}return c},a.decorators=[{type:r.Injectable}],a);function a(){}var n=(i.prototype.transform=function(e){return this._service.entryLabel(e)},i.decorators=[{type:r.Injectable},{type:r.Pipe,args:[{name:"ajfCalendarEntryLabel"}]}],i.ctorParameters=function(){return[{type:t}]},i);function i(e){this._service=e}var o=(c.decorators=[{type:r.NgModule,args:[{declarations:[n],exports:[n],providers:[t]}]}],c);function c(){}function h(){}function l(){}var u=["","monday","tuesday","wednesday","thursday","friday","saturday","sunday"],f=(Object.defineProperty(y.prototype,"viewDate",{get:function(){return this._viewDate},set:function(e){this._setViewDate(e),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"disabled",{get:function(){return this._disabled},set:function(e){var t=null!=e&&""+e!="false";t!==this._disabled&&(this._disabled=t,this._cdr.markForCheck())},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"dateOnlyForDay",{get:function(){return this._disabled},set:function(e){this._dateOnlyForDay=null!=e&&""+e!="false",this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"viewMode",{get:function(){return this._viewMode},set:function(e){this._viewMode=e,this._buildCalendar(),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"selectionMode",{get:function(){return this._selectionMode},set:function(e){this._selectionMode=e,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"startOfWeekDay",{get:function(){return u[this._startOfWeekDay]},set:function(e){this._startOfWeekDay=u.indexOf(e),"month"===this._viewMode&&this._buildCalendar(),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"isoMode",{get:function(){return this._isoMode},set:function(e){this._isoMode=e,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"minDate",{get:function(){return this._minDate},set:function(e){this._minDate=null!=e?new Date(e.valueOf()):null,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"maxDate",{get:function(){return this._maxDate},set:function(e){this._maxDate=null!=e?new Date(e.valueOf()):null,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"change",{get:function(){return this._change.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"selectedPeriod",{set:function(e){this._selectedPeriod=e,this._change.emit({source:this,period:e}),this._refreshSelection(),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"value",{get:function(){return this._dateOnlyForDay&&"day"===this.selectionMode?null!=this._selectedPeriod?this._selectedPeriod.startDate:null:this._selectedPeriod},set:function(e){this._dateOnlyForDay&&"day"===this.selectionMode&&e instanceof Date&&(null==this._selectedPeriod||e!==this._selectedPeriod.startDate)?this.selectedPeriod={type:"day",startDate:e,endDate:e}:e instanceof Object&&e!==this._selectedPeriod&&(this.selectedPeriod=e,this._onChangeCallback(e)),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"calendarHeaders",{get:function(){return this._calendarHeaders},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"calendarRows",{get:function(){return this._calendarRows},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"viewHeader",{get:function(){return this._viewHeader},enumerable:!0,configurable:!0}),y.prototype.prevPage=function(){this.viewDate=this._service.previousView(this._viewDate,this._viewMode),this._buildCalendar()},y.prototype.nextPage=function(){this.viewDate=this._service.nextView(this._viewDate,this._viewMode),this._buildCalendar()},y.prototype.previousViewMode=function(){"decade"!=this._viewMode&&("year"==this._viewMode?this._viewMode="decade":"month"==this._viewMode&&(this._viewMode="year"),this._buildCalendar())},y.prototype.selectEntry=function(e){if(!this._canSelectEntry(e))return this._nextViewMode(e);var t=null;if("full"==this._service.isEntrySelected(e,this._selectedPeriod))t=null;else if("day"==this._selectionMode)t={type:"day",startDate:e.date,endDate:e.date};else if("week"==this._selectionMode)t={type:"week",startDate:this._isoMode?_.startOfISOWeek(e.date):_.startOfWeek(e.date,{weekStartsOn:this._startOfWeekDay}),endDate:this._isoMode?_.endOfISOWeek(e.date):_.endOfWeek(e.date,{weekStartsOn:this._startOfWeekDay})};else if("month"==this._selectionMode){var r=this._service.monthBounds(e.date,this._isoMode);t={type:"month",startDate:new Date(r.start),endDate:new Date(r.end)}}else"year"==this._selectionMode&&(t={type:"year",startDate:_.startOfYear(e.date),endDate:_.endOfYear(e.date)});this.value=t,this._onTouchedCallback(),this._cdr.markForCheck()},y.prototype.registerOnChange=function(e){this._onChangeCallback=e},y.prototype.registerOnTouched=function(e){this._onTouchedCallback=e},y.prototype.writeValue=function(e){"string"==typeof e&&(e=_.parse(e)),this.value=e},y.prototype.ngOnInit=function(){this._buildCalendar()},y.prototype.ngAfterContentInit=function(){this._refreshSelection()},y.prototype._setViewDate=function(e){this._viewDate=e},y.prototype._buildCalendar=function(){var e=this._service.buildView({viewMode:this._viewMode,viewDate:this._viewDate,selection:this._selectedPeriod,isoMode:this._isoMode,minDate:null==this._minDate?null:new Date(this._minDate),maxDate:null==this._maxDate?null:new Date(this._maxDate)});this._viewHeader=e.header,this._calendarHeaders=e.headerRow,this._calendarRows=e.rows,this._cdr.markForCheck()},y.prototype._refreshSelection=function(){for(var e=0,t=this._calendarRows;e<t.length;e++)for(var r=0,a=t[e];r<a.length;r++){var n=a[r];n.selected=this._service.isEntrySelected(n,this._selectedPeriod)}},y.prototype._canSelectEntry=function(e){return!(0<=["day","week"].indexOf(this._selectionMode)&&"day"!=e.type||"month"==this._selectionMode&&"year"==e.type)},y.prototype._nextViewMode=function(e){if("decade"==this._viewMode)this._viewMode="year";else if("year"==this._viewMode)this._viewMode="month";else if("month"==this._viewMode)return;this._viewDate=e.date,this._buildCalendar()},y);function y(e,t){this._cdr=e,this._service=t,this._disabled=!1,this._dateOnlyForDay=!1,this._viewMode="month",this._selectionMode="day",this._startOfWeekDay=1,this._isoMode=!1,this._change=new r.EventEmitter,this._viewDate=new Date,this._viewHeader="",this._calendarRows=[],this._calendarHeaders=[],this._onChangeCallback=function(e){},this._onTouchedCallback=function(){}}e.AjfCalendar=f,e.AjfCalendarChange=l,e.AjfCalendarModule=o,e.AjfCalendarPeriod=h,e.AjfCalendarService=t,e.ɵa=n,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-calendar.umd.min.js.map
