/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("date-fns"),require("@angular/core")):"function"==typeof define&&define.amd?define("@ajf/core/calendar",["exports","date-fns","@angular/core"],t):t(((e=e||self).ajf=e.ajf||{},e.ajf.core=e.ajf.core||{},e.ajf.core.calendar={}),e.dateFns,e.ng.core)}(this,function(e,_,t){"use strict";var y=(i.prototype.toString=function(){return"day"===this.type?""+this.date.getDate():"month"===this.type?_.format(this.date,"MMM"):""+this.date.getFullYear()},i.prototype.getRange=function(){if("day"===this.type)return{start:new Date(this.date),end:new Date(this.date)};var e=new Date(this.date);return{start:"month"===this.type?_.startOfMonth(e):_.startOfYear(e),end:"month"===this.type?_.endOfMonth(e):_.endOfYear(e)}},i);function i(e){this.disabled=!1,this.highlight=!1;var t=Object.keys(e);this.type=e.type,this.date=e.date,this.selected=e.selected,-1<t.indexOf("disabled")&&(this.disabled=e.disabled),-1<t.indexOf("highlight")&&(this.highlight=e.highlight)}function a(){}function n(){}var r=["","monday","tuesday","wednesday","thursday","friday","saturday","sunday"],s=(Object.defineProperty(o.prototype,"viewDate",{get:function(){return this._viewDate},set:function(e){this._setViewDate(e),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"disabled",{get:function(){return this._disabled},set:function(e){var t=null!=e&&""+e!="false";t!==this._disabled&&(this._disabled=t,this._cdr.markForCheck())},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"dateOnlyForDay",{get:function(){return this._disabled},set:function(e){this._dateOnlyForDay=null!=e&&""+e!="false",this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"viewMode",{get:function(){return this._viewMode},set:function(e){this._viewMode=e,this._buildCalendar(),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"selectionMode",{get:function(){return this._selectionMode},set:function(e){this._selectionMode=e,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"startOfWeekDay",{get:function(){return r[this._startOfWeekDay]},set:function(e){this._startOfWeekDay=r.indexOf(e),"month"===this._viewMode&&this._buildCalendar(),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"isoMode",{get:function(){return this._isoMode},set:function(e){this._isoMode=e,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"minDate",{get:function(){return this._minDate},set:function(e){this._minDate=null!=e?new Date(e.valueOf()):null,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"maxDate",{get:function(){return this._maxDate},set:function(e){this._maxDate=null!=e?new Date(e.valueOf()):null,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"change",{get:function(){return this._change.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"selectedPeriod",{set:function(e){this._selectedPeriod=e,this._change.emit({source:this,period:e}),this._refreshSelection(),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"value",{get:function(){return this._dateOnlyForDay&&"day"===this.selectionMode?null!=this._selectedPeriod?this._selectedPeriod.startDate:null:this._selectedPeriod},set:function(e){this._dateOnlyForDay&&"day"===this.selectionMode?e instanceof Date&&(null==this._selectedPeriod||e!==this._selectedPeriod.startDate)&&(this.selectedPeriod={type:"day",startDate:e,endDate:e},this._onChangeCallback(e)):e instanceof Object&&e!==this._selectedPeriod&&(this.selectedPeriod=e,this._onChangeCallback(e)),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"calendarRows",{get:function(){return this._calendarRows},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"viewHeader",{get:function(){return this._viewHeader},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"weekDays",{get:function(){return this._weekDays},enumerable:!0,configurable:!0}),o.prototype.prevPage=function(){"month"==this._viewMode?this.viewDate=_.subMonths(this.viewDate,1):"year"==this._viewMode&&(this.viewDate=_.subYears(this.viewDate,1)),this._buildCalendar()},o.prototype.nextPage=function(){"month"==this._viewMode?this.viewDate=_.addMonths(this.viewDate,1):"year"==this._viewMode&&(this.viewDate=_.addYears(this.viewDate,1)),this._buildCalendar()},o.prototype.previousViewMode=function(){"decade"!=this._viewMode&&("year"==this._viewMode?this._viewMode="decade":"month"==this._viewMode&&(this._viewMode="year"),this._buildCalendar())},o.prototype.selectEntry=function(e){if(!this._canSelectEntry(e))return this._nextViewMode(e);var t=null;if("full"==this._isEntrySelected(e))t=null;else if("day"==this._selectionMode)t={type:"day",startDate:e.date,endDate:e.date};else if("week"==this._selectionMode)t={type:"week",startDate:this._isoMode?_.startOfISOWeek(e.date):_.startOfWeek(e.date,{weekStartsOn:this._startOfWeekDay}),endDate:this._isoMode?_.endOfISOWeek(e.date):_.endOfWeek(e.date,{weekStartsOn:this._startOfWeekDay})};else if("month"==this._selectionMode){var i=this._getMonthStartEnd(e.date);t={type:"month",startDate:new Date(i.start),endDate:new Date(i.end)}}else"year"==this._selectionMode&&(t={type:"year",startDate:_.startOfYear(e.date),endDate:_.endOfYear(e.date)});this.value=t,this._onTouchedCallback(),this._cdr.markForCheck()},o.prototype.registerOnChange=function(e){this._onChangeCallback=e},o.prototype.registerOnTouched=function(e){this._onTouchedCallback=e},o.prototype.writeValue=function(e){"string"==typeof e&&(e=_.parse(e)),this.value=e},o.prototype.ngOnInit=function(){this._buildCalendar()},o.prototype.ngAfterContentInit=function(){this._refreshSelection()},o.prototype._setViewDate=function(e){this._viewDate=e},o.prototype._getMonthStartEnd=function(e){if(!this._isoMode)return{start:_.startOfMonth(e),end:_.endOfMonth(e)};var t=_.startOfMonth(_.endOfISOWeek(e)),i=_.endOfMonth(t),a=t.getDay(),n=i.getDay();return(0==a||4<a)&&(t=_.addWeeks(t,1)),0<n&&n<4&&(i=_.subWeeks(i,1)),{start:t=_.startOfISOWeek(t),end:i=_.endOfISOWeek(i)}},o.prototype._buildCalendar=function(){"month"==this._viewMode?this._buildMonthView():"year"==this._viewMode?this._buildYearView():"decade"==this._viewMode&&this._buildDecadeView(),this._cdr.markForCheck()},o.prototype._buildDecadeView=function(){var e=this._viewDate.getFullYear(),t=e-e%10+1,i=11+t;this._viewHeader=t+" - "+i;var a=_.startOfYear(this._viewDate);a.setFullYear(t);for(var n=[],r=0;r<4;r++){for(var s=[],o=0;o<3;o++){var d=new Date(a),h=new y({type:"year",date:d,selected:"none"});h.selected=this._isEntrySelected(h),s.push(h),a=_.addYears(a,1)}n.push(s)}this._calendarRows=n},o.prototype._buildYearView=function(){this._viewHeader=""+this._viewDate.getFullYear();for(var e=_.startOfYear(this._viewDate),t=[],i=0;i<4;i++){for(var a=[],n=0;n<3;n++){var r=new Date(e),s=new y({type:"month",date:r,selected:"none"});s.selected=this._isEntrySelected(s),a.push(s),e=_.addMonths(e,1)}t.push(a)}this._calendarRows=t},o.prototype._buildMonthView=function(){this._viewHeader=_.format(this._viewDate,"MMM YYYY"),this._buildMonthViewWeekDays();var e=new Date(this._viewDate.getFullYear(),this._viewDate.getMonth(),5),t=this._getMonthStartEnd(e),i=new Date(t.start),a=new Date(t.end);this._isoMode||(i=_.startOfWeek(i),a=_.endOfWeek(a));for(var n=[],r=new Date,s=new Date(i),o=null==this.minDate?null:new Date(this.minDate),d=null==this.maxDate?null:new Date(this.maxDate);s<a;){for(var h=[],l=0;l<7;l++){var c=null!=o&&_.isBefore(s,o)||null!=d&&_.isAfter(s,d),u=new Date(s),f=new y({type:"day",date:u,selected:"none",highlight:_.format(r,"YYYY-MM-DD")===_.format(s,"YYYY-MM-DD"),disabled:c});f.selected=this._isEntrySelected(f),h.push(f),s=_.addDays(s,1)}n.push(h)}this._calendarRows=n},o.prototype._buildMonthViewWeekDays=function(){var e;e=this._isoMode?_.setISODay(_.startOfWeek(this._viewDate),1):_.startOfWeek(this._viewDate);for(var t=[],i=0;i<7;i++)t.push(_.format(e,"dddd")),e=_.addDays(e,1);this._weekDays=t,this._cdr.markForCheck()},o.prototype._periodOrder=function(e){return["day","week","month","year"].indexOf(e)},o.prototype._isEntrySelected=function(e){if(null!=this._selectedPeriod&&null!=this._selectedPeriod.startDate&&null!=this._selectedPeriod.endDate){var t=_.startOfDay(this._selectedPeriod.startDate),i=_.endOfDay(this._selectedPeriod.endDate),a=this._periodOrder(this._selectedPeriod.type),n=this._periodOrder(e.type),r=e.getRange();if(n<=a&&this._isBetween(r.start,t,i)&&this._isBetween(r.end,t,i))return"full";if(a<n&&this._isBetween(t,r.start,r.end)&&this._isBetween(i,r.start,r.end))return"partial"}return"none"},o.prototype._isBetween=function(e,t,i){return(_.isAfter(e,t)||_.isSameDay(e,t))&&(_.isBefore(e,i)||_.isSameDay(e,i))},o.prototype._refreshSelection=function(){for(var e=0,t=this._calendarRows;e<t.length;e++)for(var i=0,a=t[e];i<a.length;i++){var n=a[i];n.selected=this._isEntrySelected(n)}},o.prototype._canSelectEntry=function(e){return!(0<=["day","week"].indexOf(this._selectionMode)&&"day"!=e.type||"month"==this._selectionMode&&"year"==e.type)},o.prototype._nextViewMode=function(e){if("decade"==this._viewMode)this._viewMode="year";else if("year"==this._viewMode)this._viewMode="month";else if("month"==this._viewMode)return;this._viewDate=e.date,this._buildCalendar()},o);function o(e){this._cdr=e,this._disabled=!1,this._dateOnlyForDay=!1,this._viewMode="month",this._selectionMode="day",this._startOfWeekDay=1,this._isoMode=!1,this._change=new t.EventEmitter,this._viewDate=new Date,this._viewHeader="",this._calendarRows=[],this._weekDays=[],this._onChangeCallback=function(e){},this._onTouchedCallback=function(){}}e.AjfCalendar=s,e.AjfCalendarChange=n,e.AjfCalendarEntry=y,e.AjfCalendarPeriod=a,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-calendar.umd.min.js.map
