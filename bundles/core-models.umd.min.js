/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("debug"),require("esprima"),require("date-fns"),require("numeral"),require("@ajf/core/utils")):"function"==typeof define&&define.amd?define("@ajf/core/models",["exports","debug","esprima","date-fns","numeral","@ajf/core/utils"],t):t(((e=e||self).ajf=e.ajf||{},e.ajf.core=e.ajf.core||{},e.ajf.core.models={}),e.debug,e.esprima,e.dateFns,e.numeral,e.ajf.core.utils)}(this,function(e,t,l,n,r,o){"use strict";var a="default"in t?t.default:t,i="default"in r?r.default:r,u=function(e,t){return(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function f(e,t){function n(){this.constructor=e}u(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var s=function(){function o(e){this._jsonExportedMembers=[]}return o.fromJson=function(e){throw new Error("Not implemented")},o._valueToJson=function(e){return e instanceof Array&&(e=e.map(function(e){return o._valueToJson(e)})),e instanceof o?e.toJson():e},o._propertyToJson=function(e,t){var n,r="get"+t.toLocaleUpperCase().substr(0,1)+t.substr(1);return n=e.hasOwnProperty(t)?e[t]:"function"==typeof e[r]?e[r]():e[t],o._valueToJson(n)},Object.defineProperty(o.prototype,"jsonExportedMembers",{get:function(){return this._jsonExportedMembers},set:function(e){this._jsonExportedMembers=e},enumerable:!0,configurable:!0}),o.prototype.toJson=function(){var t=this,n={};return this._jsonExportedMembers.forEach(function(e){n[e]=o._propertyToJson(t,e)}),n},o}(),c=function(n){function e(e){var t=n.call(this,e)||this;return t._message=e||"",t}return f(e,n),Object.defineProperty(e.prototype,"name",{get:function(){return"AjfError"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"message",{get:function(){return this._message},enumerable:!0,configurable:!0}),e}(Error),d={addDays:n.addDays,addMonths:n.addMonths,addYears:n.addYears,endOfISOWeek:n.endOfISOWeek,format:n.format,getDay:n.getDay,parse:n.parse,startOfMonth:n.startOfMonth,startOfISOWeek:n.startOfISOWeek},p=i||r;function h(e){return null==e?0:e.toString().length}function g(e){if(null==e)return 0;if("string"==typeof e&&(e=parseFloat(e)),isNaN(e))return 0;var t=e.toString().split(".");return 1<t.length?t[1].length:0}function v(e){return!/[,.]/.test(e)}function m(e){return null!=e&&0<e.toString().length}function y(e,t){return-1<(e||[]).indexOf(t)||e===t}function b(e,t,n){for(var r=0;r<e;r++)t=n(t,r);return t}function _(e){return e.reduce(function(e,t){return e+t},0)}function x(e,t,n,r){var o,a=void 0!==e?d.parse(e):new Date;switch("remove"==n&&(r=-r),t){case"day":o=d.addDays;break;case"month":o=d.addMonths;break;case"year":o=d.addYears;break;default:return""}return d.format(o(a,r),"MM/DD/YYYY")}function j(e,t){var n;if(t=t||0,"number"!=typeof e)try{n=parseFloat(e)}catch(e){}else n=e;(null==n||isNaN(n))&&(n=0);var r=Math.pow(10,t);return Math.round(n*r)/r}function C(e,t,n){for(var r=(e=(e||[]).slice(0)).length,o=[],a=0;a<r;a++)null!=e[a][t]&&null!=n&&null!=e[a][n]?o.push(e[a][t]+e[a][n]):null!=e[a][t]&&o.push(e[a][t]);return o}function M(e,t){for(var n=0,r=(t=(t||[]).slice(0)).length,o=0;o<r;o++)for(var a=C(e,t[o]),i=a.length,u=0;u<i;u++)n+=a[u];return n}function O(e,t){var n=[];t=(t||[]).slice(0);for(var r=0;r<t.length;r++){var o=C(e,t[r]);n.push(o)}var a=[];if(0<n.length)for(var i=0;i<n[0].length;i++){for(var u=0,l=0;l<t.length;l++)u+=n[l][i];a.push(u)}return a}function w(e,t,n){e=(e||[]).slice(0),(n=n||[0])instanceof Array||(n=[n]);for(var r=e.length,o=[],a=0,i=0;i<r;i++)null!=e[i][t]&&(n.length>a?o.push(n[a]):o.push(n[0]),a++);return o}function N(e,t,n){for(var r=(e=(e||[]).slice(0)).length,o=[],a="",i=0;i<r;i++)if(null!=e[i][t]){switch(n){case"WW":a="W";break;case"MM":a="M";break;default:a=""}o.push(a+J(e[i].date_start,n))}return o}function S(e,t){for(var n=(e=(e||[]).slice(0)).length-1;0<=n&&null==e[n][t];)if(--n<0)return"";return 0<=n?e[n][t]:""}function A(e,t){e=(e||[]).slice(0);for(var n=0,r=0;r<t.length;r++)n+=S(e,t[r]);return n}function D(e,t){for(var n=(e=(e||[]).slice(0)).length-1;null==e[n][t]&&0!=n;)n--;var r=n-1;if(0==n)r=n;else for(;null==e[r][t];){if(0==r){r=n;break}r--}var o=e[n]&&e[n][t]||0,a=e[r]&&e[r][t]||0;return o==a?'<p><i class="material-icons" style="color:blue">trending_flat</i></p>':a<o?'<p><i class="material-icons" style="color:green">trending_up</i></p>':'<p><i class="material-icons" style="color:red">trending_down</i></p>'}function E(e,t){var n=O(e,t),r=0<n.length&&n[n.length-1]||0,o=1<n.length?n[n.length-2]||0:r;return r==o?'<p><i class="material-icons" style="color:blue">trending_flat</i></p>':o<r?'<p><i class="material-icons" style="color:green">trending_up</i></p>':'<p><i class="material-icons" style="color:red">trending_down</i></p>'}function F(e,t,n,r){r=r||1,n=n||12;var o=(e=(e||[]).slice(0)).length,a=0,i=0,u=0;for(o<n&&(n=o);0!=n;)null!=e[o-1][t]&&(i++,a+=e[o-1][t],0<e[o-1][t]&&u++),o--,n--;return 0==r?u:j(a/i*r,2)||0}function I(e,t,n,r){e=(e||[]).slice(0);var o=[];if(t&&0<t.length){var a=0;r=r||1,n=n||12;for(var i=1<t.length?O(e,t):C(e,t[0]),u=i.length;0<u;u--){var l=0,f=0,s=0;u<n&&(n=u);for(var c=1;c<=n;c++){var d=i[u-c];null!=d&&(f++,l+=d,0<d&&s++)}0<f&&(a=0==r?s:l/f*r||0,o.push(j(a,2)))}}return o.reverse()}function P(e,t,n){return S(e=(e||[]).slice(0),t)>n?'<p><i class="material-icons" style="color:red">warning</i></p>':"<p></p>"}function k(e,t){return t=t||"0,0[.]0",p(e).format(t)}function J(e,t){return t=t||"MM-DD-YYYY",d.format(e,t)}function T(e,t){t=t||"MM";var n=d;return n.format(n.addDays(n.startOfISOWeek(e),3),t)}function Y(e,t){return t=t||6,null==e?[51.505,-.09,t]:[e[0],e[1],t]}var $=(a||t)("ajf:models:validated-property"),W=function(e){function u(){return null!==e&&e.apply(this,arguments)||this}return f(u,e),u.validate=function(t,e){e===this._cachedContext?console.log("cache hit"):(this._cachedContext=e,this._cachedContextString=u.getContextString(e));var n=this._cachedContextString;try{var r=new Function(""+n+t);return $("validating formula %s using context %j",t,n),r(),$("formula %s validated",t),!(r=null)}catch(e){return $("formula %s not validated: error %j",t,e),!1}},u.getContextString=function(r){var o=u.UTIL_FUNCTIONS;if(r instanceof Array)for(var e=0;e<r.length;e++)o=o+"var "+r[e]+" = true;";else null!=r&&Object.keys(r).forEach(function(e){var t=r[e];if(null==t||isNaN(Number(t))||""===t||t instanceof Array){if(t instanceof Array)for(var n=0;n<t.length;n++)t[n]=(null==t||isNaN(Number(t[n]))||""===t[n])&&t[n]||Number(t[n]);t=JSON.stringify(t)}else t=Number(t);o=o+"var "+e+" = "+t+"; "});return o},u.prototype.evaluate=function(n,e){var t=e||this.getValidationFormula()||"";if(""===t)return"";if("true"===t)return!0;if("false"===t)return!1;if(null!=n&&void 0!==n[t])return n[t];if(/^"[^"]*"$/.test(t))return t.replace(/^"+|"+$/g,"");var r=l.tokenize(t).filter(function(e){return"Identifier"===e.type}).map(function(e){return e.value}),o=[];r.forEach(function(e){var t=null;if(null!=n&&void 0!==n[e])t=n[e];else if(void 0!==u.utils[e]){t=u.utils[e].fn}o.push(t)}),r.push("execContext"),o.push(u._execContext);try{$.enabled&&$("evaluating formula %s using context %j",t,o);var a=new(Function.bind.apply(Function,[void 0].concat(r,["return "+t]))),i=a.apply(void 0,o);return $.enabled&&$("formula %s evaluated: result %s",t,i),a=null,i}catch(e){return console.log(e),$.enabled&&$("formula %s not evaluated: error %j",t,e.message),!1}},u.nextCounterValue=function(e,t){return t=null!=t?t:0,null==this._execContext["$$"+e]?this._execContext["$$"+e]=t:this._execContext["$$"+e]++,this._execContext["$$"+e]},u.UTIL_FUNCTIONS="",u._execContext={},u._cachedContext={},u._cachedContextString="",u.utils={digitCount:{fn:h},decimalCount:{fn:g},isInt:{fn:v},notEmpty:{fn:m},valueInChoice:{fn:y},scanGroupField:{fn:b},sum:{fn:_},dateOperations:{fn:x},round:{fn:j},extractArray:{fn:C},extractSum:{fn:M},extractArraySum:{fn:O},drawThreshold:{fn:w},extractDates:{fn:N},lastProperty:{fn:S},sumLastProperties:{fn:A},calculateTrendProperty:{fn:D},calculateTrendByProperties:{fn:E},calculateAvgProperty:{fn:F},calculateAvgPropertyArray:{fn:I},alert:{fn:P},formatNumber:{fn:k},formatDate:{fn:J},isoMonth:{fn:T},getCoordinate:{fn:Y},Math:{fn:Math},parseInt:{fn:parseInt},parseFloat:{fn:parseFloat},parseDate:{fn:d.parse},Date:{fn:Date}},u}(s),q=function(n){function t(e){var t=n.call(this,e)||this;return t.jsonExportedMembers=["condition"],t.condition=e&&e.condition||"",t}return f(t,n),t.alwaysCondition=function(){return new t({condition:"true"})},t.neverCondition=function(){return new t({condition:"false"})},t.fromJson=function(e){return new t(e=o.deepCopy(e))},t.prototype.getValidationFormula=function(){return this.condition},t}(W),U=function(n){function t(e){var t=n.call(this)||this;return t.jsonExportedMembers=["formula"],t.formula=e&&e.formula||null,t}return f(t,n),t.fromJson=function(e){return new t(e=o.deepCopy(e))},t.prototype.getValidationFormula=function(){return this.formula},t}(W);e.AjfJsonSerializable=s,e.AjfError=c,e.AjfValidatedProperty=W,e.AjfCondition=q,e.AjfFormula=U,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-models.umd.min.js.map
