/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("debug"),require("esprima"),require("date-fns"),require("numeral")):"function"==typeof define&&define.amd?define("@ajf/core/models",["exports","debug","esprima","date-fns","numeral"],r):r(((e=e||self).ajf=e.ajf||{},e.ajf.core=e.ajf.core||{},e.ajf.core.models={}),e.debug,e.esprima,e.dateFns,e.numeral)}(this,function(e,r,t,n,a){"use strict";var o="default"in r?r.default:r,i="default"in t?t.default:t,u="default"in a?a.default:a,l=function(e,r){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};var f,s,c,d=(c=Error,l(f=v,s=c),void(f.prototype=null===s?Object.create(s):(p.prototype=s.prototype,new p)),Object.defineProperty(v.prototype,"name",{get:function(){return"AjfError"},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"message",{get:function(){return this._message},enumerable:!0,configurable:!0}),v);function p(){this.constructor=f}function v(e){var r=c.call(this,e)||this;return Object.setPrototypeOf(r,v.prototype),r._message=e||"",r}function g(e){return void 0===e&&(e={}),{condition:e.condition||""}}var m=(h.fromJson=function(e){return g(e)},h);function h(){}function y(e){return void 0===e&&(e={}),{formula:e.formula||""}}var b=(O.fromJson=function(e){return y(e)},O);function O(){}var j=(o||r)("ajf:models:validated-property"),_=u||a,x={addDays:n.addDays,addMonths:n.addMonths,addYears:n.addYears,endOfISOWeek:n.endOfISOWeek,format:n.format,getDay:n.getDay,parse:n.parse,startOfMonth:n.startOfMonth,startOfISOWeek:n.startOfISOWeek};function M(e){return isNaN(e)||"number"!=typeof e?0:isFinite(e)?e.toString().replace(/[^0-9]/g,"").length:1/0}function N(e){if("string"==typeof e&&(e=parseFloat(e)),"number"!=typeof e||isNaN(e))return 0;var r=e.toString().split(".");return 1<r.length?r[1].length:0}function A(e){return"string"==typeof e?/^-?\d+$/.test(e):"number"==typeof e&&Math.round(e)===e}function D(e){return null!=e&&0<e.toString().length}function P(e,r){return-1<(e||[]).indexOf(r)||e===r}function S(e,r,t){for(var n=0;n<e;n++)r=t(r,n);return r}function I(e){return e.reduce(function(e,r){return e+r},0)}function C(e,r,t,n){var a,o=void 0!==e?x.parse(e):new Date;switch("remove"==t&&(n=-n),r){case"day":a=x.addDays;break;case"month":a=x.addMonths;break;case"year":a=x.addYears;break;default:return""}return x.format(a(o,n),"MM/DD/YYYY")}function k(e,r){var t;if(r=r||0,"number"!=typeof e)try{t=parseFloat(e)}catch(e){}else t=e;null!=t&&!isNaN(t)||(t=0);var n=Math.pow(10,r);return Math.round(t*n)/n}function w(e,r,t){for(var n=(e=(e||[]).slice(0)).length,a=[],o=0;o<n;o++)null!=e[o][r]&&null!=t&&null!=e[o][t]?a.push(e[o][r]+e[o][t]):null!=e[o][r]&&a.push(e[o][r]);return a}function F(e,r){for(var t=0,n=(r=(r||[]).slice(0)).length,a=0;a<n;a++)for(var o=w(e,r[a]),i=o.length,u=0;u<i;u++)t+=o[u];return t}function E(e,r){var t=[];r=(r||[]).slice(0);for(var n=0;n<r.length;n++){var a=w(e,r[n]);t.push(a)}var o=[];if(0<t.length)for(var i=0;i<t[0].length;i++){for(var u=0,l=0;l<r.length;l++)u+=t[l][i];o.push(u)}return o}function Y(e,r,t){e=(e||[]).slice(0),(t=t||[0])instanceof Array||(t=[t]);for(var n=e.length,a=[],o=0,i=0;i<n;i++)null!=e[i][r]&&(t.length>o?a.push(t[o]):a.push(t[0]),o++);return a}function T(e,r,t){for(var n=(e=(e||[]).slice(0)).length,a=[],o="",i=0;i<n;i++)if(null!=e[i][r]){switch(t){case"WW":o="W";break;case"MM":o="M";break;default:o=""}a.push(o+G(e[i].date_start,t))}return a}function W(e,r){for(var t=(e=(e||[]).slice(0)).length-1;0<=t&&null==e[t][r];)if(--t<0)return"";return 0<=t?e[t][r]:""}function U(e,r){e=(e||[]).slice(0);for(var t=0,n=0;n<r.length;n++)t+=W(e,r[n]);return t}function z(e,r){for(var t=(e=(e||[]).slice(0)).length-1;null==e[t][r]&&0!=t;)t--;var n=t-1;if(0==t)n=t;else for(;null==e[n][r];){if(0==n){n=t;break}n--}var a=e[t]&&e[t][r]||0,o=e[n]&&e[n][r]||0;return a==o?'<p><i class="material-icons" style="color:blue">trending_flat</i></p>':o<a?'<p><i class="material-icons" style="color:green">trending_up</i></p>':'<p><i class="material-icons" style="color:red">trending_down</i></p>'}function q(e,r){var t=E(e,r),n=0<t.length&&t[t.length-1]||0,a=1<t.length?t[t.length-2]||0:n;return n==a?'<p><i class="material-icons" style="color:blue">trending_flat</i></p>':a<n?'<p><i class="material-icons" style="color:green">trending_up</i></p>':'<p><i class="material-icons" style="color:red">trending_down</i></p>'}function L(e,r,t,n){n=n||1,t=t||12;var a=(e=(e||[]).slice(0)).length,o=0,i=0,u=0;for(a<t&&(t=a);0!=t;)null!=e[a-1][r]&&(i++,o+=e[a-1][r],0<e[a-1][r]&&u++),a--,t--;return 0==n?u:k(o/i*n,2)||0}function $(e,r,t,n){e=(e||[]).slice(0);var a=[];if(r&&0<r.length){var o=0;n=n||1,t=t||12;for(var i=1<r.length?E(e,r):w(e,r[0]),u=i.length;0<u;u--){var l=0,f=0,s=0;u<t&&(t=u);for(var c=1;c<=t;c++){var d=i[u-c];null!=d&&(f++,l+=d,0<d&&s++)}0<f&&(o=0==n?s:l/f*n||0,a.push(k(o,2)))}}return a.reverse()}function J(e,r,t){return W(e=(e||[]).slice(0),r)>t?'<p><i class="material-icons" style="color:red">warning</i></p>':"<p></p>"}function B(e,r){return r=r||"0,0[.]0",_(e).format(r)}function G(e,r){return r=r||"MM-DD-YYYY",x.format(e,r)}function R(e,r){r=r||"MM";var t=x;return t.format(t.addDays(t.startOfISOWeek(e),3),r)}function H(e,r){return r=r||6,null==e?[51.505,-.09,r]:[e[0],e[1],r]}var K=(Q.UTIL_FUNCTIONS="",Q.utils={digitCount:{fn:M},decimalCount:{fn:N},isInt:{fn:A},notEmpty:{fn:D},valueInChoice:{fn:P},scanGroupField:{fn:S},sum:{fn:I},dateOperations:{fn:C},round:{fn:k},extractArray:{fn:w},extractSum:{fn:F},extractArraySum:{fn:E},drawThreshold:{fn:Y},extractDates:{fn:T},lastProperty:{fn:W},sumLastProperties:{fn:U},calculateTrendProperty:{fn:z},calculateTrendByProperties:{fn:q},calculateAvgProperty:{fn:L},calculateAvgPropertyArray:{fn:$},alert:{fn:J},formatNumber:{fn:B},formatDate:{fn:G},isoMonth:{fn:R},getCoordinate:{fn:H},Math:{fn:Math},parseInt:{fn:parseInt},parseFloat:{fn:parseFloat},parseDate:{fn:x.parse},Date:{fn:Date}},Q);function Q(){}var V=(i||t).tokenize,X={};function Z(n){var a=K.UTIL_FUNCTIONS;if(n instanceof Array)for(var e=0;e<n.length;e++)a=a+"var "+n[e]+" = true;";else null!=n&&Object.keys(n).forEach(function(e){var r=n[e];if(null==r||isNaN(Number(r))||""===r||r instanceof Array){if(r instanceof Array)for(var t=0;t<r.length;t++)r[t]=(null==r||isNaN(Number(r[t]))||""===r[t])&&r[t]||Number(r[t]);r=JSON.stringify(r)}else r=Number(r);a=a+"var "+e+" = "+r+"; "});return a}var ee=(i||t).tokenize;var re={},te="{}";e.AjfConditionSerializer=m,e.AjfError=d,e.AjfExpressionUtils=K,e.AjfFormulaSerializer=b,e.alert=J,e.alwaysCondition=function(){return g({condition:"true"})},e.calculateAvgProperty=L,e.calculateAvgPropertyArray=$,e.calculateTrendByProperties=q,e.calculateTrendProperty=z,e.createCondition=g,e.createFormula=y,e.dateOperations=C,e.dateUtils=x,e.dbg=j,e.decimalCount=N,e.digitCount=M,e.drawThreshold=Y,e.evaluateExpression=function(e,t,r){var n=r||e||"";if(""===n)return"";if("true"===n)return!0;if("false"===n)return!1;if(null!=t&&void 0!==t[n])return t[n];if(/^"[^"]*"$/.test(n))return n.replace(/^"+|"+$/g,"");var a=V(n).filter(function(e){return"Identifier"===e.type}).map(function(e){return e.value}),o=[];a.forEach(function(e){var r=null;if(null!=t&&void 0!==t[e])r=t[e];else if(void 0!==K.utils[e]){r=K.utils[e].fn}o.push(r)}),a.push("execContext"),o.push(X);try{j.enabled&&j("evaluating formula %s using context %j",n,o);var i=new(Function.bind.apply(Function,[void 0].concat(a,["return "+n]))),u=i.apply(void 0,o);return j.enabled&&j("formula %s evaluated: result %s",n,u),i=null,u}catch(e){return console.log(e),j.enabled&&j("formula %s not evaluated: error %j",n,e.message),!1}},e.extractArray=w,e.extractArraySum=E,e.extractDates=T,e.extractSum=F,e.formatDate=G,e.formatNumber=B,e.getContextString=Z,e.getCoordinate=H,e.isInt=A,e.isoMonth=R,e.lastProperty=W,e.neverCondition=function(){return g({condition:"false"})},e.normalizeExpression=function(r,t,n){var a=Object.keys(t);return ee(r).filter(function(e){return"Identifier"==e.type&&"$value"!=e.value}).map(function(e){return e.value}).forEach(function(e){-1<a.indexOf(e)&&(r=r.replace(new RegExp("\\b"+e+"\\b","g"),e+"__"+n.slice(t[e]).join("__")))}),r},e.notEmpty=D,e.round=k,e.scanGroupField=S,e.sum=I,e.sumLastProperties=U,e.validateExpression=function(r,e){e===re?console.log("cache hit"):te=Z(re=e);var t=te;try{var n=new Function(""+t+r);return j("validating formula %s using context %j",r,t),n(),j("formula %s validated",r),!(n=null)}catch(e){return j("formula %s not validated: error %j",r,e),!1}},e.valueInChoice=P,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-models.umd.min.js.map
