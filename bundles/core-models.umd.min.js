/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("debug"),require("esprima"),require("date-fns"),require("numeral"),require("@ajf/core/utils")):"function"==typeof define&&define.amd?define("@ajf/core/models",["exports","debug","esprima","date-fns","numeral","@ajf/core/utils"],t):t(((e=e||self).ajf=e.ajf||{},e.ajf.core=e.ajf.core||{},e.ajf.core.models={}),e.debug,e.esprima,e.dateFns,e.numeral,e.ajf.core.utils)}(this,function(e,t,n,r,o,a){"use strict";var i="default"in t?t.default:t,u="default"in n?n.default:n,l="default"in o?o.default:o,s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function f(e,t){function n(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var c=(d.fromJson=function(e){throw new Error("Not implemented")},d._valueToJson=function(e){return e instanceof Array&&(e=e.map(function(e){return d._valueToJson(e)})),e instanceof d?e.toJson():e},d._propertyToJson=function(e,t){var n,r="get"+t.toLocaleUpperCase().substr(0,1)+t.substr(1);return n=e.hasOwnProperty(t)?e[t]:"function"==typeof e[r]?e[r]():e[t],d._valueToJson(n)},Object.defineProperty(d.prototype,"jsonExportedMembers",{get:function(){return this._jsonExportedMembers},set:function(e){this._jsonExportedMembers=e},enumerable:!0,configurable:!0}),d.prototype.toJson=function(){var t=this,n={};return this._jsonExportedMembers.forEach(function(e){n[e]=d._propertyToJson(t,e)}),n},d);function d(e){this._jsonExportedMembers=[]}var p,h=(f(v,p=Error),Object.defineProperty(v.prototype,"name",{get:function(){return"AjfError"},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"message",{get:function(){return this._message},enumerable:!0,configurable:!0}),v);function v(e){var t=p.call(this,e)||this;return t._message=e||"",t}var g={addDays:r.addDays,addMonths:r.addMonths,addYears:r.addYears,endOfISOWeek:r.endOfISOWeek,format:r.format,getDay:r.getDay,parse:r.parse,startOfMonth:r.startOfMonth,startOfISOWeek:r.startOfISOWeek},m=l||o;function y(e){return null==e?0:e.toString().length}function b(e){if(null==e)return 0;if("string"==typeof e&&(e=parseFloat(e)),isNaN(e))return 0;var t=e.toString().split(".");return 1<t.length?t[1].length:0}function _(e){return!/[,.]/.test(e)}function x(e){return null!=e&&0<e.toString().length}function j(e,t){return-1<(e||[]).indexOf(t)||e===t}function C(e,t,n){for(var r=0;r<e;r++)t=n(t,r);return t}function M(e){return e.reduce(function(e,t){return e+t},0)}function O(e,t,n,r){var o,a=void 0!==e?g.parse(e):new Date;switch("remove"==n&&(r=-r),t){case"day":o=g.addDays;break;case"month":o=g.addMonths;break;case"year":o=g.addYears;break;default:return""}return g.format(o(a,r),"MM/DD/YYYY")}function w(e,t){var n;if(t=t||0,"number"!=typeof e)try{n=parseFloat(e)}catch(e){}else n=e;null!=n&&!isNaN(n)||(n=0);var r=Math.pow(10,t);return Math.round(n*r)/r}function N(e,t,n){for(var r=(e=(e||[]).slice(0)).length,o=[],a=0;a<r;a++)null!=e[a][t]&&null!=n&&null!=e[a][n]?o.push(e[a][t]+e[a][n]):null!=e[a][t]&&o.push(e[a][t]);return o}function S(e,t){for(var n=0,r=(t=(t||[]).slice(0)).length,o=0;o<r;o++)for(var a=N(e,t[o]),i=a.length,u=0;u<i;u++)n+=a[u];return n}function A(e,t){var n=[];t=(t||[]).slice(0);for(var r=0;r<t.length;r++){var o=N(e,t[r]);n.push(o)}var a=[];if(0<n.length)for(var i=0;i<n[0].length;i++){for(var u=0,l=0;l<t.length;l++)u+=n[l][i];a.push(u)}return a}function D(e,t,n){e=(e||[]).slice(0),(n=n||[0])instanceof Array||(n=[n]);for(var r=e.length,o=[],a=0,i=0;i<r;i++)null!=e[i][t]&&(n.length>a?o.push(n[a]):o.push(n[0]),a++);return o}function E(e,t,n){for(var r=(e=(e||[]).slice(0)).length,o=[],a="",i=0;i<r;i++)if(null!=e[i][t]){switch(n){case"WW":a="W";break;case"MM":a="M";break;default:a=""}o.push(a+W(e[i].date_start,n))}return o}function F(e,t){for(var n=(e=(e||[]).slice(0)).length-1;0<=n&&null==e[n][t];)if(--n<0)return"";return 0<=n?e[n][t]:""}function I(e,t){e=(e||[]).slice(0);for(var n=0,r=0;r<t.length;r++)n+=F(e,t[r]);return n}function P(e,t){for(var n=(e=(e||[]).slice(0)).length-1;null==e[n][t]&&0!=n;)n--;var r=n-1;if(0==n)r=n;else for(;null==e[r][t];){if(0==r){r=n;break}r--}var o=e[n]&&e[n][t]||0,a=e[r]&&e[r][t]||0;return o==a?'<p><i class="material-icons" style="color:blue">trending_flat</i></p>':a<o?'<p><i class="material-icons" style="color:green">trending_up</i></p>':'<p><i class="material-icons" style="color:red">trending_down</i></p>'}function k(e,t){var n=A(e,t),r=0<n.length&&n[n.length-1]||0,o=1<n.length?n[n.length-2]||0:r;return r==o?'<p><i class="material-icons" style="color:blue">trending_flat</i></p>':o<r?'<p><i class="material-icons" style="color:green">trending_up</i></p>':'<p><i class="material-icons" style="color:red">trending_down</i></p>'}function J(e,t,n,r){r=r||1,n=n||12;var o=(e=(e||[]).slice(0)).length,a=0,i=0,u=0;for(o<n&&(n=o);0!=n;)null!=e[o-1][t]&&(i++,a+=e[o-1][t],0<e[o-1][t]&&u++),o--,n--;return 0==r?u:w(a/i*r,2)||0}function T(e,t,n,r){e=(e||[]).slice(0);var o=[];if(t&&0<t.length){var a=0;r=r||1,n=n||12;for(var i=1<t.length?A(e,t):N(e,t[0]),u=i.length;0<u;u--){var l=0,s=0,f=0;u<n&&(n=u);for(var c=1;c<=n;c++){var d=i[u-c];null!=d&&(s++,l+=d,0<d&&f++)}0<s&&(a=0==r?f:l/s*r||0,o.push(w(a,2)))}}return o.reverse()}function Y(e,t,n){return F(e=(e||[]).slice(0),t)>n?'<p><i class="material-icons" style="color:red">warning</i></p>':"<p></p>"}function $(e,t){return t=t||"0,0[.]0",m(e).format(t)}function W(e,t){return t=t||"MM-DD-YYYY",g.format(e,t)}function q(e,t){t=t||"MM";var n=g;return n.format(n.addDays(n.startOfISOWeek(e),3),t)}function U(e,t){return t=t||6,null==e?[51.505,-.09,t]:[e[0],e[1],t]}var V,L=(u||n).tokenize,z=(i||t)("ajf:models:validated-property"),B=(f(G,V=c),G.validate=function(t,e){e===this._cachedContext?console.log("cache hit"):(this._cachedContext=e,this._cachedContextString=G.getContextString(e));var n=this._cachedContextString;try{var r=new Function(""+n+t);return z("validating formula %s using context %j",t,n),r(),z("formula %s validated",t),!(r=null)}catch(e){return z("formula %s not validated: error %j",t,e),!1}},G.getContextString=function(r){var o=G.UTIL_FUNCTIONS;if(r instanceof Array)for(var e=0;e<r.length;e++)o=o+"var "+r[e]+" = true;";else null!=r&&Object.keys(r).forEach(function(e){var t=r[e];if(null==t||isNaN(Number(t))||""===t||t instanceof Array){if(t instanceof Array)for(var n=0;n<t.length;n++)t[n]=(null==t||isNaN(Number(t[n]))||""===t[n])&&t[n]||Number(t[n]);t=JSON.stringify(t)}else t=Number(t);o=o+"var "+e+" = "+t+"; "});return o},G.prototype.evaluate=function(n,e){var t=e||this.getValidationFormula()||"";if(""===t)return"";if("true"===t)return!0;if("false"===t)return!1;if(null!=n&&void 0!==n[t])return n[t];if(/^"[^"]*"$/.test(t))return t.replace(/^"+|"+$/g,"");var r=L(t).filter(function(e){return"Identifier"===e.type}).map(function(e){return e.value}),o=[];r.forEach(function(e){var t=null;null!=n&&void 0!==n[e]?t=n[e]:void 0!==G.utils[e]&&(t=G.utils[e].fn),o.push(t)}),r.push("execContext"),o.push(G._execContext);try{z.enabled&&z("evaluating formula %s using context %j",t,o);var a=new(Function.bind.apply(Function,[void 0].concat(r,["return "+t]))),i=a.apply(void 0,o);return z.enabled&&z("formula %s evaluated: result %s",t,i),a=null,i}catch(e){return console.log(e),z.enabled&&z("formula %s not evaluated: error %j",t,e.message),!1}},G.nextCounterValue=function(e,t){return t=null!=t?t:0,null==this._execContext["$$"+e]?this._execContext["$$"+e]=t:this._execContext["$$"+e]++,this._execContext["$$"+e]},G.UTIL_FUNCTIONS="",G._execContext={},G._cachedContext={},G._cachedContextString="",G.utils={digitCount:{fn:y},decimalCount:{fn:b},isInt:{fn:_},notEmpty:{fn:x},valueInChoice:{fn:j},scanGroupField:{fn:C},sum:{fn:M},dateOperations:{fn:O},round:{fn:w},extractArray:{fn:N},extractSum:{fn:S},extractArraySum:{fn:A},drawThreshold:{fn:D},extractDates:{fn:E},lastProperty:{fn:F},sumLastProperties:{fn:I},calculateTrendProperty:{fn:P},calculateTrendByProperties:{fn:k},calculateAvgProperty:{fn:J},calculateAvgPropertyArray:{fn:T},alert:{fn:Y},formatNumber:{fn:$},formatDate:{fn:W},isoMonth:{fn:q},getCoordinate:{fn:U},Math:{fn:Math},parseInt:{fn:parseInt},parseFloat:{fn:parseFloat},parseDate:{fn:g.parse},Date:{fn:Date}},G);function G(){return null!==V&&V.apply(this,arguments)||this}var H,K=(f(Q,H=B),Q.alwaysCondition=function(){return new Q({condition:"true"})},Q.neverCondition=function(){return new Q({condition:"false"})},Q.fromJson=function(e){return new Q(e=a.deepCopy(e))},Q.prototype.getValidationFormula=function(){return this.condition},Q);function Q(e){var t=H.call(this,e)||this;return t.jsonExportedMembers=["condition"],t.condition=e&&e.condition||"",t}var R,X=(f(Z,R=B),Z.fromJson=function(e){return new Z(e=a.deepCopy(e))},Z.prototype.getValidationFormula=function(){return this.formula},Z);function Z(e){var t=R.call(this)||this;return t.jsonExportedMembers=["formula"],t.formula=e&&e.formula||null,t}e.AjfCondition=K,e.AjfError=h,e.AjfFormula=X,e.AjfJsonSerializable=c,e.AjfValidatedProperty=B,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-models.umd.min.js.map
