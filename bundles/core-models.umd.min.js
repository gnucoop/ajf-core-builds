!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("debug"),require("esprima"),require("date-fns"),require("numeral")):"function"==typeof define&&define.amd?define("@ajf/core/models",["exports","debug","esprima","date-fns","numeral"],r):r(((e=e||self).ajf=e.ajf||{},e.ajf.core=e.ajf.core||{},e.ajf.core.models={}),e.debug,e.esprima,e.dateFns,e.numeral)}(this,(function(e,r,t,n,a){"use strict";var o="default"in r?r.default:r,u="default"in t?t.default:t,i="default"in a?a.default:a,l=function(e,r){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};function f(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,a,o=t.call(e),u=[];try{for(;(void 0===r||r-- >0)&&!(n=o.next()).done;)u.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(t=o.return)&&t.call(o)}finally{if(a)throw a.error}}return u}function s(){for(var e=[],r=0;r<arguments.length;r++)e=e.concat(f(arguments[r]));return e}
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
var c=function(e){function r(t){var n=e.call(this,t)||this;return Object.setPrototypeOf(n,r.prototype),n._message=t||"",n}return function t(e,r){function t(){this.constructor=e}l(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}(r,e),Object.defineProperty(r.prototype,"name",{get:function(){return"AjfError"},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"message",{get:function(){return this._message},enumerable:!0,configurable:!0}),r}(Error);
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */function d(e){return void 0===e&&(e={}),{condition:e.condition||""}}
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */var p=function(){function e(){}return e.fromJson=function(e){return d(e)},e}();
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */function m(e){return void 0===e&&(e={}),{formula:e.formula||""}}
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */var y=function(){function e(){}return e.fromJson=function(e){return m(e)},e}(),v=(o||r)("ajf:models:validated-property"),g=i||a,h={addDays:n.addDays,addMonths:n.addMonths,addYears:n.addYears,endOfISOWeek:n.endOfISOWeek,format:n.format,getDay:n.getDay,parse:n.parseISO,startOfMonth:n.startOfMonth,startOfISOWeek:n.startOfISOWeek};
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */function b(e){return isNaN(e)||"number"!=typeof e?0:isFinite(e)?e.toString().replace(/[^0-9]/g,"").length:1/0}function N(e){if("string"==typeof e&&(e=parseFloat(e)),"number"!=typeof e||isNaN(e))return 0;var r=e.toString().split(".");return r.length>1?r[1].length:0}function O(e){return"string"==typeof e?/^-?\d+$/.test(e):"number"==typeof e&&Math.round(e)===e}function _(e){return null!=e&&e.toString().length>0}function j(e,r){return(e||[]).indexOf(r)>-1||e===r}function x(e,r,t){for(var n=0;n<e;n++)r=t(r,n);return r}function S(e){return e.reduce((function(e,r){return e+r}),0)}function A(e,r,t,n){var a,o=void 0!==e?h.parse(e):new Date;switch("remove"==t&&(n=-n),r){case"day":a=h.addDays;break;case"month":a=h.addMonths;break;case"year":a=h.addYears;break;default:return""}return h.format(a(o,n),"mm/dd/yyyy")}function w(e,r){var t;if(r=r||0,"number"!=typeof e)try{t=parseFloat(e)}catch(e){}else t=e;(null==t||isNaN(t))&&(t=0);var n=Math.pow(10,r);return Math.round(t*n)/n}function I(e,r,t){for(var n=(e=(e||[]).slice(0)).length,a=[],o=0;o<n;o++)null!=e[o][r]&&null!=t&&null!=e[o][t]?a.push(Number(e[o][r])+Number(e[o][t])):null!=e[o][r]&&a.push(e[o][r]);return a}function P(e,r){for(var t=0,n=(r=(r||[]).slice(0)).length,a=0;a<n;a++)for(var o=I(e,r[a]),u=o.length,i=0;i<u;i++)isNaN(Number(o[i]))||(t+=Number(o[i]));return t}function C(e,r){var t=[];r=(r||[]).slice(0);for(var n=0;n<r.length;n++){var a=I(e,r[n]);t.push(a)}var o=[];if(t.length>0)for(var u=0;u<t[0].length;u++){for(var i=0,l=0;l<r.length;l++)i+=Number(t[l][u]);o.push(i)}return o}function D(e,r,t){e=(e||[]).slice(0),(t=t||[0])instanceof Array||(t=[t]);for(var n=e.length,a=[],o=0,u=0;u<n;u++)null!=e[u][r]&&(a.push(t.length>o?t[o]:t[0]),o++);return a}function M(e,r,t){for(var n=(e=(e||[]).slice(0)).length,a=[],o=0;o<n;o++)if(null!=e[o][r])switch(t){case"WW":case"ww":a.push("W"+L(e[o].date_start,t));break;case"MM":case"mm":a.push("M"+$(e[o].date_start,t));break;default:a.push(""+L(e[o].date_start,t))}return a}function k(e,r){for(var t=(e=(e||[]).slice(0)).length-1;t>=0&&null==e[t][r];)if(--t<0)return"";return t>=0?e[t][r]:""}function F(e,r){e=(e||[]).slice(0);for(var t=0,n=0,a=0;a<r.length;a++)n=Number(k(e,r[a])),isNaN(n)||(t+=n);return t}function E(e,r){for(var t=(e=(e||[]).slice(0)).length-1;null==e[t][r]&&0!=t;)t--;var n=t-1;if(0==t)n=t;else for(;null==e[n][r];){if(0==n){n=t;break}n--}var a=e[t]&&e[t][r]||0,o=e[n]&&e[n][r]||0;return a==o?'<p><i class="material-icons" style="color:blue">trending_flat</i></p>':a>o?'<p><i class="material-icons" style="color:green">trending_up</i></p>':'<p><i class="material-icons" style="color:red">trending_down</i></p>'}function T(e,r){var t=C(e,r),n=t.length>0&&t[t.length-1]||0,a=t.length>1?t[t.length-2]||0:n;return n==a?'<p><i class="material-icons" style="color:blue">trending_flat</i></p>':n>a?'<p><i class="material-icons" style="color:green">trending_up</i></p>':'<p><i class="material-icons" style="color:red">trending_down</i></p>'}function W(e,r,t,n){n=n||1;var a=(e=(e||[]).slice(0)).length,o=0,u=0,i=0;for(a<(t=t||12)&&(t=a);0!=t;)null!=e[a-1][r]&&(u++,o+=Number(e[a-1][r]),e[a-1][r]>0&&i++),a--,t--;return 0==n?i:w(o/u*n,2)||0}function U(e,r,t,n){e=(e||[]).slice(0);var a=[];if(r&&r.length>0){n=n||1,t=t||12;for(var o=r.length>1?C(e,r):I(e,r[0]),u=o.length;u>0;u--){var i=0,l=0,f=0;u<t&&(t=u);for(var s=1;s<=t;s++){var c=o[u-s];null!=c&&(l++,i+=Number(c),c>0&&f++)}l>0&&a.push(w(0==n?f:i/l*n||0,2))}}return a.reverse()}function z(e,r,t){return k(e=(e||[]).slice(0),r)>t?'<p><i class="material-icons" style="color:red">warning</i></p>':"<p></p>"}function q(e,r){return r=r||"0,0[.]0",g(e).format(r)}function L(e,r){return r=r||"mm-DD-yyyy",h.format("string"==typeof e?h.parse(e):e,r)}function $(e,r){return r=r||"mm",h.format(h.addDays(h.startOfISOWeek(e),3),r)}function J(e,r){return r=r||6,null==e?[51.505,-.09,r]:[e[0],e[1],r]}
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */var Y=function(){function e(){}return e.UTIL_FUNCTIONS="",e.utils={digitCount:{fn:b},decimalCount:{fn:N},isInt:{fn:O},notEmpty:{fn:_},valueInChoice:{fn:j},scanGroupField:{fn:x},sum:{fn:S},dateOperations:{fn:A},round:{fn:w},extractArray:{fn:I},extractSum:{fn:P},extractArraySum:{fn:C},drawThreshold:{fn:D},extractDates:{fn:M},lastProperty:{fn:k},sumLastProperties:{fn:F},calculateTrendProperty:{fn:E},calculateTrendByProperties:{fn:T},calculateAvgProperty:{fn:W},calculateAvgPropertyArray:{fn:U},alert:{fn:z},formatNumber:{fn:q},formatDate:{fn:L},isoMonth:{fn:$},getCoordinate:{fn:J},Math:{fn:Math},parseInt:{fn:parseInt},parseFloat:{fn:parseFloat},parseDate:{fn:h.parse},Date:{fn:Date}},e}(),B=(u||t).tokenize,G={};
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
function R(e){var r=Y.UTIL_FUNCTIONS;if(e instanceof Array)for(var t=0;t<e.length;t++)r=r+"var "+e[t]+" = true;";else null!=e&&Object.keys(e).forEach((function(t){var n=e[t];if(null==n||isNaN(Number(n))||""===n||n instanceof Array){if(n instanceof Array)for(var a=0;a<n.length;a++)n[a]=(null==n||isNaN(Number(n[a]))||""===n[a])&&n[a]||Number(n[a]);n=JSON.stringify(n)}else n=Number(n);r=r+"var "+t+" = "+n+"; "}));return r}
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
var H=(u||t).tokenize,K={},Q="{}";
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
e.AjfConditionSerializer=p,e.AjfError=c,e.AjfExpressionUtils=Y,e.AjfFormulaSerializer=y,e.alert=z,e.alwaysCondition=function V(){return d({condition:"true"})}
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */,e.calculateAvgProperty=W,e.calculateAvgPropertyArray=U,e.calculateTrendByProperties=T,e.calculateTrendProperty=E,e.createCondition=d,e.createFormula=m,e.dateOperations=A,e.dateUtils=h,e.dbg=v,e.decimalCount=N,e.digitCount=b,e.drawThreshold=D,e.evaluateExpression=function X(e,r,t){var n=t||e||"";if(""===n)return"";if("true"===n)return!0;if("false"===n)return!1;if(null!=r&&void 0!==r[n])return r[n];if(/^"[^"]*"$/.test(n))return n.replace(/^"+|"+$/g,"");var a=B(n).filter((function(e){return"Identifier"===e.type})).map((function(e){return e.value})),o=[];a.forEach((function(e){var t=null;null!=r&&void 0!==r[e]?t=r[e]:void 0!==Y.utils[e]&&(t=Y.utils[e].fn),o.push(t)})),a.push("execContext"),o.push(G);try{v.enabled&&v("evaluating formula %s using context %j",n,o);var u=new(Function.bind.apply(Function,s([void 0],a,["return "+n]))),i=u.apply(void 0,s(o));return v.enabled&&v("formula %s evaluated: result %s",n,i),u=null,i}catch(e){return console.log(e),v.enabled&&v("formula %s not evaluated: error %j",n,e.message),!1}},e.extractArray=I,e.extractArraySum=C,e.extractDates=M,e.extractSum=P,e.formatDate=L,e.formatNumber=q,e.getContextString=R,e.getCoordinate=J,e.isInt=O,e.isoMonth=$,e.lastProperty=k,e.neverCondition=function Z(){return d({condition:"false"})},e.normalizeExpression=function ee(e,r,t){var n=Object.keys(r);return H(e).filter((function(e){return"Identifier"==e.type&&"$value"!=e.value})).map((function(e){return e.value})).forEach((function(a){n.indexOf(a)>-1&&(e=e.replace(new RegExp("\\b"+a+"\\b","g"),a+"__"+t.slice(r[a]).join("__")))})),e}
/**
     * @license
     * Copyright (C) Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */,e.notEmpty=_,e.round=w,e.scanGroupField=x,e.sum=S,e.sumLastProperties=F,e.validateExpression=function re(e,r){r===K?console.log("cache hit"):(K=r,Q=R(r));var t=Q;try{var n=new Function(""+t+e);return v("validating formula %s using context %j",e,t),n(),v("formula %s validated",e),n=null,!0}catch(r){return v("formula %s not validated: error %j",e,r),!1}},e.valueInChoice=j,Object.defineProperty(e,"__esModule",{value:!0})}));