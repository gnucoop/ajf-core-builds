!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("tslib"),require("debug"),require("esprima"),require("date-fns"),require("numeral")):"function"==typeof define&&define.amd?define("@ajf/core/models",["exports","tslib","debug","esprima","date-fns","numeral"],r):r(((e=e||self).ajf=e.ajf||{},e.ajf.core=e.ajf.core||{},e.ajf.core.models={}),e.tslib,e.debug,e.esprima,e.dateFns,e.numeral)}(this,(function(e,r,t,n,a,o){"use strict";var i="default"in t?t.default:t,u="default"in n?n.default:n,l="default"in o?o.default:o,f=function(e){function t(r){var n=e.call(this,r)||this;return Object.setPrototypeOf(n,t.prototype),n._message=r||"",n}return r.__extends(t,e),Object.defineProperty(t.prototype,"name",{get:function(){return"AjfError"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"message",{get:function(){return this._message},enumerable:!0,configurable:!0}),t}(Error);
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
function s(e){return void 0===e&&(e={}),{condition:e.condition||""}}
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */var c=function(){function e(){}return e.fromJson=function(e){return s(e)},e}();
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */function d(e){return void 0===e&&(e={}),{formula:e.formula||""}}
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */var p=function(){function e(){}return e.fromJson=function(e){return d(e)},e}(),m=(i||t)("ajf:models:validated-property"),v=l||o,g={addDays:a.addDays,addMonths:a.addMonths,addYears:a.addYears,endOfISOWeek:a.endOfISOWeek,format:a.format,getDay:a.getDay,parse:a.parseISO,startOfMonth:a.startOfMonth,startOfISOWeek:a.startOfISOWeek};
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */function y(e){return isNaN(e)||"number"!=typeof e?0:isFinite(e)?e.toString().replace(/[^0-9]/g,"").length:1/0}function h(e){if("string"==typeof e&&(e=parseFloat(e)),"number"!=typeof e||isNaN(e))return 0;var r=e.toString().split(".");return r.length>1?r[1].length:0}function b(e){return"string"==typeof e?/^-?\d+$/.test(e):"number"==typeof e&&Math.round(e)===e}function N(e){return null!=e&&e.toString().length>0}function O(e,r){return(e||[]).indexOf(r)>-1||e===r}function _(e,r,t){for(var n=0;n<e;n++)r=t(r,n);return r}function j(e){return e.reduce((function(e,r){return e+r}),0)}function x(e,r,t,n){var a,o=void 0!==e?g.parse(e):new Date;switch("remove"==t&&(n=-n),r){case"day":a=g.addDays;break;case"month":a=g.addMonths;break;case"year":a=g.addYears;break;default:return""}return g.format(a(o,n),"mm/dd/yyyy")}function A(e,r){var t;if(r=r||0,"number"!=typeof e)try{t=parseFloat(e)}catch(e){}else t=e;(null==t||isNaN(t))&&(t=0);var n=Math.pow(10,r);return Math.round(t*n)/n}function S(e,r,t){for(var n=(e=(e||[]).slice(0)).length,a=[],o=0;o<n;o++)null!=e[o][r]&&null!=t&&null!=e[o][t]?a.push(Number(e[o][r])+Number(e[o][t])):null!=e[o][r]&&a.push(e[o][r]);return a}function I(e,r){for(var t=0,n=(r=(r||[]).slice(0)).length,a=0;a<n;a++)for(var o=S(e,r[a]),i=o.length,u=0;u<i;u++)isNaN(Number(o[u]))||(t+=Number(o[u]));return t}function C(e,r){var t=[];r=(r||[]).slice(0);for(var n=0;n<r.length;n++){var a=S(e,r[n]);t.push(a)}var o=[];if(t.length>0)for(var i=0;i<t[0].length;i++){for(var u=0,l=0;l<r.length;l++)u+=Number(t[l][i]);o.push(u)}return o}function M(e,r,t){e=(e||[]).slice(0),(t=t||[0])instanceof Array||(t=[t]);for(var n=e.length,a=[],o=0,i=0;i<n;i++)null!=e[i][r]&&(a.push(t.length>o?t[o]:t[0]),o++);return a}function P(e,r,t){for(var n=(e=(e||[]).slice(0)).length,a=[],o=0;o<n;o++)if(null!=e[o][r])switch(t){case"WW":case"ww":a.push("W"+q(e[o].date_start,t));break;case"MM":case"mm":a.push("M"+z(e[o].date_start,t));break;default:a.push(""+q(e[o].date_start,t))}return a}function k(e,r){for(var t=(e=(e||[]).slice(0)).length-1;t>=0&&null==e[t][r];)if(--t<0)return"";return t>=0?e[t][r]:""}function w(e,r){e=(e||[]).slice(0);for(var t=0,n=0,a=0;a<r.length;a++)n=Number(k(e,r[a])),isNaN(n)||(t+=n);return t}function F(e,r){for(var t=(e=(e||[]).slice(0)).length-1;null==e[t][r]&&0!=t;)t--;var n=t-1;if(0==t)n=t;else for(;null==e[n][r];){if(0==n){n=t;break}n--}var a=e[t]&&e[t][r]||0,o=e[n]&&e[n][r]||0;return a==o?'<p><i class="material-icons" style="color:blue">trending_flat</i></p>':a>o?'<p><i class="material-icons" style="color:green">trending_up</i></p>':'<p><i class="material-icons" style="color:red">trending_down</i></p>'}function D(e,r){var t=C(e,r),n=t.length>0&&t[t.length-1]||0,a=t.length>1?t[t.length-2]||0:n;return n==a?'<p><i class="material-icons" style="color:blue">trending_flat</i></p>':n>a?'<p><i class="material-icons" style="color:green">trending_up</i></p>':'<p><i class="material-icons" style="color:red">trending_down</i></p>'}function E(e,r,t,n){n=n||1;var a=(e=(e||[]).slice(0)).length,o=0,i=0,u=0;for(a<(t=t||12)&&(t=a);0!=t;)null!=e[a-1][r]&&(i++,o+=Number(e[a-1][r]),e[a-1][r]>0&&u++),a--,t--;return 0==n?u:A(o/i*n,2)||0}function T(e,r,t,n){e=(e||[]).slice(0);var a=[];if(r&&r.length>0){n=n||1,t=t||12;for(var o=r.length>1?C(e,r):S(e,r[0]),i=o.length;i>0;i--){var u=0,l=0,f=0;i<t&&(t=i);for(var s=1;s<=t;s++){var c=o[i-s];null!=c&&(l++,u+=Number(c),c>0&&f++)}l>0&&a.push(A(0==n?f:u/l*n||0,2))}}return a.reverse()}function W(e,r,t){return k(e=(e||[]).slice(0),r)>t?'<p><i class="material-icons" style="color:red">warning</i></p>':"<p></p>"}function U(e,r){return r=r||"0,0[.]0",v(e).format(r)}function q(e,r){return g.format(e,r=r||"mm-dd-yyyy")}function z(e,r){return r=r||"mm",g.format(g.addDays(g.startOfISOWeek(e),3),r)}function L(e,r){return r=r||6,null==e?[51.505,-.09,r]:[e[0],e[1],r]}
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */var $=function(){function e(){}return e.UTIL_FUNCTIONS="",e.utils={digitCount:{fn:y},decimalCount:{fn:h},isInt:{fn:b},notEmpty:{fn:N},valueInChoice:{fn:O},scanGroupField:{fn:_},sum:{fn:j},dateOperations:{fn:x},round:{fn:A},extractArray:{fn:S},extractSum:{fn:I},extractArraySum:{fn:C},drawThreshold:{fn:M},extractDates:{fn:P},lastProperty:{fn:k},sumLastProperties:{fn:w},calculateTrendProperty:{fn:F},calculateTrendByProperties:{fn:D},calculateAvgProperty:{fn:E},calculateAvgPropertyArray:{fn:T},alert:{fn:W},formatNumber:{fn:U},formatDate:{fn:q},isoMonth:{fn:z},getCoordinate:{fn:L},Math:{fn:Math},parseInt:{fn:parseInt},parseFloat:{fn:parseFloat},parseDate:{fn:g.parse},Date:{fn:Date}},e}(),J=(u||n).tokenize,Y={};
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
function B(e){var r=$.UTIL_FUNCTIONS;if(e instanceof Array)for(var t=0;t<e.length;t++)r=r+"var "+e[t]+" = true;";else null!=e&&Object.keys(e).forEach((function(t){var n=e[t];if(null==n||isNaN(Number(n))||""===n||n instanceof Array){if(n instanceof Array)for(var a=0;a<n.length;a++)n[a]=(null==n||isNaN(Number(n[a]))||""===n[a])&&n[a]||Number(n[a]);n=JSON.stringify(n)}else n=Number(n);r=r+"var "+t+" = "+n+"; "}));return r}
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
var G=(u||n).tokenize,R={},H="{}";
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */
e.AjfConditionSerializer=c,e.AjfError=f,e.AjfExpressionUtils=$,e.AjfFormulaSerializer=p,e.alert=W,e.alwaysCondition=function K(){return s({condition:"true"})}
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */,e.calculateAvgProperty=E,e.calculateAvgPropertyArray=T,e.calculateTrendByProperties=D,e.calculateTrendProperty=F,e.createCondition=s,e.createFormula=d,e.dateOperations=x,e.dateUtils=g,e.dbg=m,e.decimalCount=h,e.digitCount=y,e.drawThreshold=M,e.evaluateExpression=function Q(e,t,n){var a=n||e||"";if(""===a)return"";if("true"===a)return!0;if("false"===a)return!1;if(null!=t&&void 0!==t[a])return t[a];if(/^"[^"]*"$/.test(a))return a.replace(/^"+|"+$/g,"");var o=J(a).filter((function(e){return"Identifier"===e.type})).map((function(e){return e.value})),i=[];o.forEach((function(e){var r=null;null!=t&&void 0!==t[e]?r=t[e]:void 0!==$.utils[e]&&(r=$.utils[e].fn),i.push(r)})),o.push("execContext"),i.push(Y);try{m.enabled&&m("evaluating formula %s using context %j",a,i);var u=new(Function.bind.apply(Function,r.__spread([void 0],o,["return "+a]))),l=u.apply(void 0,r.__spread(i));return m.enabled&&m("formula %s evaluated: result %s",a,l),u=null,l}catch(e){return console.log(e),m.enabled&&m("formula %s not evaluated: error %j",a,e.message),!1}},e.extractArray=S,e.extractArraySum=C,e.extractDates=P,e.extractSum=I,e.formatDate=q,e.formatNumber=U,e.getContextString=B,e.getCoordinate=L,e.isInt=b,e.isoMonth=z,e.lastProperty=k,e.neverCondition=function V(){return s({condition:"false"})},e.normalizeExpression=function X(e,r,t){var n=Object.keys(r);return G(e).filter((function(e){return"Identifier"==e.type&&"$value"!=e.value})).map((function(e){return e.value})).forEach((function(a){n.indexOf(a)>-1&&(e=e.replace(new RegExp("\\b"+a+"\\b","g"),a+"__"+t.slice(r[a]).join("__")))})),e}
/**
     * @license
     * Copyright (C) 2018 Gnucoop soc. coop.
     *
     * This file is part of the Advanced JSON forms (ajf).
     *
     * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
     * modify it under the terms of the GNU Affero General Public License as
     * published by the Free Software Foundation, either version 3 of the License,
     * or (at your option) any later version.
     *
     * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
     * General Public License for more details.
     *
     * You should have received a copy of the GNU Affero General Public License
     * along with Advanced JSON forms (ajf).
     * If not, see http://www.gnu.org/licenses/.
     *
     */,e.notEmpty=N,e.round=A,e.scanGroupField=_,e.sum=j,e.sumLastProperties=w,e.validateExpression=function Z(e,r){r===R?console.log("cache hit"):(R=r,H=B(r));var t=H;try{var n=new Function(""+t+e);return m("validating formula %s using context %j",e,t),n(),m("formula %s validated",e),n=null,!0}catch(r){return m("formula %s not validated: error %j",e,r),!1}},e.valueInChoice=O,Object.defineProperty(e,"__esModule",{value:!0})}));