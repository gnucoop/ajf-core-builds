/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@ajf/core/models"),require("@ajf/core/utils")):"function"==typeof define&&define.amd?define("@ajf/core/reports",["exports","@angular/core","@ajf/core/models","@ajf/core/utils"],t):t(((e=e||self).ajf=e.ajf||{},e.ajf.core=e.ajf.core||{},e.ajf.core.reports={}),e.ng.core,e.ajf.core.models,e.ajf.core.utils)}(this,function(e,t,J,S){"use strict";var P=function(){return(P=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},r=(Object.defineProperty(n.prototype,"instance",{get:function(){return this._instance},set:function(e){this._instance!==e&&(this._instance=e,this._cdr.detectChanges())},enumerable:!0,configurable:!0}),n);function n(e,t){this._cdr=e,this.el=t}var a={Line:0,Bar:1,HorizontalBar:2,Radar:3,Scatter:4,Doughnut:5,Pie:6,PolarArea:7,Bubble:8,LENGTH:9};function L(e){switch(e){case a.Line:return"line";case a.Bar:return"bar";case a.HorizontalBar:return"horizontalBar";case a.Radar:return"radar";case a.Scatter:return"scatter";case a.Doughnut:return"doughnut";case a.Pie:return"pie";case a.PolarArea:return"polarArea";case a.Bubble:return"bubble";default:return"line"}}a[a.Line]="Line",a[a.Bar]="Bar",a[a.HorizontalBar]="HorizontalBar",a[a.Radar]="Radar",a[a.Scatter]="Scatter",a[a.Doughnut]="Doughnut",a[a.Pie]="Pie",a[a.PolarArea]="PolarArea",a[a.Bubble]="Bubble",a[a.LENGTH]="LENGTH";var B={None:0,Sum:1,Average:2,WeightedAverage:3,LENGTH:4};B[B.None]="None",B[B.Sum]="Sum",B[B.Average]="Average",B[B.WeightedAverage]="WeightedAverage",B[B.LENGTH]="LENGTH";var z={Layout:0,PageBreak:1,Image:2,Text:3,Chart:4,Table:5,Map:6,Column:7,Formula:8,ImageContainer:9,LENGTH:10};z[z.Layout]="Layout",z[z.PageBreak]="PageBreak",z[z.Image]="Image",z[z.Text]="Text",z[z.Chart]="Chart",z[z.Table]="Table",z[z.Map]="Map",z[z.Column]="Column",z[z.Formula]="Formula",z[z.ImageContainer]="ImageContainer",z[z.LENGTH]="LENGTH";var o=(Object.defineProperty(i.prototype,"instance",{get:function(){return this._instance},set:function(e){this._instance=e,this._report=null!=e?e.report:null,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"report",{get:function(){return this._report},enumerable:!0,configurable:!0}),i);function i(e){this._cdr=e}var s=(l.prototype.transform=function(e,t){return 0<=t&&t<e.content.length?e.content[t]:null},l.decorators=[{type:t.Pipe,args:[{name:"ajfGetColumnContent"}]}],l);function l(){}var u=(f.decorators=[{type:t.Directive,args:[{selector:"[ajf-widget-host]"}]}],f.ctorParameters=function(){return[{type:t.ViewContainerRef}]},f);function f(e){this.viewContainerRef=e}var c=(g.decorators=[{type:t.NgModule,args:[{declarations:[s,u],exports:[s,u]}]}],g);function g(){}function p(e){return P({},e,{aggregation:e.aggregation||B.None})}var d=(m.fromJson=function(e){if(null==e.aggregation)throw new Error("Malformed aggregation");return p(P({},e,{aggregation:e.aggregation}))},m);function m(){}var y=(h.fromJson=function(e){if(null==e.formula||null==e.aggregation||null==e.label)throw new Error("Malformed dataset");return e.formula=e.formula instanceof Array?e.formula=e.formula.map(function(e){return J.AjfFormulaSerializer.fromJson(e)}):J.AjfFormulaSerializer.fromJson(e.formula),e.aggregation=d.fromJson(e.aggregation),function(e){return P({},e,{aggregation:e.aggregation||p({aggregation:B.None})})}(e)},h);function h(){}function v(e){return P({},e,{styles:e.styles||{},visibility:e.visibility||J.alwaysCondition()})}var b=(T.fromJson=function(e){if(null==e.widgetType)throw new Error("Malformed widget");e.visibility=e.visibility?J.AjfConditionSerializer.fromJson(e.visibility):J.alwaysCondition(),e.styles=e.styles||{};var t=e;if(t.widgetType===z.Layout||t.widgetType===z.Column)return T._widgetWithContentFromJson(t);if(t.widgetType===z.Chart||t.widgetType===z.Table){var r=T._dataWidgetFromJson(t);if(t.widgetType===z.Chart){var n=r;n.labels instanceof Array?n.labels.map(function(e){return J.AjfFormulaSerializer.fromJson(e)}):null!=n.labels&&(n.labels=J.AjfFormulaSerializer.fromJson(n.labels))}return r}if(t.widgetType===z.Map){var a=t;a.coordinate=J.AjfFormulaSerializer.fromJson(a.coordinate)}return t},T._dataWidgetFromJson=function(e){var t=e.dataset?e.widgetType===z.Table?e.dataset.map(function(e){return e.map(function(e){return y.fromJson(e)})}):e.dataset.map(function(e){return y.fromJson(e)}):[];return P({},v(e),{dataset:t})},T._widgetWithContentFromJson=function(e){var t=(e.content||[]).map(function(e){return T.fromJson(e)});return P({},v(e),{content:t})},T);function T(){}var w=(A.fromJson=function(e){return e.content=(e.content||[]).map(function(e){return b.fromJson(e)}),P({},e,{content:e.content,styles:e.styles||{}})},A);function A(){}var j=(C.fromJson=function(t){return["header","footer","content"].forEach(function(e){t[e]&&(t[e]=w.fromJson(t[e]))}),function(e){return P({},e)}(t)},C);function C(){}var E=(Object.defineProperty(_.prototype,"instance",{get:function(){return this._instance},set:function(e){this._instance!==e&&(this._instance=e,this._loadComponent())},enumerable:!0,configurable:!0}),_.prototype.ngAfterViewInit=function(){this._loadComponent()},_.prototype._loadComponent=function(){var t=this;if(null!=this._instance&&null!=this.widgetHost){var e=this.widgetHost.viewContainerRef;e.clear();var r=this.widgetsMap[this._instance.widget.widgetType];if(null!=r){var n=r.component;try{var a=this._cfr.resolveComponentFactory(n),o=e.createComponent(a).instance;Object.keys(this._instance.widget.styles).forEach(function(e){try{t._renderer.setStyle(o.el.nativeElement,e,""+t._instance.widget.styles[e])}catch(e){}}),o.instance=this._instance,r.inputs&&Object.keys(r.inputs).forEach(function(e){e in o&&(o[e]=r.inputs[e])})}catch(e){}}}},_);function _(e,t){this._cfr=e,this._renderer=t}function F(e,t,r){return{widget:e,widgetType:e.widgetType,visible:J.evaluateExpression(e.visibility.condition,t),styles:e.styles||{}}}function H(e,a,o){var t=F(e,a);if(e.widgetType===z.Column||e.widgetType===z.Layout){var r=e;t.content=r.content.map(function(e){return H(e,a,o)})}else if(e.widgetType===z.Chart){var n=e,i=t,s=(n.labels instanceof Array?n.labels:[n.labels]).map(function(e){var t=J.evaluateExpression(e.formula,a);try{t=t instanceof Array?t.map(function(e){return null!=e&&"string"==typeof e&&0<e.trim().length?o.instant(e):e}):null!=t&&"string"==typeof t&&0<t.trim().length?o.instant(t):t}catch(e){}return t});i.labels=n.labels instanceof Array?s:s[0],i.datasets=n.dataset.map(function(e){var t=P({},e.options||{},{data:function(e,t,r){var n=t.map(function(e){return J.evaluateExpression(e.formula,r)});switch(e.aggregation){case B.None:if(1!==n.length)throw new Error("Invalid aggregation");return n[0];case B.Sum:return n.map(function(e){return e.reduce(function(e,t){return e+t},0)});case B.Average:case B.WeightedAverage:return n.map(function(e){return e.reduce(function(e,t){return e+t},0)/n.length});default:return[]}}(e.aggregation,e.formula,a)});if(null!=e.chartType){var r=L(e.chartType);t=P({},t,{chartType:r,type:r})}return null!=e.options&&(t=P({},t,{options:e.options})),null!=e.label&&(t=P({},t,{label:e.label})),null!=e.datalabels&&(t.datalabels=S.deepCopy(e.datalabels)),t}),i.data={labels:i.labels,datasets:i.datasets},i.chartType=L(n.type||n.chartType)}else if(e.widgetType===z.Table){var l=e,u=t,f=function(e){var t=e.formula;if('"'===t.substr(0,1)){var r=t.slice(1,-1),n=null!=r&&"string"==typeof r&&0<r.trim().length?o.instant(r):r;0<r.length&&(t='"'+n+'"')}else t=null!=t&&"string"==typeof t&&0<t.trim().length?o.instant(t):t;return J.evaluateExpression(t,a)};u.dataset=l.dataset.map(function(e){return e.map(function(e){return e.formula instanceof Array?e.formula.map(function(e){return f(e)}):f(e.formula)})}),u.data=(l.dataset||[]).map(function(e){return e.map(function(e){return{value:J.evaluateExpression(e.formula.formula,a),style:P({},l.cellStyles,e.style),rowspan:e.rowspan,colspan:e.colspan}})})}else if(e.widgetType===z.Image){var c=e,g=t;c.flag&&(g.flag=J.evaluateExpression(c.flag.formula,a)),c.icon&&(g.icon=J.evaluateExpression(c.icon.formula,a)),c.url&&(g.url=J.evaluateExpression(c.url.formula,a))}else if(e.widgetType===z.ImageContainer){var p=e,d=t;if(p.flags){var m=p.flags instanceof Array?p.flags:[p.flags];d.flags=m.map(function(e){return J.evaluateExpression(e.formula,a)})}if(p.icons){var y=p.icons instanceof Array?p.icons:[p.icons];d.icons=y.map(function(e){return J.evaluateExpression(e.formula,a)})}if(p.urls){var h=p.urls instanceof Array?p.urls:[p.urls];d.urls=h.map(function(e){return J.evaluateExpression(e.formula,a)})}}else if(e.widgetType===z.Text){for(var v=t,b=/\[{2}(.+?)\]{2}/g,T=[],w=void 0,A=e.htmlText;w=b.exec(A);){var j=w.index,C=w[0].length,E=J.createFormula({formula:w[1]});T.push({idx:j,len:C,formula:E})}T.reverse().forEach(function(e){var t;try{t=J.evaluateExpression(e.formula.formula,a)}catch(e){t=""}A=""+A.substr(0,e.idx)+t+A.substr(e.idx+e.len)}),v.htmlText=null!=A&&0<A.length?o.instant(A):A}else if(e.widgetType===z.Formula){var _=e;t.formula=J.evaluateExpression(_.formula.formula,a)}else if(e.widgetType===z.Map){var x=e;t.coordinate=J.evaluateExpression(x.coordinate.formula,a)}return t}function x(e,t,r){var n=e.content.map(function(e){return H(e,t,r)});return{container:e,content:n,styles:e.styles}}e.AjfAggregationSerializer=d,e.AjfAggregationType=B,e.AjfBaseWidgetComponent=r,e.AjfChartType=a,e.AjfDatasetSerializer=y,e.AjfReportContainerSerializer=w,e.AjfReportRenderer=o,e.AjfReportSerializer=j,e.AjfReportWidget=E,e.AjfReportsModule=c,e.AjfWidgetHost=u,e.AjfWidgetSerializer=b,e.AjfWidgetType=z,e.chartToChartJsType=L,e.createAggregation=p,e.createReportInstance=function(e,t,r){return{report:e,header:e.header?x(e.header,t,r):void 0,content:e.content?x(e.content,t,r):void 0,footer:e.footer?x(e.footer,t,r):void 0,styles:e.styles||{}}},e.createWidget=v,e.createWidgetInstance=F,e.widgetToWidgetInstance=H,e.ɵa=s,e.ɵb=x,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-reports.umd.min.js.map
