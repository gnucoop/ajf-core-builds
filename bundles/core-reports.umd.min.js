/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@ajf/core/models"),require("@ajf/core/utils")):"function"==typeof define&&define.amd?define("@ajf/core/reports",["exports","@angular/core","@ajf/core/models","@ajf/core/utils"],t):t(((e=e||self).ajf=e.ajf||{},e.ajf.core=e.ajf.core||{},e.ajf.core.reports={}),e.ng.core,e.ajf.core.models,e.ajf.core.utils)}(this,function(e,t,x,J){"use strict";var S=function(){return(S=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},r=(Object.defineProperty(n.prototype,"instance",{get:function(){return this._instance},set:function(e){this._instance!==e&&(this._instance=e,this._cdr.detectChanges())},enumerable:!0,configurable:!0}),n);function n(e,t){this._cdr=e,this.el=t}var a={Line:0,Bar:1,HorizontalBar:2,Radar:3,Scatter:4,Doughnut:5,Pie:6,PolarArea:7,Bubble:8,LENGTH:9};function P(e){switch(e){case a.Line:return"line";case a.Bar:return"bar";case a.HorizontalBar:return"horizontalBar";case a.Radar:return"radar";case a.Scatter:return"scatter";case a.Doughnut:return"doughnut";case a.Pie:return"pie";case a.PolarArea:return"polarArea";case a.Bubble:return"bubble";default:return"line"}}a[a.Line]="Line",a[a.Bar]="Bar",a[a.HorizontalBar]="HorizontalBar",a[a.Radar]="Radar",a[a.Scatter]="Scatter",a[a.Doughnut]="Doughnut",a[a.Pie]="Pie",a[a.PolarArea]="PolarArea",a[a.Bubble]="Bubble",a[a.LENGTH]="LENGTH";var L={None:0,Sum:1,Average:2,WeightedAverage:3,LENGTH:4};L[L.None]="None",L[L.Sum]="Sum",L[L.Average]="Average",L[L.WeightedAverage]="WeightedAverage",L[L.LENGTH]="LENGTH";var B={Layout:0,PageBreak:1,Image:2,Text:3,Chart:4,Table:5,Map:6,Column:7,Formula:8,ImageContainer:9,LENGTH:10};B[B.Layout]="Layout",B[B.PageBreak]="PageBreak",B[B.Image]="Image",B[B.Text]="Text",B[B.Chart]="Chart",B[B.Table]="Table",B[B.Map]="Map",B[B.Column]="Column",B[B.Formula]="Formula",B[B.ImageContainer]="ImageContainer",B[B.LENGTH]="LENGTH";var o=(Object.defineProperty(i.prototype,"instance",{get:function(){return this._instance},set:function(e){this._instance=e,this._report=null!=e?e.report:null,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"report",{get:function(){return this._report},enumerable:!0,configurable:!0}),i);function i(e){this._cdr=e}var s=(l.prototype.transform=function(e,t){return 0<=t&&t<e.content.length?e.content[t]:null},l.decorators=[{type:t.Pipe,args:[{name:"ajfGetColumnContent"}]}],l);function l(){}var u=(f.decorators=[{type:t.Directive,args:[{selector:"[ajf-widget-host]"}]}],f.ctorParameters=function(){return[{type:t.ViewContainerRef}]},f);function f(e){this.viewContainerRef=e}var c=(g.decorators=[{type:t.NgModule,args:[{declarations:[s,u],exports:[s,u]}]}],g);function g(){}function p(e){return S({},e,{aggregation:e.aggregation||L.None})}var m=(d.fromJson=function(e){if(null==e.aggregation)throw new Error("Malformed aggregation");return p(S({},e,{aggregation:e.aggregation}))},d);function d(){}var y=(h.fromJson=function(e){if(null==e.formula||null==e.aggregation||null==e.label)throw new Error("Malformed dataset");return e.formula=e.formula instanceof Array?e.formula=e.formula.map(function(e){return x.AjfFormulaSerializer.fromJson(e)}):x.AjfFormulaSerializer.fromJson(e.formula),e.aggregation=m.fromJson(e.aggregation),function(e){return S({},e,{aggregation:e.aggregation||p({aggregation:L.None})})}(e)},h);function h(){}function v(e){return S({},e,{styles:e.styles||{},visibility:e.visibility||x.alwaysCondition()})}var b=(T.fromJson=function(e){if(null==e.widgetType)throw new Error("Malformed widget");e.visibility=e.visibility?x.AjfConditionSerializer.fromJson(e.visibility):x.alwaysCondition(),e.styles=e.styles||{};var t=e;if(t.widgetType===B.Layout||t.widgetType===B.Column)return T._widgetWithContentFromJson(t);if(t.widgetType===B.Chart||t.widgetType===B.Table){var r=T._dataWidgetFromJson(t);if(t.widgetType===B.Chart){var n=r;n.labels instanceof Array?n.labels.map(function(e){return x.AjfFormulaSerializer.fromJson(e)}):null!=n.labels&&(n.labels=x.AjfFormulaSerializer.fromJson(n.labels))}return r}if(t.widgetType===B.Map){var a=t;a.coordinate=x.AjfFormulaSerializer.fromJson(a.coordinate)}return t},T._dataWidgetFromJson=function(e){var t=e.dataset?e.widgetType===B.Table?e.dataset.map(function(e){return e.map(function(e){return y.fromJson(e)})}):e.dataset.map(function(e){return y.fromJson(e)}):[];return S({},v(e),{dataset:t})},T._widgetWithContentFromJson=function(e){var t=(e.content||[]).map(function(e){return T.fromJson(e)});return S({},v(e),{content:t})},T);function T(){}var w=(A.fromJson=function(e){return e.content=(e.content||[]).map(function(e){return b.fromJson(e)}),S({},e,{content:e.content,styles:e.styles||{}})},A);function A(){}var j=(E.fromJson=function(t){return["header","footer","content"].forEach(function(e){t[e]&&(t[e]=w.fromJson(t[e]))}),function(e){return S({},e)}(t)},E);function E(){}var C=(Object.defineProperty(_.prototype,"instance",{get:function(){return this._instance},set:function(e){this._instance!==e&&(this._instance=e,this._init&&this._loadComponent())},enumerable:!0,configurable:!0}),_.prototype.ngOnInit=function(){this._init=!0,this._loadComponent()},_.prototype._loadComponent=function(){var t=this;if(this._init&&null!=this._instance&&null!=this.widgetHost&&this.instance.visible){var e=this.widgetHost.viewContainerRef;e.clear();var r=this.widgetsMap[this._instance.widget.widgetType];if(null!=r){var n=r.component;try{var a=this._cfr.resolveComponentFactory(n),o=e.createComponent(a).instance;Object.keys(this._instance.widget.styles).forEach(function(e){try{t._renderer.setStyle(o.el.nativeElement,e,""+t._instance.widget.styles[e])}catch(e){}}),o.instance=this._instance,r.inputs&&Object.keys(r.inputs).forEach(function(e){e in o&&(o[e]=r.inputs[e])})}catch(e){}}}},_);function _(e,t){this._cfr=e,this._renderer=t,this._init=!1}function z(e,t,r){return{widget:e,widgetType:e.widgetType,visible:x.evaluateExpression(e.visibility.condition,t),styles:e.styles||{}}}function F(e,a,o){var t=z(e,a);if(e.widgetType===B.Column||e.widgetType===B.Layout){var r=e,n=t,i=[];r.content.forEach(function(e){if(null!=r.repetitions){if(n.repetitions=x.evaluateExpression(r.repetitions.formula,a),"number"==typeof n.repetitions&&0<n.repetitions)for(var t=0;t<n.repetitions;t++)i.push(F(e,S({},a,{$repetition:t}),o))}else i.push(F(e,a,o));n.content=i})}else if(e.widgetType===B.Chart){var s=e,l=t,u=(s.labels instanceof Array?s.labels:[s.labels]).map(function(e){var t=x.evaluateExpression(e.formula,a);try{t=t instanceof Array?t.map(function(e){return null!=e&&"string"==typeof e&&0<e.trim().length?o.instant(e):e}):null!=t&&"string"==typeof t&&0<t.trim().length?o.instant(t):t}catch(e){}return t});l.labels=s.labels instanceof Array?u:u[0],l.datasets=s.dataset.map(function(e){var t=S({},e.options||{},{data:function(e,t,r){var n=t.map(function(e){return x.evaluateExpression(e.formula,r)});switch(e.aggregation){case L.None:if(1!==n.length)throw new Error("Invalid aggregation");return n[0];case L.Sum:return n.map(function(e){return e.reduce(function(e,t){return e+t},0)});case L.Average:case L.WeightedAverage:return n.map(function(e){return e.reduce(function(e,t){return e+t},0)/n.length});default:return[]}}(e.aggregation,e.formula,a)});if(null!=e.chartType){var r=P(e.chartType);t=S({},t,{chartType:r,type:r})}return null!=e.options&&(t=S({},t,{options:e.options})),null!=e.label&&(t=S({},t,{label:e.label})),null!=e.datalabels&&(t.datalabels=J.deepCopy(e.datalabels)),t}),l.data={labels:l.labels,datasets:l.datasets},l.chartType=P(s.type||s.chartType)}else if(e.widgetType===B.Table){var f=e,c=t,g=function(e){var t=e.formula;if('"'===t.substr(0,1)){var r=t.slice(1,-1),n=null!=r&&"string"==typeof r&&0<r.trim().length?o.instant(r):r;0<r.length&&(t='"'+n+'"')}else t=null!=t&&"string"==typeof t&&0<t.trim().length?o.instant(t):t;return x.evaluateExpression(t,a)};c.dataset=f.dataset.map(function(e){return e.map(function(e){return e.formula instanceof Array?e.formula.map(function(e){return g(e)}):g(e.formula)})}),c.data=(f.dataset||[]).map(function(e){return e.map(function(e){return{value:x.evaluateExpression(e.formula.formula,a),style:S({},f.cellStyles,e.style),rowspan:e.rowspan,colspan:e.colspan}})})}else if(e.widgetType===B.Image){var p=e,m=t;p.flag&&(m.flag=x.evaluateExpression(p.flag.formula,a)),p.icon&&(m.icon=x.evaluateExpression(p.icon.formula,a)),p.url&&(m.url=x.evaluateExpression(p.url.formula,a))}else if(e.widgetType===B.ImageContainer){var d=e,y=t;d.flags&&(y.flags=d.flags instanceof Array?d.flags.map(function(e){return x.evaluateExpression(e.formula,a)}):x.evaluateExpression(d.flags.formula,a)),d.icons&&(y.icons=d.icons instanceof Array?d.icons.map(function(e){return x.evaluateExpression(e.formula,a)}):x.evaluateExpression(d.icons.formula,a)),d.urls&&(y.urls=d.urls instanceof Array?d.urls.map(function(e){return x.evaluateExpression(e.formula,a)}):x.evaluateExpression(d.urls.formula,a))}else if(e.widgetType===B.Text){for(var h=t,v=/\[{2}(.+?)\]{2}/g,b=[],T=void 0,w=e.htmlText;T=v.exec(w);){var A=T.index,j=T[0].length,E=x.createFormula({formula:T[1]});b.push({idx:A,len:j,formula:E})}b.reverse().forEach(function(e){var t;try{t=x.evaluateExpression(e.formula.formula,a)}catch(e){t=""}w=""+w.substr(0,e.idx)+t+w.substr(e.idx+e.len)}),h.htmlText=null!=w&&0<w.length?o.instant(w):w}else if(e.widgetType===B.Formula){var C=e;t.formula=x.evaluateExpression(C.formula.formula,a)}else if(e.widgetType===B.Map){var _=e;t.coordinate=x.evaluateExpression(_.coordinate.formula,a)}return t}function H(e,t,r){var n=e.content.map(function(e){return F(e,t,r)});return{container:e,content:n,styles:e.styles}}e.AjfAggregationSerializer=m,e.AjfAggregationType=L,e.AjfBaseWidgetComponent=r,e.AjfChartType=a,e.AjfDatasetSerializer=y,e.AjfReportContainerSerializer=w,e.AjfReportRenderer=o,e.AjfReportSerializer=j,e.AjfReportWidget=C,e.AjfReportsModule=c,e.AjfWidgetHost=u,e.AjfWidgetSerializer=b,e.AjfWidgetType=B,e.chartToChartJsType=P,e.createAggregation=p,e.createReportInstance=function(e,t,r){return(e.variables||[]).forEach(function(e){t[e.name]=x.evaluateExpression(e.formula.formula,t)}),{report:e,header:e.header?H(e.header,t,r):void 0,content:e.content?H(e.content,t,r):void 0,footer:e.footer?H(e.footer,t,r):void 0,styles:e.styles||{}}},e.createWidget=v,e.createWidgetInstance=z,e.widgetToWidgetInstance=F,e.ɵa=s,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-reports.umd.min.js.map
