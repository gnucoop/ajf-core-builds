/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@ajf/core/models"),require("@ajf/core/utils")):"function"==typeof define&&define.amd?define("@ajf/core/reports",["exports","@angular/core","@ajf/core/models","@ajf/core/utils"],t):t(((e=e||self).ajf=e.ajf||{},e.ajf.core=e.ajf.core||{},e.ajf.core.reports={}),e.ng.core,e.ajf.core.models,e.ajf.core.utils)}(this,function(e,t,P,L){"use strict";var B=function(){return(B=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},r=(Object.defineProperty(n.prototype,"instance",{get:function(){return this._instance},set:function(e){this._instance!==e&&(this._instance=e,this._cdr.detectChanges())},enumerable:!0,configurable:!0}),n);function n(e,t){this._cdr=e,this.el=t}var a={Line:0,Bar:1,HorizontalBar:2,Radar:3,Scatter:4,Doughnut:5,Pie:6,PolarArea:7,Bubble:8,LENGTH:9};function z(e){switch(e){case a.Line:return"line";case a.Bar:return"bar";case a.HorizontalBar:return"horizontalBar";case a.Radar:return"radar";case a.Scatter:return"scatter";case a.Doughnut:return"doughnut";case a.Pie:return"pie";case a.PolarArea:return"polarArea";case a.Bubble:return"bubble";default:return"line"}}a[a.Line]="Line",a[a.Bar]="Bar",a[a.HorizontalBar]="HorizontalBar",a[a.Radar]="Radar",a[a.Scatter]="Scatter",a[a.Doughnut]="Doughnut",a[a.Pie]="Pie",a[a.PolarArea]="PolarArea",a[a.Bubble]="Bubble",a[a.LENGTH]="LENGTH";var F={None:0,Sum:1,Average:2,WeightedAverage:3,LENGTH:4};F[F.None]="None",F[F.Sum]="Sum",F[F.Average]="Average",F[F.WeightedAverage]="WeightedAverage",F[F.LENGTH]="LENGTH";var H={Layout:0,PageBreak:1,Image:2,Text:3,Chart:4,Table:5,Map:6,Column:7,Formula:8,ImageContainer:9,LENGTH:10};H[H.Layout]="Layout",H[H.PageBreak]="PageBreak",H[H.Image]="Image",H[H.Text]="Text",H[H.Chart]="Chart",H[H.Table]="Table",H[H.Map]="Map",H[H.Column]="Column",H[H.Formula]="Formula",H[H.ImageContainer]="ImageContainer",H[H.LENGTH]="LENGTH";var o=(Object.defineProperty(i.prototype,"instance",{get:function(){return this._instance},set:function(e){this._instance=e,this._report=null!=e?e.report:null,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"report",{get:function(){return this._report},enumerable:!0,configurable:!0}),i);function i(e){this._cdr=e}var s=(l.prototype.transform=function(e,t){return 0<=t&&t<e.content.length?e.content[t]:null},l.decorators=[{type:t.Pipe,args:[{name:"ajfGetColumnContent"}]}],l);function l(){}var u=(f.decorators=[{type:t.Directive,args:[{selector:"[ajf-widget-host]"}]}],f.ctorParameters=function(){return[{type:t.ViewContainerRef}]},f);function f(e){this.viewContainerRef=e}var c=(g.decorators=[{type:t.NgModule,args:[{declarations:[s,u],exports:[s,u]}]}],g);function g(){}function p(e){return B({},e,{aggregation:e.aggregation||F.None})}var m=(d.fromJson=function(e){if(null==e.aggregation)throw new Error("Malformed aggregation");return p(B({},e,{aggregation:e.aggregation}))},d);function d(){}var y=(h.fromJson=function(e){if(null==e.formula||null==e.aggregation||null==e.label)throw new Error("Malformed dataset");return e.formula=e.formula instanceof Array?e.formula=e.formula.map(function(e){return P.AjfFormulaSerializer.fromJson(e)}):P.AjfFormulaSerializer.fromJson(e.formula),e.aggregation=m.fromJson(e.aggregation),function(e){return B({},e,{aggregation:e.aggregation||p({aggregation:F.None})})}(e)},h);function h(){}function v(e){return B({},e,{styles:e.styles||{},visibility:e.visibility||P.alwaysCondition()})}var b=(T.fromJson=function(e){if(null==e.widgetType)throw new Error("Malformed widget");e.visibility=e.visibility?P.AjfConditionSerializer.fromJson(e.visibility):P.alwaysCondition(),e.styles=e.styles||{};var t=e;if(t.widgetType===H.Layout||t.widgetType===H.Column)return T._widgetWithContentFromJson(t);if(t.widgetType===H.Chart||t.widgetType===H.Table){var r=T._dataWidgetFromJson(t);if(t.widgetType===H.Chart){var n=r;n.labels instanceof Array?n.labels.map(function(e){return P.AjfFormulaSerializer.fromJson(e)}):null!=n.labels&&(n.labels=P.AjfFormulaSerializer.fromJson(n.labels))}return r}if(t.widgetType===H.Map){var a=t;a.coordinate=P.AjfFormulaSerializer.fromJson(a.coordinate)}return t},T._dataWidgetFromJson=function(e){var t=e.dataset?e.widgetType===H.Table?e.dataset.map(function(e){return e.map(function(e){return y.fromJson(e)})}):e.dataset.map(function(e){return y.fromJson(e)}):[];return B({},v(e),{dataset:t})},T._widgetWithContentFromJson=function(e){var t=(e.content||[]).map(function(e){return T.fromJson(e)});return B({},v(e),{content:t})},T);function T(){}var w=(A.fromJson=function(e){return e.content=(e.content||[]).map(function(e){return b.fromJson(e)}),B({},e,{content:e.content,styles:e.styles||{}})},A);function A(){}var j=(C.fromJson=function(t){return["header","footer","content"].forEach(function(e){t[e]&&(t[e]=w.fromJson(t[e]))}),function(e){return B({},e)}(t)},C);function C(){}var E=(Object.defineProperty(_.prototype,"instance",{get:function(){return this._instance},set:function(e){this._instance!==e&&(this._instance=e,this._init&&this._loadComponent())},enumerable:!0,configurable:!0}),_.prototype.ngOnInit=function(){this._init=!0,this._loadComponent()},_.prototype._loadComponent=function(){var t=this;if(this._init&&null!=this._instance&&null!=this.widgetHost&&this.instance.visible){var e=this.widgetHost.viewContainerRef;e.clear();var r=this.widgetsMap[this._instance.widget.widgetType];if(null!=r){var n=r.component;try{var a=this._cfr.resolveComponentFactory(n),o=e.createComponent(a).instance;Object.keys(this._instance.widget.styles).forEach(function(e){try{t._renderer.setStyle(o.el.nativeElement,e,""+t._instance.widget.styles[e])}catch(e){}}),o.instance=this._instance,r.inputs&&Object.keys(r.inputs).forEach(function(e){e in o&&(o[e]=r.inputs[e])})}catch(e){}}}},_);function _(e,t){this._cfr=e,this._renderer=t,this._init=!1}function N(e,t,r){return{widget:e,widgetType:e.widgetType,visible:P.evaluateExpression(e.visibility.condition,t),styles:e.styles||{}}}function W(e,a,o){var t=N(e,a);if(e.widgetType===H.Column||e.widgetType===H.Layout){var r=e,n=t,i=[];r.content.forEach(function(e){if(null!=r.repetitions){if(n.repetitions=P.evaluateExpression(r.repetitions.formula,a),"number"==typeof n.repetitions&&0<n.repetitions)for(var t=0;t<n.repetitions;t++)i.push(W(e,B({},a,{$repetition:t}),o))}else i.push(W(e,a,o));n.content=i})}else if(e.widgetType===H.Chart){var s=e,l=t,u=(s.labels instanceof Array?s.labels:[s.labels]).map(function(e){var t=P.evaluateExpression(e.formula,a);try{t=t instanceof Array?t.map(function(e){return null!=e&&"string"==typeof e&&0<e.trim().length?o.instant(e):e}):null!=t&&"string"==typeof t&&0<t.trim().length?o.instant(t):t}catch(e){}return t});l.labels=s.labels instanceof Array?u:u[0],l.datasets=s.dataset.map(function(e){var t=B({},e.options||{},{data:function(e,t,r){var n=t.map(function(e){return P.evaluateExpression(e.formula,r)});switch(e.aggregation){case F.None:if(1!==n.length)throw new Error("Invalid aggregation");return n[0];case F.Sum:return n.map(function(e){return e.reduce(function(e,t){return e+t},0)});case F.Average:case F.WeightedAverage:return n.map(function(e){return e.reduce(function(e,t){return e+t},0)/n.length});default:return[]}}(e.aggregation,e.formula,a)});if(null!=e.chartType){var r=z(e.chartType);t=B({},t,{chartType:r,type:r})}return null!=e.options&&(t=B({},t,{options:e.options})),null!=e.label&&(t=B({},t,{label:e.label})),null!=e.datalabels&&(t.datalabels=L.deepCopy(e.datalabels)),t}),l.data={labels:l.labels,datasets:l.datasets},l.chartType=z(s.type||s.chartType)}else if(e.widgetType===H.Table){var f=e,c=t,g=function(e){var t=e.formula;if('"'===t.substr(0,1)){var r=t.slice(1,-1),n=null!=r&&"string"==typeof r&&0<r.trim().length?o.instant(r):r;0<r.length&&(t='"'+n+'"')}else t=null!=t&&"string"==typeof t&&0<t.trim().length?o.instant(t):t;return P.evaluateExpression(t,a)};c.dataset=f.dataset.map(function(e){return e.map(function(e){return e.formula instanceof Array?e.formula.map(function(e){return g(e)}):g(e.formula)})}),c.data=(f.dataset||[]).map(function(e){return e.map(function(e){return{value:P.evaluateExpression(e.formula.formula,a),style:B({},f.cellStyles,e.style),rowspan:e.rowspan,colspan:e.colspan}})})}else if(e.widgetType===H.Image){var p=e,m=t;p.flag&&(m.flag=P.evaluateExpression(p.flag.formula,a)),p.icon&&(m.icon=P.evaluateExpression(p.icon.formula,a)),p.url&&(m.url=P.evaluateExpression(p.url.formula,a))}else if(e.widgetType===H.ImageContainer){var d=e,y=t;if(d.flags){var h=d.flags instanceof Array?d.flags:[d.flags];y.flags=h.map(function(e){return P.evaluateExpression(e.formula,a)})}if(d.icons){var v=d.icons instanceof Array?d.icons:[d.icons];y.icons=v.map(function(e){return P.evaluateExpression(e.formula,a)})}if(d.urls){var b=d.urls instanceof Array?d.urls:[d.urls];y.urls=b.map(function(e){return P.evaluateExpression(e.formula,a)})}}else if(e.widgetType===H.Text){for(var T=t,w=/\[{2}(.+?)\]{2}/g,A=[],j=void 0,C=e.htmlText;j=w.exec(C);){var E=j.index,_=j[0].length,x=P.createFormula({formula:j[1]});A.push({idx:E,len:_,formula:x})}A.reverse().forEach(function(e){var t;try{t=P.evaluateExpression(e.formula.formula,a)}catch(e){t=""}C=""+C.substr(0,e.idx)+t+C.substr(e.idx+e.len)}),T.htmlText=null!=C&&0<C.length?o.instant(C):C}else if(e.widgetType===H.Formula){var J=e;t.formula=P.evaluateExpression(J.formula.formula,a)}else if(e.widgetType===H.Map){var S=e;t.coordinate=P.evaluateExpression(S.coordinate.formula,a)}return t}function x(e,t,r){var n=e.content.map(function(e){return W(e,t,r)});return{container:e,content:n,styles:e.styles}}e.AjfAggregationSerializer=m,e.AjfAggregationType=F,e.AjfBaseWidgetComponent=r,e.AjfChartType=a,e.AjfDatasetSerializer=y,e.AjfReportContainerSerializer=w,e.AjfReportRenderer=o,e.AjfReportSerializer=j,e.AjfReportWidget=E,e.AjfReportsModule=c,e.AjfWidgetHost=u,e.AjfWidgetSerializer=b,e.AjfWidgetType=H,e.chartToChartJsType=z,e.createAggregation=p,e.createReportInstance=function(e,t,r){return(e.variables||[]).forEach(function(e){t[e.name]=P.evaluateExpression(e.formula.formula,t)}),{report:e,header:e.header?x(e.header,t,r):void 0,content:e.content?x(e.content,t,r):void 0,footer:e.footer?x(e.footer,t,r):void 0,styles:e.styles||{}}},e.createWidget=v,e.createWidgetInstance=N,e.widgetToWidgetInstance=W,e.ɵa=s,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-reports.umd.min.js.map
