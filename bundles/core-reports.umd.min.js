/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@ajf/core/models"),require("@ajf/core/image"),require("@ajf/core/utils")):"function"==typeof define&&define.amd?define("@ajf/core/reports",["exports","@angular/core","@ajf/core/models","@ajf/core/image","@ajf/core/utils"],t):t(((e=e||self).ajf=e.ajf||{},e.ajf.core=e.ajf.core||{},e.ajf.core.reports={}),e.ng.core,e.ajf.core.models,e.ajf.core.image,e.ajf.core.utils)}(this,function(e,t,E,r,C){"use strict";var O=function(){return(O=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},n={Line:0,Bar:1,HorizontalBar:2,Radar:3,Scatter:4,Doughnut:5,Pie:6,PolarArea:7,Bubble:8,LENGTH:9};function J(e){switch(e){case n.Line:return"line";case n.Bar:return"bar";case n.HorizontalBar:return"horizontalBar";case n.Radar:return"radar";case n.Scatter:return"scatter";case n.Doughnut:return"doughnut";case n.Pie:return"pie";case n.PolarArea:return"polarArea";case n.Bubble:return"bubble";default:return"line"}}n[n.Line]="Line",n[n.Bar]="Bar",n[n.HorizontalBar]="HorizontalBar",n[n.Radar]="Radar",n[n.Scatter]="Scatter",n[n.Doughnut]="Doughnut",n[n.Pie]="Pie",n[n.PolarArea]="PolarArea",n[n.Bubble]="Bubble",n[n.LENGTH]="LENGTH";var S={None:0,Sum:1,Average:2,WeightedAverage:3,LENGTH:4};S[S.None]="None",S[S.Sum]="Sum",S[S.Average]="Average",S[S.WeightedAverage]="WeightedAverage",S[S.LENGTH]="LENGTH";var L={Layout:0,PageBreak:1,Image:2,Text:3,Chart:4,Table:5,Map:6,Column:7,Formula:8,ImageContainer:9,LENGTH:10};L[L.Layout]="Layout",L[L.PageBreak]="PageBreak",L[L.Image]="Image",L[L.Text]="Text",L[L.Chart]="Chart",L[L.Table]="Table",L[L.Map]="Map",L[L.Column]="Column",L[L.Formula]="Formula",L[L.ImageContainer]="ImageContainer",L[L.LENGTH]="LENGTH";var a=(Object.defineProperty(o.prototype,"reportInstance",{get:function(){return this._reportInstance},set:function(e){this._reportInstance=e,this._report=null!=e?e.report:null,this._cdr.markForCheck()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"report",{get:function(){return this._report},enumerable:!0,configurable:!0}),o);function o(e){this._cdr=e}var i=(u.prototype.transform=function(e,t){return 0<=t&&t<e.content.length?e.content[t]:null},u.decorators=[{type:t.Pipe,args:[{name:"ajfGetColumnContent"}]}],u);function u(){}var l=(s.decorators=[{type:t.NgModule,args:[{declarations:[i],exports:[i]}]}],s);function s(){}function f(e){return O({},e,{aggregation:e.aggregation||S.None})}var c=(g.fromJson=function(e){if(null==e.aggregation)throw new Error("Malformed aggregation");return f(O({},e,{aggregation:e.aggregation}))},g);function g(){}var p=(d.fromJson=function(e){if(null==e.formula||null==e.aggregation||null==e.label)throw new Error("Malformed dataset");return e.formula=e.formula instanceof Array?e.formula=e.formula.map(function(e){return E.AjfFormulaSerializer.fromJson(e)}):E.AjfFormulaSerializer.fromJson(e.formula),e.aggregation=c.fromJson(e.aggregation),function(e){return O({},e,{aggregation:e.aggregation||f({aggregation:S.None})})}(e)},d);function d(){}function m(e){return O({},e,{styles:e.styles||{},visibility:e.visibility||E.alwaysCondition()})}var y=(b.fromJson=function(e){if(null==e.widgetType)throw new Error("Malformed widget");e.visibility=e.visibility?E.AjfConditionSerializer.fromJson(e.visibility):E.alwaysCondition(),e.styles=e.styles||{};var t=e;if(t.widgetType===L.Layout||t.widgetType===L.Column)return b._widgetWithContentFromJson(t);if(t.widgetType===L.Chart||t.widgetType===L.Table){var r=b._dataWidgetFromJson(t);if(t.widgetType===L.Chart){var n=r;n.labels instanceof Array?n.labels.map(function(e){return E.AjfFormulaSerializer.fromJson(e)}):null!=n.labels&&(n.labels=E.AjfFormulaSerializer.fromJson(n.labels))}return r}if(t.widgetType===L.Map){var a=t;a.coordinate=E.AjfFormulaSerializer.fromJson(a.coordinate)}return t},b._dataWidgetFromJson=function(e){var t=e.dataset?e.widgetType===L.Table?e.dataset.map(function(e){return e.map(function(e){return p.fromJson(e)})}):e.dataset.map(function(e){return p.fromJson(e)}):[];return O({},m(e),{dataset:t})},b._widgetWithContentFromJson=function(e){var t=(e.content||[]).map(function(e){return b.fromJson(e)});return O({},m(e),{content:t})},b);function b(){}var h=(v.fromJson=function(e){return e.content=(e.content||[]).map(function(e){return y.fromJson(e)}),O({},e,{content:e.content,styles:e.styles||{}})},v);function v(){}var w=(j.fromJson=function(t){return["header","footer","content"].forEach(function(e){t[e]&&(t[e]=h.fromJson(t[e]))}),function(e){return O({},e)}(t)},j);function j(){}var T=(Object.defineProperty(A.prototype,"widget",{get:function(){return this._widget},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"imageTypes",{get:function(){return this._imageTypes},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"widgetInstance",{get:function(){return this._widgetInstance},set:function(e){this._widgetInstance!==e&&(this._widgetInstance=e,this._widget=null!=this._widgetInstance?this._widgetInstance.widget:null,this._cdr.markForCheck())},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"columnInst",{get:function(){return this._widgetInstance},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"imgwInst",{get:function(){return this._widgetInstance},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"imgw",{get:function(){return this._widget},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"imgcwInst",{get:function(){return this._widgetInstance},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"imgcw",{get:function(){return this._widget},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"layoutwInst",{get:function(){return this._widgetInstance},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"layoutw",{get:function(){return this._widget},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"chartwInst",{get:function(){return this._widgetInstance},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"chartw",{get:function(){return this._widget},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"tablewInst",{get:function(){return this._widgetInstance},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"textwInst",{get:function(){return this._widgetInstance},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"mapwInst",{get:function(){return this._widgetInstance},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"mapw",{get:function(){return this._widget},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"formulawInst",{get:function(){return this._widgetInstance},enumerable:!0,configurable:!0}),A);function A(e){this._cdr=e,this.widgetTypes=L,this._imageTypes=r.AjfImageType}function z(e,n,a){var t=function(e,t){return{widget:e,widgetType:e.widgetType,visible:E.evaluateExpression(e.visibility.condition,t),styles:e.styles||{}}}(e,n);if(e.widgetType===L.Column||e.widgetType===L.Layout){var r=e;t.content=r.content.map(function(e){return z(e,n,a)})}else if(e.widgetType===L.Chart){var o=e,i=t,u=o.labels instanceof Array?o.labels:[o.labels];i.labels=u.map(function(e){var t=E.evaluateExpression(e.formula,n);try{t=t instanceof Array?t.map(function(e){return a.instant(e)}):a.instant(t)}catch(e){}return t}),i.dataset=o.dataset.map(function(e){var t=O({},e.options||{},{data:function(e,t,r){var n=t.map(function(e){return E.evaluateExpression(e.formula,r)});switch(e.aggregation){case S.None:if(1!==n.length)throw new Error("Invalid aggregation");return n[0];case S.Sum:return n.map(function(e){return e.reduce(function(e,t){return e+t},0)});case S.Average:case S.WeightedAverage:return n.map(function(e){return e.reduce(function(e,t){return e+t},0)/n.length});default:return[]}}(e.aggregation,e.formula,n)});if(null!=e.chartType){var r=J(e.chartType);t=O({},t,{chartType:r,type:r})}return null!=e.options&&(t=O({},t,{options:e.options})),null!=e.label&&(t=O({},t,{label:e.label})),null!=e.datalabels&&(t.datalabels=C.deepCopy(e.datalabels)),t}),i.data={labels:i.labels,datasets:i.datasets}}else if(e.widgetType===L.Table){var l=e,s=t,f=function(e){var t=e.formula;if('"'===t.substr(0,1)){var r=t.slice(1,-1);0<r.length&&(t='"'+a.instant(r)+'"')}else t=a.instant(t);return E.evaluateExpression(t,n)};s.dataset=l.dataset.map(function(e){return e.map(function(e){return e.formula instanceof Array?e.formula.map(function(e){return f(e)}):f(e.formula)})}),s.data=(l.dataset||[]).map(function(e){return e.map(function(e){return{value:E.evaluateExpression(e.formula.formula,n),style:O({},l.cellStyles,e.style),rowspan:e.rowspan,colspan:e.colspan}})})}else if(e.widgetType===L.Image){var c=e,g=t;c.flag&&(g.flag=E.evaluateExpression(c.flag.formula,n)),c.icon&&(g.icon=E.evaluateExpression(c.icon.formula,n)),c.url&&(g.url=E.evaluateExpression(c.url.formula,n))}else if(e.widgetType===L.ImageContainer){var p=e,d=t;if(p.flags){var m=p.flags instanceof Array?p.flags:[p.flags];d.flags=m.map(function(e){return E.evaluateExpression(e.formula,n)})}if(p.icons){var y=p.icons instanceof Array?p.icons:[p.icons];d.icons=y.map(function(e){return E.evaluateExpression(e.formula,n)})}if(p.urls){var b=p.urls instanceof Array?p.urls:[p.urls];d.urls=b.map(function(e){return E.evaluateExpression(e.formula,n)})}}else if(e.widgetType===L.Text){for(var h=t,v=/\[\[(.+?)\]\]/g,w=[],j=void 0,T=e.htmlText;j=v.exec(T);){var A=j.index,I=j[0].length,_=E.createFormula({formula:j[1]});w.push({idx:A,len:I,formula:_}),w.reverse().forEach(function(e){var t;try{t=E.evaluateExpression(e.formula.formula,n)}catch(e){t=""}T=""+T.substr(0,e.idx)+t+T.substr(e.idx+e.len)})}h.htmlText=a.instant(T)}else if(e.widgetType===L.Formula){var P=e;t.formula=E.evaluateExpression(P.formula.formula,n)}else if(e.widgetType===L.Map){var x=e;t.coordinate=E.evaluateExpression(x.coordinate.formula,n)}return t}function I(e,t,r){var n=e.content.map(function(e){return z(e,t,r)});return{container:e,content:n,styles:e.styles}}e.AjfAggregationSerializer=c,e.AjfAggregationType=S,e.AjfChartType=n,e.AjfDatasetSerializer=p,e.AjfReportContainerSerializer=h,e.AjfReportRenderer=a,e.AjfReportSerializer=w,e.AjfReportsModule=l,e.AjfWidgetRenderer=T,e.AjfWidgetSerializer=y,e.AjfWidgetType=L,e.chartToChartJsType=J,e.createAggregation=f,e.createReportInstance=function(e,t,r){return{report:e,header:e.header?I(e.header,t,r):void 0,content:e.content?I(e.content,t,r):void 0,footer:e.footer?I(e.footer,t,r):void 0,styles:e.styles||{}}},e.createWidget=m,e.ɵa=i,e.ɵb=I,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-reports.umd.min.js.map
