/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { AjfFieldType } from '../interface/fields/field-type';
import { AjfNodeType } from '../interface/nodes/node-type';
import { evaluateExpression } from '@ajf/core/models';
import { createPdf } from 'pdfmake/build/pdfmake';
import { vfsFonts } from './vfs-fonts';
const fontsMap = {
    Roboto: {
        normal: 'roboto-all-400-normal.woff',
        bold: 'roboto-all-500-normal.woff',
        italics: 'roboto-all-400-italic.woff',
        bolditalics: 'roboto-all-500-italic.woff'
    },
};
export function createFormPdf(form, translate, orientation, header, context) {
    const t = translate ? translate : (s) => s;
    const pdfDef = formToPdf(form, t, orientation, header, context);
    return createPdf(pdfDef, undefined, fontsMap, vfsFonts);
}
function stripHTML(s) {
    return s.replace(/<\/?[^>]+(>|$)/g, '');
}
// Given a context, lookupStringFunction returns a function that allows to retrieve
// the field values from the context. The values are returned as print-friendly strings.
// rep is the index of the repeating slide, if the field belongs to one.
function lookupStringFunction(context, rep) {
    if (context == null) {
        return (_) => ' ';
    }
    return (name) => {
        if (name == null) {
            return ' ';
        }
        if (rep != null) {
            name = name + '__' + rep;
        }
        const val = context[name];
        if (val == null) {
            return ' ';
        }
        if (val === true) {
            return 'yes';
        }
        if (val === false) {
            return 'no';
        }
        return String(val);
    };
}
// Analogous to lookupStringFunction, but for multiple-choice questions,
// returning an array of values.
function lookupArrayFunction(context, rep) {
    if (context == null) {
        return (_) => [];
    }
    return (name) => {
        if (name == null) {
            return [];
        }
        if (rep != null) {
            name = name + '__' + rep;
        }
        const val = context[name];
        if (Array.isArray(val)) {
            return val;
        }
        return [];
    };
}
// Given an AjfForm, returns its pdfmake pdf document definition.
function formToPdf(form, translate, orientation, header, context) {
    const choicesMap = {};
    for (const o of form.choicesOrigins) {
        choicesMap[o.name] = o.choices;
    }
    const content = header ? [...header] : [];
    for (const slide of form.nodes) {
        if (slide.nodeType === AjfNodeType.AjfSlide) {
            content.push(...slideToPdf(slide, choicesMap, translate, context));
        }
        else if (slide.nodeType === AjfNodeType.AjfRepeatingSlide) {
            content.push(...repeatingSlideToPdf(slide, choicesMap, translate, context));
        }
    }
    return { content, pageOrientation: orientation };
}
function slideToPdf(slide, choicesMap, translate, context, rep) {
    let label = translate(slide.label);
    if (rep != null) {
        label = `${label} (${translate('repeat')} ${rep})`;
    }
    const content = [{ text: label, fontSize: 18, bold: true, margin: [0, 15, 0, 10] }];
    for (const field of slide.nodes) {
        content.push(...fieldToPdf(field, choicesMap, translate, context, rep));
    }
    return content;
}
function repeatingSlideToPdf(slide, choicesMap, translate, context) {
    let repeats = 3; // default, if no formData
    const maxRepeats = 20;
    if (context != null && slide.name != null) {
        const r = context[slide.name];
        if (typeof (r) === 'number') {
            repeats = Math.min(r, maxRepeats);
        }
    }
    const content = [];
    for (let r = 0; r < repeats; r++) {
        content.push(...slideToPdf(slide, choicesMap, translate, context, r));
    }
    return content;
}
function borderlessCell(text, bold) {
    return { table: { body: [[{ text, bold, border: [false, false, false, false] }]] } };
}
function fieldToPdf(field, choicesMap, translate, context, rep) {
    if (field.nodeType !== AjfNodeType.AjfField) {
        throw new Error('not a field');
    }
    const visible = context == null /* form not compiled, show all fields */ ||
        field.visibility == null ||
        evaluateExpression(field.visibility.condition, context);
    if (!visible) {
        return [];
    }
    const lookupString = lookupStringFunction(context, rep);
    switch (field.fieldType) {
        case AjfFieldType.String:
        case AjfFieldType.Text:
            return [
                borderlessCell(translate(field.label)),
                { table: { widths: ['*'], body: [[lookupString(field.name)]] }, margin: [5, 0, 0, 5] }
            ];
        case AjfFieldType.Formula:
            const formula = field.formula.formula;
            const value = evaluateExpression(formula, context);
            return [
                borderlessCell(translate(field.label)),
                { table: { widths: ['*'], body: [[String(value)]] }, margin: [5, 0, 0, 5] }
            ];
        case AjfFieldType.Number:
        case AjfFieldType.Boolean:
        case AjfFieldType.DateInput:
        case AjfFieldType.Time:
            let val = lookupString(field.name);
            // for boolean fields in compiled forms, a null value is printed as 'no':
            if (field.fieldType === AjfFieldType.Boolean && context != null && val === ' ') {
                val = 'no';
            }
            return [{
                    table: {
                        widths: ['*', '*'],
                        body: [[{ text: translate(field.label), border: [false, false, false, false] }, val]]
                    }
                }];
        case AjfFieldType.SingleChoice:
        case AjfFieldType.MultipleChoice:
            const choices = choicesMap[field.choicesOriginRef];
            if (context == null) { // empty form
                return choiceToPdf(field, choices, translate);
            }
            // compiled form, only print choices that are selected
            const selectedValues = (field.fieldType === AjfFieldType.SingleChoice) ?
                [lookupString(field.name)] :
                lookupArrayFunction(context, rep)(field.name);
            const selectedChoices = selectedValues.map(v => choices.find(c => c.value === v))
                .filter(c => c);
            return choiceToPdf(field, selectedChoices, translate, context);
        case AjfFieldType.Empty:
            const text = stripHTML(translate(field.HTML));
            return [borderlessCell(text, true)];
        case AjfFieldType.Table:
            return tableToPdf(field, lookupString, translate);
        default: // yet unsupported field type
            return [];
    }
}
function choiceToPdf(field, choices, translate, context) {
    let choiceLabels;
    if (choices == null || choices.length === 0) {
        choiceLabels = [' '];
    }
    else {
        choiceLabels = choices.map(c => c.label);
    }
    const body = [];
    for (const c of choiceLabels) {
        body.push([translate(c)]);
    }
    let question = translate(field.label);
    // If the form is empty (to be compiled),
    // help the user distinguish between single- and multiple-choice questions:
    if (context == null && field.fieldType === AjfFieldType.SingleChoice) {
        question += ` (${translate('single choice')})`;
    }
    if (context == null && field.fieldType === AjfFieldType.MultipleChoice) {
        question += ` (${translate('multipe choice')})`;
    }
    return [{
            columns: [
                borderlessCell(question), {
                    table: { widths: ['*'], body },
                }
            ],
            margin: [0, 0, 0, 5]
        }];
}
function tableToPdf(table, lookupString, translate) {
    const body = [['', ...table.columnLabels.map(translate)]];
    for (let i = 0; i < table.rows.length; i++) {
        const row = [...table.rows[i]];
        for (let j = 0; j < row.length; j++) {
            if (typeof (row[j]) !== 'string') {
                row[j] = row[j].formula;
            }
        }
        const valsRow = row.map(lookupString).map(translate);
        body.push([translate(table.rowLabels[i]), ...valsRow]);
    }
    return [
        borderlessCell(translate(table.label)),
        { table: { body, widths: Array(table.columnLabels.length + 1).fill('*') }, margin: [5, 0, 0, 5] }
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS10by1wZGYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9mb3Jtcy9mb3JtLXRvLXBkZi9mb3JtLXRvLXBkZi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7QUFLSCxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFHNUQsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLDhCQUE4QixDQUFDO0FBS3pELE9BQU8sRUFBeUIsa0JBQWtCLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUc1RSxPQUFPLEVBQUMsU0FBUyxFQUFjLE1BQU0sdUJBQXVCLENBQUM7QUFDN0QsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUVyQyxNQUFNLFFBQVEsR0FBRztJQUNmLE1BQU0sRUFBRTtRQUNOLE1BQU0sRUFBRSw0QkFBNEI7UUFDcEMsSUFBSSxFQUFFLDRCQUE0QjtRQUNsQyxPQUFPLEVBQUUsNEJBQTRCO1FBQ3JDLFdBQVcsRUFBRSw0QkFBNEI7S0FDMUM7Q0FDRixDQUFDO0FBRUYsTUFBTSxVQUFVLGFBQWEsQ0FDM0IsSUFBYSxFQUFFLFNBQWlDLEVBQUUsV0FBNkIsRUFDL0UsTUFBa0IsRUFBRSxPQUFvQjtJQUV4QyxNQUFNLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNuRCxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2hFLE9BQU8sU0FBUyxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQzFELENBQUM7QUFPRCxTQUFTLFNBQVMsQ0FBQyxDQUFT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QUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ25DLElBQUksT0FBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsRUFBRTtnQkFDL0IsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFJLEdBQUcsQ0FBQyxDQUFDLENBQWtCLENBQUMsT0FBTyxDQUFDO2FBQzNDO1NBQ0Y7UUFDRCxNQUFNLE9BQU8sR0FBSSxHQUFnQixDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDO0tBQ3hEO0lBQ0QsT0FBTztRQUNMLGNBQWMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLEVBQUMsS0FBSyxFQUFFLEVBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUM7S0FDOUYsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKEMpIEdudWNvb3Agc29jLiBjb29wLlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yXG4gKiBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXNcbiAqIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLFxuICogb3IgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIEdOVSBBZmZlcm9cbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGFsb25nIHdpdGggQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqIElmIG5vdCwgc2VlIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8uXG4gKlxuICovXG5cbmltcG9ydCB7QWpmQ2hvaWNlfSBmcm9tICcuLi9pbnRlcmZhY2UvY2hvaWNlcy9jaG9pY2UnO1xuaW1wb3J0IHtBamZFbXB0eUZpZWxkfSBmcm9tICcuLi9pbnRlcmZhY2UvZmllbGRzL2VtcHR5LWZpZWxkJztcbmltcG9ydCB7QWpmRmllbGR9IGZyb20gJy4uL2ludGVyZmFjZS9maWVsZHMvZmllbGQnO1xuaW1wb3J0IHtBamZGaWVsZFR5cGV9IGZyb20gJy4uL2ludGVyZmFjZS9maWVsZHMvZmllbGQtdHlwZSc7XG5pbXBvcnQge0FqZkZvcm19IGZyb20gJy4uL2ludGVyZmFjZS9mb3Jtcy9mb3JtJztcbmltcG9ydCB7QWpmRm9ybXVsYUZpZWxkfSBmcm9tICcuLi9pbnRlcmZhY2UvZmllbGRzL2Zvcm11bGEtZmllbGQnO1xuaW1wb3J0IHtBamZOb2RlVHlwZX0gZnJvbSAnLi4vaW50ZXJmYWNlL25vZGVzL25vZGUtdHlwZSc7XG5pbXBvcnQge0FqZlJlcGVhdGluZ1NsaWRlfSBmcm9tICcuLi9pbnRlcmZhY2Uvc2xpZGVzL3JlcGVhdGluZy1zbGlkZSc7XG5pbXBvcnQge0FqZlNsaWRlfSBmcm9tICcuLi9pbnRlcmZhY2Uvc2xpZGVzL3NsaWRlJztcbmltcG9ydCB7QWpmVGFibGVDZWxsLCBBamZUYWJsZUZpZWxkfSBmcm9tICcuLi9pbnRlcmZhY2UvZmllbGRzL3RhYmxlLWZpZWxkJztcblxuaW1wb3J0IHtBamZDb250ZXh0LCBBamZGb3JtdWxhLCBldmFsdWF0ZUV4cHJlc3Npb259IGZyb20gJ0BhamYvY29yZS9tb2RlbHMnO1xuXG5pbXBvcnQge0NvbnRlbnQsIFBhZ2VPcmllbnRhdGlvbiwgVERvY3VtZW50RGVmaW5pdGlvbnN9IGZyb20gJ3BkZm1ha2UvaW50ZXJmYWNlcyc7XG5pbXBvcnQge2NyZWF0ZVBkZiwgVENyZWF0ZWRQZGZ9IGZyb20gJ3BkZm1ha2UvYnVpbGQvcGRmbWFrZSc7XG5pbXBvcnQge3Zmc0ZvbnRzfSBmcm9tICcuL3Zmcy1mb250cyc7XG5cbmNvbnN0IGZvbnRzTWFwID0ge1xuICBSb2JvdG86IHtcbiAgICBub3JtYWw6ICdyb2JvdG8tYWxsLTQwMC1ub3JtYWwud29mZicsXG4gICAgYm9sZDogJ3JvYm90by1hbGwtNTAwLW5vcm1hbC53b2ZmJyxcbiAgICBpdGFsaWNzOiAncm9ib3RvLWFsbC00MDAtaXRhbGljLndvZmYnLFxuICAgIGJvbGRpdGFsaWNzOiAncm9ib3RvLWFsbC01MDAtaXRhbGljLndvZmYnXG4gIH0sXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRm9ybVBkZihcbiAgZm9ybTogQWpmRm9ybSwgdHJhbnNsYXRlPzogKHM6IHN0cmluZykgPT4gc3RyaW5nLCBvcmllbnRhdGlvbj86IFBhZ2VPcmllbnRhdGlvbixcbiAgaGVhZGVyPzogQ29udGVudFtdLCBjb250ZXh0PzogQWpmQ29udGV4dCk6IFRDcmVhdGVkUGRmIHtcblxuICBjb25zdCB0ID0gdHJhbnNsYXRlID8gdHJhbnNsYXRlIDogKHM6IHN0cmluZykgPT4gcztcbiAgY29uc3QgcGRmRGVmID0gZm9ybVRvUGRmKGZvcm0sIHQsIG9yaWVudGF0aW9uLCBoZWFkZXIsIGNvbnRleHQpO1xuICByZXR1cm4gY3JlYXRlUGRmKHBkZkRlZiwgdW5kZWZpbmVkLCBmb250c01hcCwgdmZzRm9udHMpO1xufVxuXG4vLyBDaG9pY2VzTWFwIG1hcHMgYSBjaG9pY2VzT3JpZ2luUmVmIHRvIHRoZSBsaXN0IHRoZSBjaG9pY2VzLlxuaW50ZXJmYWNlIENob2ljZXNNYXAge1xuICBbbmFtZTogc3RyaW5nXTogQWpmQ2hvaWNlPGFueT5bXTtcbn1cblxuZnVuY3Rpb24gc3RyaXBIVE1MKHM6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBzLnJlcGxhY2UoLzxcXC8/W14+XSsoPnwkKS9nLCAnJyk7XG59XG5cbi8vIEdpdmVuIGEgY29udGV4dCwgbG9va3VwU3RyaW5nRnVuY3Rpb24gcmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgYWxsb3dzIHRvIHJldHJpZXZlXG4vLyB0aGUgZmllbGQgdmFsdWVzIGZyb20gdGhlIGNvbnRleHQuIFRoZSB2YWx1ZXMgYXJlIHJldHVybmVkIGFzIHByaW50LWZyaWVuZGx5IHN0cmluZ3MuXG4vLyByZXAgaXMgdGhlIGluZGV4IG9mIHRoZSByZXBlYXRpbmcgc2xpZGUsIGlmIHRoZSBmaWVsZCBiZWxvbmdzIHRvIG9uZS5cbmZ1bmN0aW9uIGxvb2t1cFN0cmluZ0Z1bmN0aW9uKGNvbnRleHQ/OiBBamZDb250ZXh0LCByZXA/OiBudW1iZXIpOiAobmFtZTogc3RyaW5nKSA9PiBzdHJpbmcge1xuICBpZiAoY29udGV4dCA9PSBudWxsKSB7XG4gICAgcmV0dXJuIChfOiBzdHJpbmcpID0+ICcgJztcbiAgfVxuICByZXR1cm4gKG5hbWU6IHN0cmluZykgPT4ge1xuICAgIGlmIChuYW1lID09IG51bGwpIHtcbiAgICAgIHJldHVybiAnICc7XG4gICAgfVxuICAgIGlmIChyZXAgIT0gbnVsbCkge1xuICAgICAgbmFtZSA9IG5hbWUgKyAnX18nICsgcmVwO1xuICAgIH1cbiAgICBjb25zdCB2YWwgPSBjb250ZXh0W25hbWVdO1xuICAgIGlmICh2YWwgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuICcgJztcbiAgICB9XG4gICAgaWYgKHZhbCA9PT0gdHJ1ZSkge1xuICAgICAgcmV0dXJuICd5ZXMnO1xuICAgIH1cbiAgICBpZiAodmFsID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuICdubyc7XG4gICAgfVxuICAgIHJldHVybiBTdHJpbmcodmFsKTtcbiAgfTtcbn1cblxuLy8gQW5hbG9nb3VzIHRvIGxvb2t1cFN0cmluZ0Z1bmN0aW9uLCBidXQgZm9yIG11bHRpcGxlLWNob2ljZSBxdWVzdGlvbnMsXG4vLyByZXR1cm5pbmcgYW4gYXJyYXkgb2YgdmFsdWVzLlxuZnVuY3Rpb24gbG9va3VwQXJyYXlGdW5jdGlvbihjb250ZXh0PzogQWpmQ29udGV4dCwgcmVwPzogbnVtYmVyKTogKG5hbWU6IHN0cmluZykgPT4gc3RyaW5nW10ge1xuICBpZiAoY29udGV4dCA9PSBudWxsKSB7XG4gICAgcmV0dXJuIChfOiBzdHJpbmcpID0+IFtdO1xuICB9XG4gIHJldHVybiAobmFtZTogc3RyaW5nKSA9PiB7XG4gICAgaWYgKG5hbWUgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBpZiAocmVwICE9IG51bGwpIHtcbiAgICAgIG5hbWUgPSBuYW1lICsgJ19fJyArIHJlcDtcbiAgICB9XG4gICAgY29uc3QgdmFsID0gY29udGV4dFtuYW1lXTtcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7XG4gICAgICByZXR1cm4gdmFsO1xuICAgIH1cbiAgICByZXR1cm4gW107XG4gIH07XG59XG5cbi8vIEdpdmVuIGFuIEFqZkZvcm0sIHJldHVybnMgaXRzIHBkZm1ha2UgcGRmIGRvY3VtZW50IGRlZmluaXRpb24uXG5mdW5jdGlvbiBmb3JtVG9QZGYoXG4gIGZvcm06IEFqZkZvcm0sIHRyYW5zbGF0ZTogKHM6IHN0cmluZykgPT4gc3RyaW5nLCBvcmllbnRhdGlvbj86IFBhZ2VPcmllbnRhdGlvbixcbiAgaGVhZGVyPzogQ29udGVudFtdLCBjb250ZXh0PzogQWpmQ29udGV4dCk6IFREb2N1bWVudERlZmluaXRpb25zIHtcblxuICBjb25zdCBjaG9pY2VzTWFwOiBDaG9pY2VzTWFwID0ge307XG4gIGZvciAoY29uc3QgbyBvZiBmb3JtLmNob2ljZXNPcmlnaW5zKSB7XG4gICAgY2hvaWNlc01hcFtvLm5hbWVdID0gby5jaG9pY2VzO1xuICB9XG5cbiAgY29uc3QgY29udGVudCA9IGhlYWRlciA/IFsuLi5oZWFkZXJdIDogW107XG4gIGZvciAoY29uc3Qgc2xpZGUgb2YgZm9ybS5ub2Rlcykge1xuICAgIGlmIChzbGlkZS5ub2RlVHlwZSA9PT0gQWpmTm9kZVR5cGUuQWpmU2xpZGUpIHtcbiAgICAgIGNvbnRlbnQucHVzaCguLi5zbGlkZVRvUGRmKHNsaWRlIGFzIEFqZlNsaWRlLCBjaG9pY2VzTWFwLCB0cmFuc2xhdGUsIGNvbnRleHQpKTtcbiAgICB9IGVsc2UgaWYgKHNsaWRlLm5vZGVUeXBlID09PSBBamZOb2RlVHlwZS5BamZSZXBlYXRpbmdTbGlkZSkge1xuICAgICAgY29udGVudC5wdXNoKFxuICAgICAgICAuLi5yZXBlYXRpbmdTbGlkZVRvUGRmKHNsaWRlIGFzIEFqZlJlcGVhdGluZ1NsaWRlLCBjaG9pY2VzTWFwLCB0cmFuc2xhdGUsIGNvbnRleHQpXG4gICAgICApO1xuICAgIH1cbiAgfVxuICByZXR1cm4ge2NvbnRlbnQsIHBhZ2VPcmllbnRhdGlvbjogb3JpZW50YXRpb259O1xufVxuXG5mdW5jdGlvbiBzbGlkZVRvUGRmKFxuICBzbGlkZTogQWpmU2xpZGUgfCBBamZSZXBlYXRpbmdTbGlkZSwgY2hvaWNlc01hcDogQ2hvaWNlc01hcCxcbiAgdHJhbnNsYXRlOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsIGNvbnRleHQ/OiBBamZDb250ZXh0LCByZXA/OiBudW1iZXIpOiBDb250ZW50W10ge1xuXG4gIGxldCBsYWJlbCA9IHRyYW5zbGF0ZShzbGlkZS5sYWJlbCk7XG4gIGlmIChyZXAgIT0gbnVsbCkge1xuICAgIGxhYmVsID0gYCR7bGFiZWx9ICgke3RyYW5zbGF0ZSgncmVwZWF0Jyl9ICR7cmVwfSlgO1xuICB9XG4gIGNvbnN0IGNvbnRlbnQ6IENvbnRlbnRbXSA9XG4gICAgW3t0ZXh0OiBsYWJlbCwgZm9udFNpemU6IDE4LCBib2xkOiB0cnVlLCBtYXJnaW46IFswLCAxNSwgMCwgMTBdfV07XG4gIGZvciAoY29uc3QgZmllbGQgb2YgKHNsaWRlLm5vZGVzIGFzIEFqZkZpZWxkW10pKSB7XG4gICAgY29udGVudC5wdXNoKC4uLmZpZWxkVG9QZGYoZmllbGQsIGNob2ljZXNNYXAsIHRyYW5zbGF0ZSwgY29udGV4dCwgcmVwKSk7XG4gIH1cbiAgcmV0dXJuIGNvbnRlbnQ7XG59XG5cbmZ1bmN0aW9uIHJlcGVhdGluZ1NsaWRlVG9QZGYoXG4gIHNsaWRlOiBBamZSZXBlYXRpbmdTbGlkZSwgY2hvaWNlc01hcDogQ2hvaWNlc01hcCwgdHJhbnNsYXRlOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4gIGNvbnRleHQ/OiBBamZDb250ZXh0KTogQ29udGVudFtdIHtcblxuICBsZXQgcmVwZWF0cyA9IDM7ICAvLyBkZWZhdWx0LCBpZiBubyBmb3JtRGF0YVxuICBjb25zdCBtYXhSZXBlYXRzID0gMjA7XG4gIGlmIChjb250ZXh0ICE9IG51bGwgJiYgc2xpZGUubmFtZSAhPSBudWxsKSB7XG4gICAgY29uc3QgciA9IGNvbnRleHRbc2xpZGUubmFtZV07XG4gICAgaWYgKHR5cGVvZiAocikgPT09ICdudW1iZXInKSB7XG4gICAgICByZXBlYXRzID0gTWF0aC5taW4ociwgbWF4UmVwZWF0cyk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgY29udGVudCA9IFtdO1xuICBmb3IgKGxldCByID0gMDsgciA8IHJlcGVhdHM7IHIrKykge1xuICAgIGNvbnRlbnQucHVzaCguLi5zbGlkZVRvUGRmKHNsaWRlLCBjaG9pY2VzTWFwLCB0cmFuc2xhdGUsIGNvbnRleHQsIHIpKTtcbiAgfVxuICByZXR1cm4gY29udGVudDtcbn1cblxuZnVuY3Rpb24gYm9yZGVybGVzc0NlbGwodGV4dDogc3RyaW5nLCBib2xkPzogYm9vbGVhbik6IENvbnRlbnQge1xuICByZXR1cm4ge3RhYmxlOiB7Ym9keTogW1t7dGV4dCwgYm9sZCwgYm9yZGVyOiBbZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2VdfV1dfX07XG59XG5cbmZ1bmN0aW9uIGZpZWxkVG9QZGYoXG4gIGZpZWxkOiBBamZGaWVsZCwgY2hvaWNlc01hcDogQ2hvaWNlc01hcCwgdHJhbnNsYXRlOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4gIGNvbnRleHQ/OiBBamZDb250ZXh0LCByZXA/OiBudW1iZXIpOiBDb250ZW50W10ge1xuXG4gIGlmIChmaWVsZC5ub2RlVHlwZSAhPT0gQWpmTm9kZVR5cGUuQWpmRmllbGQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ25vdCBhIGZpZWxkJyk7XG4gIH1cblxuICBjb25zdCB2aXNpYmxlID1cbiAgICBjb250ZXh0ID09IG51bGwgLyogZm9ybSBub3QgY29tcGlsZWQsIHNob3cgYWxsIGZpZWxkcyAqLyB8fFxuICAgIGZpZWxkLnZpc2liaWxpdHkgPT0gbnVsbCB8fFxuICAgIGV2YWx1YXRlRXhwcmVzc2lvbihmaWVsZC52aXNpYmlsaXR5LmNvbmRpdGlvbiwgY29udGV4dCk7XG4gIGlmICghdmlzaWJsZSkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGNvbnN0IGxvb2t1cFN0cmluZyA9IGxvb2t1cFN0cmluZ0Z1bmN0aW9uKGNvbnRleHQsIHJlcCk7XG5cbiAgc3dpdGNoIChmaWVsZC5maWVsZFR5cGUpIHtcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5TdHJpbmc6XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuVGV4dDpcbiAgICAgIHJldHVybiBbXG4gICAgICAgIGJvcmRlcmxlc3NDZWxsKHRyYW5zbGF0ZShmaWVsZC5sYWJlbCkpLFxuICAgICAgICB7dGFibGU6IHt3aWR0aHM6IFsnKiddLCBib2R5OiBbW2xvb2t1cFN0cmluZyhmaWVsZC5uYW1lKV1dfSwgbWFyZ2luOiBbNSwgMCwgMCwgNV19XG4gICAgICBdO1xuICAgIGNhc2UgQWpmRmllbGRUeXBlLkZvcm11bGE6XG4gICAgICBjb25zdCBmb3JtdWxhID0gKChmaWVsZCBhcyBBamZGb3JtdWxhRmllbGQpLmZvcm11bGEgYXMgQWpmRm9ybXVsYSkuZm9ybXVsYTtcbiAgICAgIGNvbnN0IHZhbHVlID0gZXZhbHVhdGVFeHByZXNzaW9uKGZvcm11bGEsIGNvbnRleHQpO1xuICAgICAgcmV0dXJuIFtcbiAgICAgICAgYm9yZGVybGVzc0NlbGwodHJhbnNsYXRlKGZpZWxkLmxhYmVsKSksXG4gICAgICAgIHt0YWJsZToge3dpZHRoczogWycqJ10sIGJvZHk6IFtbU3RyaW5nKHZhbHVlKV1dfSwgbWFyZ2luOiBbNSwgMCwgMCwgNV19XG4gICAgICBdO1xuICAgIGNhc2UgQWpmRmllbGRUeXBlLk51bWJlcjpcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5Cb29sZWFuOlxuICAgIGNhc2UgQWpmRmllbGRUeXBlLkRhdGVJbnB1dDpcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5UaW1lOlxuICAgICAgbGV0IHZhbCA9IGxvb2t1cFN0cmluZyhmaWVsZC5uYW1lKTtcbiAgICAgIC8vIGZvciBib29sZWFuIGZpZWxkcyBpbiBjb21waWxlZCBmb3JtcywgYSBudWxsIHZhbHVlIGlzIHByaW50ZWQgYXMgJ25vJzpcbiAgICAgIGlmIChmaWVsZC5maWVsZFR5cGUgPT09IEFqZkZpZWxkVHlwZS5Cb29sZWFuICYmIGNvbnRleHQgIT0gbnVsbCAmJiB2YWwgPT09ICcgJykge1xuICAgICAgICB2YWwgPSAnbm8nO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFt7XG4gICAgICAgIHRhYmxlOiB7XG4gICAgICAgICAgd2lkdGhzOiBbJyonLCAnKiddLFxuICAgICAgICAgIGJvZHk6IFtbIHt0ZXh0OiB0cmFuc2xhdGUoZmllbGQubGFiZWwpLCBib3JkZXI6IFtmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZV19LCB2YWwgXV1cbiAgICAgICAgfVxuICAgICAgfV07XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuU2luZ2xlQ2hvaWNlOlxuICAgIGNhc2UgQWpmRmllbGRUeXBlLk11bHRpcGxlQ2hvaWNlOlxuICAgICAgY29uc3QgY2hvaWNlcyA9IGNob2ljZXNNYXBbKGZpZWxkIGFzIGFueSkuY2hvaWNlc09yaWdpblJlZl07XG4gICAgICBpZiAoY29udGV4dCA9PSBudWxsKSB7IC8vIGVtcHR5IGZvcm1cbiAgICAgICAgcmV0dXJuIGNob2ljZVRvUGRmKGZpZWxkLCBjaG9pY2VzLCB0cmFuc2xhdGUpO1xuICAgICAgfVxuICAgICAgLy8gY29tcGlsZWQgZm9ybSwgb25seSBwcmludCBjaG9pY2VzIHRoYXQgYXJlIHNlbGVjdGVkXG4gICAgICBjb25zdCBzZWxlY3RlZFZhbHVlcyA9IChmaWVsZC5maWVsZFR5cGUgPT09IEFqZkZpZWxkVHlwZS5TaW5nbGVDaG9pY2UpID9cbiAgICAgICAgW2xvb2t1cFN0cmluZyhmaWVsZC5uYW1lKV0gOlxuICAgICAgICBsb29rdXBBcnJheUZ1bmN0aW9uKGNvbnRleHQsIHJlcCkoZmllbGQubmFtZSk7XG4gICAgICBjb25zdCBzZWxlY3RlZENob2ljZXMgPSBzZWxlY3RlZFZhbHVlcy5tYXAodiA9PiBjaG9pY2VzLmZpbmQoYyA9PiBjLnZhbHVlID09PSB2KSlcbiAgICAgICAgLmZpbHRlcihjID0+IGMpIGFzIEFqZkNob2ljZTxhbnk+W107XG4gICAgICByZXR1cm4gY2hvaWNlVG9QZGYoZmllbGQsIHNlbGVjdGVkQ2hvaWNlcywgdHJhbnNsYXRlLCBjb250ZXh0KTtcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5FbXB0eTpcbiAgICAgIGNvbnN0IHRleHQgPSBzdHJpcEhUTUwodHJhbnNsYXRlKChmaWVsZCBhcyBBamZFbXB0eUZpZWxkKS5IVE1MKSk7XG4gICAgICByZXR1cm4gW2JvcmRlcmxlc3NDZWxsKHRleHQsIHRydWUpXTtcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5UYWJsZTpcbiAgICAgIHJldHVybiB0YWJsZVRvUGRmKGZpZWxkIGFzIEFqZlRhYmxlRmllbGQsIGxvb2t1cFN0cmluZywgdHJhbnNsYXRlKTtcbiAgICBkZWZhdWx0OiAgLy8geWV0IHVuc3VwcG9ydGVkIGZpZWxkIHR5cGVcbiAgICAgIHJldHVybiBbXTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjaG9pY2VUb1BkZihcbiAgZmllbGQ6IEFqZkZpZWxkLCBjaG9pY2VzOiBBamZDaG9pY2U8YW55PltdLCB0cmFuc2xhdGU6IChzOiBzdHJpbmcpID0+IHN0cmluZyxcbiAgY29udGV4dD86IEFqZkNvbnRleHQpOiBDb250ZW50W10ge1xuXG4gIGxldCBjaG9pY2VMYWJlbHM6IHN0cmluZ1tdO1xuICBpZiAoY2hvaWNlcyA9PSBudWxsIHx8IGNob2ljZXMubGVuZ3RoID09PSAwKSB7XG4gICAgY2hvaWNlTGFiZWxzID0gWycgJ107XG4gIH0gZWxzZSB7XG4gICAgY2hvaWNlTGFiZWxzID0gY2hvaWNlcy5tYXAoYyA9PiBjLmxhYmVsKTtcbiAgfVxuICBjb25zdCBib2R5ID0gW107XG4gIGZvciAoY29uc3QgYyBvZiBjaG9pY2VMYWJlbHMpIHtcbiAgICBib2R5LnB1c2goW3RyYW5zbGF0ZShjKV0pO1xuICB9XG4gIGxldCBxdWVzdGlvbiA9IHRyYW5zbGF0ZShmaWVsZC5sYWJlbCk7XG4gIC8vIElmIHRoZSBmb3JtIGlzIGVtcHR5ICh0byBiZSBjb21waWxlZCksXG4gIC8vIGhlbHAgdGhlIHVzZXIgZGlzdGluZ3Vpc2ggYmV0d2VlbiBzaW5nbGUtIGFuZCBtdWx0aXBsZS1jaG9pY2UgcXVlc3Rpb25zOlxuICBpZiAoY29udGV4dCA9PSBudWxsICYmIGZpZWxkLmZpZWxkVHlwZSA9PT0gQWpmRmllbGRUeXBlLlNpbmdsZUNob2ljZSkge1xuICAgIHF1ZXN0aW9uICs9IGAgKCR7dHJhbnNsYXRlKCdzaW5nbGUgY2hvaWNlJyl9KWA7XG4gIH1cbiAgaWYgKGNvbnRleHQgPT0gbnVsbCAmJiBmaWVsZC5maWVsZFR5cGUgPT09IEFqZkZpZWxkVHlwZS5NdWx0aXBsZUNob2ljZSkge1xuICAgIHF1ZXN0aW9uICs9IGAgKCR7dHJhbnNsYXRlKCdtdWx0aXBlIGNob2ljZScpfSlgO1xuICB9XG4gIHJldHVybiBbe1xuICAgIGNvbHVtbnM6IFtcbiAgICAgIGJvcmRlcmxlc3NDZWxsKHF1ZXN0aW9uKSwge1xuICAgICAgICB0YWJsZToge3dpZHRoczogWycqJ10sIGJvZHl9LFxuICAgICAgfVxuICAgIF0sXG4gICAgbWFyZ2luOiBbMCwgMCwgMCwgNV1cbiAgfV07XG59XG5cbmZ1bmN0aW9uIHRhYmxlVG9QZGYoXG4gIHRhYmxlOiBBamZUYWJsZUZpZWxkLCBsb29rdXBTdHJpbmc6IChzOiBzdHJpbmcpID0+IHN0cmluZyxcbiAgdHJhbnNsYXRlOiAoczogc3RyaW5nKSA9PiBzdHJpbmcpOiBDb250ZW50W10ge1xuXG4gIGNvbnN0IGJvZHk6IHN0cmluZ1tdW10gPSBbWycnLCAuLi50YWJsZS5jb2x1bW5MYWJlbHMubWFwKHRyYW5zbGF0ZSldXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YWJsZS5yb3dzLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3Qgcm93ID0gWy4uLnRhYmxlLnJvd3NbaV1dO1xuICAgIGZvciAobGV0IGogPSAwOyBqIDwgcm93Lmxlbmd0aDsgaisrKSB7XG4gICAgICBpZiAodHlwZW9mKHJvd1tqXSkgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJvd1tqXSA9IChyb3dbal0gYXMgQWpmVGFibGVDZWxsKS5mb3JtdWxhO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCB2YWxzUm93ID0gKHJvdyBhcyBzdHJpbmdbXSkubWFwKGxvb2t1cFN0cmluZykubWFwKHRyYW5zbGF0ZSk7XG4gICAgYm9keS5wdXNoKFt0cmFuc2xhdGUodGFibGUucm93TGFiZWxzW2ldKSwgLi4udmFsc1Jvd10pO1xuICB9XG4gIHJldHVybiBbXG4gICAgYm9yZGVybGVzc0NlbGwodHJhbnNsYXRlKHRhYmxlLmxhYmVsKSksXG4gICAge3RhYmxlOiB7Ym9keSwgd2lkdGhzOiBBcnJheSh0YWJsZS5jb2x1bW5MYWJlbHMubGVuZ3RoICsgMSkuZmlsbCgnKicpfSwgbWFyZ2luOiBbNSwgMCwgMCwgNV19XG4gIF07XG59XG4iXX0=