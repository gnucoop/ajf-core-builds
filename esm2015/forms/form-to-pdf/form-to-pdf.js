/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { AjfFieldType } from '../interface/fields/field-type';
import { AjfNodeType } from '../interface/nodes/node-type';
import { evaluateExpression } from '@ajf/core/models';
import { createPdf } from 'pdfmake/build/pdfmake';
import { vfsFonts } from './vfs-fonts';
const fontsMap = {
    Roboto: {
        normal: 'roboto-all-400-normal.woff',
        bold: 'roboto-all-500-normal.woff',
        italics: 'roboto-all-400-italic.woff',
        bolditalics: 'roboto-all-500-italic.woff'
    },
};
export function createFormPdf(formSchema, ts, formData) {
    const pdfDef = formToPdf(formSchema, ts, formData);
    return createPdf(pdfDef, undefined, fontsMap, vfsFonts);
}
function stripHTML(s) {
    return s.replace(/<\/?[^>]+(>|$)/g, '');
}
function translateFunction(ts) {
    if (ts == null) {
        return (s) => s;
    }
    return (s) => {
        if (s == null || s === '' || s === ' ') {
            return ' ';
        }
        return ts.instant(s);
    };
}
// Given a formData, lookupStringFunction returns a function that allows to retrieve
// the field values from the formData. The values are returned as print-friendly strings.
// rep is the index of the repeating slide, if the field belongs to one.
function lookupStringFunction(formData, rep) {
    if (formData == null || formData.data == null) {
        return (_) => ' ';
    }
    return (name) => {
        if (name == null) {
            return ' ';
        }
        if (rep != null) {
            name = name + '__' + rep;
        }
        const val = formData.data[name];
        if (val == null) {
            return ' ';
        }
        if (val === true) {
            return 'yes';
        }
        if (val === false) {
            return 'no';
        }
        return String(val);
    };
}
// Analogous to lookupStringFunction, but for multiple-choice questions,
// returning an array of values.
function lookupArrayFunction(formData, rep) {
    if (formData == null || formData.data == null) {
        return (_) => [];
    }
    return (name) => {
        if (name == null) {
            return [];
        }
        if (rep != null) {
            name = name + '__' + rep;
        }
        const val = formData.data[name];
        if (Array.isArray(val)) {
            return val;
        }
        return [];
    };
}
// Given an AjfForm, returns its pdfmake pdf document definition.
function formToPdf(formSchema, ts, formData) {
    const translate = translateFunction(ts);
    const name = translate(formSchema.name);
    const form = formSchema.schema;
    const choicesMap = {};
    for (const o of form.choicesOrigins) {
        choicesMap[o.name] = o.choices;
    }
    const content = [
        { text: name, fontSize: 22, bold: true, alignment: 'center', margin: [0, 0, 0, 10] }, {
            table: {
                widths: ['*', '*'],
                body: [[
                        translate('date start') + ': ' + (formData ? formData.date_start : ''),
                        translate('date end') + ': ' + (formData ? formData.date_end : ''),
                    ]]
            },
            layout: 'noBorders'
        }
    ];
    for (const slide of form.nodes) {
        if (slide.nodeType === AjfNodeType.AjfSlide) {
            content.push(...slideToPdf(slide, choicesMap, translate, formData));
        }
        else if (slide.nodeType === AjfNodeType.AjfRepeatingSlide) {
            content.push(...repeatingSlideToPdf(slide, choicesMap, translate, formData));
        }
    }
    const doc = { info: { title: name }, content };
    if (formSchema.is_tallysheet) {
        doc.pageOrientation = 'landscape';
    }
    return doc;
}
function slideToPdf(slide, choicesMap, translate, formData, rep) {
    let label = translate(slide.label);
    if (rep != null) {
        label = `${label} (${translate('repeat')} ${rep})`;
    }
    const content = [{ text: label, fontSize: 18, bold: true, margin: [0, 15, 0, 10] }];
    for (const field of slide.nodes) {
        content.push(...fieldToPdf(field, choicesMap, translate, formData, rep));
    }
    return content;
}
function repeatingSlideToPdf(slide, choicesMap, translate, formData) {
    let repeats = 3; // default, if no formData
    const maxRepeats = 20;
    if (formData != null && formData.data != null && slide.name != null) {
        const r = formData.data[slide.name];
        if (typeof (r) === 'number') {
            repeats = Math.min(r, maxRepeats);
        }
    }
    const content = [];
    for (let r = 0; r < repeats; r++) {
        content.push(...slideToPdf(slide, choicesMap, translate, formData, r));
    }
    return content;
}
function borderlessCell(text, bold) {
    return { table: { body: [[{ text, bold, border: [false, false, false, false] }]] } };
}
function fieldToPdf(field, choicesMap, translate, formData, rep) {
    if (field.nodeType !== AjfNodeType.AjfField) {
        throw new Error('not a field');
    }
    const visible = formData == null /* form not compiled, show all fields */ ||
        field.visibility == null ||
        evaluateExpression(field.visibility.condition, formData.data);
    if (!visible) {
        return [];
    }
    const lookupString = lookupStringFunction(formData, rep);
    switch (field.fieldType) {
        case AjfFieldType.String:
        case AjfFieldType.Text:
            return [
                borderlessCell(translate(field.label)),
                { table: { widths: ['*'], body: [[lookupString(field.name)]] }, margin: [5, 0, 0, 5] }
            ];
        case AjfFieldType.Formula:
            const formula = field.formula.formula;
            const value = evaluateExpression(formula, (formData || {}).data);
            return [
                borderlessCell(translate(field.label)),
                { table: { widths: ['*'], body: [[String(value)]] }, margin: [5, 0, 0, 5] }
            ];
        case AjfFieldType.Number:
        case AjfFieldType.Boolean:
        case AjfFieldType.DateInput:
        case AjfFieldType.Time:
            let val = lookupString(field.name);
            // for boolean fields in compiled forms, a null value is printed as 'no':
            if (field.fieldType === AjfFieldType.Boolean && formData != null && val === ' ') {
                val = 'no';
            }
            return [{
                    table: {
                        widths: ['*', '*'],
                        body: [[{ text: translate(field.label), border: [false, false, false, false] }, val]]
                    }
                }];
        case AjfFieldType.SingleChoice:
        case AjfFieldType.MultipleChoice:
            const choices = choicesMap[field.choicesOriginRef];
            if (formData == null) { // empty form
                return choiceToPdf(field, choices, translate);
            }
            // compiled form, only print choices that are selected
            const selectedValues = (field.fieldType === AjfFieldType.SingleChoice) ?
                [lookupString(field.name)] :
                lookupArrayFunction(formData, rep)(field.name);
            const selectedChoices = selectedValues.map(v => choices.find(c => c.value = v))
                .filter(c => c);
            return choiceToPdf(field, selectedChoices, translate);
        case AjfFieldType.Empty:
            const text = stripHTML(translate(field.HTML));
            return [borderlessCell(text, true)];
        case AjfFieldType.Table:
            return tableToPdf(field, lookupString, translate);
        default: // yet unsupported field type
            return [];
    }
}
function choiceToPdf(field, choices, translate) {
    let choiceLabels;
    if (choices == null || choices.length === 0) {
        choiceLabels = [' '];
    }
    else {
        choiceLabels = choices.map(c => c.label);
    }
    const body = [];
    for (const c of choiceLabels) {
        body.push([translate(c)]);
    }
    const question = translate(field.label) +
        ((field.fieldType === AjfFieldType.SingleChoice) ? ` (${translate('single choice')})` :
            ` (${translate('multipe choice')})`);
    return [{
            columns: [
                borderlessCell(question), {
                    table: { widths: ['*'], body },
                }
            ],
            margin: [0, 0, 0, 5]
        }];
}
function tableToPdf(table, lookupString, translate) {
    const body = [['', ...table.columnLabels.map(translate)]];
    for (let i = 0; i < table.rows.length; i++) {
        const row = [...table.rows[i]];
        for (let j = 0; j < row.length; j++) {
            if (typeof (row[j]) !== 'string') {
                row[j] = row[j].formula;
            }
        }
        const valsRow = row.map(lookupString).map(translate);
        body.push([translate(table.rowLabels[i]), ...valsRow]);
    }
    return [
        borderlessCell(translate(table.label)),
        { table: { body, widths: Array(table.columnLabels.length + 1).fill('*') }, margin: [5, 0, 0, 5] }
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS10by1wZGYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9mb3Jtcy9mb3JtLXRvLXBkZi9mb3JtLXRvLXBkZi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7QUFLSCxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFHNUQsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLDhCQUE4QixDQUFDO0FBS3pELE9BQU8sRUFBeUIsa0JBQWtCLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUc1RSxPQUFPLEVBQUMsU0FBUyxFQUFjLE1BQU0sdUJBQXVCLENBQUM7QUFDN0QsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUVyQyxNQUFNLFFBQVEsR0FBRztJQUNmLE1BQU0sRUFBRTtRQUNOLE1BQU0sRUFBRSw0QkFBNEI7UUFDcEMsSUFBSSxFQUFFLDRCQUE0QjtRQUNsQyxPQUFPLEVBQUUsNEJBQTRCO1FBQ3JDLFdBQVcsRUFBRSw0QkFBNEI7S0FDMUM7Q0FDRixDQUFDO0FBa0JGLE1BQU0sVUFBVSxhQUFhLENBQzNCLFVBQXNCLEVBQUUsRUFBcUIsRUFBRSxRQUFtQjtJQUVsRSxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsVUFBVSxFQUFFLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNuRCxPQUFPLFNBQVMsQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztBQUMxRCxDQUFDO0FBT0QsU0FBUyxTQUFTLENBQUMsQ0FBUztJQUMxQixPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDMUMsQ0FBQztBQUVELFNBQVMsaUJBQWlCLENBQUMsRUFBcUI7SUFDOUMsSUFBSSxFQUFFLElBQUksSUFBSSxFQUFFO1FBQ2QsT0FBTyxDQUFDLENBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO0tBQ3pCO0lBQ0QsT0FBTyxDQUFDLENBQVMsRUFBRSxFQUFFO1FBQ25CLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUU7WUFDdEMsT0FBTyxHQUFHLENBQUM7U0FDWjtRQUNELE9BQU8sRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQVcsQ0FBQztJQUNqQyxDQUFDLENBQUM7QUFDSixDQUFDO0FBRUQsb0ZBQW9GO0FBQ3BGLHlGQUF5RjtBQUN6Rix3RUFBd0U7QUFDeEUsU0FBUyxvQkFBb0IsQ0FBQyxRQUFtQixFQUFFLEdBQVk7SUFDN0QsSUFBSSxRQUFRLElBQUksSUFBSSxJQUFJLFFBQVEsQ0FBQyxJQUFJLElBQUksSUFBSSxFQUFFO1FBQzdDLE9BQU8sQ0FBQyxDQUFTLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQztLQUMzQjtJQUNELE9BQU8sQ0FBQyxJQUFZLEVBQUUsRUFBRTtRQUN0QixJQUFJLElBQUksSUFBSSxJQUFJLEVBQUU7WUFDaEIsT0FBTyxHQUFHLENBQUM7U0FDWjtRQUNELElBQUksR0FBRyxJQUFJLElBQUksRUFBRTtZQUNmLElBQUksR0FBRyxJQUFJLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQztTQUMxQjtRQUNELE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEMsSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFO1lBQ2YsT0FBTyxHQUFHLENBQUM7U0FDWjtRQUNELElBQUksR0FBRyxLQUFLLElBQUksRUFBRTtZQUNoQixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxHQUFHLEtBQUssS0FBSyxFQUFFO1lBQ2pCLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNyQixDQUFDLENBQUM7QUFDSixDQUFDO0FBRUQsd0VBQXdFO0FBQ3hFLGdDQUFnQztBQUNoQyxTQUFTLG1CQUFtQixDQUFDLFFBQW1CLEVBQUUsR0FBWTtJQUM1RCxJQUFJLFFBQVEsSUFBSSxJQUFJLElBQUksUUFBUSxDQUFDLElBQUksSUFBSSxJQUFJLEVBQUU7UUFDN0MsT0FBTyxDQUFDLENBQVMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDO0tBQzFCO0lBQ0QsT0FBTyxDQUFDLElBQVksRUFBRSxFQUFFO1FBQ3RCLElBQUksSUFBSSxJQUFJLElBQUksRUFBRTtZQUNoQixPQUFPLEVBQUUsQ0FBQztTQUNYO1FBQ0QsSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFO1lBQ2YsSUFBSSxHQUFHLElBQUksR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFDO1NBQzFCO1FBQ0QsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDdEIsT0FBTyxHQUFHLENBQUM7U0FDWjtRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELGlFQUFpRTtBQUNqRSxTQUFTLFNBQVMsQ0FDaEIsVUFBc0IsRUFBRSxFQUFxQixFQUFFLFFBQW1CO0lBRWxFLE1BQU0sU0FBUyxHQUFHLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLE1BQU0sSUFBSSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEMsTUFBTSxJQUFJLEdBQUcsVUFBVSxDQUFDLE1BQWlCLENBQUM7SUFFMUMsTUFBTSxVQUFVLEdBQWUsRUFBRSxDQUFDO0lBQ2xDLEtBQUssTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtRQUNuQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUM7S0FDaEM7SUFFRCxNQUFNLE9BQU8sR0FBYztRQUN6QixFQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUMsRUFBRTtZQUNsRixLQUFLLEVBQUU7Z0JBQ0wsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztnQkFDbEIsSUFBSSxFQUFFLENBQUM7d0JBQ0wsU0FBUyxDQUFDLFlBQVksQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO3dCQUN0RSxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7cUJBQ25FLENBQUM7YUFDSDtZQUNELE1BQU0sRUFBRSxXQUFXO1NBQ3BCO0tBQ0YsQ0FBQztJQUNGLEtBQUssTUFBTSxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtRQUM5QixJQUFJLEtBQUssQ0FBQyxRQUFRLEtBQUssV0FBVyxDQUFDLFFBQVEsRUFBRTtZQUMzQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsVUFBVSxDQUFDLEtBQWlCLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO1NBQ2pGO2FBQU0sSUFBSSxLQUFLLENBQUMsUUFBUSxLQUFLLFdBQVcsQ0FBQyxpQkFBaUIsRUFBRTtZQUMzRCxPQUFPLENBQUMsSUFBSSxDQUNWLEdBQUcsbUJBQW1CLENBQUMsS0FBMEIsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUNwRixDQUFDO1NBQ0g7S0FDRjtJQUNELE1BQU0sR0FBRyxHQUF5QixFQUFDLElBQUksRUFBRSxFQUFDLEtBQUssRUFBRSxJQUFJLEVBQUMsRUFBRSxPQUFPLEVBQUMsQ0FBQztJQUNqRSxJQUFJLFVBQVUsQ0FBQyxhQUFhLEVBQUU7UUFDNUIsR0FBRyxDQUFDLGVBQWUsR0FBRyxXQUFrQixDQUFDO0tBQzFDO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDO0FBRUQsU0FBUyxVQUFVLENBQ2pCLEtBQW1DLEVBQUUsVUFBc0IsRUFDM0QsU0FBZ0MsRUFBRSxRQUFtQixFQUFFLEdBQVk7SUFFbkUsSUFBSSxLQUFLLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuQyxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUU7UUFDZixLQUFLLEdBQUcsR0FBRyxLQUFLLEtBQUssU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO0tBQ3BEO0lBQ0QsTUFBTSxPQUFPLEdBQ1gsQ0FBQyxFQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFDLENBQUMsQ0FBQztJQUNwRSxLQUFLLE1BQU0sS0FBSyxJQUFLLEtBQUssQ0FBQyxLQUFvQixFQUFFO1FBQy9DLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7S0FDMUU7SUFDRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FDMUIsS0FBd0IsRUFBRSxVQUFzQixFQUFFLFNBQWdDLEVBQ2xGLFFBQW1CO0lBRW5CLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFFLDBCQUEwQjtJQUM1QyxNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7SUFDdEIsSUFBSSxRQUFRLElBQUksSUFBSSxJQUFJLFFBQVEsQ0FBQyxJQUFJLElBQUksSUFBSSxJQUFJLEtBQUssQ0FBQyxJQUFJLElBQUksSUFBSSxFQUFFO1FBQ25FLE1BQU0sQ0FBQyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BDLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsRUFBRTtZQUMzQixPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7U0FDbkM7S0FDRjtJQUVELE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQztJQUNuQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ2hDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDeEU7SUFDRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsSUFBWSxFQUFFLElBQWM7SUFDbEQsT0FBTyxFQUFDLEtBQUssRUFBRSxFQUFDLElBQUksRUFBRSxDQUFDLENBQUMsRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxFQUFDLENBQUMsQ0FBQyxFQUFDLEVBQUMsQ0FBQztBQUNqRixDQUFDO0FBRUQsU0FBUyxVQUFVLENBQ2pCLEtBQWUsRUFBRSxVQUFzQixFQUFFLFNBQWdDLEVBQ3pFLFFBQW1CLEVBQUUsR0FBWTtJQUVqQyxJQUFJLEtBQUssQ0FBQyxRQUFRLEtBQUssV0FBVyxDQUFDLFFBQVEsRUFBRTtRQUMzQyxNQUFNLElBQUksS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0tBQ2hDO0lBRUQsTUFBTSxPQUFPLEdBQ1gsUUFBUSxJQUFJLElBQUksQ0FBQyx3Q0FBd0M7UUFDekQsS0FBSyxDQUFDLFVBQVUsSUFBSSxJQUFJO1FBQ3hCLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoRSxJQUFJLENBQUMsT0FBTyxFQUFFO1FBQ1osT0FBTyxFQUFFLENBQUM7S0FDWDtJQUVELE1BQU0sWUFBWSxHQUFHLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUV6RCxRQUFRLEtBQUssQ0FBQyxTQUFTLEVBQUU7UUFDdkIsS0FBSyxZQUFZLENBQUMsTUFBTSxDQUFDO1FBQ3pCLEtBQUssWUFBWSxDQUFDLElBQUk7WUFDcEIsT0FBTztnQkFDTCxjQUFjLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDdEMsRUFBQyxLQUFLLEVBQUUsRUFBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUM7YUFDbkYsQ0FBQztRQUNKLEtBQUssWUFBWSxDQUFDLE9BQU87WUFDdkIsTUFBTSxPQUFPLEdBQUssS0FBeUIsQ0FBQyxPQUFzQixDQUFDLE9BQU8sQ0FBQztZQUMzRSxNQUFNLEtBQUssR0FBRyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakUsT0FBTztnQkFDTCxjQUFjLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDdEMsRUFBQyxLQUFLLEVBQUUsRUFBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBQzthQUN4RSxDQUFDO1FBQ0osS0FBSyxZQUFZLENBQUMsTUFBTSxDQUFDO1FBQ3pCLEtBQUssWUFBWSxDQUFDLE9BQU8sQ0FBQztRQUMxQixLQUFLLFlBQVksQ0FBQyxTQUFTLENBQUM7UUFDNUIsS0FBSyxZQUFZLENBQUMsSUFBSTtZQUNwQixJQUFJLEdBQUcsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25DLHlFQUF5RTtZQUN6RSxJQUFJLEtBQUssQ0FBQyxTQUFTLEtBQUssWUFBWSxDQUFDLE9BQU8sSUFBSSxRQUFRLElBQUksSUFBSSxJQUFJLEdBQUcsS0FBSyxHQUFHLEVBQUU7Z0JBQy9FLEdBQUcsR0FBRyxJQUFJLENBQUM7YUFDWjtZQUNELE9BQU8sQ0FBQztvQkFDTixLQUFLLEVBQUU7d0JBQ0wsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQzt3QkFDbEIsSUFBSSxFQUFFLENBQUMsQ0FBRSxFQUFDLElBQUksRUFBRSxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxFQUFDLEVBQUUsR0FBRyxDQUFFLENBQUM7cUJBQ3RGO2lCQUNGLENBQUMsQ0FBQztRQUNMLEtBQUssWUFBWSxDQUFDLFlBQVksQ0FBQztRQUMvQixLQUFLLFlBQVksQ0FBQyxjQUFjO1lBQzlCLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBRSxLQUFhLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUM1RCxJQUFJLFFBQVEsSUFBSSxJQUFJLEVBQUUsRUFBRSxhQUFhO2dCQUNuQyxPQUFPLFdBQVcsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2FBQy9DO1lBQ0Qsc0RBQXNEO1lBQ3RELE1BQU0sY0FBYyxHQUFHLENBQUMsS0FBSyxDQUFDLFNBQVMsS0FBSyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztnQkFDdEUsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDNUIsbUJBQW1CLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNqRCxNQUFNLGVBQWUsR0FBRyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7aUJBQzVFLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBcUIsQ0FBQztZQUN0QyxPQUFPLFdBQVcsQ0FBQyxLQUFLLEVBQUUsZUFBZSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3hELEtBQUssWUFBWSxDQUFDLEtBQUs7WUFDckIsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBRSxLQUF1QixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDakUsT0FBTyxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUN0QyxLQUFLLFlBQVksQ0FBQyxLQUFLO1lBQ3JCLE9BQU8sVUFBVSxDQUFDLEtBQXNCLEVBQUUsWUFBWSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3JFLFNBQVUsNkJBQTZCO1lBQ3JDLE9BQU8sRUFBRSxDQUFDO0tBQ2I7QUFDSCxDQUFDO0FBRUQsU0FBUyxXQUFXLENBQ2xCLEtBQWUsRUFBRSxPQUF5QixFQUFFLFNBQWdDO0lBRTVFLElBQUksWUFBc0IsQ0FBQztJQUMzQixJQUFJLE9BQU8sSUFBSSxJQUFJLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDM0MsWUFBWSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDdEI7U0FBTTtRQUNMLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQzFDO0lBQ0QsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ2hCLEtBQUssTUFBTSxDQUFDLElBQUksWUFBWSxFQUFFO1FBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzNCO0lBQ0QsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7UUFDckMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLEtBQUssWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckYsS0FBSyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekMsT0FBTyxDQUFDO1lBQ04sT0FBTyxFQUFFO2dCQUNQLGNBQWMsQ0FBQyxRQUFRLENBQUMsRUFBRTtvQkFDeEIsS0FBSyxFQUFFLEVBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxFQUFDO2lCQUM3QjthQUNGO1lBQ0QsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3JCLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FDakIsS0FBb0IsRUFBRSxZQUFtQyxFQUN6RCxTQUFnQztJQUVoQyxNQUFNLElBQUksR0FBZSxDQUFDLENBQUMsRUFBRSxFQUFFLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RFLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMxQyxNQUFNLEdBQUcsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ25DLElBQUksT0FBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsRUFBRTtnQkFDL0IsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFJLEdBQUcsQ0FBQyxDQUFDLENBQWtCLENBQUMsT0FBTyxDQUFDO2FBQzNDO1NBQ0Y7UUFDRCxNQUFNLE9BQU8sR0FBSSxHQUFnQixDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDO0tBQ3hEO0lBQ0QsT0FBTztRQUNMLGNBQWMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLEVBQUMsS0FBSyxFQUFFLEVBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUM7S0FDOUYsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKEMpIEdudWNvb3Agc29jLiBjb29wLlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yXG4gKiBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXNcbiAqIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLFxuICogb3IgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIEdOVSBBZmZlcm9cbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGFsb25nIHdpdGggQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqIElmIG5vdCwgc2VlIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8uXG4gKlxuICovXG5cbmltcG9ydCB7QWpmQ2hvaWNlfSBmcm9tICcuLi9pbnRlcmZhY2UvY2hvaWNlcy9jaG9pY2UnO1xuaW1wb3J0IHtBamZFbXB0eUZpZWxkfSBmcm9tICcuLi9pbnRlcmZhY2UvZmllbGRzL2VtcHR5LWZpZWxkJztcbmltcG9ydCB7QWpmRmllbGR9IGZyb20gJy4uL2ludGVyZmFjZS9maWVsZHMvZmllbGQnO1xuaW1wb3J0IHtBamZGaWVsZFR5cGV9IGZyb20gJy4uL2ludGVyZmFjZS9maWVsZHMvZmllbGQtdHlwZSc7XG5pbXBvcnQge0FqZkZvcm19IGZyb20gJy4uL2ludGVyZmFjZS9mb3Jtcy9mb3JtJztcbmltcG9ydCB7QWpmRm9ybXVsYUZpZWxkfSBmcm9tICcuLi9pbnRlcmZhY2UvZmllbGRzL2Zvcm11bGEtZmllbGQnO1xuaW1wb3J0IHtBamZOb2RlVHlwZX0gZnJvbSAnLi4vaW50ZXJmYWNlL25vZGVzL25vZGUtdHlwZSc7XG5pbXBvcnQge0FqZlJlcGVhdGluZ1NsaWRlfSBmcm9tICcuLi9pbnRlcmZhY2Uvc2xpZGVzL3JlcGVhdGluZy1zbGlkZSc7XG5pbXBvcnQge0FqZlNsaWRlfSBmcm9tICcuLi9pbnRlcmZhY2Uvc2xpZGVzL3NsaWRlJztcbmltcG9ydCB7QWpmVGFibGVDZWxsLCBBamZUYWJsZUZpZWxkfSBmcm9tICcuLi9pbnRlcmZhY2UvZmllbGRzL3RhYmxlLWZpZWxkJztcblxuaW1wb3J0IHtBamZDb250ZXh0LCBBamZGb3JtdWxhLCBldmFsdWF0ZUV4cHJlc3Npb259IGZyb20gJ0BhamYvY29yZS9tb2RlbHMnO1xuXG5pbXBvcnQge0NvbnRlbnQsIFREb2N1bWVudERlZmluaXRpb25zfSBmcm9tICdwZGZtYWtlL2ludGVyZmFjZXMnO1xuaW1wb3J0IHtjcmVhdGVQZGYsIFRDcmVhdGVkUGRmfSBmcm9tICdwZGZtYWtlL2J1aWxkL3BkZm1ha2UnO1xuaW1wb3J0IHt2ZnNGb250c30gZnJvbSAnLi92ZnMtZm9udHMnO1xuXG5jb25zdCBmb250c01hcCA9IHtcbiAgUm9ib3RvOiB7XG4gICAgbm9ybWFsOiAncm9ib3RvLWFsbC00MDAtbm9ybWFsLndvZmYnLFxuICAgIGJvbGQ6ICdyb2JvdG8tYWxsLTUwMC1ub3JtYWwud29mZicsXG4gICAgaXRhbGljczogJ3JvYm90by1hbGwtNDAwLWl0YWxpYy53b2ZmJyxcbiAgICBib2xkaXRhbGljczogJ3JvYm90by1hbGwtNTAwLWl0YWxpYy53b2ZmJ1xuICB9LFxufTtcblxuaW50ZXJmYWNlIEZvcm1TY2hlbWEge1xuICBuYW1lOiBzdHJpbmc7XG4gIHNjaGVtYT86IEFqZkZvcm07XG4gIGlzX3RhbGx5c2hlZXQ/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgRm9ybURhdGEge1xuICBkYXRlX3N0YXJ0OiBzdHJpbmc7XG4gIGRhdGVfZW5kOiBzdHJpbmc7XG4gIGRhdGE6IEFqZkNvbnRleHQ7XG59XG5cbmludGVyZmFjZSBUcmFuc2xhdGVTZXJ2aWNlIHtcbiAgaW5zdGFudChzOiBzdHJpbmcpOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVGb3JtUGRmKFxuICBmb3JtU2NoZW1hOiBGb3JtU2NoZW1hLCB0cz86IFRyYW5zbGF0ZVNlcnZpY2UsIGZvcm1EYXRhPzogRm9ybURhdGEpOiBUQ3JlYXRlZFBkZiB7XG5cbiAgY29uc3QgcGRmRGVmID0gZm9ybVRvUGRmKGZvcm1TY2hlbWEsIHRzLCBmb3JtRGF0YSk7XG4gIHJldHVybiBjcmVhdGVQZGYocGRmRGVmLCB1bmRlZmluZWQsIGZvbnRzTWFwLCB2ZnNGb250cyk7XG59XG5cbi8vIENob2ljZXNNYXAgbWFwcyBhIGNob2ljZXNPcmlnaW5SZWYgdG8gdGhlIGxpc3QgdGhlIGNob2ljZXMuXG5pbnRlcmZhY2UgQ2hvaWNlc01hcCB7XG4gIFtuYW1lOiBzdHJpbmddOiBBamZDaG9pY2U8YW55PltdO1xufVxuXG5mdW5jdGlvbiBzdHJpcEhUTUwoczogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHMucmVwbGFjZSgvPFxcLz9bXj5dKyg+fCQpL2csICcnKTtcbn1cblxuZnVuY3Rpb24gdHJhbnNsYXRlRnVuY3Rpb24odHM/OiBUcmFuc2xhdGVTZXJ2aWNlKTogKHM6IHN0cmluZykgPT4gc3RyaW5nIHtcbiAgaWYgKHRzID09IG51bGwpIHtcbiAgICByZXR1cm4gKHM6IHN0cmluZykgPT4gcztcbiAgfVxuICByZXR1cm4gKHM6IHN0cmluZykgPT4ge1xuICAgIGlmIChzID09IG51bGwgfHwgcyA9PT0gJycgfHwgcyA9PT0gJyAnKSB7XG4gICAgICByZXR1cm4gJyAnO1xuICAgIH1cbiAgICByZXR1cm4gdHMuaW5zdGFudChzKSBhcyBzdHJpbmc7XG4gIH07XG59XG5cbi8vIEdpdmVuIGEgZm9ybURhdGEsIGxvb2t1cFN0cmluZ0Z1bmN0aW9uIHJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGFsbG93cyB0byByZXRyaWV2ZVxuLy8gdGhlIGZpZWxkIHZhbHVlcyBmcm9tIHRoZSBmb3JtRGF0YS4gVGhlIHZhbHVlcyBhcmUgcmV0dXJuZWQgYXMgcHJpbnQtZnJpZW5kbHkgc3RyaW5ncy5cbi8vIHJlcCBpcyB0aGUgaW5kZXggb2YgdGhlIHJlcGVhdGluZyBzbGlkZSwgaWYgdGhlIGZpZWxkIGJlbG9uZ3MgdG8gb25lLlxuZnVuY3Rpb24gbG9va3VwU3RyaW5nRnVuY3Rpb24oZm9ybURhdGE/OiBGb3JtRGF0YSwgcmVwPzogbnVtYmVyKTogKG5hbWU6IHN0cmluZykgPT4gc3RyaW5nIHtcbiAgaWYgKGZvcm1EYXRhID09IG51bGwgfHwgZm9ybURhdGEuZGF0YSA9PSBudWxsKSB7XG4gICAgcmV0dXJuIChfOiBzdHJpbmcpID0+ICcgJztcbiAgfVxuICByZXR1cm4gKG5hbWU6IHN0cmluZykgPT4ge1xuICAgIGlmIChuYW1lID09IG51bGwpIHtcbiAgICAgIHJldHVybiAnICc7XG4gICAgfVxuICAgIGlmIChyZXAgIT0gbnVsbCkge1xuICAgICAgbmFtZSA9IG5hbWUgKyAnX18nICsgcmVwO1xuICAgIH1cbiAgICBjb25zdCB2YWwgPSBmb3JtRGF0YS5kYXRhW25hbWVdO1xuICAgIGlmICh2YWwgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuICcgJztcbiAgICB9XG4gICAgaWYgKHZhbCA9PT0gdHJ1ZSkge1xuICAgICAgcmV0dXJuICd5ZXMnO1xuICAgIH1cbiAgICBpZiAodmFsID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuICdubyc7XG4gICAgfVxuICAgIHJldHVybiBTdHJpbmcodmFsKTtcbiAgfTtcbn1cblxuLy8gQW5hbG9nb3VzIHRvIGxvb2t1cFN0cmluZ0Z1bmN0aW9uLCBidXQgZm9yIG11bHRpcGxlLWNob2ljZSBxdWVzdGlvbnMsXG4vLyByZXR1cm5pbmcgYW4gYXJyYXkgb2YgdmFsdWVzLlxuZnVuY3Rpb24gbG9va3VwQXJyYXlGdW5jdGlvbihmb3JtRGF0YT86IEZvcm1EYXRhLCByZXA/OiBudW1iZXIpOiAobmFtZTogc3RyaW5nKSA9PiBzdHJpbmdbXSB7XG4gIGlmIChmb3JtRGF0YSA9PSBudWxsIHx8IGZvcm1EYXRhLmRhdGEgPT0gbnVsbCkge1xuICAgIHJldHVybiAoXzogc3RyaW5nKSA9PiBbXTtcbiAgfVxuICByZXR1cm4gKG5hbWU6IHN0cmluZykgPT4ge1xuICAgIGlmIChuYW1lID09IG51bGwpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgaWYgKHJlcCAhPSBudWxsKSB7XG4gICAgICBuYW1lID0gbmFtZSArICdfXycgKyByZXA7XG4gICAgfVxuICAgIGNvbnN0IHZhbCA9IGZvcm1EYXRhLmRhdGFbbmFtZV07XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkge1xuICAgICAgcmV0dXJuIHZhbDtcbiAgICB9XG4gICAgcmV0dXJuIFtdO1xuICB9O1xufVxuXG4vLyBHaXZlbiBhbiBBamZGb3JtLCByZXR1cm5zIGl0cyBwZGZtYWtlIHBkZiBkb2N1bWVudCBkZWZpbml0aW9uLlxuZnVuY3Rpb24gZm9ybVRvUGRmKFxuICBmb3JtU2NoZW1hOiBGb3JtU2NoZW1hLCB0cz86IFRyYW5zbGF0ZVNlcnZpY2UsIGZvcm1EYXRhPzogRm9ybURhdGEpOiBURG9jdW1lbnREZWZpbml0aW9ucyB7XG5cbiAgY29uc3QgdHJhbnNsYXRlID0gdHJhbnNsYXRlRnVuY3Rpb24odHMpO1xuICBjb25zdCBuYW1lID0gdHJhbnNsYXRlKGZvcm1TY2hlbWEubmFtZSk7XG4gIGNvbnN0IGZvcm0gPSBmb3JtU2NoZW1hLnNjaGVtYSBhcyBBamZGb3JtO1xuXG4gIGNvbnN0IGNob2ljZXNNYXA6IENob2ljZXNNYXAgPSB7fTtcbiAgZm9yIChjb25zdCBvIG9mIGZvcm0uY2hvaWNlc09yaWdpbnMpIHtcbiAgICBjaG9pY2VzTWFwW28ubmFtZV0gPSBvLmNob2ljZXM7XG4gIH1cblxuICBjb25zdCBjb250ZW50OiBDb250ZW50W10gPSBbXG4gICAge3RleHQ6IG5hbWUsIGZvbnRTaXplOiAyMiwgYm9sZDogdHJ1ZSwgYWxpZ25tZW50OiAnY2VudGVyJywgbWFyZ2luOiBbMCwgMCwgMCwgMTBdfSwge1xuICAgICAgdGFibGU6IHtcbiAgICAgICAgd2lkdGhzOiBbJyonLCAnKiddLFxuICAgICAgICBib2R5OiBbW1xuICAgICAgICAgIHRyYW5zbGF0ZSgnZGF0ZSBzdGFydCcpICsgJzogJyArIChmb3JtRGF0YSA/IGZvcm1EYXRhLmRhdGVfc3RhcnQgOiAnJyksXG4gICAgICAgICAgdHJhbnNsYXRlKCdkYXRlIGVuZCcpICsgJzogJyArIChmb3JtRGF0YSA/IGZvcm1EYXRhLmRhdGVfZW5kIDogJycpLFxuICAgICAgICBdXVxuICAgICAgfSxcbiAgICAgIGxheW91dDogJ25vQm9yZGVycydcbiAgICB9XG4gIF07XG4gIGZvciAoY29uc3Qgc2xpZGUgb2YgZm9ybS5ub2Rlcykge1xuICAgIGlmIChzbGlkZS5ub2RlVHlwZSA9PT0gQWpmTm9kZVR5cGUuQWpmU2xpZGUpIHtcbiAgICAgIGNvbnRlbnQucHVzaCguLi5zbGlkZVRvUGRmKHNsaWRlIGFzIEFqZlNsaWRlLCBjaG9pY2VzTWFwLCB0cmFuc2xhdGUsIGZvcm1EYXRhKSk7XG4gICAgfSBlbHNlIGlmIChzbGlkZS5ub2RlVHlwZSA9PT0gQWpmTm9kZVR5cGUuQWpmUmVwZWF0aW5nU2xpZGUpIHtcbiAgICAgIGNvbnRlbnQucHVzaChcbiAgICAgICAgLi4ucmVwZWF0aW5nU2xpZGVUb1BkZihzbGlkZSBhcyBBamZSZXBlYXRpbmdTbGlkZSwgY2hvaWNlc01hcCwgdHJhbnNsYXRlLCBmb3JtRGF0YSlcbiAgICAgICk7XG4gICAgfVxuICB9XG4gIGNvbnN0IGRvYzogVERvY3VtZW50RGVmaW5pdGlvbnMgPSB7aW5mbzoge3RpdGxlOiBuYW1lfSwgY29udGVudH07XG4gIGlmIChmb3JtU2NoZW1hLmlzX3RhbGx5c2hlZXQpIHtcbiAgICBkb2MucGFnZU9yaWVudGF0aW9uID0gJ2xhbmRzY2FwZScgYXMgYW55O1xuICB9XG4gIHJldHVybiBkb2M7XG59XG5cbmZ1bmN0aW9uIHNsaWRlVG9QZGYoXG4gIHNsaWRlOiBBamZTbGlkZSB8IEFqZlJlcGVhdGluZ1NsaWRlLCBjaG9pY2VzTWFwOiBDaG9pY2VzTWFwLFxuICB0cmFuc2xhdGU6IChzOiBzdHJpbmcpID0+IHN0cmluZywgZm9ybURhdGE/OiBGb3JtRGF0YSwgcmVwPzogbnVtYmVyKTogQ29udGVudFtdIHtcblxuICBsZXQgbGFiZWwgPSB0cmFuc2xhdGUoc2xpZGUubGFiZWwpO1xuICBpZiAocmVwICE9IG51bGwpIHtcbiAgICBsYWJlbCA9IGAke2xhYmVsfSAoJHt0cmFuc2xhdGUoJ3JlcGVhdCcpfSAke3JlcH0pYDtcbiAgfVxuICBjb25zdCBjb250ZW50OiBDb250ZW50W10gPVxuICAgIFt7dGV4dDogbGFiZWwsIGZvbnRTaXplOiAxOCwgYm9sZDogdHJ1ZSwgbWFyZ2luOiBbMCwgMTUsIDAsIDEwXX1dO1xuICBmb3IgKGNvbnN0IGZpZWxkIG9mIChzbGlkZS5ub2RlcyBhcyBBamZGaWVsZFtdKSkge1xuICAgIGNvbnRlbnQucHVzaCguLi5maWVsZFRvUGRmKGZpZWxkLCBjaG9pY2VzTWFwLCB0cmFuc2xhdGUsIGZvcm1EYXRhLCByZXApKTtcbiAgfVxuICByZXR1cm4gY29udGVudDtcbn1cblxuZnVuY3Rpb24gcmVwZWF0aW5nU2xpZGVUb1BkZihcbiAgc2xpZGU6IEFqZlJlcGVhdGluZ1NsaWRlLCBjaG9pY2VzTWFwOiBDaG9pY2VzTWFwLCB0cmFuc2xhdGU6IChzOiBzdHJpbmcpID0+IHN0cmluZyxcbiAgZm9ybURhdGE/OiBGb3JtRGF0YSk6IENvbnRlbnRbXSB7XG5cbiAgbGV0IHJlcGVhdHMgPSAzOyAgLy8gZGVmYXVsdCwgaWYgbm8gZm9ybURhdGFcbiAgY29uc3QgbWF4UmVwZWF0cyA9IDIwO1xuICBpZiAoZm9ybURhdGEgIT0gbnVsbCAmJiBmb3JtRGF0YS5kYXRhICE9IG51bGwgJiYgc2xpZGUubmFtZSAhPSBudWxsKSB7XG4gICAgY29uc3QgciA9IGZvcm1EYXRhLmRhdGFbc2xpZGUubmFtZV07XG4gICAgaWYgKHR5cGVvZiAocikgPT09ICdudW1iZXInKSB7XG4gICAgICByZXBlYXRzID0gTWF0aC5taW4ociwgbWF4UmVwZWF0cyk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgY29udGVudCA9IFtdO1xuICBmb3IgKGxldCByID0gMDsgciA8IHJlcGVhdHM7IHIrKykge1xuICAgIGNvbnRlbnQucHVzaCguLi5zbGlkZVRvUGRmKHNsaWRlLCBjaG9pY2VzTWFwLCB0cmFuc2xhdGUsIGZvcm1EYXRhLCByKSk7XG4gIH1cbiAgcmV0dXJuIGNvbnRlbnQ7XG59XG5cbmZ1bmN0aW9uIGJvcmRlcmxlc3NDZWxsKHRleHQ6IHN0cmluZywgYm9sZD86IGJvb2xlYW4pOiBDb250ZW50IHtcbiAgcmV0dXJuIHt0YWJsZToge2JvZHk6IFtbe3RleHQsIGJvbGQsIGJvcmRlcjogW2ZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlXX1dXX19O1xufVxuXG5mdW5jdGlvbiBmaWVsZFRvUGRmKFxuICBmaWVsZDogQWpmRmllbGQsIGNob2ljZXNNYXA6IENob2ljZXNNYXAsIHRyYW5zbGF0ZTogKHM6IHN0cmluZykgPT4gc3RyaW5nLFxuICBmb3JtRGF0YT86IEZvcm1EYXRhLCByZXA/OiBudW1iZXIpOiBDb250ZW50W10ge1xuXG4gIGlmIChmaWVsZC5ub2RlVHlwZSAhPT0gQWpmTm9kZVR5cGUuQWpmRmllbGQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ25vdCBhIGZpZWxkJyk7XG4gIH1cblxuICBjb25zdCB2aXNpYmxlID1cbiAgICBmb3JtRGF0YSA9PSBudWxsIC8qIGZvcm0gbm90IGNvbXBpbGVkLCBzaG93IGFsbCBmaWVsZHMgKi8gfHxcbiAgICBmaWVsZC52aXNpYmlsaXR5ID09IG51bGwgfHxcbiAgICBldmFsdWF0ZUV4cHJlc3Npb24oZmllbGQudmlzaWJpbGl0eS5jb25kaXRpb24sIGZvcm1EYXRhLmRhdGEpO1xuICBpZiAoIXZpc2libGUpIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBjb25zdCBsb29rdXBTdHJpbmcgPSBsb29rdXBTdHJpbmdGdW5jdGlvbihmb3JtRGF0YSwgcmVwKTtcblxuICBzd2l0Y2ggKGZpZWxkLmZpZWxkVHlwZSkge1xuICAgIGNhc2UgQWpmRmllbGRUeXBlLlN0cmluZzpcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5UZXh0OlxuICAgICAgcmV0dXJuIFtcbiAgICAgICAgYm9yZGVybGVzc0NlbGwodHJhbnNsYXRlKGZpZWxkLmxhYmVsKSksXG4gICAgICAgIHt0YWJsZToge3dpZHRoczogWycqJ10sIGJvZHk6IFtbbG9va3VwU3RyaW5nKGZpZWxkLm5hbWUpXV19LCBtYXJnaW46IFs1LCAwLCAwLCA1XX1cbiAgICAgIF07XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuRm9ybXVsYTpcbiAgICAgIGNvbnN0IGZvcm11bGEgPSAoKGZpZWxkIGFzIEFqZkZvcm11bGFGaWVsZCkuZm9ybXVsYSBhcyBBamZGb3JtdWxhKS5mb3JtdWxhO1xuICAgICAgY29uc3QgdmFsdWUgPSBldmFsdWF0ZUV4cHJlc3Npb24oZm9ybXVsYSwgKGZvcm1EYXRhIHx8IHt9KS5kYXRhKTtcbiAgICAgIHJldHVybiBbXG4gICAgICAgIGJvcmRlcmxlc3NDZWxsKHRyYW5zbGF0ZShmaWVsZC5sYWJlbCkpLFxuICAgICAgICB7dGFibGU6IHt3aWR0aHM6IFsnKiddLCBib2R5OiBbW1N0cmluZyh2YWx1ZSldXX0sIG1hcmdpbjogWzUsIDAsIDAsIDVdfVxuICAgICAgXTtcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5OdW1iZXI6XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuQm9vbGVhbjpcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5EYXRlSW5wdXQ6XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuVGltZTpcbiAgICAgIGxldCB2YWwgPSBsb29rdXBTdHJpbmcoZmllbGQubmFtZSk7XG4gICAgICAvLyBmb3IgYm9vbGVhbiBmaWVsZHMgaW4gY29tcGlsZWQgZm9ybXMsIGEgbnVsbCB2YWx1ZSBpcyBwcmludGVkIGFzICdubyc6XG4gICAgICBpZiAoZmllbGQuZmllbGRUeXBlID09PSBBamZGaWVsZFR5cGUuQm9vbGVhbiAmJiBmb3JtRGF0YSAhPSBudWxsICYmIHZhbCA9PT0gJyAnKSB7XG4gICAgICAgIHZhbCA9ICdubyc7XG4gICAgICB9XG4gICAgICByZXR1cm4gW3tcbiAgICAgICAgdGFibGU6IHtcbiAgICAgICAgICB3aWR0aHM6IFsnKicsICcqJ10sXG4gICAgICAgICAgYm9keTogW1sge3RleHQ6IHRyYW5zbGF0ZShmaWVsZC5sYWJlbCksIGJvcmRlcjogW2ZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlXX0sIHZhbCBdXVxuICAgICAgICB9XG4gICAgICB9XTtcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5TaW5nbGVDaG9pY2U6XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuTXVsdGlwbGVDaG9pY2U6XG4gICAgICBjb25zdCBjaG9pY2VzID0gY2hvaWNlc01hcFsoZmllbGQgYXMgYW55KS5jaG9pY2VzT3JpZ2luUmVmXTtcbiAgICAgIGlmIChmb3JtRGF0YSA9PSBudWxsKSB7IC8vIGVtcHR5IGZvcm1cbiAgICAgICAgcmV0dXJuIGNob2ljZVRvUGRmKGZpZWxkLCBjaG9pY2VzLCB0cmFuc2xhdGUpO1xuICAgICAgfVxuICAgICAgLy8gY29tcGlsZWQgZm9ybSwgb25seSBwcmludCBjaG9pY2VzIHRoYXQgYXJlIHNlbGVjdGVkXG4gICAgICBjb25zdCBzZWxlY3RlZFZhbHVlcyA9IChmaWVsZC5maWVsZFR5cGUgPT09IEFqZkZpZWxkVHlwZS5TaW5nbGVDaG9pY2UpID9cbiAgICAgICAgW2xvb2t1cFN0cmluZyhmaWVsZC5uYW1lKV0gOlxuICAgICAgICBsb29rdXBBcnJheUZ1bmN0aW9uKGZvcm1EYXRhLCByZXApKGZpZWxkLm5hbWUpO1xuICAgICAgY29uc3Qgc2VsZWN0ZWRDaG9pY2VzID0gc2VsZWN0ZWRWYWx1ZXMubWFwKHYgPT4gY2hvaWNlcy5maW5kKGMgPT4gYy52YWx1ZSA9IHYpKVxuICAgICAgICAuZmlsdGVyKGMgPT4gYykgYXMgQWpmQ2hvaWNlPGFueT5bXTtcbiAgICAgIHJldHVybiBjaG9pY2VUb1BkZihmaWVsZCwgc2VsZWN0ZWRDaG9pY2VzLCB0cmFuc2xhdGUpO1xuICAgIGNhc2UgQWpmRmllbGRUeXBlLkVtcHR5OlxuICAgICAgY29uc3QgdGV4dCA9IHN0cmlwSFRNTCh0cmFuc2xhdGUoKGZpZWxkIGFzIEFqZkVtcHR5RmllbGQpLkhUTUwpKTtcbiAgICAgIHJldHVybiBbYm9yZGVybGVzc0NlbGwodGV4dCwgdHJ1ZSldO1xuICAgIGNhc2UgQWpmRmllbGRUeXBlLlRhYmxlOlxuICAgICAgcmV0dXJuIHRhYmxlVG9QZGYoZmllbGQgYXMgQWpmVGFibGVGaWVsZCwgbG9va3VwU3RyaW5nLCB0cmFuc2xhdGUpO1xuICAgIGRlZmF1bHQ6ICAvLyB5ZXQgdW5zdXBwb3J0ZWQgZmllbGQgdHlwZVxuICAgICAgcmV0dXJuIFtdO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNob2ljZVRvUGRmKFxuICBmaWVsZDogQWpmRmllbGQsIGNob2ljZXM6IEFqZkNob2ljZTxhbnk+W10sIHRyYW5zbGF0ZTogKHM6IHN0cmluZykgPT4gc3RyaW5nKTogQ29udGVudFtdIHtcblxuICBsZXQgY2hvaWNlTGFiZWxzOiBzdHJpbmdbXTtcbiAgaWYgKGNob2ljZXMgPT0gbnVsbCB8fCBjaG9pY2VzLmxlbmd0aCA9PT0gMCkge1xuICAgIGNob2ljZUxhYmVscyA9IFsnICddO1xuICB9IGVsc2Uge1xuICAgIGNob2ljZUxhYmVscyA9IGNob2ljZXMubWFwKGMgPT4gYy5sYWJlbCk7XG4gIH1cbiAgY29uc3QgYm9keSA9IFtdO1xuICBmb3IgKGNvbnN0IGMgb2YgY2hvaWNlTGFiZWxzKSB7XG4gICAgYm9keS5wdXNoKFt0cmFuc2xhdGUoYyldKTtcbiAgfVxuICBjb25zdCBxdWVzdGlvbiA9IHRyYW5zbGF0ZShmaWVsZC5sYWJlbCkgK1xuICAgICgoZmllbGQuZmllbGRUeXBlID09PSBBamZGaWVsZFR5cGUuU2luZ2xlQ2hvaWNlKSA/IGAgKCR7dHJhbnNsYXRlKCdzaW5nbGUgY2hvaWNlJyl9KWAgOlxuICAgICAgYCAoJHt0cmFuc2xhdGUoJ211bHRpcGUgY2hvaWNlJyl9KWApO1xuICByZXR1cm4gW3tcbiAgICBjb2x1bW5zOiBbXG4gICAgICBib3JkZXJsZXNzQ2VsbChxdWVzdGlvbiksIHtcbiAgICAgICAgdGFibGU6IHt3aWR0aHM6IFsnKiddLCBib2R5fSxcbiAgICAgIH1cbiAgICBdLFxuICAgIG1hcmdpbjogWzAsIDAsIDAsIDVdXG4gIH1dO1xufVxuXG5mdW5jdGlvbiB0YWJsZVRvUGRmKFxuICB0YWJsZTogQWpmVGFibGVGaWVsZCwgbG9va3VwU3RyaW5nOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4gIHRyYW5zbGF0ZTogKHM6IHN0cmluZykgPT4gc3RyaW5nKTogQ29udGVudFtdIHtcblxuICBjb25zdCBib2R5OiBzdHJpbmdbXVtdID0gW1snJywgLi4udGFibGUuY29sdW1uTGFiZWxzLm1hcCh0cmFuc2xhdGUpXV07XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdGFibGUucm93cy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IHJvdyA9IFsuLi50YWJsZS5yb3dzW2ldXTtcbiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJvdy5sZW5ndGg7IGorKykge1xuICAgICAgaWYgKHR5cGVvZihyb3dbal0pICE9PSAnc3RyaW5nJykge1xuICAgICAgICByb3dbal0gPSAocm93W2pdIGFzIEFqZlRhYmxlQ2VsbCkuZm9ybXVsYTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgdmFsc1JvdyA9IChyb3cgYXMgc3RyaW5nW10pLm1hcChsb29rdXBTdHJpbmcpLm1hcCh0cmFuc2xhdGUpO1xuICAgIGJvZHkucHVzaChbdHJhbnNsYXRlKHRhYmxlLnJvd0xhYmVsc1tpXSksIC4uLnZhbHNSb3ddKTtcbiAgfVxuICByZXR1cm4gW1xuICAgIGJvcmRlcmxlc3NDZWxsKHRyYW5zbGF0ZSh0YWJsZS5sYWJlbCkpLFxuICAgIHt0YWJsZToge2JvZHksIHdpZHRoczogQXJyYXkodGFibGUuY29sdW1uTGFiZWxzLmxlbmd0aCArIDEpLmZpbGwoJyonKX0sIG1hcmdpbjogWzUsIDAsIDAsIDVdfVxuICBdO1xufVxuIl19