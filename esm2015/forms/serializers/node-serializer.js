/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { AjfConditionSerializer, AjfFormulaSerializer } from '@ajf/core/models';
import { AjfFieldType } from '../interface/fields/field-type';
import { AjfNodeType } from '../interface/nodes/node-type';
import { createField } from '../utils/fields/create-field';
import { createFieldWithChoices } from '../utils/fields/create-field-with-choices';
import { componentsMap } from '../utils/fields/fields-map';
import { createContainerNode } from '../utils/nodes/create-container-node';
import { createNode } from '../utils/nodes/create-node';
import { createNodeGroup } from '../utils/nodes/create-node-group';
import { createRepeatingNode } from '../utils/nodes/create-repeating-node';
import { createRepeatingSlide } from '../utils/slides/create-repeating-slide';
import { createSlide } from '../utils/slides/create-slide';
import { AjfValidationGroupSerializer } from './validation-group-serializer';
import { AjfWarningGroupSerializer } from './warning-group-serializer';
export class AjfNodeSerializer {
    static fromJson(json, choicesOrigins, attachmentsOrigins) {
        const err = 'Malformed node';
        json.name = json.name || '';
        if (json.id == null || json.parent == null || json.nodeType == null) {
            throw new Error(err);
        }
        const obj = json;
        if (obj.visibility) {
            obj.visibility = AjfConditionSerializer.fromJson(obj.visibility);
        }
        obj.conditionalBranches =
            (obj.conditionalBranches || []).map(c => AjfConditionSerializer.fromJson(c));
        switch (obj.nodeType) {
            case AjfNodeType.AjfField:
                return AjfNodeSerializer._fieldFromJson(obj, choicesOrigins, attachmentsOrigins);
            case AjfNodeType.AjfFieldNodeLink:
                return AjfNodeSerializer._fieldNodeLinkFromJson(obj);
            case AjfNodeType.AjfNodeGroup:
                return AjfNodeSerializer._nodeGroupFromJson(obj, choicesOrigins, attachmentsOrigins);
            case AjfNodeType.AjfRepeatingSlide:
                return AjfNodeSerializer._repeatingSlideFromJson(obj, choicesOrigins, attachmentsOrigins);
            case AjfNodeType.AjfSlide:
                const slideObj = obj;
                if (slideObj.readonly) {
                    slideObj.readonly = AjfConditionSerializer.fromJson(slideObj.readonly);
                }
                return AjfNodeSerializer._slideFromJson(slideObj, choicesOrigins, attachmentsOrigins);
        }
        throw new Error(err);
    }
    static _containerNodeFromJson(json, choicesOrigins, attachmentsOrigins) {
        json.nodes = (json.nodes ||
            []).map(n => AjfNodeSerializer.fromJson(n, choicesOrigins, attachmentsOrigins));
        return createContainerNode(json);
    }
    static _fieldFromJson(json, choicesOrigins, attachmentsOrigins) {
        if (json.fieldType == null) {
            throw new Error('Malformed field');
        }
        const obj = json;
        if (obj.validation) {
            obj.validation = AjfValidationGroupSerializer.fromJson(obj.validation);
        }
        if (obj.warning) {
            obj.warning = AjfWarningGroupSerializer.fromJson(obj.warning);
        }
        if (json.attachmentsOriginRef) {
            obj.attachmentOrigin =
                (attachmentsOrigins || []).find(a => a.name === json.attachmentsOriginRef);
        }
        if (obj.nextSlideCondition) {
            obj.nextSlideCondition = AjfConditionSerializer.fromJson(obj.nextSlideCondition);
        }
        const isCustomFieldWithChoice = obj.fieldType > 100 && componentsMap[obj.fieldType] != null &&
            componentsMap[obj.fieldType].isFieldWithChoice === true;
        if (isCustomFieldWithChoice) {
            return AjfNodeSerializer._fieldWithChoicesFromJson(json, choicesOrigins);
        }
        switch (obj.fieldType) {
            case AjfFieldType.Formula:
                return AjfNodeSerializer._formulaFieldFromJson(json);
            case AjfFieldType.MultipleChoice:
            case AjfFieldType.SingleChoice:
                return AjfNodeSerializer._fieldWithChoicesFromJson(json, choicesOrigins);
        }
        return createField(obj);
    }
    static _fieldNodeLinkFromJson(json) {
        return Object.assign(Object.assign({}, createNode(json)), { nodeType: AjfNodeType.AjfFieldNodeLink });
    }
    static _fieldWithChoicesFromJson(json, choicesOrigins) {
        const err = 'Malformed field with choices';
        if (json.choicesOriginRef == null) {
            throw new Error(err);
        }
        const choicesOrigin = (choicesOrigins || []).find(c => c.name === json.choicesOriginRef);
        if (choicesOrigin == null) {
            throw new Error(err);
        }
        if (json.choicesFilter) {
            json.choicesFilter = AjfFormulaSerializer.fromJson(json.choicesFilter);
        }
        if (json.triggerConditions) {
            json.triggerConditions = json.triggerConditions.map(t => AjfConditionSerializer.fromJson(t));
        }
        return createFieldWithChoices(Object.assign(Object.assign({}, json), { choicesOrigin }));
    }
    static _formulaFieldFromJson(json) {
        if (json.formula) {
            json.formula = AjfFormulaSerializer.fromJson(json.formula);
        }
        return Object.assign(Object.assign({}, createField(json)), { fieldType: AjfFieldType.Formula });
    }
    static _nodeGroupFromJson(json, choicesOrigins, attachmentsOrigins) {
        return createNodeGroup(Object.assign(Object.assign({}, AjfNodeSerializer._containerNodeFromJson(json, choicesOrigins, attachmentsOrigins)), AjfNodeSerializer._repeatingNodeFromJson(json)));
    }
    static _repeatingNodeFromJson(json) {
        if (json.formulaReps) {
            json.formulaReps = AjfFormulaSerializer.fromJson(json.formulaReps);
        }
        return createRepeatingNode(json);
    }
    static _repeatingSlideFromJson(json, choicesOrigins, attachmentsOrigins) {
        return createRepeatingSlide(Object.assign(Object.assign({}, AjfNodeSerializer._containerNodeFromJson(json, choicesOrigins, attachmentsOrigins)), AjfNodeSerializer._repeatingNodeFromJson(json)));
    }
    static _slideFromJson(json, choicesOrigins, attachmentsOrigins) {
        return createSlide(AjfNodeSerializer._containerNodeFromJson(json, choicesOrigins, attachmentsOrigins));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1zZXJpYWxpemVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvZm9ybXMvc2VyaWFsaXplcnMvbm9kZS1zZXJpYWxpemVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUVILE9BQU8sRUFBQyxzQkFBc0IsRUFBRSxvQkFBb0IsRUFBQyxNQUFNLGtCQUFrQixDQUFDO0FBSzlFLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxnQ0FBZ0MsQ0FBQztBQU81RCxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sOEJBQThCLENBQUM7QUFJekQsT0FBTyxFQUFpQixXQUFXLEVBQUMsTUFBTSw4QkFBOEIsQ0FBQztBQUN6RSxPQUFPLEVBQUMsc0JBQXNCLEVBQUMsTUFBTSwyQ0FBMkMsQ0FBQztBQUNqRixPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFDekQsT0FBTyxFQUFDLG1CQUFtQixFQUFDLE1BQU0sc0NBQXNDLENBQUM7QUFDekUsT0FBTyxFQUFnQixVQUFVLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQUNyRSxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sa0NBQWtDLENBQUM7QUFDakUsT0FBTyxFQUFDLG1CQUFtQixFQUFDLE1BQU0sc0NBQXNDLENBQUM7QUFDekUsT0FBTyxFQUFDLG9CQUFvQixFQUFDLE1BQU0sd0NBQXdDLENBQUM7QUFDNUUsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLDhCQUE4QixDQUFDO0FBRXpELE9BQU8sRUFBQyw0QkFBNEIsRUFBQyxNQUFNLCtCQUErQixDQUFDO0FBQzNFLE9BQU8sRUFBQyx5QkFBeUIsRUFBQyxNQUFNLDRCQUE0QixDQUFDO0FBRXJFLE1BQU0sT0FBTyxpQkFBaUI7SUFDNUIsTUFBTSxDQUFDLFFBQVEsQ0FDWCxJQUFzQixFQUN0QixjQUF3QyxFQUN4QyxrQkFBZ0Q7UUFFbEQsTUFBTSxHQUFHLEdBQUcsZ0JBQWdCLENBQUM7UUFDN0IsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUM1QixJQUFJLElBQUksQ0FBQyxFQUFFLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxFQUFFO1lBQ25FLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDdEI7UUFDRCxNQUFNLEdBQUcsR0FBRyxJQUFxQixDQUFDO1FBQ2xDLElBQUksR0FBRyxDQUFDLFVBQVUsRUFBRTtZQUNsQixHQUFHLENBQUMsVUFBVSxHQUFHLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDbEU7UUFDRCxHQUFHLENBQUMsbUJBQW1CO1lBQ25CLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pGLFFBQVEsR0FBRyxDQUFDLFFBQVEsRUFBRTtZQUNwQixLQUFLLFdBQVcsQ0FBQyxRQUFRO2dCQUN2QixPQUFPLGlCQUFpQixDQUFDLGNBQWMsQ0FDbkMsR0FBd0MsRUFDeEMsY0FBYyxFQUNkLGtCQUFrQixDQUNyQixDQUFDO1lBQ0osS0FBSyxXQUFXLENBQUMsZ0JBQWdCO2dCQUMvQixPQUFPLGlCQUFpQixDQUFDLHNCQUFzQixDQUMzQyxHQUFnRCxDQUFDLENBQUM7WUFDeEQsS0FBSyxXQUFXLENBQUMsWUFBWTtnQkFDM0IsT0FBTyxpQkFBaUIsQ0FBQyxrQkFBa0IsQ0FDdkMsR0FBNEMsRUFDNUMsY0FBYyxFQUNkLGtCQUFrQixDQUNyQixDQUFDO1lBQ0osS0FBSyxXQUFXLENBQUMsaUJBQWlCO2dCQUNoQyxPQUFPLGlCQUFpQixDQUFDLHVCQUF1QixDQUM1QyxHQUFpRCxFQUNqRCxjQUFjLEVBQ2Qsa0JBQWtCLENBQ3JCLENBQUM7WUFDSixLQUFLLFdBQVcsQ0FBQyxRQUFRO2dCQUN2QixNQUFNLFFBQVEsR0FBRyxHQUF3QyxDQUFDO2dCQUMxRCxJQUFJLFFBQVEsQ0FBQyxRQUFRLEVBQUU7b0JBQ3JCLFFBQVEsQ0FBQyxRQUFRLEdBQUcsc0JBQXNCLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztpQkFDeEU7Z0JBQ0QsT0FBTyxpQkFBaUIsQ0FBQyxjQUFjLENBQ25DLFFBQTZDLEVBQzdDLGNBQWMsRUFDZCxrQkFBa0IsQ0FDckIsQ0FBQztTQUNMO1FBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRU8sTUFBTSxDQUFDLHNCQUFzQixDQUNqQyxJQUE2QyxFQUM3QyxjQUF3QyxFQUN4QyxrQkFBZ0Q7UUFFbEQsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLO1lBQ1YsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO1FBQzlGLE9BQU8sbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVPLE1BQU0sQ0FBQyxjQUFjLENBQ3pCLElBQTZFLEVBQzdFLGNBQXdDLEVBQ3hDLGtCQUFnRDtRQUVsRCxJQUFJLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxFQUFFO1lBQzFCLE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztTQUNwQztRQUNELE1BQU0sR0FBRyxHQUFHLElBQXNCLENBQUM7UUFDbkMsSUFBSSxHQUFHLENBQUMsVUFBVSxFQUFFO1lBQ2xCLEdBQUcsQ0FBQyxVQUFVLEdBQUcsNEJBQTRCLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUN4RTtRQUNELElBQUksR0FBRyxDQUFDLE9BQU8sRUFBRTtZQUNmLEdBQUcsQ0FBQyxPQUFPLEdBQUcseUJBQXlCLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUMvRDtRQUNELElBQUksSUFBSSxDQUFDLG9CQUFvQixFQUFFO1lBQzdCLEdBQUcsQ0FBQyxnQkFBZ0I7Z0JBQ2hCLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQztTQUNoRjtRQUNELElBQUksR0FBRyxDQUFDLGtCQUFrQixFQUFFO1lBQzFCLEdBQUcsQ0FBQyxrQkFBa0IsR0FBRyxzQkFBc0IsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7U0FDbEY7UUFDRCxNQUFNLHVCQUF1QixHQUFHLEdBQUcsQ0FBQyxTQUFTLEdBQUcsR0FBRyxJQUFJLGFBQWEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSTtZQUN2RixhQUFhLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLGlCQUFpQixLQUFLLElBQUksQ0FBQztRQUM1RCxJQUFJLHVCQUF1QixFQUFFO1lBQzNCLE9BQU8saUJBQWlCLENBQUMseUJBQXlCLENBQzlDLElBQTBELEVBQzFELGNBQWMsQ0FDakIsQ0FBQztTQUNIO1FBRUQsUUFBUSxHQUFHLENBQUMsU0FBUyxFQUFFO1lBQ3JCLEtBQUssWUFBWSxDQUFDLE9BQU87Z0JBQ3ZCLE9BQU8saUJBQWlCLENBQUMscUJBQXFCLENBQzFDLElBQWlELENBQUMsQ0FBQztZQUN6RCxLQUFLLFlBQVksQ0FBQyxjQUFjLENBQUM7WUFDakMsS0FBSyxZQUFZLENBQUMsWUFBWTtnQkFDNUIsT0FBTyxpQkFBaUIsQ0FBQyx5QkFBeUIsQ0FDOUMsSUFBMEQsRUFDMUQsY0FBYyxDQUNqQixDQUFDO1NBQ0w7UUFDRCxPQUFPLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRU8sTUFBTSxDQUFDLHNCQUFzQixDQUFDLElBQ3lCO1FBQzdELHVDQUFXLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBRSxRQUFRLEVBQUUsV0FBVyxDQUFDLGdCQUFnQixJQUFFO0lBQ3ZFLENBQUM7SUFFTyxNQUFNLENBQUMseUJBQXlCLENBQ3BDLElBQTBGLEVBQzFGLGNBQXdDO1FBRTFDLE1BQU0sR0FBRyxHQUFHLDhCQUE4QixDQUFDO1FBQzNDLElBQUksSUFBSSxDQUFDLGdCQUFnQixJQUFJLElBQUksRUFBRTtZQUNqQyxNQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3RCO1FBQ0QsTUFBTSxhQUFhLEdBQUcsQ0FBQyxjQUFjLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN6RixJQUFJLGFBQWEsSUFBSSxJQUFJLEVBQUU7WUFDekIsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN0QjtRQUNELElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUN0QixJQUFJLENBQUMsYUFBYSxHQUFHLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDeEU7UUFDRCxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUMxQixJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzlGO1FBQ0QsT0FBTyxzQkFBc0IsaUNBQVUsSUFBSSxLQUFFLGFBQWEsSUFBRSxDQUFDO0lBQy9ELENBQUM7SUFFTyxNQUFNLENBQUMscUJBQXFCLENBQUMsSUFDd0I7UUFDM0QsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2hCLElBQUksQ0FBQyxPQUFPLEdBQUcsb0JBQW9CLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUM1RDtRQUNELHVDQUNLLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FDcEIsU0FBUyxFQUFFLFlBQVksQ0FBQyxPQUFPLElBQy9CO0lBQ0osQ0FBQztJQUVPLE1BQU0sQ0FBQyxrQkFBa0IsQ0FDN0IsSUFBeUMsRUFDekMsY0FBd0MsRUFDeEMsa0JBQWdEO1FBRWxELE9BQU8sZUFBZSxpQ0FDakIsaUJBQWlCLENBQUMsc0JBQXNCLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsQ0FBQyxHQUNsRixpQkFBaUIsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsRUFDakQsQ0FBQztJQUNMLENBQUM7SUFFTyxNQUFNLENBQUMsc0JBQXNCLENBQUMsSUFDeUI7UUFDN0QsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxXQUFXLEdBQUcsb0JBQW9CLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNwRTtRQUNELE9BQU8sbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVPLE1BQU0sQ0FBQyx1QkFBdUIsQ0FDbEMsSUFBOEMsRUFDOUMsY0FBd0MsRUFDeEMsa0JBQWdEO1FBRWxELE9BQU8sb0JBQW9CLGlDQUN0QixpQkFBaUIsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixDQUFDLEdBQ2xGLGlCQUFpQixDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxFQUNqRCxDQUFDO0lBQ0wsQ0FBQztJQUVPLE1BQU0sQ0FBQyxjQUFjLENBQ3pCLElBQXFDLEVBQ3JDLGNBQXdDLEVBQ3hDLGtCQUFnRDtRQUVsRCxPQUFPLFdBQVcsQ0FDZCxpQkFBaUIsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixDQUFDLENBQUMsQ0FBQztJQUMxRixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKEMpIEdudWNvb3Agc29jLiBjb29wLlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yXG4gKiBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXNcbiAqIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLFxuICogb3IgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIEdOVSBBZmZlcm9cbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGFsb25nIHdpdGggQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqIElmIG5vdCwgc2VlIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8uXG4gKlxuICovXG5cbmltcG9ydCB7QWpmQ29uZGl0aW9uU2VyaWFsaXplciwgQWpmRm9ybXVsYVNlcmlhbGl6ZXJ9IGZyb20gJ0BhamYvY29yZS9tb2RlbHMnO1xuXG5pbXBvcnQge0FqZkF0dGFjaG1lbnRzT3JpZ2lufSBmcm9tICcuLi9pbnRlcmZhY2UvYXR0YWNobWVudHMvYXR0YWNobWVudHMtb3JpZ2luJztcbmltcG9ydCB7QWpmQ2hvaWNlc09yaWdpbn0gZnJvbSAnLi4vaW50ZXJmYWNlL2Nob2ljZXMvY2hvaWNlcy1vcmlnaW4nO1xuaW1wb3J0IHtBamZGaWVsZH0gZnJvbSAnLi4vaW50ZXJmYWNlL2ZpZWxkcy9maWVsZCc7XG5pbXBvcnQge0FqZkZpZWxkVHlwZX0gZnJvbSAnLi4vaW50ZXJmYWNlL2ZpZWxkcy9maWVsZC10eXBlJztcbmltcG9ydCB7QWpmRmllbGRXaXRoQ2hvaWNlc30gZnJvbSAnLi4vaW50ZXJmYWNlL2ZpZWxkcy9maWVsZC13aXRoLWNob2ljZXMnO1xuaW1wb3J0IHtBamZGb3JtdWxhRmllbGR9IGZyb20gJy4uL2ludGVyZmFjZS9maWVsZHMvZm9ybXVsYS1maWVsZCc7XG5pbXBvcnQge0FqZkNvbnRhaW5lck5vZGV9IGZyb20gJy4uL2ludGVyZmFjZS9ub2Rlcy9jb250YWluZXItbm9kZSc7XG5pbXBvcnQge0FqZk5vZGV9IGZyb20gJy4uL2ludGVyZmFjZS9ub2Rlcy9ub2RlJztcbmltcG9ydCB7QWpmTm9kZUdyb3VwfSBmcm9tICcuLi9pbnRlcmZhY2Uvbm9kZXMvbm9kZS1ncm91cCc7XG5pbXBvcnQge0FqZkZpZWxkTm9kZUxpbmt9IGZyb20gJy4uL2ludGVyZmFjZS9ub2Rlcy9ub2RlLWxpbmsnO1xuaW1wb3J0IHtBamZOb2RlVHlwZX0gZnJvbSAnLi4vaW50ZXJmYWNlL25vZGVzL25vZGUtdHlwZSc7XG5pbXBvcnQge0FqZlJlcGVhdGluZ05vZGV9IGZyb20gJy4uL2ludGVyZmFjZS9ub2Rlcy9yZXBlYXRpbmctbm9kZSc7XG5pbXBvcnQge0FqZlJlcGVhdGluZ1NsaWRlfSBmcm9tICcuLi9pbnRlcmZhY2Uvc2xpZGVzL3JlcGVhdGluZy1zbGlkZSc7XG5pbXBvcnQge0FqZlNsaWRlfSBmcm9tICcuLi9pbnRlcmZhY2Uvc2xpZGVzL3NsaWRlJztcbmltcG9ydCB7QWpmRmllbGRDcmVhdGUsIGNyZWF0ZUZpZWxkfSBmcm9tICcuLi91dGlscy9maWVsZHMvY3JlYXRlLWZpZWxkJztcbmltcG9ydCB7Y3JlYXRlRmllbGRXaXRoQ2hvaWNlc30gZnJvbSAnLi4vdXRpbHMvZmllbGRzL2NyZWF0ZS1maWVsZC13aXRoLWNob2ljZXMnO1xuaW1wb3J0IHtjb21wb25lbnRzTWFwfSBmcm9tICcuLi91dGlscy9maWVsZHMvZmllbGRzLW1hcCc7XG5pbXBvcnQge2NyZWF0ZUNvbnRhaW5lck5vZGV9IGZyb20gJy4uL3V0aWxzL25vZGVzL2NyZWF0ZS1jb250YWluZXItbm9kZSc7XG5pbXBvcnQge0FqZk5vZGVDcmVhdGUsIGNyZWF0ZU5vZGV9IGZyb20gJy4uL3V0aWxzL25vZGVzL2NyZWF0ZS1ub2RlJztcbmltcG9ydCB7Y3JlYXRlTm9kZUdyb3VwfSBmcm9tICcuLi91dGlscy9ub2Rlcy9jcmVhdGUtbm9kZS1ncm91cCc7XG5pbXBvcnQge2NyZWF0ZVJlcGVhdGluZ05vZGV9IGZyb20gJy4uL3V0aWxzL25vZGVzL2NyZWF0ZS1yZXBlYXRpbmctbm9kZSc7XG5pbXBvcnQge2NyZWF0ZVJlcGVhdGluZ1NsaWRlfSBmcm9tICcuLi91dGlscy9zbGlkZXMvY3JlYXRlLXJlcGVhdGluZy1zbGlkZSc7XG5pbXBvcnQge2NyZWF0ZVNsaWRlfSBmcm9tICcuLi91dGlscy9zbGlkZXMvY3JlYXRlLXNsaWRlJztcblxuaW1wb3J0IHtBamZWYWxpZGF0aW9uR3JvdXBTZXJpYWxpemVyfSBmcm9tICcuL3ZhbGlkYXRpb24tZ3JvdXAtc2VyaWFsaXplcic7XG5pbXBvcnQge0FqZldhcm5pbmdHcm91cFNlcmlhbGl6ZXJ9IGZyb20gJy4vd2FybmluZy1ncm91cC1zZXJpYWxpemVyJztcblxuZXhwb3J0IGNsYXNzIEFqZk5vZGVTZXJpYWxpemVyIHtcbiAgc3RhdGljIGZyb21Kc29uKFxuICAgICAganNvbjogUGFydGlhbDxBamZOb2RlPixcbiAgICAgIGNob2ljZXNPcmlnaW5zPzogQWpmQ2hvaWNlc09yaWdpbjxhbnk+W10sXG4gICAgICBhdHRhY2htZW50c09yaWdpbnM/OiBBamZBdHRhY2htZW50c09yaWdpbjxhbnk+W10sXG4gICAgICApOiBBamZOb2RlIHtcbiAgICBjb25zdCBlcnIgPSAnTWFsZm9ybWVkIG5vZGUnO1xuICAgIGpzb24ubmFtZSA9IGpzb24ubmFtZSB8fCAnJztcbiAgICBpZiAoanNvbi5pZCA9PSBudWxsIHx8IGpzb24ucGFyZW50ID09IG51bGwgfHwganNvbi5ub2RlVHlwZSA9PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcbiAgICB9XG4gICAgY29uc3Qgb2JqID0ganNvbiBhcyBBamZOb2RlQ3JlYXRlO1xuICAgIGlmIChvYmoudmlzaWJpbGl0eSkge1xuICAgICAgb2JqLnZpc2liaWxpdHkgPSBBamZDb25kaXRpb25TZXJpYWxpemVyLmZyb21Kc29uKG9iai52aXNpYmlsaXR5KTtcbiAgICB9XG4gICAgb2JqLmNvbmRpdGlvbmFsQnJhbmNoZXMgPVxuICAgICAgICAob2JqLmNvbmRpdGlvbmFsQnJhbmNoZXMgfHwgW10pLm1hcChjID0+IEFqZkNvbmRpdGlvblNlcmlhbGl6ZXIuZnJvbUpzb24oYykpO1xuICAgIHN3aXRjaCAob2JqLm5vZGVUeXBlKSB7XG4gICAgICBjYXNlIEFqZk5vZGVUeXBlLkFqZkZpZWxkOlxuICAgICAgICByZXR1cm4gQWpmTm9kZVNlcmlhbGl6ZXIuX2ZpZWxkRnJvbUpzb24oXG4gICAgICAgICAgICBvYmogYXMgQWpmTm9kZUNyZWF0ZSAmIFBhcnRpYWw8QWpmRmllbGQ+LFxuICAgICAgICAgICAgY2hvaWNlc09yaWdpbnMsXG4gICAgICAgICAgICBhdHRhY2htZW50c09yaWdpbnMsXG4gICAgICAgICk7XG4gICAgICBjYXNlIEFqZk5vZGVUeXBlLkFqZkZpZWxkTm9kZUxpbms6XG4gICAgICAgIHJldHVybiBBamZOb2RlU2VyaWFsaXplci5fZmllbGROb2RlTGlua0Zyb21Kc29uKFxuICAgICAgICAgICAgb2JqIGFzIEFqZk5vZGVDcmVhdGUgJiBQYXJ0aWFsPEFqZkZpZWxkTm9kZUxpbms+KTtcbiAgICAgIGNhc2UgQWpmTm9kZVR5cGUuQWpmTm9kZUdyb3VwOlxuICAgICAgICByZXR1cm4gQWpmTm9kZVNlcmlhbGl6ZXIuX25vZGVHcm91cEZyb21Kc29uKFxuICAgICAgICAgICAgb2JqIGFzIEFqZk5vZGVDcmVhdGUgJiBQYXJ0aWFsPEFqZk5vZGVHcm91cD4sXG4gICAgICAgICAgICBjaG9pY2VzT3JpZ2lucyxcbiAgICAgICAgICAgIGF0dGFjaG1lbnRzT3JpZ2lucyxcbiAgICAgICAgKTtcbiAgICAgIGNhc2UgQWpmTm9kZVR5cGUuQWpmUmVwZWF0aW5nU2xpZGU6XG4gICAgICAgIHJldHVybiBBamZOb2RlU2VyaWFsaXplci5fcmVwZWF0aW5nU2xpZGVGcm9tSnNvbihcbiAgICAgICAgICAgIG9iaiBhcyBBamZOb2RlQ3JlYXRlICYgUGFydGlhbDxBamZSZXBlYXRpbmdTbGlkZT4sXG4gICAgICAgICAgICBjaG9pY2VzT3JpZ2lucyxcbiAgICAgICAgICAgIGF0dGFjaG1lbnRzT3JpZ2lucyxcbiAgICAgICAgKTtcbiAgICAgIGNhc2UgQWpmTm9kZVR5cGUuQWpmU2xpZGU6XG4gICAgICAgIGNvbnN0IHNsaWRlT2JqID0gb2JqIGFzIEFqZk5vZGVDcmVhdGUgJiBQYXJ0aWFsPEFqZlNsaWRlPjtcbiAgICAgICAgaWYgKHNsaWRlT2JqLnJlYWRvbmx5KSB7XG4gICAgICAgICAgc2xpZGVPYmoucmVhZG9ubHkgPSBBamZDb25kaXRpb25TZXJpYWxpemVyLmZyb21Kc29uKHNsaWRlT2JqLnJlYWRvbmx5KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gQWpmTm9kZVNlcmlhbGl6ZXIuX3NsaWRlRnJvbUpzb24oXG4gICAgICAgICAgICBzbGlkZU9iaiBhcyBBamZOb2RlQ3JlYXRlICYgUGFydGlhbDxBamZTbGlkZT4sXG4gICAgICAgICAgICBjaG9pY2VzT3JpZ2lucyxcbiAgICAgICAgICAgIGF0dGFjaG1lbnRzT3JpZ2lucyxcbiAgICAgICAgKTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGVycik7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBfY29udGFpbmVyTm9kZUZyb21Kc29uKFxuICAgICAganNvbjogQWpmTm9kZUNyZWF0ZSZQYXJ0aWFsPEFqZkNvbnRhaW5lck5vZGU+LFxuICAgICAgY2hvaWNlc09yaWdpbnM/OiBBamZDaG9pY2VzT3JpZ2luPGFueT5bXSxcbiAgICAgIGF0dGFjaG1lbnRzT3JpZ2lucz86IEFqZkF0dGFjaG1lbnRzT3JpZ2luPGFueT5bXSxcbiAgICAgICk6IEFqZkNvbnRhaW5lck5vZGUge1xuICAgIGpzb24ubm9kZXMgPSAoanNvbi5ub2RlcyB8fFxuICAgICAgICAgICAgICAgICAgW10pLm1hcChuID0+IEFqZk5vZGVTZXJpYWxpemVyLmZyb21Kc29uKG4sIGNob2ljZXNPcmlnaW5zLCBhdHRhY2htZW50c09yaWdpbnMpKTtcbiAgICByZXR1cm4gY3JlYXRlQ29udGFpbmVyTm9kZShqc29uKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIF9maWVsZEZyb21Kc29uKFxuICAgICAganNvbjogQWpmTm9kZUNyZWF0ZSZQYXJ0aWFsPEFqZkZpZWxkPiZQYXJ0aWFsPHthdHRhY2htZW50c09yaWdpblJlZjogc3RyaW5nfT4sXG4gICAgICBjaG9pY2VzT3JpZ2lucz86IEFqZkNob2ljZXNPcmlnaW48YW55PltdLFxuICAgICAgYXR0YWNobWVudHNPcmlnaW5zPzogQWpmQXR0YWNobWVudHNPcmlnaW48YW55PltdLFxuICAgICAgKTogQWpmRmllbGQge1xuICAgIGlmIChqc29uLmZpZWxkVHlwZSA9PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ01hbGZvcm1lZCBmaWVsZCcpO1xuICAgIH1cbiAgICBjb25zdCBvYmogPSBqc29uIGFzIEFqZkZpZWxkQ3JlYXRlO1xuICAgIGlmIChvYmoudmFsaWRhdGlvbikge1xuICAgICAgb2JqLnZhbGlkYXRpb24gPSBBamZWYWxpZGF0aW9uR3JvdXBTZXJpYWxpemVyLmZyb21Kc29uKG9iai52YWxpZGF0aW9uKTtcbiAgICB9XG4gICAgaWYgKG9iai53YXJuaW5nKSB7XG4gICAgICBvYmoud2FybmluZyA9IEFqZldhcm5pbmdHcm91cFNlcmlhbGl6ZXIuZnJvbUpzb24ob2JqLndhcm5pbmcpO1xuICAgIH1cbiAgICBpZiAoanNvbi5hdHRhY2htZW50c09yaWdpblJlZikge1xuICAgICAgb2JqLmF0dGFjaG1lbnRPcmlnaW4gPVxuICAgICAgICAgIChhdHRhY2htZW50c09yaWdpbnMgfHwgW10pLmZpbmQoYSA9PiBhLm5hbWUgPT09IGpzb24uYXR0YWNobWVudHNPcmlnaW5SZWYpO1xuICAgIH1cbiAgICBpZiAob2JqLm5leHRTbGlkZUNvbmRpdGlvbikge1xuICAgICAgb2JqLm5leHRTbGlkZUNvbmRpdGlvbiA9IEFqZkNvbmRpdGlvblNlcmlhbGl6ZXIuZnJvbUpzb24ob2JqLm5leHRTbGlkZUNvbmRpdGlvbik7XG4gICAgfVxuICAgIGNvbnN0IGlzQ3VzdG9tRmllbGRXaXRoQ2hvaWNlID0gb2JqLmZpZWxkVHlwZSA+IDEwMCAmJiBjb21wb25lbnRzTWFwW29iai5maWVsZFR5cGVdICE9IG51bGwgJiZcbiAgICAgICAgY29tcG9uZW50c01hcFtvYmouZmllbGRUeXBlXS5pc0ZpZWxkV2l0aENob2ljZSA9PT0gdHJ1ZTtcbiAgICBpZiAoaXNDdXN0b21GaWVsZFdpdGhDaG9pY2UpIHtcbiAgICAgIHJldHVybiBBamZOb2RlU2VyaWFsaXplci5fZmllbGRXaXRoQ2hvaWNlc0Zyb21Kc29uKFxuICAgICAgICAgIGpzb24gYXMgQWpmRmllbGRDcmVhdGUgJiBQYXJ0aWFsPEFqZkZpZWxkV2l0aENob2ljZXM8YW55Pj4sXG4gICAgICAgICAgY2hvaWNlc09yaWdpbnMsXG4gICAgICApO1xuICAgIH1cblxuICAgIHN3aXRjaCAob2JqLmZpZWxkVHlwZSkge1xuICAgICAgY2FzZSBBamZGaWVsZFR5cGUuRm9ybXVsYTpcbiAgICAgICAgcmV0dXJuIEFqZk5vZGVTZXJpYWxpemVyLl9mb3JtdWxhRmllbGRGcm9tSnNvbihcbiAgICAgICAgICAgIGpzb24gYXMgQWpmRmllbGRDcmVhdGUgJiBQYXJ0aWFsPEFqZkZvcm11bGFGaWVsZD4pO1xuICAgICAgY2FzZSBBamZGaWVsZFR5cGUuTXVsdGlwbGVDaG9pY2U6XG4gICAgICBjYXNlIEFqZkZpZWxkVHlwZS5TaW5nbGVDaG9pY2U6XG4gICAgICAgIHJldHVybiBBamZOb2RlU2VyaWFsaXplci5fZmllbGRXaXRoQ2hvaWNlc0Zyb21Kc29uKFxuICAgICAgICAgICAganNvbiBhcyBBamZGaWVsZENyZWF0ZSAmIFBhcnRpYWw8QWpmRmllbGRXaXRoQ2hvaWNlczxhbnk+PixcbiAgICAgICAgICAgIGNob2ljZXNPcmlnaW5zLFxuICAgICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gY3JlYXRlRmllbGQob2JqKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIF9maWVsZE5vZGVMaW5rRnJvbUpzb24oanNvbjogQWpmTm9kZUNyZWF0ZSZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQYXJ0aWFsPEFqZkZpZWxkTm9kZUxpbms+KTogQWpmRmllbGROb2RlTGluayB7XG4gICAgcmV0dXJuIHsuLi5jcmVhdGVOb2RlKGpzb24pLCBub2RlVHlwZTogQWpmTm9kZVR5cGUuQWpmRmllbGROb2RlTGlua307XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBfZmllbGRXaXRoQ2hvaWNlc0Zyb21Kc29uKFxuICAgICAganNvbjogQWpmRmllbGRDcmVhdGUmUGFydGlhbDxBamZGaWVsZFdpdGhDaG9pY2VzPGFueT4+JlBhcnRpYWw8e2Nob2ljZXNPcmlnaW5SZWY6IHN0cmluZ30+LFxuICAgICAgY2hvaWNlc09yaWdpbnM/OiBBamZDaG9pY2VzT3JpZ2luPGFueT5bXSxcbiAgICAgICk6IEFqZkZpZWxkV2l0aENob2ljZXM8YW55PiB7XG4gICAgY29uc3QgZXJyID0gJ01hbGZvcm1lZCBmaWVsZCB3aXRoIGNob2ljZXMnO1xuICAgIGlmIChqc29uLmNob2ljZXNPcmlnaW5SZWYgPT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycik7XG4gICAgfVxuICAgIGNvbnN0IGNob2ljZXNPcmlnaW4gPSAoY2hvaWNlc09yaWdpbnMgfHwgW10pLmZpbmQoYyA9PiBjLm5hbWUgPT09IGpzb24uY2hvaWNlc09yaWdpblJlZik7XG4gICAgaWYgKGNob2ljZXNPcmlnaW4gPT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycik7XG4gICAgfVxuICAgIGlmIChqc29uLmNob2ljZXNGaWx0ZXIpIHtcbiAgICAgIGpzb24uY2hvaWNlc0ZpbHRlciA9IEFqZkZvcm11bGFTZXJpYWxpemVyLmZyb21Kc29uKGpzb24uY2hvaWNlc0ZpbHRlcik7XG4gICAgfVxuICAgIGlmIChqc29uLnRyaWdnZXJDb25kaXRpb25zKSB7XG4gICAgICBqc29uLnRyaWdnZXJDb25kaXRpb25zID0ganNvbi50cmlnZ2VyQ29uZGl0aW9ucy5tYXAodCA9PiBBamZDb25kaXRpb25TZXJpYWxpemVyLmZyb21Kc29uKHQpKTtcbiAgICB9XG4gICAgcmV0dXJuIGNyZWF0ZUZpZWxkV2l0aENob2ljZXM8YW55Pih7Li4uanNvbiwgY2hvaWNlc09yaWdpbn0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgX2Zvcm11bGFGaWVsZEZyb21Kc29uKGpzb246IEFqZkZpZWxkQ3JlYXRlJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUGFydGlhbDxBamZGb3JtdWxhRmllbGQ+KTogQWpmRm9ybXVsYUZpZWxkIHtcbiAgICBpZiAoanNvbi5mb3JtdWxhKSB7XG4gICAgICBqc29uLmZvcm11bGEgPSBBamZGb3JtdWxhU2VyaWFsaXplci5mcm9tSnNvbihqc29uLmZvcm11bGEpO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgLi4uY3JlYXRlRmllbGQoanNvbiksXG4gICAgICBmaWVsZFR5cGU6IEFqZkZpZWxkVHlwZS5Gb3JtdWxhLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBfbm9kZUdyb3VwRnJvbUpzb24oXG4gICAgICBqc29uOiBBamZOb2RlQ3JlYXRlJlBhcnRpYWw8QWpmTm9kZUdyb3VwPixcbiAgICAgIGNob2ljZXNPcmlnaW5zPzogQWpmQ2hvaWNlc09yaWdpbjxhbnk+W10sXG4gICAgICBhdHRhY2htZW50c09yaWdpbnM/OiBBamZBdHRhY2htZW50c09yaWdpbjxhbnk+W10sXG4gICAgICApOiBBamZOb2RlR3JvdXAge1xuICAgIHJldHVybiBjcmVhdGVOb2RlR3JvdXAoe1xuICAgICAgLi4uQWpmTm9kZVNlcmlhbGl6ZXIuX2NvbnRhaW5lck5vZGVGcm9tSnNvbihqc29uLCBjaG9pY2VzT3JpZ2lucywgYXR0YWNobWVudHNPcmlnaW5zKSxcbiAgICAgIC4uLkFqZk5vZGVTZXJpYWxpemVyLl9yZXBlYXRpbmdOb2RlRnJvbUpzb24oanNvbiksXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBfcmVwZWF0aW5nTm9kZUZyb21Kc29uKGpzb246IEFqZk5vZGVDcmVhdGUmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUGFydGlhbDxBamZSZXBlYXRpbmdOb2RlPik6IEFqZlJlcGVhdGluZ05vZGUge1xuICAgIGlmIChqc29uLmZvcm11bGFSZXBzKSB7XG4gICAgICBqc29uLmZvcm11bGFSZXBzID0gQWpmRm9ybXVsYVNlcmlhbGl6ZXIuZnJvbUpzb24oanNvbi5mb3JtdWxhUmVwcyk7XG4gICAgfVxuICAgIHJldHVybiBjcmVhdGVSZXBlYXRpbmdOb2RlKGpzb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgX3JlcGVhdGluZ1NsaWRlRnJvbUpzb24oXG4gICAgICBqc29uOiBBamZOb2RlQ3JlYXRlJlBhcnRpYWw8QWpmUmVwZWF0aW5nU2xpZGU+LFxuICAgICAgY2hvaWNlc09yaWdpbnM/OiBBamZDaG9pY2VzT3JpZ2luPGFueT5bXSxcbiAgICAgIGF0dGFjaG1lbnRzT3JpZ2lucz86IEFqZkF0dGFjaG1lbnRzT3JpZ2luPGFueT5bXSxcbiAgICAgICk6IEFqZlJlcGVhdGluZ1NsaWRlIHtcbiAgICByZXR1cm4gY3JlYXRlUmVwZWF0aW5nU2xpZGUoe1xuICAgICAgLi4uQWpmTm9kZVNlcmlhbGl6ZXIuX2NvbnRhaW5lck5vZGVGcm9tSnNvbihqc29uLCBjaG9pY2VzT3JpZ2lucywgYXR0YWNobWVudHNPcmlnaW5zKSxcbiAgICAgIC4uLkFqZk5vZGVTZXJpYWxpemVyLl9yZXBlYXRpbmdOb2RlRnJvbUpzb24oanNvbiksXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBfc2xpZGVGcm9tSnNvbihcbiAgICAgIGpzb246IEFqZk5vZGVDcmVhdGUmUGFydGlhbDxBamZTbGlkZT4sXG4gICAgICBjaG9pY2VzT3JpZ2lucz86IEFqZkNob2ljZXNPcmlnaW48YW55PltdLFxuICAgICAgYXR0YWNobWVudHNPcmlnaW5zPzogQWpmQXR0YWNobWVudHNPcmlnaW48YW55PltdLFxuICAgICAgKTogQWpmU2xpZGUge1xuICAgIHJldHVybiBjcmVhdGVTbGlkZShcbiAgICAgICAgQWpmTm9kZVNlcmlhbGl6ZXIuX2NvbnRhaW5lck5vZGVGcm9tSnNvbihqc29uLCBjaG9pY2VzT3JpZ2lucywgYXR0YWNobWVudHNPcmlnaW5zKSk7XG4gIH1cbn1cbiJdfQ==