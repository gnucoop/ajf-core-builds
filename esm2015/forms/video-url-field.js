/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { HttpClient } from '@angular/common/http';
import { ChangeDetectorRef, Inject } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { of as obsOf } from 'rxjs';
import { catchError, filter, map, startWith, switchMap } from 'rxjs/operators';
import { AjfBaseFieldComponent } from './base-field';
import { AjfFormRendererService } from './form-renderer';
import { AJF_WARNING_ALERT_SERVICE } from './warning-alert-service';
let AjfVideoUrlFieldComponent = /** @class */ (() => {
    class AjfVideoUrlFieldComponent extends AjfBaseFieldComponent {
        constructor(cdr, service, was, domSanitizer, httpClient) {
            super(cdr, service, was);
            const video = this.control.pipe(filter(control => control != null), switchMap(control => {
                control = control;
                return control.valueChanges.pipe(startWith(control.value));
            }), filter(value => value != null), map(value => getVideoProviderAndId(value)));
            this.validUrl = video.pipe(map(v => v != null));
            this.videoThumbnail = video.pipe(filter(info => info != null), switchMap(info => videoPreviewUrl(httpClient, info)), filter(url => url != null), map(url => domSanitizer.bypassSecurityTrustResourceUrl(url)));
        }
    }
    AjfVideoUrlFieldComponent.ctorParameters = () => [
        { type: ChangeDetectorRef },
        { type: AjfFormRendererService },
        { type: undefined, decorators: [{ type: Inject, args: [AJF_WARNING_ALERT_SERVICE,] }] },
        { type: DomSanitizer },
        { type: HttpClient }
    ];
    return AjfVideoUrlFieldComponent;
})();
export { AjfVideoUrlFieldComponent };
function videoPreviewUrl(httpClient, video) {
    if (video.provider === 'youtube') {
        return obsOf(`https://img.youtube.com/vi/${video.id}/default.jpg`);
    }
    if (video.provider === 'vimeo') {
        return httpClient
            .get(`https://vimeo.com/api/oembed.json?url=https://vimeo.com/${video.id}`)
            .pipe(map(response => response.thumbnail_url), catchError(() => obsOf(null)));
    }
    return obsOf('');
}
function getVideoProviderAndId(url) {
    let provider = null;
    let id = null;
    if (/youtube|youtu\.be|y2u\.be|i.ytimg\./.test(url)) {
        provider = 'youtube';
        id = getYouTubeVideoId(url);
    }
    else if (/vimeo/.test(url)) {
        provider = 'vimeo';
        id = getVimeoVideoId(url);
    }
    if (provider == null || id == null) {
        return null;
    }
    return { provider, id };
}
function getVimeoVideoId(url) {
    if (url.indexOf('#') > -1) {
        url = url.split('#')[0];
    }
    if (url.indexOf('?') > -1 && url.indexOf('clip_id=') === -1) {
        url = url.split('?')[0];
    }
    let id = null;
    let arr;
    const vimeoPipe = [
        'https?:\/\/vimeo\.com\/[0-9]+$', 'https?:\/\/player\.vimeo\.com\/video\/[0-9]+$',
        'https?:\/\/vimeo\.com\/channels', 'groups', 'album'
    ].join('|');
    const vimeoRegex = new RegExp(vimeoPipe, 'gim');
    if (vimeoRegex.test(url)) {
        arr = url.split('/');
        if (arr && arr.length) {
            id = arr.pop();
        }
    }
    else if (/clip_id=/gim.test(url)) {
        arr = url.split('clip_id=');
        if (arr && arr.length) {
            id = arr[1].split('&')[0];
        }
    }
    return id;
}
function getYouTubeVideoId(url) {
    const shortcode = /youtube:\/\/|https?:\/\/youtu\.be\/|http:\/\/y2u\.be\//g;
    if (shortcode.test(url)) {
        const shortcodeId = url.split(shortcode)[1];
        return stripParameters(shortcodeId);
    }
    // /v/ or /vi/
    const inlinev = /\/v\/|\/vi\//g;
    if (inlinev.test(url)) {
        const inlineId = url.split(inlinev)[1];
        return stripParameters(inlineId);
    }
    // v= or vi=
    const parameterV = /v=|vi=/g;
    if (parameterV.test(url)) {
        const arr = url.split(parameterV);
        return arr[1].split('&')[0];
    }
    // v= or vi=
    const parameterWebp = /\/an_webp\//g;
    if (parameterWebp.test(url)) {
        const webp = url.split(parameterWebp)[1];
        return stripParameters(webp);
    }
    // embed
    const embedReg = /\/embed\//g;
    if (embedReg.test(url)) {
        const embedId = url.split(embedReg)[1];
        return stripParameters(embedId);
    }
    // ignore /user/username pattern
    const usernameReg = /\/user\/([a-zA-Z0-9]*)$/g;
    if (usernameReg.test(url)) {
        return null;
    }
    // user
    const userReg = /\/user\/(?!.*videos)/g;
    if (userReg.test(url)) {
        const elements = url.split('/');
        return stripParameters(elements.pop());
    }
    // attribution_link
    const attrReg = /\/attribution_link\?.*v%3D([^%&]*)(%26|&|$)/;
    if (attrReg.test(url)) {
        return url.match(attrReg)[1];
    }
    return null;
}
function stripParameters(url) {
    // Split parameters or split folder separator
    if (url.indexOf('?') > -1) {
        return url.split('?')[0];
    }
    else if (url.indexOf('/') > -1) {
        return url.split('/')[0];
    }
    return url;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlkZW8tdXJsLWZpZWxkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvZm9ybXMvdmlkZW8tdXJsLWZpZWxkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUVILE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUNoRCxPQUFPLEVBQUMsaUJBQWlCLEVBQUUsTUFBTSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBRXhELE9BQU8sRUFBQyxZQUFZLEVBQWtCLE1BQU0sMkJBQTJCLENBQUM7QUFDeEUsT0FBTyxFQUFhLEVBQUUsSUFBSSxLQUFLLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUU3RSxPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFDbkQsT0FBTyxFQUFDLHNCQUFzQixFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDdkQsT0FBTyxFQUFDLHlCQUF5QixFQUF5QixNQUFNLHlCQUF5QixDQUFDO0FBUzFGO0lBQUEsTUFBYSx5QkFBMEIsU0FBUSxxQkFBcUI7UUFJbEUsWUFDSSxHQUFzQixFQUFFLE9BQStCLEVBQ3BCLEdBQTJCLEVBQUUsWUFBMEIsRUFDMUYsVUFBc0I7WUFDeEIsS0FBSyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFekIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQzNCLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsRUFDbEMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNsQixPQUFPLEdBQUcsT0FBc0IsQ0FBQztnQkFDakMs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O0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChDKSBHbnVjb29wIHNvYy4gY29vcC5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vclxuICogbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzXG4gKiBwdWJsaXNoZWQgYnkgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSxcbiAqIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlUgQWZmZXJvXG4gKiBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKiBJZiBub3QsIHNlZSBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvLlxuICpcbiAqL1xuXG5pbXBvcnQge0h0dHBDbGllbnR9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7Q2hhbmdlRGV0ZWN0b3JSZWYsIEluamVjdH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0Zvcm1Db250cm9sfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQge0RvbVNhbml0aXplciwgU2FmZVJlc291cmNlVXJsfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgb2YgYXMgb2JzT2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtjYXRjaEVycm9yLCBmaWx0ZXIsIG1hcCwgc3RhcnRXaXRoLCBzd2l0Y2hNYXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHtBamZCYXNlRmllbGRDb21wb25lbnR9IGZyb20gJy4vYmFzZS1maWVsZCc7XG5pbXBvcnQge0FqZkZvcm1SZW5kZXJlclNlcnZpY2V9IGZyb20gJy4vZm9ybS1yZW5kZXJlcic7XG5pbXBvcnQge0FKRl9XQVJOSU5HX0FMRVJUX1NFUlZJQ0UsIEFqZldhcm5pbmdBbGVydFNlcnZpY2V9IGZyb20gJy4vd2FybmluZy1hbGVydC1zZXJ2aWNlJztcblxuZXhwb3J0IHR5cGUgQWpmVmlkZW9Qcm92aWRlciA9ICd5b3V0dWJlJ3wndmltZW8nO1xuXG5pbnRlcmZhY2UgVmlkZW9JbmZvIHtcbiAgcHJvdmlkZXI6IEFqZlZpZGVvUHJvdmlkZXI7XG4gIGlkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBBamZWaWRlb1VybEZpZWxkQ29tcG9uZW50IGV4dGVuZHMgQWpmQmFzZUZpZWxkQ29tcG9uZW50IHtcbiAgcmVhZG9ubHkgdmFsaWRVcmw6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIHJlYWRvbmx5IHZpZGVvVGh1bWJuYWlsOiBPYnNlcnZhYmxlPFNhZmVSZXNvdXJjZVVybD47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICBjZHI6IENoYW5nZURldGVjdG9yUmVmLCBzZXJ2aWNlOiBBamZGb3JtUmVuZGVyZXJTZXJ2aWNlLFxuICAgICAgQEluamVjdChBSkZfV0FSTklOR19BTEVSVF9TRVJWSUNFKSB3YXM6IEFqZldhcm5pbmdBbGVydFNlcnZpY2UsIGRvbVNhbml0aXplcjogRG9tU2FuaXRpemVyLFxuICAgICAgaHR0cENsaWVudDogSHR0cENsaWVudCkge1xuICAgIHN1cGVyKGNkciwgc2VydmljZSwgd2FzKTtcblxuICAgIGNvbnN0IHZpZGVvID0gdGhpcy5jb250cm9sLnBpcGUoXG4gICAgICAgIGZpbHRlcihjb250cm9sID0+IGNvbnRyb2wgIT0gbnVsbCksXG4gICAgICAgIHN3aXRjaE1hcChjb250cm9sID0+IHtcbiAgICAgICAgICBjb250cm9sID0gY29udHJvbCBhcyBGb3JtQ29udHJvbDtcbiAgICAgICAgICByZXR1cm4gY29udHJvbC52YWx1ZUNoYW5nZXMucGlwZShcbiAgICAgICAgICAgICAgc3RhcnRXaXRoKGNvbnRyb2wudmFsdWUpLFxuICAgICAgICAgICk7XG4gICAgICAgIH0pLFxuICAgICAgICBmaWx0ZXIodmFsdWUgPT4gdmFsdWUgIT0gbnVsbCksXG4gICAgICAgIG1hcCh2YWx1ZSA9PiBnZXRWaWRlb1Byb3ZpZGVyQW5kSWQodmFsdWUpKSxcbiAgICApO1xuICAgIHRoaXMudmFsaWRVcmwgPSB2aWRlby5waXBlKG1hcCh2ID0+IHYgIT0gbnVsbCkpO1xuICAgIHRoaXMudmlkZW9UaHVtYm5haWwgPSB2aWRlby5waXBlKFxuICAgICAgICBmaWx0ZXIoaW5mbyA9PiBpbmZvICE9IG51bGwpLFxuICAgICAgICBzd2l0Y2hNYXAoaW5mbyA9PiB2aWRlb1ByZXZpZXdVcmwoaHR0cENsaWVudCwgaW5mbyBhcyBWaWRlb0luZm8pKSxcbiAgICAgICAgZmlsdGVyKHVybCA9PiB1cmwgIT0gbnVsbCksXG4gICAgICAgIG1hcCh1cmwgPT4gZG9tU2FuaXRpemVyLmJ5cGFzc1NlY3VyaXR5VHJ1c3RSZXNvdXJjZVVybCh1cmwgYXMgc3RyaW5nKSksXG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB2aWRlb1ByZXZpZXdVcmwoaHR0cENsaWVudDogSHR0cENsaWVudCwgdmlkZW86IFZpZGVvSW5mbyk6IE9ic2VydmFibGU8c3RyaW5nfG51bGw+IHtcbiAgaWYgKHZpZGVvLnByb3ZpZGVyID09PSAneW91dHViZScpIHtcbiAgICByZXR1cm4gb2JzT2YoYGh0dHBzOi8vaW1nLnlvdXR1YmUuY29tL3ZpLyR7dmlkZW8uaWR9L2RlZmF1bHQuanBnYCk7XG4gIH1cbiAgaWYgKHZpZGVvLnByb3ZpZGVyID09PSAndmltZW8nKSB7XG4gICAgcmV0dXJuIGh0dHBDbGllbnRcbiAgICAgICAgLmdldDx7dGh1bWJuYWlsX3VybDogc3RyaW5nfT4oXG4gICAgICAgICAgICBgaHR0cHM6Ly92aW1lby5jb20vYXBpL29lbWJlZC5qc29uP3VybD1odHRwczovL3ZpbWVvLmNvbS8ke3ZpZGVvLmlkfWApXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgICAgbWFwKHJlc3BvbnNlID0+IHJlc3BvbnNlLnRodW1ibmFpbF91cmwpLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvYnNPZihudWxsKSksXG4gICAgICAgICk7XG4gIH1cbiAgcmV0dXJuIG9ic09mKCcnKTtcbn1cblxuZnVuY3Rpb24gZ2V0VmlkZW9Qcm92aWRlckFuZElkKHVybDogc3RyaW5nKTogVmlkZW9JbmZvfG51bGwge1xuICBsZXQgcHJvdmlkZXI6IEFqZlZpZGVvUHJvdmlkZXJ8bnVsbCA9IG51bGw7XG4gIGxldCBpZDogc3RyaW5nfG51bGwgPSBudWxsO1xuICBpZiAoL3lvdXR1YmV8eW91dHVcXC5iZXx5MnVcXC5iZXxpLnl0aW1nXFwuLy50ZXN0KHVybCkpIHtcbiAgICBwcm92aWRlciA9ICd5b3V0dWJlJztcbiAgICBpZCA9IGdldFlvdVR1YmVWaWRlb0lkKHVybCk7XG4gIH0gZWxzZSBpZiAoL3ZpbWVvLy50ZXN0KHVybCkpIHtcbiAgICBwcm92aWRlciA9ICd2aW1lbyc7XG4gICAgaWQgPSBnZXRWaW1lb1ZpZGVvSWQodXJsKTtcbiAgfVxuICBpZiAocHJvdmlkZXIgPT0gbnVsbCB8fCBpZCA9PSBudWxsKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgcmV0dXJuIHtwcm92aWRlciwgaWR9O1xufVxuXG5mdW5jdGlvbiBnZXRWaW1lb1ZpZGVvSWQodXJsOiBzdHJpbmcpOiBzdHJpbmd8bnVsbCB7XG4gIGlmICh1cmwuaW5kZXhPZignIycpID4gLTEpIHtcbiAgICB1cmwgPSB1cmwuc3BsaXQoJyMnKVswXTtcbiAgfVxuICBpZiAodXJsLmluZGV4T2YoJz8nKSA+IC0xICYmIHVybC5pbmRleE9mKCdjbGlwX2lkPScpID09PSAtMSkge1xuICAgIHVybCA9IHVybC5zcGxpdCgnPycpWzBdO1xuICB9XG5cbiAgbGV0IGlkOiBzdHJpbmd8bnVsbCA9IG51bGw7XG4gIGxldCBhcnI6IHN0cmluZ1tdO1xuXG4gIGNvbnN0IHZpbWVvUGlwZSA9IFtcbiAgICAnaHR0cHM/OlxcL1xcL3ZpbWVvXFwuY29tXFwvWzAtOV0rJCcsICdodHRwcz86XFwvXFwvcGxheWVyXFwudmltZW9cXC5jb21cXC92aWRlb1xcL1swLTldKyQnLFxuICAgICdodHRwcz86XFwvXFwvdmltZW9cXC5jb21cXC9jaGFubmVscycsICdncm91cHMnLCAnYWxidW0nXG4gIF0uam9pbignfCcpO1xuXG4gIGNvbnN0IHZpbWVvUmVnZXggPSBuZXcgUmVnRXhwKHZpbWVvUGlwZSwgJ2dpbScpO1xuXG4gIGlmICh2aW1lb1JlZ2V4LnRlc3QodXJsKSkge1xuICAgIGFyciA9IHVybC5zcGxpdCgnLycpO1xuICAgIGlmIChhcnIgJiYgYXJyLmxlbmd0aCkge1xuICAgICAgaWQgPSBhcnIucG9wKCkgYXMgc3RyaW5nO1xuICAgIH1cbiAgfSBlbHNlIGlmICgvY2xpcF9pZD0vZ2ltLnRlc3QodXJsKSkge1xuICAgIGFyciA9IHVybC5zcGxpdCgnY2xpcF9pZD0nKTtcbiAgICBpZiAoYXJyICYmIGFyci5sZW5ndGgpIHtcbiAgICAgIGlkID0gYXJyWzFdLnNwbGl0KCcmJylbMF07XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGlkO1xufVxuXG5mdW5jdGlvbiBnZXRZb3VUdWJlVmlkZW9JZCh1cmw6IHN0cmluZyk6IHN0cmluZ3xudWxsIHtcbiAgY29uc3Qgc2hvcnRjb2RlID0gL3lvdXR1YmU6XFwvXFwvfGh0dHBzPzpcXC9cXC95b3V0dVxcLmJlXFwvfGh0dHA6XFwvXFwveTJ1XFwuYmVcXC8vZztcbiAgaWYgKHNob3J0Y29kZS50ZXN0KHVybCkpIHtcbiAgICBjb25zdCBzaG9ydGNvZGVJZCA9IHVybC5zcGxpdChzaG9ydGNvZGUpWzFdO1xuICAgIHJldHVybiBzdHJpcFBhcmFtZXRlcnMoc2hvcnRjb2RlSWQpO1xuICB9XG4gIC8vIC92LyBvciAvdmkvXG4gIGNvbnN0IGlubGluZXYgPSAvXFwvdlxcL3xcXC92aVxcLy9nO1xuXG4gIGlmIChpbmxpbmV2LnRlc3QodXJsKSkge1xuICAgIGNvbnN0IGlubGluZUlkID0gdXJsLnNwbGl0KGlubGluZXYpWzFdO1xuICAgIHJldHVybiBzdHJpcFBhcmFtZXRlcnMoaW5saW5lSWQpO1xuICB9XG5cbiAgLy8gdj0gb3Igdmk9XG4gIGNvbnN0IHBhcmFtZXRlclYgPSAvdj18dmk9L2c7XG5cbiAgaWYgKHBhcmFtZXRlclYudGVzdCh1cmwpKSB7XG4gICAgY29uc3QgYXJyID0gdXJsLnNwbGl0KHBhcmFtZXRlclYpO1xuICAgIHJldHVybiBhcnJbMV0uc3BsaXQoJyYnKVswXTtcbiAgfVxuXG4gIC8vIHY9IG9yIHZpPVxuICBjb25zdCBwYXJhbWV0ZXJXZWJwID0gL1xcL2FuX3dlYnBcXC8vZztcblxuICBpZiAocGFyYW1ldGVyV2VicC50ZXN0KHVybCkpIHtcbiAgICBjb25zdCB3ZWJwID0gdXJsLnNwbGl0KHBhcmFtZXRlcldlYnApWzFdO1xuICAgIHJldHVybiBzdHJpcFBhcmFtZXRlcnMod2VicCk7XG4gIH1cblxuICAvLyBlbWJlZFxuICBjb25zdCBlbWJlZFJlZyA9IC9cXC9lbWJlZFxcLy9nO1xuXG4gIGlmIChlbWJlZFJlZy50ZXN0KHVybCkpIHtcbiAgICBjb25zdCBlbWJlZElkID0gdXJsLnNwbGl0KGVtYmVkUmVnKVsxXTtcbiAgICByZXR1cm4gc3RyaXBQYXJhbWV0ZXJzKGVtYmVkSWQpO1xuICB9XG5cbiAgLy8gaWdub3JlIC91c2VyL3VzZXJuYW1lIHBhdHRlcm5cbiAgY29uc3QgdXNlcm5hbWVSZWcgPSAvXFwvdXNlclxcLyhbYS16QS1aMC05XSopJC9nO1xuXG4gIGlmICh1c2VybmFtZVJlZy50ZXN0KHVybCkpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8vIHVzZXJcbiAgY29uc3QgdXNlclJlZyA9IC9cXC91c2VyXFwvKD8hLip2aWRlb3MpL2c7XG5cbiAgaWYgKHVzZXJSZWcudGVzdCh1cmwpKSB7XG4gICAgY29uc3QgZWxlbWVudHMgPSB1cmwuc3BsaXQoJy8nKTtcbiAgICByZXR1cm4gc3RyaXBQYXJhbWV0ZXJzKGVsZW1lbnRzLnBvcCgpIGFzIHN0cmluZyk7XG4gIH1cblxuICAvLyBhdHRyaWJ1dGlvbl9saW5rXG4gIGNvbnN0IGF0dHJSZWcgPSAvXFwvYXR0cmlidXRpb25fbGlua1xcPy4qdiUzRChbXiUmXSopKCUyNnwmfCQpLztcblxuICBpZiAoYXR0clJlZy50ZXN0KHVybCkpIHtcbiAgICByZXR1cm4gKHVybC5tYXRjaChhdHRyUmVnKSBhcyBzdHJpbmdbXSlbMV07XG4gIH1cblxuICByZXR1cm4gbnVsbDtcbn1cblxuZnVuY3Rpb24gc3RyaXBQYXJhbWV0ZXJzKHVybDogc3RyaW5nKTogc3RyaW5nIHtcbiAgLy8gU3BsaXQgcGFyYW1ldGVycyBvciBzcGxpdCBmb2xkZXIgc2VwYXJhdG9yXG4gIGlmICh1cmwuaW5kZXhPZignPycpID4gLTEpIHtcbiAgICByZXR1cm4gdXJsLnNwbGl0KCc/JylbMF07XG4gIH0gZWxzZSBpZiAodXJsLmluZGV4T2YoJy8nKSA+IC0xKSB7XG4gICAgcmV0dXJuIHVybC5zcGxpdCgnLycpWzBdO1xuICB9XG4gIHJldHVybiB1cmw7XG59XG4iXX0=