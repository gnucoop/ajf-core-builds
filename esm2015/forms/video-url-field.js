/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { __decorate, __metadata, __param } from "tslib";
import { HttpClient } from '@angular/common/http';
import { ChangeDetectorRef, Inject } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { of as obsOf } from 'rxjs';
import { catchError, filter, map, startWith, switchMap } from 'rxjs/operators';
import { AjfBaseFieldComponent } from './base-field';
import { AjfFormRendererService } from './form-renderer';
import { AJF_WARNING_ALERT_SERVICE } from './warning-alert-service';
let AjfVideoUrlFieldComponent = /** @class */ (() => {
    let AjfVideoUrlFieldComponent = class AjfVideoUrlFieldComponent extends AjfBaseFieldComponent {
        constructor(cdr, service, was, domSanitizer, httpClient) {
            super(cdr, service, was);
            const video = this.control.pipe(filter(control => control != null), switchMap(control => {
                control = control;
                return control.valueChanges.pipe(startWith(control.value));
            }), filter(value => value != null), map(value => getVideoProviderAndId(value)));
            this.validUrl = video.pipe(map(v => v != null));
            this.videoThumbnail = video.pipe(filter(info => info != null), switchMap(info => videoPreviewUrl(httpClient, info)), filter(url => url != null), map(url => domSanitizer.bypassSecurityTrustResourceUrl(url)));
        }
    };
    AjfVideoUrlFieldComponent = __decorate([
        __param(2, Inject(AJF_WARNING_ALERT_SERVICE)),
        __metadata("design:paramtypes", [ChangeDetectorRef, AjfFormRendererService, Object, DomSanitizer,
            HttpClient])
    ], AjfVideoUrlFieldComponent);
    return AjfVideoUrlFieldComponent;
})();
export { AjfVideoUrlFieldComponent };
function videoPreviewUrl(httpClient, video) {
    if (video.provider === 'youtube') {
        return obsOf(`https://img.youtube.com/vi/${video.id}/default.jpg`);
    }
    if (video.provider === 'vimeo') {
        return httpClient
            .get(`https://vimeo.com/api/oembed.json?url=https://vimeo.com/${video.id}`)
            .pipe(map(response => response.thumbnail_url), catchError(() => obsOf(null)));
    }
    return obsOf('');
}
function getVideoProviderAndId(url) {
    let provider = null;
    let id = null;
    if (/youtube|youtu\.be|y2u\.be|i.ytimg\./.test(url)) {
        provider = 'youtube';
        id = getYouTubeVideoId(url);
    }
    else if (/vimeo/.test(url)) {
        provider = 'vimeo';
        id = getVimeoVideoId(url);
    }
    if (provider == null || id == null) {
        return null;
    }
    return { provider, id };
}
function getVimeoVideoId(url) {
    if (url.indexOf('#') > -1) {
        url = url.split('#')[0];
    }
    if (url.indexOf('?') > -1 && url.indexOf('clip_id=') === -1) {
        url = url.split('?')[0];
    }
    let id = null;
    let arr;
    const vimeoPipe = [
        'https?:\/\/vimeo\.com\/[0-9]+$', 'https?:\/\/player\.vimeo\.com\/video\/[0-9]+$',
        'https?:\/\/vimeo\.com\/channels', 'groups', 'album'
    ].join('|');
    const vimeoRegex = new RegExp(vimeoPipe, 'gim');
    if (vimeoRegex.test(url)) {
        arr = url.split('/');
        if (arr && arr.length) {
            id = arr.pop();
        }
    }
    else if (/clip_id=/gim.test(url)) {
        arr = url.split('clip_id=');
        if (arr && arr.length) {
            id = arr[1].split('&')[0];
        }
    }
    return id;
}
function getYouTubeVideoId(url) {
    const shortcode = /youtube:\/\/|https?:\/\/youtu\.be\/|http:\/\/y2u\.be\//g;
    if (shortcode.test(url)) {
        const shortcodeId = url.split(shortcode)[1];
        return stripParameters(shortcodeId);
    }
    // /v/ or /vi/
    const inlinev = /\/v\/|\/vi\//g;
    if (inlinev.test(url)) {
        const inlineId = url.split(inlinev)[1];
        return stripParameters(inlineId);
    }
    // v= or vi=
    const parameterV = /v=|vi=/g;
    if (parameterV.test(url)) {
        const arr = url.split(parameterV);
        return arr[1].split('&')[0];
    }
    // v= or vi=
    const parameterWebp = /\/an_webp\//g;
    if (parameterWebp.test(url)) {
        const webp = url.split(parameterWebp)[1];
        return stripParameters(webp);
    }
    // embed
    const embedReg = /\/embed\//g;
    if (embedReg.test(url)) {
        const embedId = url.split(embedReg)[1];
        return stripParameters(embedId);
    }
    // ignore /user/username pattern
    const usernameReg = /\/user\/([a-zA-Z0-9]*)$/g;
    if (usernameReg.test(url)) {
        return null;
    }
    // user
    const userReg = /\/user\/(?!.*videos)/g;
    if (userReg.test(url)) {
        const elements = url.split('/');
        return stripParameters(elements.pop());
    }
    // attribution_link
    const attrReg = /\/attribution_link\?.*v%3D([^%&]*)(%26|&|$)/;
    if (attrReg.test(url)) {
        return url.match(attrReg)[1];
    }
    return null;
}
function stripParameters(url) {
    // Split parameters or split folder separator
    if (url.indexOf('?') > -1) {
        return url.split('?')[0];
    }
    else if (url.indexOf('/') > -1) {
        return url.split('/')[0];
    }
    return url;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlkZW8tdXJsLWZpZWxkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvZm9ybXMvdmlkZW8tdXJsLWZpZWxkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRzs7QUFFSCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDaEQsT0FBTyxFQUFDLGlCQUFpQixFQUFFLE1BQU0sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUV4RCxPQUFPLEVBQUMsWUFBWSxFQUFrQixNQUFNLDJCQUEyQixDQUFDO0FBQ3hFLE9BQU8sRUFBYSxFQUFFLElBQUksS0FBSyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQzdDLE9BQU8sRUFBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFFN0UsT0FBTyxFQUFDLHFCQUFxQixFQUFDLE1BQU0sY0FBYyxDQUFDO0FBQ25ELE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQ3ZELE9BQU8sRUFBQyx5QkFBeUIsRUFBeUIsTUFBTSx5QkFBeUIsQ0FBQztBQVMxRjtJQUFBLElBQWEseUJBQXlCLEdBQXRDLE1BQWEseUJBQTBCLFNBQVEscUJBQXFCO1FBSWxFLFlBQ0ksR0FBc0IsRUFBRSxPQUErQixFQUNwQixHQUEyQixFQUFFLFlBQTBCLEVBQzFGLFVBQXNCO1lBQ3hCLEtBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBRXpCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUMzQixNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLEVBQ2xDLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRTtnQkFDbEIsT0FBTyxHQUFH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QUNoQyxPQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDMUI7SUFDRCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKEMpIEdudWNvb3Agc29jLiBjb29wLlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yXG4gKiBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXNcbiAqIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLFxuICogb3IgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIEdOVSBBZmZlcm9cbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGFsb25nIHdpdGggQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqIElmIG5vdCwgc2VlIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8uXG4gKlxuICovXG5cbmltcG9ydCB7SHR0cENsaWVudH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtDaGFuZ2VEZXRlY3RvclJlZiwgSW5qZWN0fSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7Rm9ybUNvbnRyb2x9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7RG9tU2FuaXRpemVyLCBTYWZlUmVzb3VyY2VVcmx9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCBvZiBhcyBvYnNPZn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2NhdGNoRXJyb3IsIGZpbHRlciwgbWFwLCBzdGFydFdpdGgsIHN3aXRjaE1hcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge0FqZkJhc2VGaWVsZENvbXBvbmVudH0gZnJvbSAnLi9iYXNlLWZpZWxkJztcbmltcG9ydCB7QWpmRm9ybVJlbmRlcmVyU2VydmljZX0gZnJvbSAnLi9mb3JtLXJlbmRlcmVyJztcbmltcG9ydCB7QUpGX1dBUk5JTkdfQUxFUlRfU0VSVklDRSwgQWpmV2FybmluZ0FsZXJ0U2VydmljZX0gZnJvbSAnLi93YXJuaW5nLWFsZXJ0LXNlcnZpY2UnO1xuXG5leHBvcnQgdHlwZSBBamZWaWRlb1Byb3ZpZGVyID0gJ3lvdXR1YmUnfCd2aW1lbyc7XG5cbmludGVyZmFjZSBWaWRlb0luZm8ge1xuICBwcm92aWRlcjogQWpmVmlkZW9Qcm92aWRlcjtcbiAgaWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEFqZlZpZGVvVXJsRmllbGRDb21wb25lbnQgZXh0ZW5kcyBBamZCYXNlRmllbGRDb21wb25lbnQge1xuICByZWFkb25seSB2YWxpZFVybDogT2JzZXJ2YWJsZTxib29sZWFuPjtcbiAgcmVhZG9ubHkgdmlkZW9UaHVtYm5haWw6IE9ic2VydmFibGU8U2FmZVJlc291cmNlVXJsPjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICAgIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsIHNlcnZpY2U6IEFqZkZvcm1SZW5kZXJlclNlcnZpY2UsXG4gICAgICBASW5qZWN0KEFKRl9XQVJOSU5HX0FMRVJUX1NFUlZJQ0UpIHdhczogQWpmV2FybmluZ0FsZXJ0U2VydmljZSwgZG9tU2FuaXRpemVyOiBEb21TYW5pdGl6ZXIsXG4gICAgICBodHRwQ2xpZW50OiBIdHRwQ2xpZW50KSB7XG4gICAgc3VwZXIoY2RyLCBzZXJ2aWNlLCB3YXMpO1xuXG4gICAgY29uc3QgdmlkZW8gPSB0aGlzLmNvbnRyb2wucGlwZShcbiAgICAgICAgZmlsdGVyKGNvbnRyb2wgPT4gY29udHJvbCAhPSBudWxsKSxcbiAgICAgICAgc3dpdGNoTWFwKGNvbnRyb2wgPT4ge1xuICAgICAgICAgIGNvbnRyb2wgPSBjb250cm9sIGFzIEZvcm1Db250cm9sO1xuICAgICAgICAgIHJldHVybiBjb250cm9sLnZhbHVlQ2hhbmdlcy5waXBlKFxuICAgICAgICAgICAgICBzdGFydFdpdGgoY29udHJvbC52YWx1ZSksXG4gICAgICAgICAgKTtcbiAgICAgICAgfSksXG4gICAgICAgIGZpbHRlcih2YWx1ZSA9PiB2YWx1ZSAhPSBudWxsKSxcbiAgICAgICAgbWFwKHZhbHVlID0+IGdldFZpZGVvUHJvdmlkZXJBbmRJZCh2YWx1ZSkpLFxuICAgICk7XG4gICAgdGhpcy52YWxpZFVybCA9IHZpZGVvLnBpcGUobWFwKHYgPT4gdiAhPSBudWxsKSk7XG4gICAgdGhpcy52aWRlb1RodW1ibmFpbCA9IHZpZGVvLnBpcGUoXG4gICAgICAgIGZpbHRlcihpbmZvID0+IGluZm8gIT0gbnVsbCksXG4gICAgICAgIHN3aXRjaE1hcChpbmZvID0+IHZpZGVvUHJldmlld1VybChodHRwQ2xpZW50LCBpbmZvIGFzIFZpZGVvSW5mbykpLFxuICAgICAgICBmaWx0ZXIodXJsID0+IHVybCAhPSBudWxsKSxcbiAgICAgICAgbWFwKHVybCA9PiBkb21TYW5pdGl6ZXIuYnlwYXNzU2VjdXJpdHlUcnVzdFJlc291cmNlVXJsKHVybCBhcyBzdHJpbmcpKSxcbiAgICApO1xuICB9XG59XG5cbmZ1bmN0aW9uIHZpZGVvUHJldmlld1VybChodHRwQ2xpZW50OiBIdHRwQ2xpZW50LCB2aWRlbzogVmlkZW9JbmZvKTogT2JzZXJ2YWJsZTxzdHJpbmd8bnVsbD4ge1xuICBpZiAodmlkZW8ucHJvdmlkZXIgPT09ICd5b3V0dWJlJykge1xuICAgIHJldHVybiBvYnNPZihgaHR0cHM6Ly9pbWcueW91dHViZS5jb20vdmkvJHt2aWRlby5pZH0vZGVmYXVsdC5qcGdgKTtcbiAgfVxuICBpZiAodmlkZW8ucHJvdmlkZXIgPT09ICd2aW1lbycpIHtcbiAgICByZXR1cm4gaHR0cENsaWVudFxuICAgICAgICAuZ2V0PHt0aHVtYm5haWxfdXJsOiBzdHJpbmd9PihcbiAgICAgICAgICAgIGBodHRwczovL3ZpbWVvLmNvbS9hcGkvb2VtYmVkLmpzb24/dXJsPWh0dHBzOi8vdmltZW8uY29tLyR7dmlkZW8uaWR9YClcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBtYXAocmVzcG9uc2UgPT4gcmVzcG9uc2UudGh1bWJuYWlsX3VybCksXG4gICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9ic09mKG51bGwpKSxcbiAgICAgICAgKTtcbiAgfVxuICByZXR1cm4gb2JzT2YoJycpO1xufVxuXG5mdW5jdGlvbiBnZXRWaWRlb1Byb3ZpZGVyQW5kSWQodXJsOiBzdHJpbmcpOiBWaWRlb0luZm98bnVsbCB7XG4gIGxldCBwcm92aWRlcjogQWpmVmlkZW9Qcm92aWRlcnxudWxsID0gbnVsbDtcbiAgbGV0IGlkOiBzdHJpbmd8bnVsbCA9IG51bGw7XG4gIGlmICgveW91dHViZXx5b3V0dVxcLmJlfHkydVxcLmJlfGkueXRpbWdcXC4vLnRlc3QodXJsKSkge1xuICAgIHByb3ZpZGVyID0gJ3lvdXR1YmUnO1xuICAgIGlkID0gZ2V0WW91VHViZVZpZGVvSWQodXJsKTtcbiAgfSBlbHNlIGlmICgvdmltZW8vLnRlc3QodXJsKSkge1xuICAgIHByb3ZpZGVyID0gJ3ZpbWVvJztcbiAgICBpZCA9IGdldFZpbWVvVmlkZW9JZCh1cmwpO1xuICB9XG4gIGlmIChwcm92aWRlciA9PSBudWxsIHx8IGlkID09IG51bGwpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZXR1cm4ge3Byb3ZpZGVyLCBpZH07XG59XG5cbmZ1bmN0aW9uIGdldFZpbWVvVmlkZW9JZCh1cmw6IHN0cmluZyk6IHN0cmluZ3xudWxsIHtcbiAgaWYgKHVybC5pbmRleE9mKCcjJykgPiAtMSkge1xuICAgIHVybCA9IHVybC5zcGxpdCgnIycpWzBdO1xuICB9XG4gIGlmICh1cmwuaW5kZXhPZignPycpID4gLTEgJiYgdXJsLmluZGV4T2YoJ2NsaXBfaWQ9JykgPT09IC0xKSB7XG4gICAgdXJsID0gdXJsLnNwbGl0KCc/JylbMF07XG4gIH1cblxuICBsZXQgaWQ6IHN0cmluZ3xudWxsID0gbnVsbDtcbiAgbGV0IGFycjogc3RyaW5nW107XG5cbiAgY29uc3QgdmltZW9QaXBlID0gW1xuICAgICdodHRwcz86XFwvXFwvdmltZW9cXC5jb21cXC9bMC05XSskJywgJ2h0dHBzPzpcXC9cXC9wbGF5ZXJcXC52aW1lb1xcLmNvbVxcL3ZpZGVvXFwvWzAtOV0rJCcsXG4gICAgJ2h0dHBzPzpcXC9cXC92aW1lb1xcLmNvbVxcL2NoYW5uZWxzJywgJ2dyb3VwcycsICdhbGJ1bSdcbiAgXS5qb2luKCd8Jyk7XG5cbiAgY29uc3QgdmltZW9SZWdleCA9IG5ldyBSZWdFeHAodmltZW9QaXBlLCAnZ2ltJyk7XG5cbiAgaWYgKHZpbWVvUmVnZXgudGVzdCh1cmwpKSB7XG4gICAgYXJyID0gdXJsLnNwbGl0KCcvJyk7XG4gICAgaWYgKGFyciAmJiBhcnIubGVuZ3RoKSB7XG4gICAgICBpZCA9IGFyci5wb3AoKSBhcyBzdHJpbmc7XG4gICAgfVxuICB9IGVsc2UgaWYgKC9jbGlwX2lkPS9naW0udGVzdCh1cmwpKSB7XG4gICAgYXJyID0gdXJsLnNwbGl0KCdjbGlwX2lkPScpO1xuICAgIGlmIChhcnIgJiYgYXJyLmxlbmd0aCkge1xuICAgICAgaWQgPSBhcnJbMV0uc3BsaXQoJyYnKVswXTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gaWQ7XG59XG5cbmZ1bmN0aW9uIGdldFlvdVR1YmVWaWRlb0lkKHVybDogc3RyaW5nKTogc3RyaW5nfG51bGwge1xuICBjb25zdCBzaG9ydGNvZGUgPSAveW91dHViZTpcXC9cXC98aHR0cHM/OlxcL1xcL3lvdXR1XFwuYmVcXC98aHR0cDpcXC9cXC95MnVcXC5iZVxcLy9nO1xuICBpZiAoc2hvcnRjb2RlLnRlc3QodXJsKSkge1xuICAgIGNvbnN0IHNob3J0Y29kZUlkID0gdXJsLnNwbGl0KHNob3J0Y29kZSlbMV07XG4gICAgcmV0dXJuIHN0cmlwUGFyYW1ldGVycyhzaG9ydGNvZGVJZCk7XG4gIH1cbiAgLy8gL3YvIG9yIC92aS9cbiAgY29uc3QgaW5saW5ldiA9IC9cXC92XFwvfFxcL3ZpXFwvL2c7XG5cbiAgaWYgKGlubGluZXYudGVzdCh1cmwpKSB7XG4gICAgY29uc3QgaW5saW5lSWQgPSB1cmwuc3BsaXQoaW5saW5ldilbMV07XG4gICAgcmV0dXJuIHN0cmlwUGFyYW1ldGVycyhpbmxpbmVJZCk7XG4gIH1cblxuICAvLyB2PSBvciB2aT1cbiAgY29uc3QgcGFyYW1ldGVyViA9IC92PXx2aT0vZztcblxuICBpZiAocGFyYW1ldGVyVi50ZXN0KHVybCkpIHtcbiAgICBjb25zdCBhcnIgPSB1cmwuc3BsaXQocGFyYW1ldGVyVik7XG4gICAgcmV0dXJuIGFyclsxXS5zcGxpdCgnJicpWzBdO1xuICB9XG5cbiAgLy8gdj0gb3Igdmk9XG4gIGNvbnN0IHBhcmFtZXRlcldlYnAgPSAvXFwvYW5fd2VicFxcLy9nO1xuXG4gIGlmIChwYXJhbWV0ZXJXZWJwLnRlc3QodXJsKSkge1xuICAgIGNvbnN0IHdlYnAgPSB1cmwuc3BsaXQocGFyYW1ldGVyV2VicClbMV07XG4gICAgcmV0dXJuIHN0cmlwUGFyYW1ldGVycyh3ZWJwKTtcbiAgfVxuXG4gIC8vIGVtYmVkXG4gIGNvbnN0IGVtYmVkUmVnID0gL1xcL2VtYmVkXFwvL2c7XG5cbiAgaWYgKGVtYmVkUmVnLnRlc3QodXJsKSkge1xuICAgIGNvbnN0IGVtYmVkSWQgPSB1cmwuc3BsaXQoZW1iZWRSZWcpWzFdO1xuICAgIHJldHVybiBzdHJpcFBhcmFtZXRlcnMoZW1iZWRJZCk7XG4gIH1cblxuICAvLyBpZ25vcmUgL3VzZXIvdXNlcm5hbWUgcGF0dGVyblxuICBjb25zdCB1c2VybmFtZVJlZyA9IC9cXC91c2VyXFwvKFthLXpBLVowLTldKikkL2c7XG5cbiAgaWYgKHVzZXJuYW1lUmVnLnRlc3QodXJsKSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLy8gdXNlclxuICBjb25zdCB1c2VyUmVnID0gL1xcL3VzZXJcXC8oPyEuKnZpZGVvcykvZztcblxuICBpZiAodXNlclJlZy50ZXN0KHVybCkpIHtcbiAgICBjb25zdCBlbGVtZW50cyA9IHVybC5zcGxpdCgnLycpO1xuICAgIHJldHVybiBzdHJpcFBhcmFtZXRlcnMoZWxlbWVudHMucG9wKCkgYXMgc3RyaW5nKTtcbiAgfVxuXG4gIC8vIGF0dHJpYnV0aW9uX2xpbmtcbiAgY29uc3QgYXR0clJlZyA9IC9cXC9hdHRyaWJ1dGlvbl9saW5rXFw/Lip2JTNEKFteJSZdKikoJTI2fCZ8JCkvO1xuXG4gIGlmIChhdHRyUmVnLnRlc3QodXJsKSkge1xuICAgIHJldHVybiAodXJsLm1hdGNoKGF0dHJSZWcpIGFzIHN0cmluZ1tdKVsxXTtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBzdHJpcFBhcmFtZXRlcnModXJsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAvLyBTcGxpdCBwYXJhbWV0ZXJzIG9yIHNwbGl0IGZvbGRlciBzZXBhcmF0b3JcbiAgaWYgKHVybC5pbmRleE9mKCc/JykgPiAtMSkge1xuICAgIHJldHVybiB1cmwuc3BsaXQoJz8nKVswXTtcbiAgfSBlbHNlIGlmICh1cmwuaW5kZXhPZignLycpID4gLTEpIHtcbiAgICByZXR1cm4gdXJsLnNwbGl0KCcvJylbMF07XG4gIH1cbiAgcmV0dXJuIHVybDtcbn1cbiJdfQ==