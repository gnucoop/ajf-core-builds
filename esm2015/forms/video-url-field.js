/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { HttpClient } from '@angular/common/http';
import { ChangeDetectorRef, Inject } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { of as obsOf } from 'rxjs';
import { catchError, filter, map, startWith, switchMap } from 'rxjs/operators';
import { AjfBaseFieldComponent } from './base-field';
import { AjfFormRendererService } from './form-renderer';
import { AJF_WARNING_ALERT_SERVICE } from './warning-alert-service';
/**
 * It allows the loading of video(youtube or vimeo) url inside an AjfForm.
 *
 * @export
 * @class AjfVideoUrlFieldComponent
 */
export class AjfVideoUrlFieldComponent extends AjfBaseFieldComponent {
    constructor(cdr, service, was, domSanitizer, httpClient) {
        super(cdr, service, was);
        const video = this.control.pipe(filter(control => control != null), switchMap(control => {
            control = control;
            return control.valueChanges.pipe(startWith(control.value));
        }), filter(value => value != null), map(value => getVideoProviderAndId(value)));
        this.validUrl = video.pipe(map(v => v != null));
        this.videoThumbnail = video.pipe(filter(info => info != null), switchMap(info => videoPreviewUrl(httpClient, info)), filter(url => url != null), map(url => domSanitizer.bypassSecurityTrustResourceUrl(url)));
    }
}
AjfVideoUrlFieldComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: AjfFormRendererService },
    { type: undefined, decorators: [{ type: Inject, args: [AJF_WARNING_ALERT_SERVICE,] }] },
    { type: DomSanitizer },
    { type: HttpClient }
];
/**
 * it returns a url of thumbnail related to video or null.
 *
 * @param httpClient
 * @param video
 * @return {*}
 */
function videoPreviewUrl(httpClient, video) {
    if (video.provider === 'youtube') {
        return obsOf(`https://img.youtube.com/vi/${video.id}/default.jpg`);
    }
    if (video.provider === 'vimeo') {
        return httpClient
            .get(`https://vimeo.com/api/oembed.json?url=https://vimeo.com/${video.id}`)
            .pipe(map(response => response.thumbnail_url), catchError(() => obsOf(null)));
    }
    return obsOf('');
}
/**
 * It checks the url param, if url is an youtube o vimeo domain return
 * an videoInfo else null
 *
 * @param url
 * @return {*}
 */
function getVideoProviderAndId(url) {
    let provider = null;
    let id = null;
    if (/youtube|youtu\.be|y2u\.be|i.ytimg\./.test(url)) {
        provider = 'youtube';
        id = getYouTubeVideoId(url);
    }
    else if (/vimeo/.test(url)) {
        provider = 'vimeo';
        id = getVimeoVideoId(url);
    }
    if (provider == null || id == null) {
        return null;
    }
    return { provider, id };
}
/**
 * it gets the id of vimeo video url.
 *
 * @param url
 * @return {*}
 */
function getVimeoVideoId(url) {
    if (url.includes('#')) {
        url = url.split('#')[0];
    }
    if (url.includes('?') && !url.includes('clip_id=')) {
        url = url.split('?')[0];
    }
    let id = null;
    let arr;
    const vimeoPipe = [
        'https?:\/\/vimeo\.com\/[0-9]+$', 'https?:\/\/player\.vimeo\.com\/video\/[0-9]+$',
        'https?:\/\/vimeo\.com\/channels', 'groups', 'album'
    ].join('|');
    const vimeoRegex = new RegExp(vimeoPipe, 'gim');
    if (vimeoRegex.test(url)) {
        arr = url.split('/');
        if (arr && arr.length) {
            id = arr.pop();
        }
    }
    else if (/clip_id=/gim.test(url)) {
        arr = url.split('clip_id=');
        if (arr && arr.length) {
            id = arr[1].split('&')[0];
        }
    }
    return id;
}
/**
 * it gets the id of youtube video url.
 *
 * @param url
 * @return {*}
 */
function getYouTubeVideoId(url) {
    const shortcode = /youtube:\/\/|https?:\/\/youtu\.be\/|http:\/\/y2u\.be\//g;
    if (shortcode.test(url)) {
        const shortcodeId = url.split(shortcode)[1];
        return stripParameters(shortcodeId);
    }
    // /v/ or /vi/
    const inlinev = /\/v\/|\/vi\//g;
    if (inlinev.test(url)) {
        const inlineId = url.split(inlinev)[1];
        return stripParameters(inlineId);
    }
    // v= or vi=
    const parameterV = /v=|vi=/g;
    if (parameterV.test(url)) {
        const arr = url.split(parameterV);
        return arr[1].split('&')[0];
    }
    // v= or vi=
    const parameterWebp = /\/an_webp\//g;
    if (parameterWebp.test(url)) {
        const webp = url.split(parameterWebp)[1];
        return stripParameters(webp);
    }
    // embed
    const embedReg = /\/embed\//g;
    if (embedReg.test(url)) {
        const embedId = url.split(embedReg)[1];
        return stripParameters(embedId);
    }
    // ignore /user/username pattern
    const usernameReg = /\/user\/([a-zA-Z0-9]*)$/g;
    if (usernameReg.test(url)) {
        return null;
    }
    // user
    const userReg = /\/user\/(?!.*videos)/g;
    if (userReg.test(url)) {
        const elements = url.split('/');
        return stripParameters(elements.pop());
    }
    // attribution_link
    const attrReg = /\/attribution_link\?.*v%3D([^%&]*)(%26|&|$)/;
    if (attrReg.test(url)) {
        return url.match(attrReg)[1];
    }
    return null;
}
function stripParameters(url) {
    // Split parameters or split folder separator
    if (url.includes('?')) {
        return url.split('?')[0];
    }
    else if (url.includes('/')) {
        return url.split('/')[0];
    }
    return url;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlkZW8tdXJsLWZpZWxkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvZm9ybXMvdmlkZW8tdXJsLWZpZWxkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUVILE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUNoRCxPQUFPLEVBQUMsaUJBQWlCLEVBQUUsTUFBTSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBRXhELE9BQU8sRUFBQyxZQUFZLEVBQWtCLE1BQU0sMkJBQTJCLENBQUM7QUFDeEUsT0FBTyxFQUFhLEVBQUUsSUFBSSxLQUFLLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUU3RSxPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFDbkQsT0FBTyxFQUFDLHNCQUFzQixFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDdkQsT0FBTyxFQUFDLHlCQUF5QixFQUF5QixNQUFNLHlCQUF5QixDQUFDO0FBUzFGOzs7OztHQUtHO0FBQ0gsTUFBTSxPQUFPLHlCQUEwQixTQUFRLHFCQUFxQjtJQUlsRSxZQUNJLEdBQXNCLEVBQUUsT0FBK0IsRUFDcEIsR0FBMkIsRUFBRSxZQUEwQixFQUMxRixVQUFzQjtRQUN4QixLQUFLLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUV6QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FDM0IsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxFQUNsQyxTQUFTLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDbEIsT0FBTyxHQUFHLE9BQXNC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dXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoQykgR251Y29vcCBzb2MuIGNvb3AuXG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3JcbiAqIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhc1xuICogcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsXG4gKiBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VIEFmZmVyb1xuICogR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogYWxvbmcgd2l0aCBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICogSWYgbm90LCBzZWUgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLy5cbiAqXG4gKi9cblxuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge0NoYW5nZURldGVjdG9yUmVmLCBJbmplY3R9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtGb3JtQ29udHJvbH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHtEb21TYW5pdGl6ZXIsIFNhZmVSZXNvdXJjZVVybH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5pbXBvcnQge09ic2VydmFibGUsIG9mIGFzIG9ic09mfSBmcm9tICdyeGpzJztcbmltcG9ydCB7Y2F0Y2hFcnJvciwgZmlsdGVyLCBtYXAsIHN0YXJ0V2l0aCwgc3dpdGNoTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7QWpmQmFzZUZpZWxkQ29tcG9uZW50fSBmcm9tICcuL2Jhc2UtZmllbGQnO1xuaW1wb3J0IHtBamZGb3JtUmVuZGVyZXJTZXJ2aWNlfSBmcm9tICcuL2Zvcm0tcmVuZGVyZXInO1xuaW1wb3J0IHtBSkZfV0FSTklOR19BTEVSVF9TRVJWSUNFLCBBamZXYXJuaW5nQWxlcnRTZXJ2aWNlfSBmcm9tICcuL3dhcm5pbmctYWxlcnQtc2VydmljZSc7XG5cbmV4cG9ydCB0eXBlIEFqZlZpZGVvUHJvdmlkZXIgPSAneW91dHViZSd8J3ZpbWVvJztcblxuaW50ZXJmYWNlIFZpZGVvSW5mbyB7XG4gIHByb3ZpZGVyOiBBamZWaWRlb1Byb3ZpZGVyO1xuICBpZDogc3RyaW5nO1xufVxuXG4vKipcbiAqIEl0IGFsbG93cyB0aGUgbG9hZGluZyBvZiB2aWRlbyh5b3V0dWJlIG9yIHZpbWVvKSB1cmwgaW5zaWRlIGFuIEFqZkZvcm0uXG4gKlxuICogQGV4cG9ydFxuICogQGNsYXNzIEFqZlZpZGVvVXJsRmllbGRDb21wb25lbnRcbiAqL1xuZXhwb3J0IGNsYXNzIEFqZlZpZGVvVXJsRmllbGRDb21wb25lbnQgZXh0ZW5kcyBBamZCYXNlRmllbGRDb21wb25lbnQge1xuICByZWFkb25seSB2YWxpZFVybDogT2JzZXJ2YWJsZTxib29sZWFuPjtcbiAgcmVhZG9ubHkgdmlkZW9UaHVtYm5haWw6IE9ic2VydmFibGU8U2FmZVJlc291cmNlVXJsPjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICAgIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsIHNlcnZpY2U6IEFqZkZvcm1SZW5kZXJlclNlcnZpY2UsXG4gICAgICBASW5qZWN0KEFKRl9XQVJOSU5HX0FMRVJUX1NFUlZJQ0UpIHdhczogQWpmV2FybmluZ0FsZXJ0U2VydmljZSwgZG9tU2FuaXRpemVyOiBEb21TYW5pdGl6ZXIsXG4gICAgICBodHRwQ2xpZW50OiBIdHRwQ2xpZW50KSB7XG4gICAgc3VwZXIoY2RyLCBzZXJ2aWNlLCB3YXMpO1xuXG4gICAgY29uc3QgdmlkZW8gPSB0aGlzLmNvbnRyb2wucGlwZShcbiAgICAgICAgZmlsdGVyKGNvbnRyb2wgPT4gY29udHJvbCAhPSBudWxsKSxcbiAgICAgICAgc3dpdGNoTWFwKGNvbnRyb2wgPT4ge1xuICAgICAgICAgIGNvbnRyb2wgPSBjb250cm9sIGFzIEZvcm1Db250cm9sO1xuICAgICAgICAgIHJldHVybiBjb250cm9sLnZhbHVlQ2hhbmdlcy5waXBlKFxuICAgICAgICAgICAgICBzdGFydFdpdGgoY29udHJvbC52YWx1ZSksXG4gICAgICAgICAgKTtcbiAgICAgICAgfSksXG4gICAgICAgIGZpbHRlcih2YWx1ZSA9PiB2YWx1ZSAhPSBudWxsKSxcbiAgICAgICAgbWFwKHZhbHVlID0+IGdldFZpZGVvUHJvdmlkZXJBbmRJZCh2YWx1ZSBhcyBzdHJpbmcpKSxcbiAgICApO1xuICAgIHRoaXMudmFsaWRVcmwgPSB2aWRlby5waXBlKG1hcCh2ID0+IHYgIT0gbnVsbCkpO1xuICAgIHRoaXMudmlkZW9UaHVtYm5haWwgPSB2aWRlby5waXBlKFxuICAgICAgICBmaWx0ZXIoaW5mbyA9PiBpbmZvICE9IG51bGwpLFxuICAgICAgICBzd2l0Y2hNYXAoaW5mbyA9PiB2aWRlb1ByZXZpZXdVcmwoaHR0cENsaWVudCwgaW5mbyBhcyBWaWRlb0luZm8pKSxcbiAgICAgICAgZmlsdGVyKHVybCA9PiB1cmwgIT0gbnVsbCksXG4gICAgICAgIG1hcCh1cmwgPT4gZG9tU2FuaXRpemVyLmJ5cGFzc1NlY3VyaXR5VHJ1c3RSZXNvdXJjZVVybCh1cmwgYXMgc3RyaW5nKSksXG4gICAgKTtcbiAgfVxufVxuXG4vKipcbiAqIGl0IHJldHVybnMgYSB1cmwgb2YgdGh1bWJuYWlsIHJlbGF0ZWQgdG8gdmlkZW8gb3IgbnVsbC5cbiAqXG4gKiBAcGFyYW0gaHR0cENsaWVudFxuICogQHBhcmFtIHZpZGVvXG4gKiBAcmV0dXJuIHsqfVxuICovXG5mdW5jdGlvbiB2aWRlb1ByZXZpZXdVcmwoaHR0cENsaWVudDogSHR0cENsaWVudCwgdmlkZW86IFZpZGVvSW5mbyk6IE9ic2VydmFibGU8c3RyaW5nfG51bGw+IHtcbiAgaWYgKHZpZGVvLnByb3ZpZGVyID09PSAneW91dHViZScpIHtcbiAgICByZXR1cm4gb2JzT2YoYGh0dHBzOi8vaW1nLnlvdXR1YmUuY29tL3ZpLyR7dmlkZW8uaWR9L2RlZmF1bHQuanBnYCk7XG4gIH1cbiAgaWYgKHZpZGVvLnByb3ZpZGVyID09PSAndmltZW8nKSB7XG4gICAgcmV0dXJuIGh0dHBDbGllbnRcbiAgICAgICAgICAgICAgIC5nZXQ8e3RodW1ibmFpbF91cmw6IHN0cmluZ30+KFxuICAgICAgICAgICAgICAgICAgIGBodHRwczovL3ZpbWVvLmNvbS9hcGkvb2VtYmVkLmpzb24/dXJsPWh0dHBzOi8vdmltZW8uY29tLyR7dmlkZW8uaWR9YClcbiAgICAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgICAgIG1hcChyZXNwb25zZSA9PiByZXNwb25zZS50aHVtYm5haWxfdXJsKSxcbiAgICAgICAgICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9ic09mKG51bGwpKSxcbiAgICAgICAgICAgICAgICAgICApIGFzIE9ic2VydmFibGU8c3RyaW5nfG51bGw+O1xuICB9XG4gIHJldHVybiBvYnNPZignJyk7XG59XG5cbi8qKlxuICogSXQgY2hlY2tzIHRoZSB1cmwgcGFyYW0sIGlmIHVybCBpcyBhbiB5b3V0dWJlIG8gdmltZW8gZG9tYWluIHJldHVyblxuICogYW4gdmlkZW9JbmZvIGVsc2UgbnVsbFxuICpcbiAqIEBwYXJhbSB1cmxcbiAqIEByZXR1cm4geyp9XG4gKi9cbmZ1bmN0aW9uIGdldFZpZGVvUHJvdmlkZXJBbmRJZCh1cmw6IHN0cmluZyk6IFZpZGVvSW5mb3xudWxsIHtcbiAgbGV0IHByb3ZpZGVyOiBBamZWaWRlb1Byb3ZpZGVyfG51bGwgPSBudWxsO1xuICBsZXQgaWQ6IHN0cmluZ3xudWxsID0gbnVsbDtcbiAgaWYgKC95b3V0dWJlfHlvdXR1XFwuYmV8eTJ1XFwuYmV8aS55dGltZ1xcLi8udGVzdCh1cmwpKSB7XG4gICAgcHJvdmlkZXIgPSAneW91dHViZSc7XG4gICAgaWQgPSBnZXRZb3VUdWJlVmlkZW9JZCh1cmwpO1xuICB9IGVsc2UgaWYgKC92aW1lby8udGVzdCh1cmwpKSB7XG4gICAgcHJvdmlkZXIgPSAndmltZW8nO1xuICAgIGlkID0gZ2V0VmltZW9WaWRlb0lkKHVybCk7XG4gIH1cbiAgaWYgKHByb3ZpZGVyID09IG51bGwgfHwgaWQgPT0gbnVsbCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIHJldHVybiB7cHJvdmlkZXIsIGlkfTtcbn1cblxuLyoqXG4gKiBpdCBnZXRzIHRoZSBpZCBvZiB2aW1lbyB2aWRlbyB1cmwuXG4gKlxuICogQHBhcmFtIHVybFxuICogQHJldHVybiB7Kn1cbiAqL1xuZnVuY3Rpb24gZ2V0VmltZW9WaWRlb0lkKHVybDogc3RyaW5nKTogc3RyaW5nfG51bGwge1xuICBpZiAodXJsLmluY2x1ZGVzKCcjJykpIHtcbiAgICB1cmwgPSB1cmwuc3BsaXQoJyMnKVswXTtcbiAgfVxuICBpZiAodXJsLmluY2x1ZGVzKCc/JykgJiYgIXVybC5pbmNsdWRlcygnY2xpcF9pZD0nKSkge1xuICAgIHVybCA9IHVybC5zcGxpdCgnPycpWzBdO1xuICB9XG5cbiAgbGV0IGlkOiBzdHJpbmd8bnVsbCA9IG51bGw7XG4gIGxldCBhcnI6IHN0cmluZ1tdO1xuXG4gIGNvbnN0IHZpbWVvUGlwZSA9IFtcbiAgICAnaHR0cHM/OlxcL1xcL3ZpbWVvXFwuY29tXFwvWzAtOV0rJCcsICdodHRwcz86XFwvXFwvcGxheWVyXFwudmltZW9cXC5jb21cXC92aWRlb1xcL1swLTldKyQnLFxuICAgICdodHRwcz86XFwvXFwvdmltZW9cXC5jb21cXC9jaGFubmVscycsICdncm91cHMnLCAnYWxidW0nXG4gIF0uam9pbignfCcpO1xuXG4gIGNvbnN0IHZpbWVvUmVnZXggPSBuZXcgUmVnRXhwKHZpbWVvUGlwZSwgJ2dpbScpO1xuXG4gIGlmICh2aW1lb1JlZ2V4LnRlc3QodXJsKSkge1xuICAgIGFyciA9IHVybC5zcGxpdCgnLycpO1xuICAgIGlmIChhcnIgJiYgYXJyLmxlbmd0aCkge1xuICAgICAgaWQgPSBhcnIucG9wKCkgYXMgc3RyaW5nO1xuICAgIH1cbiAgfSBlbHNlIGlmICgvY2xpcF9pZD0vZ2ltLnRlc3QodXJsKSkge1xuICAgIGFyciA9IHVybC5zcGxpdCgnY2xpcF9pZD0nKTtcbiAgICBpZiAoYXJyICYmIGFyci5sZW5ndGgpIHtcbiAgICAgIGlkID0gYXJyWzFdLnNwbGl0KCcmJylbMF07XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGlkO1xufVxuXG4vKipcbiAqIGl0IGdldHMgdGhlIGlkIG9mIHlvdXR1YmUgdmlkZW8gdXJsLlxuICpcbiAqIEBwYXJhbSB1cmxcbiAqIEByZXR1cm4geyp9XG4gKi9cbmZ1bmN0aW9uIGdldFlvdVR1YmVWaWRlb0lkKHVybDogc3RyaW5nKTogc3RyaW5nfG51bGwge1xuICBjb25zdCBzaG9ydGNvZGUgPSAveW91dHViZTpcXC9cXC98aHR0cHM/OlxcL1xcL3lvdXR1XFwuYmVcXC98aHR0cDpcXC9cXC95MnVcXC5iZVxcLy9nO1xuICBpZiAoc2hvcnRjb2RlLnRlc3QodXJsKSkge1xuICAgIGNvbnN0IHNob3J0Y29kZUlkID0gdXJsLnNwbGl0KHNob3J0Y29kZSlbMV07XG4gICAgcmV0dXJuIHN0cmlwUGFyYW1ldGVycyhzaG9ydGNvZGVJZCk7XG4gIH1cbiAgLy8gL3YvIG9yIC92aS9cbiAgY29uc3QgaW5saW5ldiA9IC9cXC92XFwvfFxcL3ZpXFwvL2c7XG5cbiAgaWYgKGlubGluZXYudGVzdCh1cmwpKSB7XG4gICAgY29uc3QgaW5saW5lSWQgPSB1cmwuc3BsaXQoaW5saW5ldilbMV07XG4gICAgcmV0dXJuIHN0cmlwUGFyYW1ldGVycyhpbmxpbmVJZCk7XG4gIH1cblxuICAvLyB2PSBvciB2aT1cbiAgY29uc3QgcGFyYW1ldGVyViA9IC92PXx2aT0vZztcblxuICBpZiAocGFyYW1ldGVyVi50ZXN0KHVybCkpIHtcbiAgICBjb25zdCBhcnIgPSB1cmwuc3BsaXQocGFyYW1ldGVyVik7XG4gICAgcmV0dXJuIGFyclsxXS5zcGxpdCgnJicpWzBdO1xuICB9XG5cbiAgLy8gdj0gb3Igdmk9XG4gIGNvbnN0IHBhcmFtZXRlcldlYnAgPSAvXFwvYW5fd2VicFxcLy9nO1xuXG4gIGlmIChwYXJhbWV0ZXJXZWJwLnRlc3QodXJsKSkge1xuICAgIGNvbnN0IHdlYnAgPSB1cmwuc3BsaXQocGFyYW1ldGVyV2VicClbMV07XG4gICAgcmV0dXJuIHN0cmlwUGFyYW1ldGVycyh3ZWJwKTtcbiAgfVxuXG4gIC8vIGVtYmVkXG4gIGNvbnN0IGVtYmVkUmVnID0gL1xcL2VtYmVkXFwvL2c7XG5cbiAgaWYgKGVtYmVkUmVnLnRlc3QodXJsKSkge1xuICAgIGNvbnN0IGVtYmVkSWQgPSB1cmwuc3BsaXQoZW1iZWRSZWcpWzFdO1xuICAgIHJldHVybiBzdHJpcFBhcmFtZXRlcnMoZW1iZWRJZCk7XG4gIH1cblxuICAvLyBpZ25vcmUgL3VzZXIvdXNlcm5hbWUgcGF0dGVyblxuICBjb25zdCB1c2VybmFtZVJlZyA9IC9cXC91c2VyXFwvKFthLXpBLVowLTldKikkL2c7XG5cbiAgaWYgKHVzZXJuYW1lUmVnLnRlc3QodXJsKSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLy8gdXNlclxuICBjb25zdCB1c2VyUmVnID0gL1xcL3VzZXJcXC8oPyEuKnZpZGVvcykvZztcblxuICBpZiAodXNlclJlZy50ZXN0KHVybCkpIHtcbiAgICBjb25zdCBlbGVtZW50cyA9IHVybC5zcGxpdCgnLycpO1xuICAgIHJldHVybiBzdHJpcFBhcmFtZXRlcnMoZWxlbWVudHMucG9wKCkgYXMgc3RyaW5nKTtcbiAgfVxuXG4gIC8vIGF0dHJpYnV0aW9uX2xpbmtcbiAgY29uc3QgYXR0clJlZyA9IC9cXC9hdHRyaWJ1dGlvbl9saW5rXFw/Lip2JTNEKFteJSZdKikoJTI2fCZ8JCkvO1xuXG4gIGlmIChhdHRyUmVnLnRlc3QodXJsKSkge1xuICAgIHJldHVybiAodXJsLm1hdGNoKGF0dHJSZWcpIGFzIHN0cmluZ1tdKVsxXTtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBzdHJpcFBhcmFtZXRlcnModXJsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAvLyBTcGxpdCBwYXJhbWV0ZXJzIG9yIHNwbGl0IGZvbGRlciBzZXBhcmF0b3JcbiAgaWYgKHVybC5pbmNsdWRlcygnPycpKSB7XG4gICAgcmV0dXJuIHVybC5zcGxpdCgnPycpWzBdO1xuICB9IGVsc2UgaWYgKHVybC5pbmNsdWRlcygnLycpKSB7XG4gICAgcmV0dXJuIHVybC5zcGxpdCgnLycpWzBdO1xuICB9XG4gIHJldHVybiB1cmw7XG59XG4iXX0=