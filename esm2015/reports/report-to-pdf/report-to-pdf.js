/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { AjfImageType } from '@ajf/core/image';
import { vfsFonts, vfsFontsMap } from '@ajf/core/vfs-fonts';
import { createPdf } from 'pdfmake/build/pdfmake';
import { AjfWidgetType } from '../interface/widgets/widget-type';
import { loadReportImages } from './load-report-images';
export function openReportPdf(report, orientation) {
    createReportPdf(report, orientation).then(pdf => {
        pdf.open();
    });
}
export function createReportPdf(report, orientation) {
    return new Promise(resolve => {
        loadReportImages(report).then(images => {
            let width = 595.28 - 40 * 2; // A4 page width - margins
            if (orientation === 'landscape') {
                width = 841.89 - 40 * 2;
            }
            const pdfDef = reportToPdf(report, images, width);
            pdfDef.pageOrientation = orientation;
            resolve(createPdf(pdfDef, undefined, vfsFontsMap, vfsFonts));
        });
    });
}
function reportToPdf(report, images, width) {
    const stack = [];
    if (report.header != null) {
        stack.push(containerToPdf(report.header, images, width));
    }
    if (report.content != null) {
        stack.push(containerToPdf(report.content, images, width));
    }
    if (report.footer != null) {
        stack.push(containerToPdf(report.footer, images, width));
    }
    return { content: { stack } };
}
function containerToPdf(container, images, width) {
    return { stack: container.content.map(w => widgetToPdf(w, images, width)) };
}
const marginBetweenWidgets = 10;
function widgetToPdf(widget, images, width) {
    switch (widget.widget.widgetType) {
        case AjfWidgetType.Layout:
            return layoutToPdf(widget, images, width);
        case AjfWidgetType.PageBreak:
            return { text: '', pageBreak: 'after' };
        case AjfWidgetType.Image:
            return imageToPdf(widget, images, width);
        case AjfWidgetType.Text:
            return textToPdf(widget);
        case AjfWidgetType.Chart:
            const chart = widget;
            const dataUrl = chart.canvasDataUrl == null ? '' : chart.canvasDataUrl();
            if (dataUrl === '') {
                return { text: '[chart with no attached canvas]' };
            }
            return { image: dataUrl, width, margin: [0, 0, 0, marginBetweenWidgets] };
        case AjfWidgetType.Table:
            return tableToPdf(widget);
        case AjfWidgetType.Column:
            const cw = widget;
            return { stack: cw.content.map(w => widgetToPdf(w, images, width)) };
        case AjfWidgetType.Formula:
            const fw = widget;
            return { text: fw.formula, margin: [0, 0, 0, marginBetweenWidgets] };
        default:
            return { text: '' };
    }
}
function layoutToPdf(lw, images, width) {
    const columns = [...lw.widget.columns];
    while (columns.length < lw.content.length) {
        columns.push(1);
    }
    const childWidth = width / (columns.length || 1);
    const children = [];
    for (let i = 0; i < lw.content.length; i++) {
        let child = widgetToPdf(lw.content[i], images, childWidth);
        // Children of Layout widgets are supposed to be Columns. If they aren't,
        // we must wrap them to avoid problems like images having an 'auto' width.
        if (child.stack == null) {
            child = { stack: [child] };
        }
        child.width = columns[i] === -1 ? 'auto' : '*';
        children.push(child);
    }
    return { columns: children };
}
function imageToPdf(image, images, width) {
    if (image.widget.imageType !== AjfImageType.Image) {
        // Can't get icons to work, pdfs with multiple fonts don't seem to be working
        return { text: '' };
    }
    const dataUrl = images[image.url];
    if (dataUrl == null) {
        return { text: '' };
    }
    const w = image.styles.width;
    if (typeof (w) === 'string' && w.endsWith('px')) {
        width = Number(w.slice(0, -2));
    }
    return { image: dataUrl, width, margin: [0, 0, 0, marginBetweenWidgets] };
}
function textToPdf(tw) {
    const text = {
        text: stripHTML(tw.htmlText),
        margin: [0, 0, 0, marginBetweenWidgets],
    };
    if (tw.htmlText.startsWith('<h1>')) {
        text.fontSize = 20;
        text.margin = [0, 10, 0, marginBetweenWidgets];
    }
    else if (tw.htmlText.startsWith('<h2>')) {
        text.fontSize = 15;
        text.margin = [0, 5, 0, marginBetweenWidgets];
    }
    return text;
}
function tableToPdf(table) {
    if (table.data == null || table.data.length === 0) {
        return { text: '' };
    }
    const body = [];
    for (let i = 0; i < table.data.length; i++) {
        const dataRow = table.data[i];
        const bodyRow = [];
        for (let j = 0; j < dataRow.length; j++) {
            const cell = dataRow[j];
            bodyRow.push({ text: table.dataset[i][j], colSpan: cell.colspan });
            // pdfmake wants placeholder cells after cells with colspan > 1:
            for (let k = 1; k < (cell.colspan || 1); k++) {
                bodyRow.push({ text: '' });
            }
        }
        body.push(bodyRow);
    }
    return { table: { headerRows: 0, body }, margin: [0, 0, 0, marginBetweenWidgets] };
}
function stripHTML(s) {
    return s.replace(/<\/?[^>]+(>|$)/g, '');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3J0LXRvLXBkZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3JlcG9ydHMvcmVwb3J0LXRvLXBkZi9yZXBvcnQtdG8tcGRmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUVILE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQUMsUUFBUSxFQUFFLFdBQVcsRUFBQyxNQUFNLHFCQUFxQixDQUFDO0FBQzFELE9BQU8sRUFBQyxTQUFTLEVBQWMsTUFBTSx1QkFBdUIsQ0FBQztBQW9CN0QsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLGtDQUFrQyxDQUFDO0FBRS9ELE9BQU8sRUFBVyxnQkFBZ0IsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBRWhFLE1BQU0sVUFBVSxhQUFhLENBQUMsTUFBeUIsRUFBRSxXQUE2QjtJQUNwRixlQUFlLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUM5QyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDYixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxNQUFNLFVBQVUsZUFBZSxDQUMzQixNQUF5QixFQUFFLFdBQTZCO0lBQzFELE9BQU8sSUFBSSxPQUFPLENBQWMsT0FBTyxDQUFDLEVBQUU7UUFDeEMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3JDLElBQUksS0FBSyxHQUFHLE1BQU0sR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUUsMEJBQTBCO1lBQ3hELElBQUksV0FBVyxLQUFLLFdBQVcsRUFBRTtnQkFDL0IsS0FBSyxHQUFHLE1BQU0sR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2FBQ3pCO1lBQ0QsTUFBTSxNQUFNLEdBQUcsV0FB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QUFDLEVBQUUsRUFBRTtRQUMxQyxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlCLE1BQU0sT0FBTyxHQUFnQixFQUFFLENBQUM7UUFDaEMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDdkMsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3hCLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBQyxDQUFDLENBQUM7WUFDakUsZ0VBQWdFO1lBQ2hFLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQzVDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFDLENBQUMsQ0FBQzthQUMxQjtTQUNGO1FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUNwQjtJQUNELE9BQU8sRUFBQyxLQUFLLEVBQUUsRUFBQyxVQUFVLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLG9CQUFvQixDQUFDLEVBQUMsQ0FBQztBQUNqRixDQUFDO0FBRUQsU0FBUyxTQUFTLENBQUMsQ0FBUztJQUMxQixPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDMUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoQykgR251Y29vcCBzb2MuIGNvb3AuXG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3JcbiAqIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhc1xuICogcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsXG4gKiBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VIEFmZmVyb1xuICogR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogYWxvbmcgd2l0aCBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICogSWYgbm90LCBzZWUgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLy5cbiAqXG4gKi9cblxuaW1wb3J0IHtBamZJbWFnZVR5cGV9IGZyb20gJ0BhamYvY29yZS9pbWFnZSc7XG5pbXBvcnQge3Zmc0ZvbnRzLCB2ZnNGb250c01hcH0gZnJvbSAnQGFqZi9jb3JlL3Zmcy1mb250cyc7XG5pbXBvcnQge2NyZWF0ZVBkZiwgVENyZWF0ZWRQZGZ9IGZyb20gJ3BkZm1ha2UvYnVpbGQvcGRmbWFrZSc7XG5pbXBvcnQge1xuICBDb2x1bW4sXG4gIENvbnRlbnQsXG4gIENvbnRlbnRTdGFjayxcbiAgUGFnZU9yaWVudGF0aW9uLFxuICBUYWJsZUNlbGwsXG4gIFREb2N1bWVudERlZmluaXRpb25zXG59IGZyb20gJ3BkZm1ha2UvaW50ZXJmYWNlcyc7XG5cbmltcG9ydCB7QWpmUmVwb3J0Q29udGFpbmVySW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS9yZXBvcnRzLWluc3RhbmNlcy9yZXBvcnQtY29udGFpbmVyLWluc3RhbmNlJztcbmltcG9ydCB7QWpmUmVwb3J0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS9yZXBvcnRzLWluc3RhbmNlcy9yZXBvcnQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZDaGFydFdpZGdldEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvY2hhcnQtd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmQ29sdW1uV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9jb2x1bW4td2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmRm9ybXVsYVdpZGdldEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvZm9ybXVsYS13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZJbWFnZVdpZGdldEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvaW1hZ2Utd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmTGF5b3V0V2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9sYXlvdXQtd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmVGFibGVXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL3RhYmxlLXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZlRleHRXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL3RleHQtd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy93aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZXaWRnZXRUeXBlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy93aWRnZXQtdHlwZSc7XG5cbmltcG9ydCB7SW1hZ2VNYXAsIGxvYWRSZXBvcnRJbWFnZXN9IGZyb20gJy4vbG9hZC1yZXBvcnQtaW1hZ2VzJztcblxuZXhwb3J0IGZ1bmN0aW9uIG9wZW5SZXBvcnRQZGYocmVwb3J0OiBBamZSZXBvcnRJbnN0YW5jZSwgb3JpZW50YXRpb24/OiBQYWdlT3JpZW50YXRpb24pIHtcbiAgY3JlYXRlUmVwb3J0UGRmKHJlcG9ydCwgb3JpZW50YXRpb24pLnRoZW4ocGRmID0+IHtcbiAgICBwZGYub3BlbigpO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJlcG9ydFBkZihcbiAgICByZXBvcnQ6IEFqZlJlcG9ydEluc3RhbmNlLCBvcmllbnRhdGlvbj86IFBhZ2VPcmllbnRhdGlvbik6IFByb21pc2U8VENyZWF0ZWRQZGY+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPFRDcmVhdGVkUGRmPihyZXNvbHZlID0+IHtcbiAgICBsb2FkUmVwb3J0SW1hZ2VzKHJlcG9ydCkudGhlbihpbWFnZXMgPT4ge1xuICAgICAgbGV0IHdpZHRoID0gNTk1LjI4IC0gNDAgKiAyOyAgLy8gQTQgcGFnZSB3aWR0aCAtIG1hcmdpbnNcbiAgICAgIGlmIChvcmllbnRhdGlvbiA9PT0gJ2xhbmRzY2FwZScpIHtcbiAgICAgICAgd2lkdGggPSA4NDEuODkgLSA0MCAqIDI7XG4gICAgICB9XG4gICAgICBjb25zdCBwZGZEZWYgPSByZXBvcnRUb1BkZihyZXBvcnQsIGltYWdlcywgd2lkdGgpO1xuICAgICAgcGRmRGVmLnBhZ2VPcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uO1xuICAgICAgcmVzb2x2ZShjcmVhdGVQZGYocGRmRGVmLCB1bmRlZmluZWQsIHZmc0ZvbnRzTWFwLCB2ZnNGb250cykpO1xuICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVwb3J0VG9QZGYoXG4gICAgcmVwb3J0OiBBamZSZXBvcnRJbnN0YW5jZSwgaW1hZ2VzOiBJbWFnZU1hcCwgd2lkdGg6IG51bWJlcik6IFREb2N1bWVudERlZmluaXRpb25zIHtcbiAgY29uc3Qgc3RhY2s6IENvbnRlbnRbXSA9IFtdO1xuICBpZiAocmVwb3J0LmhlYWRlciAhPSBudWxsKSB7XG4gICAgc3RhY2sucHVzaChjb250YWluZXJUb1BkZihyZXBvcnQuaGVhZGVyLCBpbWFnZXMsIHdpZHRoKSk7XG4gIH1cbiAgaWYgKHJlcG9ydC5jb250ZW50ICE9IG51bGwpIHtcbiAgICBzdGFjay5wdXNoKGNvbnRhaW5lclRvUGRmKHJlcG9ydC5jb250ZW50LCBpbWFnZXMsIHdpZHRoKSk7XG4gIH1cbiAgaWYgKHJlcG9ydC5mb290ZXIgIT0gbnVsbCkge1xuICAgIHN0YWNrLnB1c2goY29udGFpbmVyVG9QZGYocmVwb3J0LmZvb3RlciwgaW1hZ2VzLCB3aWR0aCkpO1xuICB9XG4gIHJldHVybiB7Y29udGVudDoge3N0YWNrfX07XG59XG5cbmZ1bmN0aW9uIGNvbnRhaW5lclRvUGRmKFxuICAgIGNvbnRhaW5lcjogQWpmUmVwb3J0Q29udGFpbmVySW5zdGFuY2UsIGltYWdlczogSW1hZ2VNYXAsIHdpZHRoOiBudW1iZXIpOiBDb250ZW50IHtcbiAgcmV0dXJuIHtzdGFjazogY29udGFpbmVyLmNvbnRlbnQubWFwKHcgPT4gd2lkZ2V0VG9QZGYodywgaW1hZ2VzLCB3aWR0aCkpfTtcbn1cblxuY29uc3QgbWFyZ2luQmV0d2VlbldpZGdldHMgPSAxMDtcblxuZnVuY3Rpb24gd2lkZ2V0VG9QZGYod2lkZ2V0OiBBamZXaWRnZXRJbnN0YW5jZSwgaW1hZ2VzOiBJbWFnZU1hcCwgd2lkdGg6IG51bWJlcik6IENvbnRlbnQge1xuICBzd2l0Y2ggKHdpZGdldC53aWRnZXQud2lkZ2V0VHlwZSkge1xuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5MYXlvdXQ6XG4gICAgICByZXR1cm4gbGF5b3V0VG9QZGYod2lkZ2V0IGFzIEFqZkxheW91dFdpZGdldEluc3RhbmNlLCBpbWFnZXMsIHdpZHRoKTtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuUGFnZUJyZWFrOlxuICAgICAgcmV0dXJuIHt0ZXh0OiAnJywgcGFnZUJyZWFrOiAnYWZ0ZXInfTtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuSW1hZ2U6XG4gICAgICByZXR1cm4gaW1hZ2VUb1BkZih3aWRnZXQgYXMgQWpmSW1hZ2VXaWRnZXRJbnN0YW5jZSwgaW1hZ2VzLCB3aWR0aCk7XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLlRleHQ6XG4gICAgICByZXR1cm4gdGV4dFRvUGRmKHdpZGdldCBhcyBBamZUZXh0V2lkZ2V0SW5zdGFuY2UpO1xuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5DaGFydDpcbiAgICAgIGNvbnN0IGNoYXJ0ID0gd2lkZ2V0IGFzIEFqZkNoYXJ0V2lkZ2V0SW5zdGFuY2U7XG4gICAgICBjb25zdCBkYXRhVXJsID0gY2hhcnQuY2FudmFzRGF0YVVybCA9PSBudWxsID8gJycgOiBjaGFydC5jYW52YXNEYXRhVXJsKCk7XG4gICAgICBpZiAoZGF0YVVybCA9PT0gJycpIHtcbiAgICAgICAgcmV0dXJuIHt0ZXh0OiAnW2NoYXJ0IHdpdGggbm8gYXR0YWNoZWQgY2FudmFzXSd9O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHtpbWFnZTogZGF0YVVybCwgd2lkdGgsIG1hcmdpbjogWzAsIDAsIDAsIG1hcmdpbkJldHdlZW5XaWRnZXRzXX07XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLlRhYmxlOlxuICAgICAgcmV0dXJuIHRhYmxlVG9QZGYod2lkZ2V0IGFzIEFqZlRhYmxlV2lkZ2V0SW5zdGFuY2UpO1xuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5Db2x1bW46XG4gICAgICBjb25zdCBjdyA9IHdpZGdldCBhcyBBamZDb2x1bW5XaWRnZXRJbnN0YW5jZTtcbiAgICAgIHJldHVybiB7c3RhY2s6IGN3LmNvbnRlbnQubWFwKHcgPT4gd2lkZ2V0VG9QZGYodywgaW1hZ2VzLCB3aWR0aCkpfTtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuRm9ybXVsYTpcbiAgICAgIGNvbnN0IGZ3ID0gd2lkZ2V0IGFzIEFqZkZvcm11bGFXaWRnZXRJbnN0YW5jZTtcbiAgICAgIHJldHVybiB7dGV4dDogZncuZm9ybXVsYSwgbWFyZ2luOiBbMCwgMCwgMCwgbWFyZ2luQmV0d2VlbldpZGdldHNdfTtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIHt0ZXh0OiAnJ307XG4gIH1cbn1cblxuZnVuY3Rpb24gbGF5b3V0VG9QZGYobHc6IEFqZkxheW91dFdpZGdldEluc3RhbmNlLCBpbWFnZXM6IEltYWdlTWFwLCB3aWR0aDogbnVtYmVyKTogQ29udGVudCB7XG4gIGNvbnN0IGNvbHVtbnMgPSBbLi4ubHcud2lkZ2V0LmNvbHVtbnNdO1xuICB3aGlsZSAoY29sdW1ucy5sZW5ndGggPCBsdy5jb250ZW50Lmxlbmd0aCkge1xuICAgIGNvbHVtbnMucHVzaCgxKTtcbiAgfVxuICBjb25zdCBjaGlsZFdpZHRoID0gd2lkdGggLyAoY29sdW1ucy5sZW5ndGggfHwgMSk7XG4gIGNvbnN0IGNoaWxkcmVuID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbHcuY29udGVudC5sZW5ndGg7IGkrKykge1xuICAgIGxldCBjaGlsZCA9IHdpZGdldFRvUGRmKGx3LmNvbnRlbnRbaV0sIGltYWdlcywgY2hpbGRXaWR0aCkgYXMgQ29udGVudFN0YWNrO1xuICAgIC8vIENoaWxkcmVuIG9mIExheW91dCB3aWRnZXRzIGFyZSBzdXBwb3NlZCB0byBiZSBDb2x1bW5zLiBJZiB0aGV5IGFyZW4ndCxcbiAgICAvLyB3ZSBtdXN0IHdyYXAgdGhlbSB0byBhdm9pZCBwcm9ibGVtcyBsaWtlIGltYWdlcyBoYXZpbmcgYW4gJ2F1dG8nIHdpZHRoLlxuICAgIGlmIChjaGlsZC5zdGFjayA9PSBudWxsKSB7XG4gICAgICBjaGlsZCA9IHtzdGFjazogW2NoaWxkXX07XG4gICAgfVxuICAgIChjaGlsZCBhcyBDb2x1bW4pLndpZHRoID0gY29sdW1uc1tpXSA9PT0gLTEgPyAnYXV0bycgOiAnKic7XG4gICAgY2hpbGRyZW4ucHVzaChjaGlsZCk7XG4gIH1cbiAgcmV0dXJuIHtjb2x1bW5zOiBjaGlsZHJlbn07XG59XG5cbmZ1bmN0aW9uIGltYWdlVG9QZGYoaW1hZ2U6IEFqZkltYWdlV2lkZ2V0SW5zdGFuY2UsIGltYWdlczogSW1hZ2VNYXAsIHdpZHRoOiBudW1iZXIpOiBDb250ZW50IHtcbiAgaWYgKGltYWdlLndpZGdldC5pbWFnZVR5cGUgIT09IEFqZkltYWdlVHlwZS5JbWFnZSkge1xuICAgIC8vIENhbid0IGdldCBpY29ucyB0byB3b3JrLCBwZGZzIHdpdGggbXVsdGlwbGUgZm9udHMgZG9uJ3Qgc2VlbSB0byBiZSB3b3JraW5nXG4gICAgcmV0dXJuIHt0ZXh0OiAnJ307XG4gIH1cbiAgY29uc3QgZGF0YVVybCA9IGltYWdlc1tpbWFnZS51cmxdO1xuICBpZiAoZGF0YVVybCA9PSBudWxsKSB7XG4gICAgcmV0dXJuIHt0ZXh0OiAnJ307XG4gIH1cbiAgY29uc3QgdyA9IGltYWdlLnN0eWxlcy53aWR0aDtcbiAgaWYgKHR5cGVvZiAodykgPT09ICdzdHJpbmcnICYmIHcuZW5kc1dpdGgoJ3B4JykpIHtcbiAgICB3aWR0aCA9IE51bWJlcih3LnNsaWNlKDAsIC0yKSk7XG4gIH1cbiAgcmV0dXJuIHtpbWFnZTogZGF0YVVybCwgd2lkdGgsIG1hcmdpbjogWzAsIDAsIDAsIG1hcmdpbkJldHdlZW5XaWRnZXRzXX07XG59XG5cbmZ1bmN0aW9uIHRleHRUb1BkZih0dzogQWpmVGV4dFdpZGdldEluc3RhbmNlKTogQ29udGVudCB7XG4gIGNvbnN0IHRleHQ6IENvbnRlbnQgPSB7XG4gICAgdGV4dDogc3RyaXBIVE1MKHR3Lmh0bWxUZXh0KSxcbiAgICBtYXJnaW46IFswLCAwLCAwLCBtYXJnaW5CZXR3ZWVuV2lkZ2V0c10sXG4gIH07XG4gIGlmICh0dy5odG1sVGV4dC5zdGFydHNXaXRoKCc8aDE+JykpIHtcbiAgICB0ZXh0LmZvbnRTaXplID0gMjA7XG4gICAgdGV4dC5tYXJnaW4gPSBbMCwgMTAsIDAsIG1hcmdpbkJldHdlZW5XaWRnZXRzXTtcbiAgfSBlbHNlIGlmICh0dy5odG1sVGV4dC5zdGFydHNXaXRoKCc8aDI+JykpIHtcbiAgICB0ZXh0LmZvbnRTaXplID0gMTU7XG4gICAgdGV4dC5tYXJnaW4gPSBbMCwgNSwgMCwgbWFyZ2luQmV0d2VlbldpZGdldHNdO1xuICB9XG4gIHJldHVybiB0ZXh0O1xufVxuXG5mdW5jdGlvbiB0YWJsZVRvUGRmKHRhYmxlOiBBamZUYWJsZVdpZGdldEluc3RhbmNlKTogQ29udGVudCB7XG4gIGlmICh0YWJsZS5kYXRhID09IG51bGwgfHwgdGFibGUuZGF0YS5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4ge3RleHQ6ICcnfTtcbiAgfVxuICBjb25zdCBib2R5OiBUYWJsZUNlbGxbXVtdID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdGFibGUuZGF0YS5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGRhdGFSb3cgPSB0YWJsZS5kYXRhW2ldO1xuICAgIGNvbnN0IGJvZHlSb3c6IFRhYmxlQ2VsbFtdID0gW107XG4gICAgZm9yIChsZXQgaiA9IDA7IGogPCBkYXRhUm93Lmxlbmd0aDsgaisrKSB7XG4gICAgICBjb25zdCBjZWxsID0gZGF0YVJvd1tqXTtcbiAgICAgIGJvZHlSb3cucHVzaCh7dGV4dDogdGFibGUuZGF0YXNldFtpXVtqXSwgY29sU3BhbjogY2VsbC5jb2xzcGFufSk7XG4gICAgICAvLyBwZGZtYWtlIHdhbnRzIHBsYWNlaG9sZGVyIGNlbGxzIGFmdGVyIGNlbGxzIHdpdGggY29sc3BhbiA+IDE6XG4gICAgICBmb3IgKGxldCBrID0gMTsgayA8IChjZWxsLmNvbHNwYW4gfHwgMSk7IGsrKykge1xuICAgICAgICBib2R5Um93LnB1c2goe3RleHQ6ICcnfSk7XG4gICAgICB9XG4gICAgfVxuICAgIGJvZHkucHVzaChib2R5Um93KTtcbiAgfVxuICByZXR1cm4ge3RhYmxlOiB7aGVhZGVyUm93czogMCwgYm9keX0sIG1hcmdpbjogWzAsIDAsIDAsIG1hcmdpbkJldHdlZW5XaWRnZXRzXX07XG59XG5cbmZ1bmN0aW9uIHN0cmlwSFRNTChzOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gcy5yZXBsYWNlKC88XFwvP1tePl0rKD58JCkvZywgJycpO1xufVxuIl19