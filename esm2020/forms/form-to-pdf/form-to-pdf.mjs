/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { evaluateExpression } from '@ajf/core/models';
import { vfsFonts, vfsFontsMap } from '@ajf/core/vfs-fonts';
import * as pdfMakeModule from 'pdfmake/build/pdfmake';
import { AjfFieldType } from '../interface/fields/field-type';
import { AjfNodeType } from '../interface/nodes/node-type';
const { createPdf } = (pdfMakeModule.default || pdfMakeModule);
export function createFormPdf(form, translate, orientation, header, context) {
    const t = translate ? translate : (s) => s;
    const pdfDef = formToPdf(form, t, orientation, header, context);
    return createPdf(pdfDef, undefined, vfsFontsMap, vfsFonts);
}
function stripHTML(s) {
    return s.replace(/<\/?[^>]+(>|$)/g, '');
}
// Given a context, lookupStringFunction returns a function that allows to retrieve
// the field values from the context. The values are returned as print-friendly strings.
// rep is the index of the repeating slide, if the field belongs to one.
function lookupStringFunction(context, rep) {
    if (context == null) {
        return (_) => ' ';
    }
    return (name) => {
        if (name == null) {
            return ' ';
        }
        if (rep != null) {
            name = name + '__' + rep;
        }
        const val = context[name];
        if (val == null) {
            return ' ';
        }
        if (val === true) {
            return 'yes';
        }
        if (val === false) {
            return 'no';
        }
        return String(val);
    };
}
// Analogous to lookupStringFunction, but for multiple-choice questions,
// returning an array of values.
function lookupArrayFunction(context, rep) {
    if (context == null) {
        return (_) => [];
    }
    return (name) => {
        if (name == null) {
            return [];
        }
        if (rep != null) {
            name = name + '__' + rep;
        }
        const val = context[name];
        if (Array.isArray(val)) {
            return val;
        }
        return [];
    };
}
// Given an AjfForm, returns its pdfmake pdf document definition.
function formToPdf(form, translate, orientation, header, context) {
    const choicesMap = {};
    for (const o of form.choicesOrigins) {
        choicesMap[o.name] = o.choices;
    }
    const content = header ? [...header] : [];
    for (const slide of form.nodes) {
        if (slide.nodeType === AjfNodeType.AjfSlide) {
            content.push(...slideToPdf(slide, choicesMap, translate, context));
        }
        else if (slide.nodeType === AjfNodeType.AjfRepeatingSlide) {
            content.push(...repeatingSlideToPdf(slide, choicesMap, translate, context));
        }
    }
    return { content, pageOrientation: orientation };
}
function slideToPdf(slide, choicesMap, translate, context, rep) {
    let label = translate(slide.label);
    if (rep != null) {
        label = `${label} (${translate('repeat')} ${rep})`;
    }
    const content = [{ text: label, fontSize: 18, bold: true, margin: [0, 15, 0, 10] }];
    for (const field of slide.nodes) {
        content.push(...fieldToPdf(field, choicesMap, translate, context, rep));
    }
    return content;
}
function repeatingSlideToPdf(slide, choicesMap, translate, context) {
    let repeats = 3; // default, if no formData
    const maxRepeats = 20;
    if (context != null && slide.name != null) {
        const r = context[slide.name];
        if (typeof r === 'number') {
            repeats = Math.min(r, maxRepeats);
        }
    }
    const content = [];
    for (let r = 0; r < repeats; r++) {
        content.push(...slideToPdf(slide, choicesMap, translate, context, r));
    }
    return content;
}
function borderlessCell(text, bold) {
    return { table: { body: [[{ text, bold, border: [false, false, false, false] }]] } };
}
function fieldToPdf(field, choicesMap, translate, context, rep) {
    if (field.nodeType !== AjfNodeType.AjfField) {
        throw new Error('not a field');
    }
    const visible = context == null /* form not compiled, show all fields */ ||
        field.visibility == null ||
        evaluateExpression(field.visibility.condition, context);
    if (!visible) {
        return [];
    }
    const lookupString = lookupStringFunction(context, rep);
    switch (field.fieldType) {
        case AjfFieldType.String:
        case AjfFieldType.Text:
            return [
                borderlessCell(translate(field.label)),
                { table: { widths: ['*'], body: [[lookupString(field.name)]] }, margin: [5, 0, 0, 5] },
            ];
        case AjfFieldType.Formula:
            const formula = field.formula.formula;
            const value = evaluateExpression(formula, context);
            return [
                borderlessCell(translate(field.label)),
                { table: { widths: ['*'], body: [[String(value)]] }, margin: [5, 0, 0, 5] },
            ];
        case AjfFieldType.Number:
        case AjfFieldType.Boolean:
        case AjfFieldType.DateInput:
        case AjfFieldType.Time:
            let val = lookupString(field.name);
            // for boolean fields in compiled forms, a null value is printed as 'no':
            if (field.fieldType === AjfFieldType.Boolean && context != null && val === ' ') {
                val = 'no';
            }
            return [
                {
                    table: {
                        widths: ['*', '*'],
                        body: [[{ text: translate(field.label), border: [false, false, false, false] }, val]],
                    },
                },
            ];
        case AjfFieldType.SingleChoice:
        case AjfFieldType.MultipleChoice:
            const choices = choicesMap[field.choicesOriginRef];
            if (context == null) {
                // empty form
                return choiceToPdf(field, choices, translate);
            }
            // compiled form, only print choices that are selected
            const selectedValues = field.fieldType === AjfFieldType.SingleChoice
                ? [lookupString(field.name)]
                : lookupArrayFunction(context, rep)(field.name);
            let selectedChoices = selectedValues
                .map(v => choices.find(c => c.value === v))
                .filter(c => c);
            if (selectedChoices.length === 0) {
                selectedChoices = selectedValues.map(v => ({
                    label: v,
                    value: v,
                }));
            }
            return choiceToPdf(field, selectedChoices, translate, context);
        case AjfFieldType.Empty:
            const text = stripHTML(translate(field.HTML));
            return [borderlessCell(text, true)];
        case AjfFieldType.Table:
            return tableToPdf(field, lookupString, translate);
        default:
            // yet unsupported field type
            return [];
    }
}
function choiceToPdf(field, choices, translate, context) {
    let choiceLabels;
    if (choices == null || choices.length === 0) {
        choiceLabels = [' '];
    }
    else {
        choiceLabels = choices.map(c => c.label);
    }
    const body = [];
    for (const c of choiceLabels) {
        body.push([translate(c)]);
    }
    let question = translate(field.label);
    // If the form is empty (to be compiled),
    // help the user distinguish between single- and multiple-choice questions:
    if (context == null && field.fieldType === AjfFieldType.SingleChoice) {
        question += ` (${translate('single choice')})`;
    }
    if (context == null && field.fieldType === AjfFieldType.MultipleChoice) {
        question += ` (${translate('multipe choice')})`;
    }
    return [
        {
            columns: [
                borderlessCell(question),
                {
                    table: { widths: ['*'], body },
                },
            ],
            margin: [0, 0, 0, 5],
        },
    ];
}
function tableToPdf(table, lookupString, translate) {
    const body = [['', ...table.columnLabels.map(translate)]];
    for (let i = 0; i < table.rows.length; i++) {
        const row = [...table.rows[i]];
        for (let j = 0; j < row.length; j++) {
            if (typeof row[j] !== 'string') {
                row[j] = row[j].formula;
            }
        }
        const valsRow = row.map(lookupString).map(translate);
        body.push([translate(table.rowLabels[i]), ...valsRow]);
    }
    return [
        borderlessCell(translate(table.label)),
        { table: { body, widths: Array(table.columnLabels.length + 1).fill('*') }, margin: [5, 0, 0, 5] },
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS10by1wZGYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9mb3Jtcy9mb3JtLXRvLXBkZi9mb3JtLXRvLXBkZi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7QUFFSCxPQUFPLEVBQXlCLGtCQUFrQixFQUFDLE1BQU0sa0JBQWtCLENBQUM7QUFDNUUsT0FBTyxFQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUMxRCxPQUFPLEtBQUssYUFBYSxNQUFNLHVCQUF1QixDQUFDO0FBUXZELE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxnQ0FBZ0MsQ0FBQztBQUk1RCxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sOEJBQThCLENBQUM7QUFJekQsTUFBTSxFQUFDLFNBQVMsRUFBQyxHQUFHLENBQUUsYUFBcUIsQ0FBQyxPQUFPLElBQUksYUFBYSxDQUF5QixDQUFDO0FBRTlGLE1BQU0sVUFBVSxhQUFhLENBQzNCLElBQWEsRUFDYixTQUFpQyxFQUNqQyxXQUE2QixFQUM3QixNQUFrQixFQUNsQixPQUFvQjtJQUVwQixNQUFNLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNuRCxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2hFLE9BQU8sU0FBUyxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQzdELENBQUM7QUFPRCxTQUFTLFNBQVMsQ0FBQyxDQUFTO0lBQzFCLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLENBQUMsQ0FBQztB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Y29vcC5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vclxuICogbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzXG4gKiBwdWJsaXNoZWQgYnkgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSxcbiAqIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlUgQWZmZXJvXG4gKiBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKiBJZiBub3QsIHNlZSBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvLlxuICpcbiAqL1xuXG5pbXBvcnQge0FqZkNvbnRleHQsIEFqZkZvcm11bGEsIGV2YWx1YXRlRXhwcmVzc2lvbn0gZnJvbSAnQGFqZi9jb3JlL21vZGVscyc7XG5pbXBvcnQge3Zmc0ZvbnRzLCB2ZnNGb250c01hcH0gZnJvbSAnQGFqZi9jb3JlL3Zmcy1mb250cyc7XG5pbXBvcnQgKiBhcyBwZGZNYWtlTW9kdWxlIGZyb20gJ3BkZm1ha2UvYnVpbGQvcGRmbWFrZSc7XG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZHVwbGljYXRlLWltcG9ydHNcbmltcG9ydCB7VENyZWF0ZWRQZGZ9IGZyb20gJ3BkZm1ha2UvYnVpbGQvcGRmbWFrZSc7XG5pbXBvcnQge0NvbnRlbnQsIFBhZ2VPcmllbnRhdGlvbiwgVERvY3VtZW50RGVmaW5pdGlvbnN9IGZyb20gJ3BkZm1ha2UvaW50ZXJmYWNlcyc7XG5cbmltcG9ydCB7QWpmQ2hvaWNlfSBmcm9tICcuLi9pbnRlcmZhY2UvY2hvaWNlcy9jaG9pY2UnO1xuaW1wb3J0IHtBamZFbXB0eUZpZWxkfSBmcm9tICcuLi9pbnRlcmZhY2UvZmllbGRzL2VtcHR5LWZpZWxkJztcbmltcG9ydCB7QWpmRmllbGR9IGZyb20gJy4uL2ludGVyZmFjZS9maWVsZHMvZmllbGQnO1xuaW1wb3J0IHtBamZGaWVsZFR5cGV9IGZyb20gJy4uL2ludGVyZmFjZS9maWVsZHMvZmllbGQtdHlwZSc7XG5pbXBvcnQge0FqZkZvcm11bGFGaWVsZH0gZnJvbSAnLi4vaW50ZXJmYWNlL2ZpZWxkcy9mb3JtdWxhLWZpZWxkJztcbmltcG9ydCB7QWpmVGFibGVDZWxsLCBBamZUYWJsZUZpZWxkfSBmcm9tICcuLi9pbnRlcmZhY2UvZmllbGRzL3RhYmxlLWZpZWxkJztcbmltcG9ydCB7QWpmRm9ybX0gZnJvbSAnLi4vaW50ZXJmYWNlL2Zvcm1zL2Zvcm0nO1xuaW1wb3J0IHtBamZOb2RlVHlwZX0gZnJvbSAnLi4vaW50ZXJmYWNlL25vZGVzL25vZGUtdHlwZSc7XG5pbXBvcnQge0FqZlJlcGVhdGluZ1NsaWRlfSBmcm9tICcuLi9pbnRlcmZhY2Uvc2xpZGVzL3JlcGVhdGluZy1zbGlkZSc7XG5pbXBvcnQge0FqZlNsaWRlfSBmcm9tICcuLi9pbnRlcmZhY2Uvc2xpZGVzL3NsaWRlJztcblxuY29uc3Qge2NyZWF0ZVBkZn0gPSAoKHBkZk1ha2VNb2R1bGUgYXMgYW55KS5kZWZhdWx0IHx8IHBkZk1ha2VNb2R1bGUpIGFzIHR5cGVvZiBwZGZNYWtlTW9kdWxlO1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRm9ybVBkZihcbiAgZm9ybTogQWpmRm9ybSxcbiAgdHJhbnNsYXRlPzogKHM6IHN0cmluZykgPT4gc3RyaW5nLFxuICBvcmllbnRhdGlvbj86IFBhZ2VPcmllbnRhdGlvbixcbiAgaGVhZGVyPzogQ29udGVudFtdLFxuICBjb250ZXh0PzogQWpmQ29udGV4dCxcbik6IFRDcmVhdGVkUGRmIHtcbiAgY29uc3QgdCA9IHRyYW5zbGF0ZSA/IHRyYW5zbGF0ZSA6IChzOiBzdHJpbmcpID0+IHM7XG4gIGNvbnN0IHBkZkRlZiA9IGZvcm1Ub1BkZihmb3JtLCB0LCBvcmllbnRhdGlvbiwgaGVhZGVyLCBjb250ZXh0KTtcbiAgcmV0dXJuIGNyZWF0ZVBkZihwZGZEZWYsIHVuZGVmaW5lZCwgdmZzRm9udHNNYXAsIHZmc0ZvbnRzKTtcbn1cblxuLy8gQ2hvaWNlc01hcCBtYXBzIGEgY2hvaWNlc09yaWdpblJlZiB0byB0aGUgbGlzdCB0aGUgY2hvaWNlcy5cbmludGVyZmFjZSBDaG9pY2VzTWFwIHtcbiAgW25hbWU6IHN0cmluZ106IEFqZkNob2ljZTxhbnk+W107XG59XG5cbmZ1bmN0aW9uIHN0cmlwSFRNTChzOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gcy5yZXBsYWNlKC88XFwvP1tePl0rKD58JCkvZywgJycpO1xufVxuXG4vLyBHaXZlbiBhIGNvbnRleHQsIGxvb2t1cFN0cmluZ0Z1bmN0aW9uIHJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGFsbG93cyB0byByZXRyaWV2ZVxuLy8gdGhlIGZpZWxkIHZhbHVlcyBmcm9tIHRoZSBjb250ZXh0LiBUaGUgdmFsdWVzIGFyZSByZXR1cm5lZCBhcyBwcmludC1mcmllbmRseSBzdHJpbmdzLlxuLy8gcmVwIGlzIHRoZSBpbmRleCBvZiB0aGUgcmVwZWF0aW5nIHNsaWRlLCBpZiB0aGUgZmllbGQgYmVsb25ncyB0byBvbmUuXG5mdW5jdGlvbiBsb29rdXBTdHJpbmdGdW5jdGlvbihjb250ZXh0PzogQWpmQ29udGV4dCwgcmVwPzogbnVtYmVyKTogKG5hbWU6IHN0cmluZykgPT4gc3RyaW5nIHtcbiAgaWYgKGNvbnRleHQgPT0gbnVsbCkge1xuICAgIHJldHVybiAoXzogc3RyaW5nKSA9PiAnICc7XG4gIH1cbiAgcmV0dXJuIChuYW1lOiBzdHJpbmcpID0+IHtcbiAgICBpZiAobmFtZSA9PSBudWxsKSB7XG4gICAgICByZXR1cm4gJyAnO1xuICAgIH1cbiAgICBpZiAocmVwICE9IG51bGwpIHtcbiAgICAgIG5hbWUgPSBuYW1lICsgJ19fJyArIHJlcDtcbiAgICB9XG4gICAgY29uc3QgdmFsID0gY29udGV4dFtuYW1lXTtcbiAgICBpZiAodmFsID09IG51bGwpIHtcbiAgICAgIHJldHVybiAnICc7XG4gICAgfVxuICAgIGlmICh2YWwgPT09IHRydWUpIHtcbiAgICAgIHJldHVybiAneWVzJztcbiAgICB9XG4gICAgaWYgKHZhbCA9PT0gZmFsc2UpIHtcbiAgICAgIHJldHVybiAnbm8nO1xuICAgIH1cbiAgICByZXR1cm4gU3RyaW5nKHZhbCk7XG4gIH07XG59XG5cbi8vIEFuYWxvZ291cyB0byBsb29rdXBTdHJpbmdGdW5jdGlvbiwgYnV0IGZvciBtdWx0aXBsZS1jaG9pY2UgcXVlc3Rpb25zLFxuLy8gcmV0dXJuaW5nIGFuIGFycmF5IG9mIHZhbHVlcy5cbmZ1bmN0aW9uIGxvb2t1cEFycmF5RnVuY3Rpb24oY29udGV4dD86IEFqZkNvbnRleHQsIHJlcD86IG51bWJlcik6IChuYW1lOiBzdHJpbmcpID0+IHN0cmluZ1tdIHtcbiAgaWYgKGNvbnRleHQgPT0gbnVsbCkge1xuICAgIHJldHVybiAoXzogc3RyaW5nKSA9PiBbXTtcbiAgfVxuICByZXR1cm4gKG5hbWU6IHN0cmluZykgPT4ge1xuICAgIGlmIChuYW1lID09IG51bGwpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgaWYgKHJlcCAhPSBudWxsKSB7XG4gICAgICBuYW1lID0gbmFtZSArICdfXycgKyByZXA7XG4gICAgfVxuICAgIGNvbnN0IHZhbCA9IGNvbnRleHRbbmFtZV07XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkge1xuICAgICAgcmV0dXJuIHZhbDtcbiAgICB9XG4gICAgcmV0dXJuIFtdO1xuICB9O1xufVxuXG4vLyBHaXZlbiBhbiBBamZGb3JtLCByZXR1cm5zIGl0cyBwZGZtYWtlIHBkZiBkb2N1bWVudCBkZWZpbml0aW9uLlxuZnVuY3Rpb24gZm9ybVRvUGRmKFxuICBmb3JtOiBBamZGb3JtLFxuICB0cmFuc2xhdGU6IChzOiBzdHJpbmcpID0+IHN0cmluZyxcbiAgb3JpZW50YXRpb24/OiBQYWdlT3JpZW50YXRpb24sXG4gIGhlYWRlcj86IENvbnRlbnRbXSxcbiAgY29udGV4dD86IEFqZkNvbnRleHQsXG4pOiBURG9jdW1lbnREZWZpbml0aW9ucyB7XG4gIGNvbnN0IGNob2ljZXNNYXA6IENob2ljZXNNYXAgPSB7fTtcbiAgZm9yIChjb25zdCBvIG9mIGZvcm0uY2hvaWNlc09yaWdpbnMpIHtcbiAgICBjaG9pY2VzTWFwW28ubmFtZV0gPSBvLmNob2ljZXM7XG4gIH1cblxuICBjb25zdCBjb250ZW50ID0gaGVhZGVyID8gWy4uLmhlYWRlcl0gOiBbXTtcbiAgZm9yIChjb25zdCBzbGlkZSBvZiBmb3JtLm5vZGVzKSB7XG4gICAgaWYgKHNsaWRlLm5vZGVUeXBlID09PSBBamZOb2RlVHlwZS5BamZTbGlkZSkge1xuICAgICAgY29udGVudC5wdXNoKC4uLnNsaWRlVG9QZGYoc2xpZGUgYXMgQWpmU2xpZGUsIGNob2ljZXNNYXAsIHRyYW5zbGF0ZSwgY29udGV4dCkpO1xuICAgIH0gZWxzZSBpZiAoc2xpZGUubm9kZVR5cGUgPT09IEFqZk5vZGVUeXBlLkFqZlJlcGVhdGluZ1NsaWRlKSB7XG4gICAgICBjb250ZW50LnB1c2goXG4gICAgICAgIC4uLnJlcGVhdGluZ1NsaWRlVG9QZGYoc2xpZGUgYXMgQWpmUmVwZWF0aW5nU2xpZGUsIGNob2ljZXNNYXAsIHRyYW5zbGF0ZSwgY29udGV4dCksXG4gICAgICApO1xuICAgIH1cbiAgfVxuICByZXR1cm4ge2NvbnRlbnQsIHBhZ2VPcmllbnRhdGlvbjogb3JpZW50YXRpb259O1xufVxuXG5mdW5jdGlvbiBzbGlkZVRvUGRmKFxuICBzbGlkZTogQWpmU2xpZGUgfCBBamZSZXBlYXRpbmdTbGlkZSxcbiAgY2hvaWNlc01hcDogQ2hvaWNlc01hcCxcbiAgdHJhbnNsYXRlOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4gIGNvbnRleHQ/OiBBamZDb250ZXh0LFxuICByZXA/OiBudW1iZXIsXG4pOiBDb250ZW50W10ge1xuICBsZXQgbGFiZWwgPSB0cmFuc2xhdGUoc2xpZGUubGFiZWwpO1xuICBpZiAocmVwICE9IG51bGwpIHtcbiAgICBsYWJlbCA9IGAke2xhYmVsfSAoJHt0cmFuc2xhdGUoJ3JlcGVhdCcpfSAke3JlcH0pYDtcbiAgfVxuICBjb25zdCBjb250ZW50OiBDb250ZW50W10gPSBbe3RleHQ6IGxhYmVsLCBmb250U2l6ZTogMTgsIGJvbGQ6IHRydWUsIG1hcmdpbjogWzAsIDE1LCAwLCAxMF19XTtcbiAgZm9yIChjb25zdCBmaWVsZCBvZiBzbGlkZS5ub2RlcyBhcyBBamZGaWVsZFtdKSB7XG4gICAgY29udGVudC5wdXNoKC4uLmZpZWxkVG9QZGYoZmllbGQsIGNob2ljZXNNYXAsIHRyYW5zbGF0ZSwgY29udGV4dCwgcmVwKSk7XG4gIH1cbiAgcmV0dXJuIGNvbnRlbnQ7XG59XG5cbmZ1bmN0aW9uIHJlcGVhdGluZ1NsaWRlVG9QZGYoXG4gIHNsaWRlOiBBamZSZXBlYXRpbmdTbGlkZSxcbiAgY2hvaWNlc01hcDogQ2hvaWNlc01hcCxcbiAgdHJhbnNsYXRlOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4gIGNvbnRleHQ/OiBBamZDb250ZXh0LFxuKTogQ29udGVudFtdIHtcbiAgbGV0IHJlcGVhdHMgPSAzOyAvLyBkZWZhdWx0LCBpZiBubyBmb3JtRGF0YVxuICBjb25zdCBtYXhSZXBlYXRzID0gMjA7XG4gIGlmIChjb250ZXh0ICE9IG51bGwgJiYgc2xpZGUubmFtZSAhPSBudWxsKSB7XG4gICAgY29uc3QgciA9IGNvbnRleHRbc2xpZGUubmFtZV07XG4gICAgaWYgKHR5cGVvZiByID09PSAnbnVtYmVyJykge1xuICAgICAgcmVwZWF0cyA9IE1hdGgubWluKHIsIG1heFJlcGVhdHMpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGNvbnRlbnQgPSBbXTtcbiAgZm9yIChsZXQgciA9IDA7IHIgPCByZXBlYXRzOyByKyspIHtcbiAgICBjb250ZW50LnB1c2goLi4uc2xpZGVUb1BkZihzbGlkZSwgY2hvaWNlc01hcCwgdHJhbnNsYXRlLCBjb250ZXh0LCByKSk7XG4gIH1cbiAgcmV0dXJuIGNvbnRlbnQ7XG59XG5cbmZ1bmN0aW9uIGJvcmRlcmxlc3NDZWxsKHRleHQ6IHN0cmluZywgYm9sZD86IGJvb2xlYW4pOiBDb250ZW50IHtcbiAgcmV0dXJuIHt0YWJsZToge2JvZHk6IFtbe3RleHQsIGJvbGQsIGJvcmRlcjogW2ZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlXX1dXX19O1xufVxuXG5mdW5jdGlvbiBmaWVsZFRvUGRmKFxuICBmaWVsZDogQWpmRmllbGQsXG4gIGNob2ljZXNNYXA6IENob2ljZXNNYXAsXG4gIHRyYW5zbGF0ZTogKHM6IHN0cmluZykgPT4gc3RyaW5nLFxuICBjb250ZXh0PzogQWpmQ29udGV4dCxcbiAgcmVwPzogbnVtYmVyLFxuKTogQ29udGVudFtdIHtcbiAgaWYgKGZpZWxkLm5vZGVUeXBlICE9PSBBamZOb2RlVHlwZS5BamZGaWVsZCkge1xuICAgIHRocm93IG5ldyBFcnJvcignbm90IGEgZmllbGQnKTtcbiAgfVxuXG4gIGNvbnN0IHZpc2libGUgPVxuICAgIGNvbnRleHQgPT0gbnVsbCAvKiBmb3JtIG5vdCBjb21waWxlZCwgc2hvdyBhbGwgZmllbGRzICovIHx8XG4gICAgZmllbGQudmlzaWJpbGl0eSA9PSBudWxsIHx8XG4gICAgZXZhbHVhdGVFeHByZXNzaW9uKGZpZWxkLnZpc2liaWxpdHkuY29uZGl0aW9uLCBjb250ZXh0KTtcbiAgaWYgKCF2aXNpYmxlKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgY29uc3QgbG9va3VwU3RyaW5nID0gbG9va3VwU3RyaW5nRnVuY3Rpb24oY29udGV4dCwgcmVwKTtcblxuICBzd2l0Y2ggKGZpZWxkLmZpZWxkVHlwZSkge1xuICAgIGNhc2UgQWpmRmllbGRUeXBlLlN0cmluZzpcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5UZXh0OlxuICAgICAgcmV0dXJuIFtcbiAgICAgICAgYm9yZGVybGVzc0NlbGwodHJhbnNsYXRlKGZpZWxkLmxhYmVsKSksXG4gICAgICAgIHt0YWJsZToge3dpZHRoczogWycqJ10sIGJvZHk6IFtbbG9va3VwU3RyaW5nKGZpZWxkLm5hbWUpXV19LCBtYXJnaW46IFs1LCAwLCAwLCA1XX0sXG4gICAgICBdO1xuICAgIGNhc2UgQWpmRmllbGRUeXBlLkZvcm11bGE6XG4gICAgICBjb25zdCBmb3JtdWxhID0gKChmaWVsZCBhcyBBamZGb3JtdWxhRmllbGQpLmZvcm11bGEgYXMgQWpmRm9ybXVsYSkuZm9ybXVsYTtcbiAgICAgIGNvbnN0IHZhbHVlID0gZXZhbHVhdGVFeHByZXNzaW9uKGZvcm11bGEsIGNvbnRleHQpO1xuICAgICAgcmV0dXJuIFtcbiAgICAgICAgYm9yZGVybGVzc0NlbGwodHJhbnNsYXRlKGZpZWxkLmxhYmVsKSksXG4gICAgICAgIHt0YWJsZToge3dpZHRoczogWycqJ10sIGJvZHk6IFtbU3RyaW5nKHZhbHVlKV1dfSwgbWFyZ2luOiBbNSwgMCwgMCwgNV19LFxuICAgICAgXTtcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5OdW1iZXI6XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuQm9vbGVhbjpcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5EYXRlSW5wdXQ6XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuVGltZTpcbiAgICAgIGxldCB2YWwgPSBsb29rdXBTdHJpbmcoZmllbGQubmFtZSk7XG4gICAgICAvLyBmb3IgYm9vbGVhbiBmaWVsZHMgaW4gY29tcGlsZWQgZm9ybXMsIGEgbnVsbCB2YWx1ZSBpcyBwcmludGVkIGFzICdubyc6XG4gICAgICBpZiAoZmllbGQuZmllbGRUeXBlID09PSBBamZGaWVsZFR5cGUuQm9vbGVhbiAmJiBjb250ZXh0ICE9IG51bGwgJiYgdmFsID09PSAnICcpIHtcbiAgICAgICAgdmFsID0gJ25vJztcbiAgICAgIH1cbiAgICAgIHJldHVybiBbXG4gICAgICAgIHtcbiAgICAgICAgICB0YWJsZToge1xuICAgICAgICAgICAgd2lkdGhzOiBbJyonLCAnKiddLFxuICAgICAgICAgICAgYm9keTogW1t7dGV4dDogdHJhbnNsYXRlKGZpZWxkLmxhYmVsKSwgYm9yZGVyOiBbZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2VdfSwgdmFsXV0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIF07XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuU2luZ2xlQ2hvaWNlOlxuICAgIGNhc2UgQWpmRmllbGRUeXBlLk11bHRpcGxlQ2hvaWNlOlxuICAgICAgY29uc3QgY2hvaWNlcyA9IGNob2ljZXNNYXBbKGZpZWxkIGFzIGFueSkuY2hvaWNlc09yaWdpblJlZl07XG4gICAgICBpZiAoY29udGV4dCA9PSBudWxsKSB7XG4gICAgICAgIC8vIGVtcHR5IGZvcm1cbiAgICAgICAgcmV0dXJuIGNob2ljZVRvUGRmKGZpZWxkLCBjaG9pY2VzLCB0cmFuc2xhdGUpO1xuICAgICAgfVxuICAgICAgLy8gY29tcGlsZWQgZm9ybSwgb25seSBwcmludCBjaG9pY2VzIHRoYXQgYXJlIHNlbGVjdGVkXG4gICAgICBjb25zdCBzZWxlY3RlZFZhbHVlcyA9XG4gICAgICAgIGZpZWxkLmZpZWxkVHlwZSA9PT0gQWpmRmllbGRUeXBlLlNpbmdsZUNob2ljZVxuICAgICAgICAgID8gW2xvb2t1cFN0cmluZyhmaWVsZC5uYW1lKV1cbiAgICAgICAgICA6IGxvb2t1cEFycmF5RnVuY3Rpb24oY29udGV4dCwgcmVwKShmaWVsZC5uYW1lKTtcbiAgICAgIGxldCBzZWxlY3RlZENob2ljZXMgPSBzZWxlY3RlZFZhbHVlc1xuICAgICAgICAubWFwKHYgPT4gY2hvaWNlcy5maW5kKGMgPT4gYy52YWx1ZSA9PT0gdikpXG4gICAgICAgIC5maWx0ZXIoYyA9PiBjKSBhcyBBamZDaG9pY2U8YW55PltdO1xuICAgICAgaWYgKHNlbGVjdGVkQ2hvaWNlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgc2VsZWN0ZWRDaG9pY2VzID0gc2VsZWN0ZWRWYWx1ZXMubWFwKFxuICAgICAgICAgIHYgPT5cbiAgICAgICAgICAgICh7XG4gICAgICAgICAgICAgIGxhYmVsOiB2LFxuICAgICAgICAgICAgICB2YWx1ZTogdixcbiAgICAgICAgICAgIH0gYXMgQWpmQ2hvaWNlPHN0cmluZz4pLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGNob2ljZVRvUGRmKGZpZWxkLCBzZWxlY3RlZENob2ljZXMsIHRyYW5zbGF0ZSwgY29udGV4dCk7XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuRW1wdHk6XG4gICAgICBjb25zdCB0ZXh0ID0gc3RyaXBIVE1MKHRyYW5zbGF0ZSgoZmllbGQgYXMgQWpmRW1wdHlGaWVsZCkuSFRNTCkpO1xuICAgICAgcmV0dXJuIFtib3JkZXJsZXNzQ2VsbCh0ZXh0LCB0cnVlKV07XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuVGFibGU6XG4gICAgICByZXR1cm4gdGFibGVUb1BkZihmaWVsZCBhcyBBamZUYWJsZUZpZWxkLCBsb29rdXBTdHJpbmcsIHRyYW5zbGF0ZSk7XG4gICAgZGVmYXVsdDpcbiAgICAgIC8vIHlldCB1bnN1cHBvcnRlZCBmaWVsZCB0eXBlXG4gICAgICByZXR1cm4gW107XG4gIH1cbn1cblxuZnVuY3Rpb24gY2hvaWNlVG9QZGYoXG4gIGZpZWxkOiBBamZGaWVsZCxcbiAgY2hvaWNlczogQWpmQ2hvaWNlPGFueT5bXSxcbiAgdHJhbnNsYXRlOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4gIGNvbnRleHQ/OiBBamZDb250ZXh0LFxuKTogQ29udGVudFtdIHtcbiAgbGV0IGNob2ljZUxhYmVsczogc3RyaW5nW107XG4gIGlmIChjaG9pY2VzID09IG51bGwgfHwgY2hvaWNlcy5sZW5ndGggPT09IDApIHtcbiAgICBjaG9pY2VMYWJlbHMgPSBbJyAnXTtcbiAgfSBlbHNlIHtcbiAgICBjaG9pY2VMYWJlbHMgPSBjaG9pY2VzLm1hcChjID0+IGMubGFiZWwpO1xuICB9XG4gIGNvbnN0IGJvZHkgPSBbXTtcbiAgZm9yIChjb25zdCBjIG9mIGNob2ljZUxhYmVscykge1xuICAgIGJvZHkucHVzaChbdHJhbnNsYXRlKGMpXSk7XG4gIH1cbiAgbGV0IHF1ZXN0aW9uID0gdHJhbnNsYXRlKGZpZWxkLmxhYmVsKTtcbiAgLy8gSWYgdGhlIGZvcm0gaXMgZW1wdHkgKHRvIGJlIGNvbXBpbGVkKSxcbiAgLy8gaGVscCB0aGUgdXNlciBkaXN0aW5ndWlzaCBiZXR3ZWVuIHNpbmdsZS0gYW5kIG11bHRpcGxlLWNob2ljZSBxdWVzdGlvbnM6XG4gIGlmIChjb250ZXh0ID09IG51bGwgJiYgZmllbGQuZmllbGRUeXBlID09PSBBamZGaWVsZFR5cGUuU2luZ2xlQ2hvaWNlKSB7XG4gICAgcXVlc3Rpb24gKz0gYCAoJHt0cmFuc2xhdGUoJ3NpbmdsZSBjaG9pY2UnKX0pYDtcbiAgfVxuICBpZiAoY29udGV4dCA9PSBudWxsICYmIGZpZWxkLmZpZWxkVHlwZSA9PT0gQWpmRmllbGRUeXBlLk11bHRpcGxlQ2hvaWNlKSB7XG4gICAgcXVlc3Rpb24gKz0gYCAoJHt0cmFuc2xhdGUoJ211bHRpcGUgY2hvaWNlJyl9KWA7XG4gIH1cbiAgcmV0dXJuIFtcbiAgICB7XG4gICAgICBjb2x1bW5zOiBbXG4gICAgICAgIGJvcmRlcmxlc3NDZWxsKHF1ZXN0aW9uKSxcbiAgICAgICAge1xuICAgICAgICAgIHRhYmxlOiB7d2lkdGhzOiBbJyonXSwgYm9keX0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgbWFyZ2luOiBbMCwgMCwgMCwgNV0sXG4gICAgfSxcbiAgXTtcbn1cblxuZnVuY3Rpb24gdGFibGVUb1BkZihcbiAgdGFibGU6IEFqZlRhYmxlRmllbGQsXG4gIGxvb2t1cFN0cmluZzogKHM6IHN0cmluZykgPT4gc3RyaW5nLFxuICB0cmFuc2xhdGU6IChzOiBzdHJpbmcpID0+IHN0cmluZyxcbik6IENvbnRlbnRbXSB7XG4gIGNvbnN0IGJvZHk6IHN0cmluZ1tdW10gPSBbWycnLCAuLi50YWJsZS5jb2x1bW5MYWJlbHMubWFwKHRyYW5zbGF0ZSldXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YWJsZS5yb3dzLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3Qgcm93ID0gWy4uLnRhYmxlLnJvd3NbaV1dO1xuICAgIGZvciAobGV0IGogPSAwOyBqIDwgcm93Lmxlbmd0aDsgaisrKSB7XG4gICAgICBpZiAodHlwZW9mIHJvd1tqXSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgcm93W2pdID0gKHJvd1tqXSBhcyBBamZUYWJsZUNlbGwpLmZvcm11bGE7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHZhbHNSb3cgPSAocm93IGFzIHN0cmluZ1tdKS5tYXAobG9va3VwU3RyaW5nKS5tYXAodHJhbnNsYXRlKTtcbiAgICBib2R5LnB1c2goW3RyYW5zbGF0ZSh0YWJsZS5yb3dMYWJlbHNbaV0pLCAuLi52YWxzUm93XSk7XG4gIH1cbiAgcmV0dXJuIFtcbiAgICBib3JkZXJsZXNzQ2VsbCh0cmFuc2xhdGUodGFibGUubGFiZWwpKSxcbiAgICB7dGFibGU6IHtib2R5LCB3aWR0aHM6IEFycmF5KHRhYmxlLmNvbHVtbkxhYmVscy5sZW5ndGggKyAxKS5maWxsKCcqJyl9LCBtYXJnaW46IFs1LCAwLCAwLCA1XX0sXG4gIF07XG59XG4iXX0=