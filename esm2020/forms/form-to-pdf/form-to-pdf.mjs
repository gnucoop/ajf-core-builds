/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { evaluateExpression } from '@ajf/core/models';
import { vfsFonts, vfsFontsMap } from '@ajf/core/vfs-fonts';
import { createPdf } from 'pdfmake/build/pdfmake';
import { AjfFieldType } from '../interface/fields/field-type';
import { AjfNodeType } from '../interface/nodes/node-type';
export function createFormPdf(form, translate, orientation, header, context) {
    const t = translate ? translate : (s) => s;
    const pdfDef = formToPdf(form, t, orientation, header, context);
    return createPdf(pdfDef, undefined, vfsFontsMap, vfsFonts);
}
function stripHTML(s) {
    return s.replace(/<\/?[^>]+(>|$)/g, '');
}
// Given a context, lookupStringFunction returns a function that allows to retrieve
// the field values from the context. The values are returned as print-friendly strings.
// rep is the index of the repeating slide, if the field belongs to one.
function lookupStringFunction(context, rep) {
    if (context == null) {
        return (_) => ' ';
    }
    return (name) => {
        if (name == null) {
            return ' ';
        }
        if (rep != null) {
            name = name + '__' + rep;
        }
        const val = context[name];
        if (val == null) {
            return ' ';
        }
        if (val === true) {
            return 'yes';
        }
        if (val === false) {
            return 'no';
        }
        return String(val);
    };
}
// Analogous to lookupStringFunction, but for multiple-choice questions,
// returning an array of values.
function lookupArrayFunction(context, rep) {
    if (context == null) {
        return (_) => [];
    }
    return (name) => {
        if (name == null) {
            return [];
        }
        if (rep != null) {
            name = name + '__' + rep;
        }
        const val = context[name];
        if (Array.isArray(val)) {
            return val;
        }
        return [];
    };
}
// Given an AjfForm, returns its pdfmake pdf document definition.
function formToPdf(form, translate, orientation, header, context) {
    const choicesMap = {};
    for (const o of form.choicesOrigins) {
        choicesMap[o.name] = o.choices;
    }
    const content = header ? [...header] : [];
    for (const slide of form.nodes) {
        if (slide.nodeType === AjfNodeType.AjfSlide) {
            content.push(...slideToPdf(slide, choicesMap, translate, context));
        }
        else if (slide.nodeType === AjfNodeType.AjfRepeatingSlide) {
            content.push(...repeatingSlideToPdf(slide, choicesMap, translate, context));
        }
    }
    return { content, pageOrientation: orientation };
}
function slideToPdf(slide, choicesMap, translate, context, rep) {
    let label = translate(slide.label);
    if (rep != null) {
        label = `${label} (${translate('repeat')} ${rep})`;
    }
    const content = [{ text: label, fontSize: 18, bold: true, margin: [0, 15, 0, 10] }];
    for (const field of slide.nodes) {
        content.push(...fieldToPdf(field, choicesMap, translate, context, rep));
    }
    return content;
}
function repeatingSlideToPdf(slide, choicesMap, translate, context) {
    let repeats = 3; // default, if no formData
    const maxRepeats = 20;
    if (context != null && slide.name != null) {
        const r = context[slide.name];
        if (typeof r === 'number') {
            repeats = Math.min(r, maxRepeats);
        }
    }
    const content = [];
    for (let r = 0; r < repeats; r++) {
        content.push(...slideToPdf(slide, choicesMap, translate, context, r));
    }
    return content;
}
function borderlessCell(text, bold) {
    return { table: { body: [[{ text, bold, border: [false, false, false, false] }]] } };
}
function fieldToPdf(field, choicesMap, translate, context, rep) {
    if (field.nodeType !== AjfNodeType.AjfField) {
        throw new Error('not a field');
    }
    const visible = context == null /* form not compiled, show all fields */ ||
        field.visibility == null ||
        evaluateExpression(field.visibility.condition, context);
    if (!visible) {
        return [];
    }
    const lookupString = lookupStringFunction(context, rep);
    switch (field.fieldType) {
        case AjfFieldType.String:
        case AjfFieldType.Text:
            return [
                borderlessCell(translate(field.label)),
                { table: { widths: ['*'], body: [[lookupString(field.name)]] }, margin: [5, 0, 0, 5] },
            ];
        case AjfFieldType.Formula:
            const formula = field.formula.formula;
            const value = evaluateExpression(formula, context);
            return [
                borderlessCell(translate(field.label)),
                { table: { widths: ['*'], body: [[String(value)]] }, margin: [5, 0, 0, 5] },
            ];
        case AjfFieldType.Number:
        case AjfFieldType.Boolean:
        case AjfFieldType.DateInput:
        case AjfFieldType.Time:
            let val = lookupString(field.name);
            // for boolean fields in compiled forms, a null value is printed as 'no':
            if (field.fieldType === AjfFieldType.Boolean && context != null && val === ' ') {
                val = 'no';
            }
            return [
                {
                    table: {
                        widths: ['*', '*'],
                        body: [[{ text: translate(field.label), border: [false, false, false, false] }, val]],
                    },
                },
            ];
        case AjfFieldType.SingleChoice:
        case AjfFieldType.MultipleChoice:
            const choices = choicesMap[field.choicesOriginRef];
            if (context == null) {
                // empty form
                return choiceToPdf(field, choices, translate);
            }
            // compiled form, only print choices that are selected
            const selectedValues = field.fieldType === AjfFieldType.SingleChoice
                ? [lookupString(field.name)]
                : lookupArrayFunction(context, rep)(field.name);
            let selectedChoices = selectedValues
                .map(v => choices.find(c => c.value === v))
                .filter(c => c);
            if (selectedChoices.length === 0) {
                selectedChoices = selectedValues.map(v => ({
                    label: v,
                    value: v,
                }));
            }
            return choiceToPdf(field, selectedChoices, translate, context);
        case AjfFieldType.Empty:
            const text = stripHTML(translate(field.HTML));
            return [borderlessCell(text, true)];
        case AjfFieldType.Table:
            return tableToPdf(field, lookupString, translate);
        default:
            // yet unsupported field type
            return [];
    }
}
function choiceToPdf(field, choices, translate, context) {
    let choiceLabels;
    if (choices == null || choices.length === 0) {
        choiceLabels = [' '];
    }
    else {
        choiceLabels = choices.map(c => c.label);
    }
    const body = [];
    for (const c of choiceLabels) {
        body.push([translate(c)]);
    }
    let question = translate(field.label);
    // If the form is empty (to be compiled),
    // help the user distinguish between single- and multiple-choice questions:
    if (context == null && field.fieldType === AjfFieldType.SingleChoice) {
        question += ` (${translate('single choice')})`;
    }
    if (context == null && field.fieldType === AjfFieldType.MultipleChoice) {
        question += ` (${translate('multipe choice')})`;
    }
    return [
        {
            columns: [
                borderlessCell(question),
                {
                    table: { widths: ['*'], body },
                },
            ],
            margin: [0, 0, 0, 5],
        },
    ];
}
function tableToPdf(table, lookupString, translate) {
    const body = [['', ...table.columnLabels.map(translate)]];
    for (let i = 0; i < table.rows.length; i++) {
        const row = [...table.rows[i]];
        for (let j = 0; j < row.length; j++) {
            if (typeof row[j] !== 'string') {
                row[j] = row[j].formula;
            }
        }
        const valsRow = row.map(lookupString).map(translate);
        body.push([translate(table.rowLabels[i]), ...valsRow]);
    }
    return [
        borderlessCell(translate(table.label)),
        { table: { body, widths: Array(table.columnLabels.length + 1).fill('*') }, margin: [5, 0, 0, 5] },
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS10by1wZGYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9mb3Jtcy9mb3JtLXRvLXBkZi9mb3JtLXRvLXBkZi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7QUFFSCxPQUFPLEVBQXlCLGtCQUFrQixFQUFDLE1BQU0sa0JBQWtCLENBQUM7QUFDNUUsT0FBTyxFQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUMxRCxPQUFPLEVBQUMsU0FBUyxFQUFjLE1BQU0sdUJBQXVCLENBQUM7QUFNN0QsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLGdDQUFnQyxDQUFDO0FBSTVELE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSw4QkFBOEIsQ0FBQztBQUl6RCxNQUFNLFVBQVUsYUFBYSxDQUMzQixJQUFhLEVBQ2IsU0FBaUMsRUFDakMsV0FBNkIsRUFDN0IsTUFBa0IsRUFDbEIsT0FBb0I7SUFFcEIsTUFBTSxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDbkQsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNoRSxPQUFPLFNBQVMsQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQztBQUM3RCxDQUFDO0FBT0QsU0FBUyxTQUFTLENBQUMsQ0FBUztJQUMxQixPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDMUMsQ0FBQztBQUVELG1GQUFtRjtBQUNuRix3RkFBd0Y7QUFDeEYsd0VBQXdFO0FBQ3hFLFNBQVMsb0JBQW9CLENB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RSxDQUFDLEVBQUUsRUFBRTtRQUMxQyxNQUFNLEdBQUcsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ25DLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssUUFBUSxFQUFFO2dCQUM5QixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUksR0FBRyxDQUFDLENBQUMsQ0FBa0IsQ0FBQyxPQUFPLENBQUM7YUFDM0M7U0FDRjtRQUNELE1BQU0sT0FBTyxHQUFJLEdBQWdCLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNuRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUM7S0FDeEQ7SUFDRCxPQUFPO1FBQ0wsY0FBYyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdEMsRUFBQyxLQUFLLEVBQUUsRUFBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBQztLQUM5RixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoQykgR251Y29vcCBzb2MuIGNvb3AuXG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3JcbiAqIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhc1xuICogcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsXG4gKiBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VIEFmZmVyb1xuICogR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogYWxvbmcgd2l0aCBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICogSWYgbm90LCBzZWUgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLy5cbiAqXG4gKi9cblxuaW1wb3J0IHtBamZDb250ZXh0LCBBamZGb3JtdWxhLCBldmFsdWF0ZUV4cHJlc3Npb259IGZyb20gJ0BhamYvY29yZS9tb2RlbHMnO1xuaW1wb3J0IHt2ZnNGb250cywgdmZzRm9udHNNYXB9IGZyb20gJ0BhamYvY29yZS92ZnMtZm9udHMnO1xuaW1wb3J0IHtjcmVhdGVQZGYsIFRDcmVhdGVkUGRmfSBmcm9tICdwZGZtYWtlL2J1aWxkL3BkZm1ha2UnO1xuaW1wb3J0IHtDb250ZW50LCBQYWdlT3JpZW50YXRpb24sIFREb2N1bWVudERlZmluaXRpb25zfSBmcm9tICdwZGZtYWtlL2ludGVyZmFjZXMnO1xuXG5pbXBvcnQge0FqZkNob2ljZX0gZnJvbSAnLi4vaW50ZXJmYWNlL2Nob2ljZXMvY2hvaWNlJztcbmltcG9ydCB7QWpmRW1wdHlGaWVsZH0gZnJvbSAnLi4vaW50ZXJmYWNlL2ZpZWxkcy9lbXB0eS1maWVsZCc7XG5pbXBvcnQge0FqZkZpZWxkfSBmcm9tICcuLi9pbnRlcmZhY2UvZmllbGRzL2ZpZWxkJztcbmltcG9ydCB7QWpmRmllbGRUeXBlfSBmcm9tICcuLi9pbnRlcmZhY2UvZmllbGRzL2ZpZWxkLXR5cGUnO1xuaW1wb3J0IHtBamZGb3JtdWxhRmllbGR9IGZyb20gJy4uL2ludGVyZmFjZS9maWVsZHMvZm9ybXVsYS1maWVsZCc7XG5pbXBvcnQge0FqZlRhYmxlQ2VsbCwgQWpmVGFibGVGaWVsZH0gZnJvbSAnLi4vaW50ZXJmYWNlL2ZpZWxkcy90YWJsZS1maWVsZCc7XG5pbXBvcnQge0FqZkZvcm19IGZyb20gJy4uL2ludGVyZmFjZS9mb3Jtcy9mb3JtJztcbmltcG9ydCB7QWpmTm9kZVR5cGV9IGZyb20gJy4uL2ludGVyZmFjZS9ub2Rlcy9ub2RlLXR5cGUnO1xuaW1wb3J0IHtBamZSZXBlYXRpbmdTbGlkZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3NsaWRlcy9yZXBlYXRpbmctc2xpZGUnO1xuaW1wb3J0IHtBamZTbGlkZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3NsaWRlcy9zbGlkZSc7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVGb3JtUGRmKFxuICBmb3JtOiBBamZGb3JtLFxuICB0cmFuc2xhdGU/OiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4gIG9yaWVudGF0aW9uPzogUGFnZU9yaWVudGF0aW9uLFxuICBoZWFkZXI/OiBDb250ZW50W10sXG4gIGNvbnRleHQ/OiBBamZDb250ZXh0LFxuKTogVENyZWF0ZWRQZGYge1xuICBjb25zdCB0ID0gdHJhbnNsYXRlID8gdHJhbnNsYXRlIDogKHM6IHN0cmluZykgPT4gcztcbiAgY29uc3QgcGRmRGVmID0gZm9ybVRvUGRmKGZvcm0sIHQsIG9yaWVudGF0aW9uLCBoZWFkZXIsIGNvbnRleHQpO1xuICByZXR1cm4gY3JlYXRlUGRmKHBkZkRlZiwgdW5kZWZpbmVkLCB2ZnNGb250c01hcCwgdmZzRm9udHMpO1xufVxuXG4vLyBDaG9pY2VzTWFwIG1hcHMgYSBjaG9pY2VzT3JpZ2luUmVmIHRvIHRoZSBsaXN0IHRoZSBjaG9pY2VzLlxuaW50ZXJmYWNlIENob2ljZXNNYXAge1xuICBbbmFtZTogc3RyaW5nXTogQWpmQ2hvaWNlPGFueT5bXTtcbn1cblxuZnVuY3Rpb24gc3RyaXBIVE1MKHM6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBzLnJlcGxhY2UoLzxcXC8/W14+XSsoPnwkKS9nLCAnJyk7XG59XG5cbi8vIEdpdmVuIGEgY29udGV4dCwgbG9va3VwU3RyaW5nRnVuY3Rpb24gcmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgYWxsb3dzIHRvIHJldHJpZXZlXG4vLyB0aGUgZmllbGQgdmFsdWVzIGZyb20gdGhlIGNvbnRleHQuIFRoZSB2YWx1ZXMgYXJlIHJldHVybmVkIGFzIHByaW50LWZyaWVuZGx5IHN0cmluZ3MuXG4vLyByZXAgaXMgdGhlIGluZGV4IG9mIHRoZSByZXBlYXRpbmcgc2xpZGUsIGlmIHRoZSBmaWVsZCBiZWxvbmdzIHRvIG9uZS5cbmZ1bmN0aW9uIGxvb2t1cFN0cmluZ0Z1bmN0aW9uKGNvbnRleHQ/OiBBamZDb250ZXh0LCByZXA/OiBudW1iZXIpOiAobmFtZTogc3RyaW5nKSA9PiBzdHJpbmcge1xuICBpZiAoY29udGV4dCA9PSBudWxsKSB7XG4gICAgcmV0dXJuIChfOiBzdHJpbmcpID0+ICcgJztcbiAgfVxuICByZXR1cm4gKG5hbWU6IHN0cmluZykgPT4ge1xuICAgIGlmIChuYW1lID09IG51bGwpIHtcbiAgICAgIHJldHVybiAnICc7XG4gICAgfVxuICAgIGlmIChyZXAgIT0gbnVsbCkge1xuICAgICAgbmFtZSA9IG5hbWUgKyAnX18nICsgcmVwO1xuICAgIH1cbiAgICBjb25zdCB2YWwgPSBjb250ZXh0W25hbWVdO1xuICAgIGlmICh2YWwgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuICcgJztcbiAgICB9XG4gICAgaWYgKHZhbCA9PT0gdHJ1ZSkge1xuICAgICAgcmV0dXJuICd5ZXMnO1xuICAgIH1cbiAgICBpZiAodmFsID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuICdubyc7XG4gICAgfVxuICAgIHJldHVybiBTdHJpbmcodmFsKTtcbiAgfTtcbn1cblxuLy8gQW5hbG9nb3VzIHRvIGxvb2t1cFN0cmluZ0Z1bmN0aW9uLCBidXQgZm9yIG11bHRpcGxlLWNob2ljZSBxdWVzdGlvbnMsXG4vLyByZXR1cm5pbmcgYW4gYXJyYXkgb2YgdmFsdWVzLlxuZnVuY3Rpb24gbG9va3VwQXJyYXlGdW5jdGlvbihjb250ZXh0PzogQWpmQ29udGV4dCwgcmVwPzogbnVtYmVyKTogKG5hbWU6IHN0cmluZykgPT4gc3RyaW5nW10ge1xuICBpZiAoY29udGV4dCA9PSBudWxsKSB7XG4gICAgcmV0dXJuIChfOiBzdHJpbmcpID0+IFtdO1xuICB9XG4gIHJldHVybiAobmFtZTogc3RyaW5nKSA9PiB7XG4gICAgaWYgKG5hbWUgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBpZiAocmVwICE9IG51bGwpIHtcbiAgICAgIG5hbWUgPSBuYW1lICsgJ19fJyArIHJlcDtcbiAgICB9XG4gICAgY29uc3QgdmFsID0gY29udGV4dFtuYW1lXTtcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7XG4gICAgICByZXR1cm4gdmFsO1xuICAgIH1cbiAgICByZXR1cm4gW107XG4gIH07XG59XG5cbi8vIEdpdmVuIGFuIEFqZkZvcm0sIHJldHVybnMgaXRzIHBkZm1ha2UgcGRmIGRvY3VtZW50IGRlZmluaXRpb24uXG5mdW5jdGlvbiBmb3JtVG9QZGYoXG4gIGZvcm06IEFqZkZvcm0sXG4gIHRyYW5zbGF0ZTogKHM6IHN0cmluZykgPT4gc3RyaW5nLFxuICBvcmllbnRhdGlvbj86IFBhZ2VPcmllbnRhdGlvbixcbiAgaGVhZGVyPzogQ29udGVudFtdLFxuICBjb250ZXh0PzogQWpmQ29udGV4dCxcbik6IFREb2N1bWVudERlZmluaXRpb25zIHtcbiAgY29uc3QgY2hvaWNlc01hcDogQ2hvaWNlc01hcCA9IHt9O1xuICBmb3IgKGNvbnN0IG8gb2YgZm9ybS5jaG9pY2VzT3JpZ2lucykge1xuICAgIGNob2ljZXNNYXBbby5uYW1lXSA9IG8uY2hvaWNlcztcbiAgfVxuXG4gIGNvbnN0IGNvbnRlbnQgPSBoZWFkZXIgPyBbLi4uaGVhZGVyXSA6IFtdO1xuICBmb3IgKGNvbnN0IHNsaWRlIG9mIGZvcm0ubm9kZXMpIHtcbiAgICBpZiAoc2xpZGUubm9kZVR5cGUgPT09IEFqZk5vZGVUeXBlLkFqZlNsaWRlKSB7XG4gICAgICBjb250ZW50LnB1c2goLi4uc2xpZGVUb1BkZihzbGlkZSBhcyBBamZTbGlkZSwgY2hvaWNlc01hcCwgdHJhbnNsYXRlLCBjb250ZXh0KSk7XG4gICAgfSBlbHNlIGlmIChzbGlkZS5ub2RlVHlwZSA9PT0gQWpmTm9kZVR5cGUuQWpmUmVwZWF0aW5nU2xpZGUpIHtcbiAgICAgIGNvbnRlbnQucHVzaChcbiAgICAgICAgLi4ucmVwZWF0aW5nU2xpZGVUb1BkZihzbGlkZSBhcyBBamZSZXBlYXRpbmdTbGlkZSwgY2hvaWNlc01hcCwgdHJhbnNsYXRlLCBjb250ZXh0KSxcbiAgICAgICk7XG4gICAgfVxuICB9XG4gIHJldHVybiB7Y29udGVudCwgcGFnZU9yaWVudGF0aW9uOiBvcmllbnRhdGlvbn07XG59XG5cbmZ1bmN0aW9uIHNsaWRlVG9QZGYoXG4gIHNsaWRlOiBBamZTbGlkZSB8IEFqZlJlcGVhdGluZ1NsaWRlLFxuICBjaG9pY2VzTWFwOiBDaG9pY2VzTWFwLFxuICB0cmFuc2xhdGU6IChzOiBzdHJpbmcpID0+IHN0cmluZyxcbiAgY29udGV4dD86IEFqZkNvbnRleHQsXG4gIHJlcD86IG51bWJlcixcbik6IENvbnRlbnRbXSB7XG4gIGxldCBsYWJlbCA9IHRyYW5zbGF0ZShzbGlkZS5sYWJlbCk7XG4gIGlmIChyZXAgIT0gbnVsbCkge1xuICAgIGxhYmVsID0gYCR7bGFiZWx9ICgke3RyYW5zbGF0ZSgncmVwZWF0Jyl9ICR7cmVwfSlgO1xuICB9XG4gIGNvbnN0IGNvbnRlbnQ6IENvbnRlbnRbXSA9IFt7dGV4dDogbGFiZWwsIGZvbnRTaXplOiAxOCwgYm9sZDogdHJ1ZSwgbWFyZ2luOiBbMCwgMTUsIDAsIDEwXX1dO1xuICBmb3IgKGNvbnN0IGZpZWxkIG9mIHNsaWRlLm5vZGVzIGFzIEFqZkZpZWxkW10pIHtcbiAgICBjb250ZW50LnB1c2goLi4uZmllbGRUb1BkZihmaWVsZCwgY2hvaWNlc01hcCwgdHJhbnNsYXRlLCBjb250ZXh0LCByZXApKTtcbiAgfVxuICByZXR1cm4gY29udGVudDtcbn1cblxuZnVuY3Rpb24gcmVwZWF0aW5nU2xpZGVUb1BkZihcbiAgc2xpZGU6IEFqZlJlcGVhdGluZ1NsaWRlLFxuICBjaG9pY2VzTWFwOiBDaG9pY2VzTWFwLFxuICB0cmFuc2xhdGU6IChzOiBzdHJpbmcpID0+IHN0cmluZyxcbiAgY29udGV4dD86IEFqZkNvbnRleHQsXG4pOiBDb250ZW50W10ge1xuICBsZXQgcmVwZWF0cyA9IDM7IC8vIGRlZmF1bHQsIGlmIG5vIGZvcm1EYXRhXG4gIGNvbnN0IG1heFJlcGVhdHMgPSAyMDtcbiAgaWYgKGNvbnRleHQgIT0gbnVsbCAmJiBzbGlkZS5uYW1lICE9IG51bGwpIHtcbiAgICBjb25zdCByID0gY29udGV4dFtzbGlkZS5uYW1lXTtcbiAgICBpZiAodHlwZW9mIHIgPT09ICdudW1iZXInKSB7XG4gICAgICByZXBlYXRzID0gTWF0aC5taW4ociwgbWF4UmVwZWF0cyk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgY29udGVudCA9IFtdO1xuICBmb3IgKGxldCByID0gMDsgciA8IHJlcGVhdHM7IHIrKykge1xuICAgIGNvbnRlbnQucHVzaCguLi5zbGlkZVRvUGRmKHNsaWRlLCBjaG9pY2VzTWFwLCB0cmFuc2xhdGUsIGNvbnRleHQsIHIpKTtcbiAgfVxuICByZXR1cm4gY29udGVudDtcbn1cblxuZnVuY3Rpb24gYm9yZGVybGVzc0NlbGwodGV4dDogc3RyaW5nLCBib2xkPzogYm9vbGVhbik6IENvbnRlbnQge1xuICByZXR1cm4ge3RhYmxlOiB7Ym9keTogW1t7dGV4dCwgYm9sZCwgYm9yZGVyOiBbZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2VdfV1dfX07XG59XG5cbmZ1bmN0aW9uIGZpZWxkVG9QZGYoXG4gIGZpZWxkOiBBamZGaWVsZCxcbiAgY2hvaWNlc01hcDogQ2hvaWNlc01hcCxcbiAgdHJhbnNsYXRlOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4gIGNvbnRleHQ/OiBBamZDb250ZXh0LFxuICByZXA/OiBudW1iZXIsXG4pOiBDb250ZW50W10ge1xuICBpZiAoZmllbGQubm9kZVR5cGUgIT09IEFqZk5vZGVUeXBlLkFqZkZpZWxkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdub3QgYSBmaWVsZCcpO1xuICB9XG5cbiAgY29uc3QgdmlzaWJsZSA9XG4gICAgY29udGV4dCA9PSBudWxsIC8qIGZvcm0gbm90IGNvbXBpbGVkLCBzaG93IGFsbCBmaWVsZHMgKi8gfHxcbiAgICBmaWVsZC52aXNpYmlsaXR5ID09IG51bGwgfHxcbiAgICBldmFsdWF0ZUV4cHJlc3Npb24oZmllbGQudmlzaWJpbGl0eS5jb25kaXRpb24sIGNvbnRleHQpO1xuICBpZiAoIXZpc2libGUpIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBjb25zdCBsb29rdXBTdHJpbmcgPSBsb29rdXBTdHJpbmdGdW5jdGlvbihjb250ZXh0LCByZXApO1xuXG4gIHN3aXRjaCAoZmllbGQuZmllbGRUeXBlKSB7XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuU3RyaW5nOlxuICAgIGNhc2UgQWpmRmllbGRUeXBlLlRleHQ6XG4gICAgICByZXR1cm4gW1xuICAgICAgICBib3JkZXJsZXNzQ2VsbCh0cmFuc2xhdGUoZmllbGQubGFiZWwpKSxcbiAgICAgICAge3RhYmxlOiB7d2lkdGhzOiBbJyonXSwgYm9keTogW1tsb29rdXBTdHJpbmcoZmllbGQubmFtZSldXX0sIG1hcmdpbjogWzUsIDAsIDAsIDVdfSxcbiAgICAgIF07XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuRm9ybXVsYTpcbiAgICAgIGNvbnN0IGZvcm11bGEgPSAoKGZpZWxkIGFzIEFqZkZvcm11bGFGaWVsZCkuZm9ybXVsYSBhcyBBamZGb3JtdWxhKS5mb3JtdWxhO1xuICAgICAgY29uc3QgdmFsdWUgPSBldmFsdWF0ZUV4cHJlc3Npb24oZm9ybXVsYSwgY29udGV4dCk7XG4gICAgICByZXR1cm4gW1xuICAgICAgICBib3JkZXJsZXNzQ2VsbCh0cmFuc2xhdGUoZmllbGQubGFiZWwpKSxcbiAgICAgICAge3RhYmxlOiB7d2lkdGhzOiBbJyonXSwgYm9keTogW1tTdHJpbmcodmFsdWUpXV19LCBtYXJnaW46IFs1LCAwLCAwLCA1XX0sXG4gICAgICBdO1xuICAgIGNhc2UgQWpmRmllbGRUeXBlLk51bWJlcjpcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5Cb29sZWFuOlxuICAgIGNhc2UgQWpmRmllbGRUeXBlLkRhdGVJbnB1dDpcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5UaW1lOlxuICAgICAgbGV0IHZhbCA9IGxvb2t1cFN0cmluZyhmaWVsZC5uYW1lKTtcbiAgICAgIC8vIGZvciBib29sZWFuIGZpZWxkcyBpbiBjb21waWxlZCBmb3JtcywgYSBudWxsIHZhbHVlIGlzIHByaW50ZWQgYXMgJ25vJzpcbiAgICAgIGlmIChmaWVsZC5maWVsZFR5cGUgPT09IEFqZkZpZWxkVHlwZS5Cb29sZWFuICYmIGNvbnRleHQgIT0gbnVsbCAmJiB2YWwgPT09ICcgJykge1xuICAgICAgICB2YWwgPSAnbm8nO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFtcbiAgICAgICAge1xuICAgICAgICAgIHRhYmxlOiB7XG4gICAgICAgICAgICB3aWR0aHM6IFsnKicsICcqJ10sXG4gICAgICAgICAgICBib2R5OiBbW3t0ZXh0OiB0cmFuc2xhdGUoZmllbGQubGFiZWwpLCBib3JkZXI6IFtmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZV19LCB2YWxdXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXTtcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5TaW5nbGVDaG9pY2U6XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuTXVsdGlwbGVDaG9pY2U6XG4gICAgICBjb25zdCBjaG9pY2VzID0gY2hvaWNlc01hcFsoZmllbGQgYXMgYW55KS5jaG9pY2VzT3JpZ2luUmVmXTtcbiAgICAgIGlmIChjb250ZXh0ID09IG51bGwpIHtcbiAgICAgICAgLy8gZW1wdHkgZm9ybVxuICAgICAgICByZXR1cm4gY2hvaWNlVG9QZGYoZmllbGQsIGNob2ljZXMsIHRyYW5zbGF0ZSk7XG4gICAgICB9XG4gICAgICAvLyBjb21waWxlZCBmb3JtLCBvbmx5IHByaW50IGNob2ljZXMgdGhhdCBhcmUgc2VsZWN0ZWRcbiAgICAgIGNvbnN0IHNlbGVjdGVkVmFsdWVzID1cbiAgICAgICAgZmllbGQuZmllbGRUeXBlID09PSBBamZGaWVsZFR5cGUuU2luZ2xlQ2hvaWNlXG4gICAgICAgICAgPyBbbG9va3VwU3RyaW5nKGZpZWxkLm5hbWUpXVxuICAgICAgICAgIDogbG9va3VwQXJyYXlGdW5jdGlvbihjb250ZXh0LCByZXApKGZpZWxkLm5hbWUpO1xuICAgICAgbGV0IHNlbGVjdGVkQ2hvaWNlcyA9IHNlbGVjdGVkVmFsdWVzXG4gICAgICAgIC5tYXAodiA9PiBjaG9pY2VzLmZpbmQoYyA9PiBjLnZhbHVlID09PSB2KSlcbiAgICAgICAgLmZpbHRlcihjID0+IGMpIGFzIEFqZkNob2ljZTxhbnk+W107XG4gICAgICBpZiAoc2VsZWN0ZWRDaG9pY2VzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBzZWxlY3RlZENob2ljZXMgPSBzZWxlY3RlZFZhbHVlcy5tYXAoXG4gICAgICAgICAgdiA9PlxuICAgICAgICAgICAgKHtcbiAgICAgICAgICAgICAgbGFiZWw6IHYsXG4gICAgICAgICAgICAgIHZhbHVlOiB2LFxuICAgICAgICAgICAgfSBhcyBBamZDaG9pY2U8c3RyaW5nPiksXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gY2hvaWNlVG9QZGYoZmllbGQsIHNlbGVjdGVkQ2hvaWNlcywgdHJhbnNsYXRlLCBjb250ZXh0KTtcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5FbXB0eTpcbiAgICAgIGNvbnN0IHRleHQgPSBzdHJpcEhUTUwodHJhbnNsYXRlKChmaWVsZCBhcyBBamZFbXB0eUZpZWxkKS5IVE1MKSk7XG4gICAgICByZXR1cm4gW2JvcmRlcmxlc3NDZWxsKHRleHQsIHRydWUpXTtcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5UYWJsZTpcbiAgICAgIHJldHVybiB0YWJsZVRvUGRmKGZpZWxkIGFzIEFqZlRhYmxlRmllbGQsIGxvb2t1cFN0cmluZywgdHJhbnNsYXRlKTtcbiAgICBkZWZhdWx0OlxuICAgICAgLy8geWV0IHVuc3VwcG9ydGVkIGZpZWxkIHR5cGVcbiAgICAgIHJldHVybiBbXTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjaG9pY2VUb1BkZihcbiAgZmllbGQ6IEFqZkZpZWxkLFxuICBjaG9pY2VzOiBBamZDaG9pY2U8YW55PltdLFxuICB0cmFuc2xhdGU6IChzOiBzdHJpbmcpID0+IHN0cmluZyxcbiAgY29udGV4dD86IEFqZkNvbnRleHQsXG4pOiBDb250ZW50W10ge1xuICBsZXQgY2hvaWNlTGFiZWxzOiBzdHJpbmdbXTtcbiAgaWYgKGNob2ljZXMgPT0gbnVsbCB8fCBjaG9pY2VzLmxlbmd0aCA9PT0gMCkge1xuICAgIGNob2ljZUxhYmVscyA9IFsnICddO1xuICB9IGVsc2Uge1xuICAgIGNob2ljZUxhYmVscyA9IGNob2ljZXMubWFwKGMgPT4gYy5sYWJlbCk7XG4gIH1cbiAgY29uc3QgYm9keSA9IFtdO1xuICBmb3IgKGNvbnN0IGMgb2YgY2hvaWNlTGFiZWxzKSB7XG4gICAgYm9keS5wdXNoKFt0cmFuc2xhdGUoYyldKTtcbiAgfVxuICBsZXQgcXVlc3Rpb24gPSB0cmFuc2xhdGUoZmllbGQubGFiZWwpO1xuICAvLyBJZiB0aGUgZm9ybSBpcyBlbXB0eSAodG8gYmUgY29tcGlsZWQpLFxuICAvLyBoZWxwIHRoZSB1c2VyIGRpc3Rpbmd1aXNoIGJldHdlZW4gc2luZ2xlLSBhbmQgbXVsdGlwbGUtY2hvaWNlIHF1ZXN0aW9uczpcbiAgaWYgKGNvbnRleHQgPT0gbnVsbCAmJiBmaWVsZC5maWVsZFR5cGUgPT09IEFqZkZpZWxkVHlwZS5TaW5nbGVDaG9pY2UpIHtcbiAgICBxdWVzdGlvbiArPSBgICgke3RyYW5zbGF0ZSgnc2luZ2xlIGNob2ljZScpfSlgO1xuICB9XG4gIGlmIChjb250ZXh0ID09IG51bGwgJiYgZmllbGQuZmllbGRUeXBlID09PSBBamZGaWVsZFR5cGUuTXVsdGlwbGVDaG9pY2UpIHtcbiAgICBxdWVzdGlvbiArPSBgICgke3RyYW5zbGF0ZSgnbXVsdGlwZSBjaG9pY2UnKX0pYDtcbiAgfVxuICByZXR1cm4gW1xuICAgIHtcbiAgICAgIGNvbHVtbnM6IFtcbiAgICAgICAgYm9yZGVybGVzc0NlbGwocXVlc3Rpb24pLFxuICAgICAgICB7XG4gICAgICAgICAgdGFibGU6IHt3aWR0aHM6IFsnKiddLCBib2R5fSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBtYXJnaW46IFswLCAwLCAwLCA1XSxcbiAgICB9LFxuICBdO1xufVxuXG5mdW5jdGlvbiB0YWJsZVRvUGRmKFxuICB0YWJsZTogQWpmVGFibGVGaWVsZCxcbiAgbG9va3VwU3RyaW5nOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4gIHRyYW5zbGF0ZTogKHM6IHN0cmluZykgPT4gc3RyaW5nLFxuKTogQ29udGVudFtdIHtcbiAgY29uc3QgYm9keTogc3RyaW5nW11bXSA9IFtbJycsIC4uLnRhYmxlLmNvbHVtbkxhYmVscy5tYXAodHJhbnNsYXRlKV1dO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHRhYmxlLnJvd3MubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCByb3cgPSBbLi4udGFibGUucm93c1tpXV07XG4gICAgZm9yIChsZXQgaiA9IDA7IGogPCByb3cubGVuZ3RoOyBqKyspIHtcbiAgICAgIGlmICh0eXBlb2Ygcm93W2pdICE9PSAnc3RyaW5nJykge1xuICAgICAgICByb3dbal0gPSAocm93W2pdIGFzIEFqZlRhYmxlQ2VsbCkuZm9ybXVsYTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgdmFsc1JvdyA9IChyb3cgYXMgc3RyaW5nW10pLm1hcChsb29rdXBTdHJpbmcpLm1hcCh0cmFuc2xhdGUpO1xuICAgIGJvZHkucHVzaChbdHJhbnNsYXRlKHRhYmxlLnJvd0xhYmVsc1tpXSksIC4uLnZhbHNSb3ddKTtcbiAgfVxuICByZXR1cm4gW1xuICAgIGJvcmRlcmxlc3NDZWxsKHRyYW5zbGF0ZSh0YWJsZS5sYWJlbCkpLFxuICAgIHt0YWJsZToge2JvZHksIHdpZHRoczogQXJyYXkodGFibGUuY29sdW1uTGFiZWxzLmxlbmd0aCArIDEpLmZpbGwoJyonKX0sIG1hcmdpbjogWzUsIDAsIDAsIDVdfSxcbiAgXTtcbn1cbiJdfQ==