/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { evaluateExpression } from '@ajf/core/models';
import { createPdf, } from '@ajf/core/pdfmake';
import { AjfFieldType } from '../interface/fields/field-type';
import { AjfNodeType } from '../interface/nodes/node-type';
import { isField } from '../utils/nodes/is-field';
import { isRepeatingSlide } from '../utils/nodes/is-repeating-slide';
import { isSlideNode } from '../utils/nodes/is-slide-node';
export function createFormPdf(form, translate, orientation, header, context) {
    const t = translate ? translate : (s) => s;
    const pdfDef = formToPdf(form, t, orientation, header, context);
    return createPdf(pdfDef);
}
function stripHTML(s) {
    return s.replace(/<\/?[^>]+(>|$)/g, '');
}
// Given a context, lookupStringFunction returns a function that allows to retrieve
// the field values from the context. The values are returned as print-friendly strings.
// rep is the index of the repeating slide, if the field belongs to one.
function lookupStringFunction(context, rep) {
    if (context == null) {
        return (_) => ' ';
    }
    return (name) => {
        if (name == null) {
            return ' ';
        }
        if (rep != null) {
            name = name + '__' + rep;
        }
        const val = context[name];
        if (val == null) {
            return ' ';
        }
        if (val === true) {
            return 'yes';
        }
        if (val === false) {
            return 'no';
        }
        return String(val);
    };
}
// Analogous to lookupStringFunction, but for multiple-choice questions,
// returning an array of values.
function lookupArrayFunction(context, rep) {
    if (context == null) {
        return (_) => [];
    }
    return (name) => {
        if (name == null) {
            return [];
        }
        if (rep != null) {
            name = name + '__' + rep;
        }
        const val = context[name];
        if (Array.isArray(val)) {
            return val;
        }
        return [];
    };
}
// Given an AjfForm, returns its pdfmake pdf document definition.
function formToPdf(form, translate, orientation, header, context) {
    const choicesMap = {};
    for (const o of form.choicesOrigins) {
        choicesMap[o.name] = o.choices;
    }
    const content = header ? [...header] : [];
    for (const slide of form.nodes) {
        if (isSlideNode(slide)) {
            content.push(...slideToPdf(slide, choicesMap, translate, context));
        }
        else if (isRepeatingSlide(slide)) {
            content.push(...repeatingSlideToPdf(slide, choicesMap, translate, context));
        }
    }
    return { content, pageOrientation: orientation };
}
function slideToPdf(slide, choicesMap, translate, context, rep) {
    let label = translate(slide.label);
    if (rep != null) {
        label = `${label} (${translate('repeat')} ${rep})`;
    }
    const content = [{ text: label, fontSize: 18, bold: true, margin: [0, 15, 0, 10] }];
    for (const field of slide.nodes) {
        if (isField(field)) {
            content.push(...fieldToPdf(field, choicesMap, translate, context, rep));
        }
    }
    return content;
}
function repeatingSlideToPdf(slide, choicesMap, translate, context) {
    let repeats = 3; // default, if no formData
    const maxRepeats = 20;
    if (context != null && slide.name != null) {
        const r = context[slide.name];
        if (typeof r === 'number') {
            repeats = Math.min(r, maxRepeats);
        }
    }
    const content = [];
    for (let r = 0; r < repeats; r++) {
        content.push(...slideToPdf(slide, choicesMap, translate, context, r));
    }
    return content;
}
function borderlessCell(text, bold) {
    return { table: { body: [[{ text, bold, border: [false, false, false, false] }]] } };
}
function fieldToPdf(field, choicesMap, translate, context, rep) {
    if (field.nodeType !== AjfNodeType.AjfField) {
        throw new Error('not a field');
    }
    const visible = context == null /* form not compiled, show all fields */ ||
        field.visibility == null ||
        evaluateExpression(field.visibility.condition, context);
    if (!visible) {
        return [];
    }
    const lookupString = lookupStringFunction(context, rep);
    switch (field.fieldType) {
        case AjfFieldType.String:
        case AjfFieldType.Text:
            return [
                borderlessCell(translate(field.label)),
                { table: { widths: ['*'], body: [[lookupString(field.name)]] }, margin: [5, 0, 0, 5] },
            ];
        case AjfFieldType.Formula:
            let value = lookupString(field.name);
            if (value === ' ') {
                // If the value of the field is not in the context, recompute the formula.
                const formula = field.formula || { formula: '' };
                value = String(evaluateExpression(formula.formula, context));
            }
            return [
                borderlessCell(translate(field.label)),
                { table: { widths: ['*'], body: [[value]] }, margin: [5, 0, 0, 5] },
            ];
        case AjfFieldType.Number:
        case AjfFieldType.Boolean:
        case AjfFieldType.DateInput:
        case AjfFieldType.Time:
            let val = lookupString(field.name);
            // for boolean fields in compiled forms, a null value is printed as 'no':
            if (field.fieldType === AjfFieldType.Boolean && context != null && val === ' ') {
                val = 'no';
            }
            return [
                {
                    table: {
                        widths: ['*', '*'],
                        body: [[{ text: translate(field.label), border: [false, false, false, false] }, val]],
                    },
                },
            ];
        case AjfFieldType.SingleChoice:
        case AjfFieldType.MultipleChoice:
            const choices = choicesMap[field.choicesOriginRef];
            if (context == null) {
                // empty form
                return choiceToPdf(field, choices, translate);
            }
            // compiled form, only print choices that are selected
            const selectedValues = field.fieldType === AjfFieldType.SingleChoice
                ? [lookupString(field.name)]
                : lookupArrayFunction(context, rep)(field.name);
            const nonNullChoice = (c) => c != null;
            let selectedChoices = selectedValues
                .map(v => choices.find(c => c.value === v))
                .filter(nonNullChoice);
            if (selectedChoices.length === 0) {
                selectedChoices = selectedValues.map(v => ({
                    label: v,
                    value: v,
                }));
            }
            return choiceToPdf(field, selectedChoices, translate, context);
        case AjfFieldType.Empty:
            const text = stripHTML(translate(field.HTML));
            return [borderlessCell(text, true)];
        case AjfFieldType.Table:
            return tableToPdf(field, lookupString, translate);
        default:
            // yet unsupported field type
            return [];
    }
}
function choiceToPdf(field, choices, translate, context) {
    let choiceLabels;
    if (choices == null || choices.length === 0) {
        choiceLabels = [' '];
    }
    else {
        choiceLabels = choices.map(c => c.label);
    }
    const body = [];
    for (const c of choiceLabels) {
        body.push([translate(c)]);
    }
    let question = translate(field.label);
    // If the form is empty (to be compiled),
    // help the user distinguish between single- and multiple-choice questions:
    if (context == null && field.fieldType === AjfFieldType.SingleChoice) {
        question += ` (${translate('single choice')})`;
    }
    if (context == null && field.fieldType === AjfFieldType.MultipleChoice) {
        question += ` (${translate('multipe choice')})`;
    }
    return [
        {
            columns: [
                borderlessCell(question),
                {
                    table: { widths: ['*'], body },
                },
            ],
            margin: [0, 0, 0, 5],
        },
    ];
}
function tableToPdf(table, lookupString, translate) {
    const body = [['', ...table.columnLabels.map(translate)]];
    for (let i = 0; i < table.rows.length; i++) {
        const row = [...table.rows[i]];
        for (let j = 0; j < row.length; j++) {
            const cell = row[j];
            if (typeof cell !== 'string') {
                row[j] = cell.formula;
            }
        }
        const valsRow = row.map(lookupString).map(translate);
        body.push([translate(table.rowLabels[i]), ...valsRow]);
    }
    return [
        borderlessCell(translate(table.label)),
        { table: { body, widths: Array(table.columnLabels.length + 1).fill('*') }, margin: [5, 0, 0, 5] },
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS10by1wZGYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jb3JlL2Zvcm1zL3NyYy9mb3JtLXRvLXBkZi9mb3JtLXRvLXBkZi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7QUFFSCxPQUFPLEVBQWEsa0JBQWtCLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRSxPQUFPLEVBQ0wsU0FBUyxHQUtWLE1BQU0sbUJBQW1CLENBQUM7QUFLM0IsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLGdDQUFnQyxDQUFDO0FBRzVELE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSw4QkFBOEIsQ0FBQztBQUd6RCxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDaEQsT0FBTyxFQUFDLGdCQUFnQixFQUFDLE1BQU0sbUNBQW1DLENBQUM7QUFDbkUsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLDhCQUE4QixDQUFDO0FBRXpELE1BQU0sVUFBVSxhQUFhLENBQzNCLElBQWEsRUFDYixTQUFpQyxFQUNqQyxXQUE2QixFQUM3QixNQUFrQixFQUNsQixPQUFvQjtJQUVwQixNQUFNLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNuRCxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2hFLE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLENBQUM7QUFPRCxTQUFTLFNBQVMsQ0FBQyxDQUFTO0lBQzFCLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUMxQyxDQUFDO0FBRUQsbUZB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QUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUM7S0FDOUYsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKEMpIEdudWNvb3Agc29jLiBjb29wLlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yXG4gKiBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXNcbiAqIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLFxuICogb3IgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIEdOVSBBZmZlcm9cbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGFsb25nIHdpdGggQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqIElmIG5vdCwgc2VlIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8uXG4gKlxuICovXG5cbmltcG9ydCB7QWpmQ29udGV4dCwgZXZhbHVhdGVFeHByZXNzaW9ufSBmcm9tICdAYWpmL2NvcmUvbW9kZWxzJztcbmltcG9ydCB7XG4gIGNyZWF0ZVBkZixcbiAgQ29udGVudCxcbiAgUGFnZU9yaWVudGF0aW9uLFxuICBUQ3JlYXRlZFBkZixcbiAgVERvY3VtZW50RGVmaW5pdGlvbnMsXG59IGZyb20gJ0BhamYvY29yZS9wZGZtYWtlJztcblxuaW1wb3J0IHtBamZDaG9pY2V9IGZyb20gJy4uL2ludGVyZmFjZS9jaG9pY2VzL2Nob2ljZSc7XG5pbXBvcnQge0FqZkVtcHR5RmllbGR9IGZyb20gJy4uL2ludGVyZmFjZS9maWVsZHMvZW1wdHktZmllbGQnO1xuaW1wb3J0IHtBamZGaWVsZH0gZnJvbSAnLi4vaW50ZXJmYWNlL2ZpZWxkcy9maWVsZCc7XG5pbXBvcnQge0FqZkZpZWxkVHlwZX0gZnJvbSAnLi4vaW50ZXJmYWNlL2ZpZWxkcy9maWVsZC10eXBlJztcbmltcG9ydCB7QWpmVGFibGVGaWVsZH0gZnJvbSAnLi4vaW50ZXJmYWNlL2ZpZWxkcy90YWJsZS1maWVsZCc7XG5pbXBvcnQge0FqZkZvcm19IGZyb20gJy4uL2ludGVyZmFjZS9mb3Jtcy9mb3JtJztcbmltcG9ydCB7QWpmTm9kZVR5cGV9IGZyb20gJy4uL2ludGVyZmFjZS9ub2Rlcy9ub2RlLXR5cGUnO1xuaW1wb3J0IHtBamZSZXBlYXRpbmdTbGlkZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3NsaWRlcy9yZXBlYXRpbmctc2xpZGUnO1xuaW1wb3J0IHtBamZTbGlkZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3NsaWRlcy9zbGlkZSc7XG5pbXBvcnQge2lzRmllbGR9IGZyb20gJy4uL3V0aWxzL25vZGVzL2lzLWZpZWxkJztcbmltcG9ydCB7aXNSZXBlYXRpbmdTbGlkZX0gZnJvbSAnLi4vdXRpbHMvbm9kZXMvaXMtcmVwZWF0aW5nLXNsaWRlJztcbmltcG9ydCB7aXNTbGlkZU5vZGV9IGZyb20gJy4uL3V0aWxzL25vZGVzL2lzLXNsaWRlLW5vZGUnO1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRm9ybVBkZihcbiAgZm9ybTogQWpmRm9ybSxcbiAgdHJhbnNsYXRlPzogKF86IHN0cmluZykgPT4gc3RyaW5nLFxuICBvcmllbnRhdGlvbj86IFBhZ2VPcmllbnRhdGlvbixcbiAgaGVhZGVyPzogQ29udGVudFtdLFxuICBjb250ZXh0PzogQWpmQ29udGV4dCxcbik6IFRDcmVhdGVkUGRmIHtcbiAgY29uc3QgdCA9IHRyYW5zbGF0ZSA/IHRyYW5zbGF0ZSA6IChzOiBzdHJpbmcpID0+IHM7XG4gIGNvbnN0IHBkZkRlZiA9IGZvcm1Ub1BkZihmb3JtLCB0LCBvcmllbnRhdGlvbiwgaGVhZGVyLCBjb250ZXh0KTtcbiAgcmV0dXJuIGNyZWF0ZVBkZihwZGZEZWYpO1xufVxuXG4vLyBDaG9pY2VzTWFwIG1hcHMgYSBjaG9pY2VzT3JpZ2luUmVmIHRvIHRoZSBsaXN0IHRoZSBjaG9pY2VzLlxuaW50ZXJmYWNlIENob2ljZXNNYXAge1xuICBbbmFtZTogc3RyaW5nXTogQWpmQ2hvaWNlPGFueT5bXTtcbn1cblxuZnVuY3Rpb24gc3RyaXBIVE1MKHM6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBzLnJlcGxhY2UoLzxcXC8/W14+XSsoPnwkKS9nLCAnJyk7XG59XG5cbi8vIEdpdmVuIGEgY29udGV4dCwgbG9va3VwU3RyaW5nRnVuY3Rpb24gcmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgYWxsb3dzIHRvIHJldHJpZXZlXG4vLyB0aGUgZmllbGQgdmFsdWVzIGZyb20gdGhlIGNvbnRleHQuIFRoZSB2YWx1ZXMgYXJlIHJldHVybmVkIGFzIHByaW50LWZyaWVuZGx5IHN0cmluZ3MuXG4vLyByZXAgaXMgdGhlIGluZGV4IG9mIHRoZSByZXBlYXRpbmcgc2xpZGUsIGlmIHRoZSBmaWVsZCBiZWxvbmdzIHRvIG9uZS5cbmZ1bmN0aW9uIGxvb2t1cFN0cmluZ0Z1bmN0aW9uKGNvbnRleHQ/OiBBamZDb250ZXh0LCByZXA/OiBudW1iZXIpOiAobmFtZTogc3RyaW5nKSA9PiBzdHJpbmcge1xuICBpZiAoY29udGV4dCA9PSBudWxsKSB7XG4gICAgcmV0dXJuIChfOiBzdHJpbmcpID0+ICcgJztcbiAgfVxuICByZXR1cm4gKG5hbWU6IHN0cmluZykgPT4ge1xuICAgIGlmIChuYW1lID09IG51bGwpIHtcbiAgICAgIHJldHVybiAnICc7XG4gICAgfVxuICAgIGlmIChyZXAgIT0gbnVsbCkge1xuICAgICAgbmFtZSA9IG5hbWUgKyAnX18nICsgcmVwO1xuICAgIH1cbiAgICBjb25zdCB2YWwgPSBjb250ZXh0W25hbWVdO1xuICAgIGlmICh2YWwgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuICcgJztcbiAgICB9XG4gICAgaWYgKHZhbCA9PT0gdHJ1ZSkge1xuICAgICAgcmV0dXJuICd5ZXMnO1xuICAgIH1cbiAgICBpZiAodmFsID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuICdubyc7XG4gICAgfVxuICAgIHJldHVybiBTdHJpbmcodmFsKTtcbiAgfTtcbn1cblxuLy8gQW5hbG9nb3VzIHRvIGxvb2t1cFN0cmluZ0Z1bmN0aW9uLCBidXQgZm9yIG11bHRpcGxlLWNob2ljZSBxdWVzdGlvbnMsXG4vLyByZXR1cm5pbmcgYW4gYXJyYXkgb2YgdmFsdWVzLlxuZnVuY3Rpb24gbG9va3VwQXJyYXlGdW5jdGlvbihjb250ZXh0PzogQWpmQ29udGV4dCwgcmVwPzogbnVtYmVyKTogKG5hbWU6IHN0cmluZykgPT4gc3RyaW5nW10ge1xuICBpZiAoY29udGV4dCA9PSBudWxsKSB7XG4gICAgcmV0dXJuIChfOiBzdHJpbmcpID0+IFtdO1xuICB9XG4gIHJldHVybiAobmFtZTogc3RyaW5nKSA9PiB7XG4gICAgaWYgKG5hbWUgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBpZiAocmVwICE9IG51bGwpIHtcbiAgICAgIG5hbWUgPSBuYW1lICsgJ19fJyArIHJlcDtcbiAgICB9XG4gICAgY29uc3QgdmFsID0gY29udGV4dFtuYW1lXTtcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7XG4gICAgICByZXR1cm4gdmFsO1xuICAgIH1cbiAgICByZXR1cm4gW107XG4gIH07XG59XG5cbi8vIEdpdmVuIGFuIEFqZkZvcm0sIHJldHVybnMgaXRzIHBkZm1ha2UgcGRmIGRvY3VtZW50IGRlZmluaXRpb24uXG5mdW5jdGlvbiBmb3JtVG9QZGYoXG4gIGZvcm06IEFqZkZvcm0sXG4gIHRyYW5zbGF0ZTogKHM6IHN0cmluZykgPT4gc3RyaW5nLFxuICBvcmllbnRhdGlvbj86IFBhZ2VPcmllbnRhdGlvbixcbiAgaGVhZGVyPzogQ29udGVudFtdLFxuICBjb250ZXh0PzogQWpmQ29udGV4dCxcbik6IFREb2N1bWVudERlZmluaXRpb25zIHtcbiAgY29uc3QgY2hvaWNlc01hcDogQ2hvaWNlc01hcCA9IHt9O1xuICBmb3IgKGNvbnN0IG8gb2YgZm9ybS5jaG9pY2VzT3JpZ2lucykge1xuICAgIGNob2ljZXNNYXBbby5uYW1lXSA9IG8uY2hvaWNlcztcbiAgfVxuXG4gIGNvbnN0IGNvbnRlbnQgPSBoZWFkZXIgPyBbLi4uaGVhZGVyXSA6IFtdO1xuICBmb3IgKGNvbnN0IHNsaWRlIG9mIGZvcm0ubm9kZXMpIHtcbiAgICBpZiAoaXNTbGlkZU5vZGUoc2xpZGUpKSB7XG4gICAgICBjb250ZW50LnB1c2goLi4uc2xpZGVUb1BkZihzbGlkZSwgY2hvaWNlc01hcCwgdHJhbnNsYXRlLCBjb250ZXh0KSk7XG4gICAgfSBlbHNlIGlmIChpc1JlcGVhdGluZ1NsaWRlKHNsaWRlKSkge1xuICAgICAgY29udGVudC5wdXNoKC4uLnJlcGVhdGluZ1NsaWRlVG9QZGYoc2xpZGUsIGNob2ljZXNNYXAsIHRyYW5zbGF0ZSwgY29udGV4dCkpO1xuICAgIH1cbiAgfVxuICByZXR1cm4ge2NvbnRlbnQsIHBhZ2VPcmllbnRhdGlvbjogb3JpZW50YXRpb259O1xufVxuXG5mdW5jdGlvbiBzbGlkZVRvUGRmKFxuICBzbGlkZTogQWpmU2xpZGUgfCBBamZSZXBlYXRpbmdTbGlkZSxcbiAgY2hvaWNlc01hcDogQ2hvaWNlc01hcCxcbiAgdHJhbnNsYXRlOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4gIGNvbnRleHQ/OiBBamZDb250ZXh0LFxuICByZXA/OiBudW1iZXIsXG4pOiBDb250ZW50W10ge1xuICBsZXQgbGFiZWwgPSB0cmFuc2xhdGUoc2xpZGUubGFiZWwpO1xuICBpZiAocmVwICE9IG51bGwpIHtcbiAgICBsYWJlbCA9IGAke2xhYmVsfSAoJHt0cmFuc2xhdGUoJ3JlcGVhdCcpfSAke3JlcH0pYDtcbiAgfVxuICBjb25zdCBjb250ZW50OiBDb250ZW50W10gPSBbe3RleHQ6IGxhYmVsLCBmb250U2l6ZTogMTgsIGJvbGQ6IHRydWUsIG1hcmdpbjogWzAsIDE1LCAwLCAxMF19XTtcbiAgZm9yIChjb25zdCBmaWVsZCBvZiBzbGlkZS5ub2Rlcykge1xuICAgIGlmIChpc0ZpZWxkKGZpZWxkKSkge1xuICAgICAgY29udGVudC5wdXNoKC4uLmZpZWxkVG9QZGYoZmllbGQsIGNob2ljZXNNYXAsIHRyYW5zbGF0ZSwgY29udGV4dCwgcmVwKSk7XG4gICAgfVxuICB9XG4gIHJldHVybiBjb250ZW50O1xufVxuXG5mdW5jdGlvbiByZXBlYXRpbmdTbGlkZVRvUGRmKFxuICBzbGlkZTogQWpmUmVwZWF0aW5nU2xpZGUsXG4gIGNob2ljZXNNYXA6IENob2ljZXNNYXAsXG4gIHRyYW5zbGF0ZTogKHM6IHN0cmluZykgPT4gc3RyaW5nLFxuICBjb250ZXh0PzogQWpmQ29udGV4dCxcbik6IENvbnRlbnRbXSB7XG4gIGxldCByZXBlYXRzID0gMzsgLy8gZGVmYXVsdCwgaWYgbm8gZm9ybURhdGFcbiAgY29uc3QgbWF4UmVwZWF0cyA9IDIwO1xuICBpZiAoY29udGV4dCAhPSBudWxsICYmIHNsaWRlLm5hbWUgIT0gbnVsbCkge1xuICAgIGNvbnN0IHIgPSBjb250ZXh0W3NsaWRlLm5hbWVdO1xuICAgIGlmICh0eXBlb2YgciA9PT0gJ251bWJlcicpIHtcbiAgICAgIHJlcGVhdHMgPSBNYXRoLm1pbihyLCBtYXhSZXBlYXRzKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBjb250ZW50ID0gW107XG4gIGZvciAobGV0IHIgPSAwOyByIDwgcmVwZWF0czsgcisrKSB7XG4gICAgY29udGVudC5wdXNoKC4uLnNsaWRlVG9QZGYoc2xpZGUsIGNob2ljZXNNYXAsIHRyYW5zbGF0ZSwgY29udGV4dCwgcikpO1xuICB9XG4gIHJldHVybiBjb250ZW50O1xufVxuXG5mdW5jdGlvbiBib3JkZXJsZXNzQ2VsbCh0ZXh0OiBzdHJpbmcsIGJvbGQ/OiBib29sZWFuKTogQ29udGVudCB7XG4gIHJldHVybiB7dGFibGU6IHtib2R5OiBbW3t0ZXh0LCBib2xkLCBib3JkZXI6IFtmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZV19XV19fTtcbn1cblxuZnVuY3Rpb24gZmllbGRUb1BkZihcbiAgZmllbGQ6IEFqZkZpZWxkIHwgQWpmRW1wdHlGaWVsZCxcbiAgY2hvaWNlc01hcDogQ2hvaWNlc01hcCxcbiAgdHJhbnNsYXRlOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4gIGNvbnRleHQ/OiBBamZDb250ZXh0LFxuICByZXA/OiBudW1iZXIsXG4pOiBDb250ZW50W10ge1xuICBpZiAoZmllbGQubm9kZVR5cGUgIT09IEFqZk5vZGVUeXBlLkFqZkZpZWxkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdub3QgYSBmaWVsZCcpO1xuICB9XG5cbiAgY29uc3QgdmlzaWJsZSA9XG4gICAgY29udGV4dCA9PSBudWxsIC8qIGZvcm0gbm90IGNvbXBpbGVkLCBzaG93IGFsbCBmaWVsZHMgKi8gfHxcbiAgICBmaWVsZC52aXNpYmlsaXR5ID09IG51bGwgfHxcbiAgICBldmFsdWF0ZUV4cHJlc3Npb24oZmllbGQudmlzaWJpbGl0eS5jb25kaXRpb24sIGNvbnRleHQpO1xuICBpZiAoIXZpc2libGUpIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBjb25zdCBsb29rdXBTdHJpbmcgPSBsb29rdXBTdHJpbmdGdW5jdGlvbihjb250ZXh0LCByZXApO1xuXG4gIHN3aXRjaCAoZmllbGQuZmllbGRUeXBlKSB7XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuU3RyaW5nOlxuICAgIGNhc2UgQWpmRmllbGRUeXBlLlRleHQ6XG4gICAgICByZXR1cm4gW1xuICAgICAgICBib3JkZXJsZXNzQ2VsbCh0cmFuc2xhdGUoZmllbGQubGFiZWwpKSxcbiAgICAgICAge3RhYmxlOiB7d2lkdGhzOiBbJyonXSwgYm9keTogW1tsb29rdXBTdHJpbmcoZmllbGQubmFtZSldXX0sIG1hcmdpbjogWzUsIDAsIDAsIDVdfSxcbiAgICAgIF07XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuRm9ybXVsYTpcbiAgICAgIGxldCB2YWx1ZSA9IGxvb2t1cFN0cmluZyhmaWVsZC5uYW1lKTtcbiAgICAgIGlmICh2YWx1ZSA9PT0gJyAnKSB7XG4gICAgICAgIC8vIElmIHRoZSB2YWx1ZSBvZiB0aGUgZmllbGQgaXMgbm90IGluIHRoZSBjb250ZXh0LCByZWNvbXB1dGUgdGhlIGZvcm11bGEuXG4gICAgICAgIGNvbnN0IGZvcm11bGEgPSBmaWVsZC5mb3JtdWxhIHx8IHtmb3JtdWxhOiAnJ307XG4gICAgICAgIHZhbHVlID0gU3RyaW5nKGV2YWx1YXRlRXhwcmVzc2lvbihmb3JtdWxhLmZvcm11bGEsIGNvbnRleHQpKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBbXG4gICAgICAgIGJvcmRlcmxlc3NDZWxsKHRyYW5zbGF0ZShmaWVsZC5sYWJlbCkpLFxuICAgICAgICB7dGFibGU6IHt3aWR0aHM6IFsnKiddLCBib2R5OiBbW3ZhbHVlXV19LCBtYXJnaW46IFs1LCAwLCAwLCA1XX0sXG4gICAgICBdO1xuICAgIGNhc2UgQWpmRmllbGRUeXBlLk51bWJlcjpcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5Cb29sZWFuOlxuICAgIGNhc2UgQWpmRmllbGRUeXBlLkRhdGVJbnB1dDpcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5UaW1lOlxuICAgICAgbGV0IHZhbCA9IGxvb2t1cFN0cmluZyhmaWVsZC5uYW1lKTtcbiAgICAgIC8vIGZvciBib29sZWFuIGZpZWxkcyBpbiBjb21waWxlZCBmb3JtcywgYSBudWxsIHZhbHVlIGlzIHByaW50ZWQgYXMgJ25vJzpcbiAgICAgIGlmIChmaWVsZC5maWVsZFR5cGUgPT09IEFqZkZpZWxkVHlwZS5Cb29sZWFuICYmIGNvbnRleHQgIT0gbnVsbCAmJiB2YWwgPT09ICcgJykge1xuICAgICAgICB2YWwgPSAnbm8nO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFtcbiAgICAgICAge1xuICAgICAgICAgIHRhYmxlOiB7XG4gICAgICAgICAgICB3aWR0aHM6IFsnKicsICcqJ10sXG4gICAgICAgICAgICBib2R5OiBbW3t0ZXh0OiB0cmFuc2xhdGUoZmllbGQubGFiZWwpLCBib3JkZXI6IFtmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZV19LCB2YWxdXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXTtcbiAgICBjYXNlIEFqZkZpZWxkVHlwZS5TaW5nbGVDaG9pY2U6XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuTXVsdGlwbGVDaG9pY2U6XG4gICAgICBjb25zdCBjaG9pY2VzID0gY2hvaWNlc01hcFsoZmllbGQgYXMgYW55KS5jaG9pY2VzT3JpZ2luUmVmXTtcbiAgICAgIGlmIChjb250ZXh0ID09IG51bGwpIHtcbiAgICAgICAgLy8gZW1wdHkgZm9ybVxuICAgICAgICByZXR1cm4gY2hvaWNlVG9QZGYoZmllbGQsIGNob2ljZXMsIHRyYW5zbGF0ZSk7XG4gICAgICB9XG4gICAgICAvLyBjb21waWxlZCBmb3JtLCBvbmx5IHByaW50IGNob2ljZXMgdGhhdCBhcmUgc2VsZWN0ZWRcbiAgICAgIGNvbnN0IHNlbGVjdGVkVmFsdWVzID1cbiAgICAgICAgZmllbGQuZmllbGRUeXBlID09PSBBamZGaWVsZFR5cGUuU2luZ2xlQ2hvaWNlXG4gICAgICAgICAgPyBbbG9va3VwU3RyaW5nKGZpZWxkLm5hbWUpXVxuICAgICAgICAgIDogbG9va3VwQXJyYXlGdW5jdGlvbihjb250ZXh0LCByZXApKGZpZWxkLm5hbWUpO1xuICAgICAgY29uc3Qgbm9uTnVsbENob2ljZSA9IChjOiBBamZDaG9pY2U8YW55PiB8IHVuZGVmaW5lZCk6IGMgaXMgQWpmQ2hvaWNlPGFueT4gPT4gYyAhPSBudWxsO1xuICAgICAgbGV0IHNlbGVjdGVkQ2hvaWNlcyA9IHNlbGVjdGVkVmFsdWVzXG4gICAgICAgIC5tYXAodiA9PiBjaG9pY2VzLmZpbmQoYyA9PiBjLnZhbHVlID09PSB2KSlcbiAgICAgICAgLmZpbHRlcihub25OdWxsQ2hvaWNlKTtcbiAgICAgIGlmIChzZWxlY3RlZENob2ljZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHNlbGVjdGVkQ2hvaWNlcyA9IHNlbGVjdGVkVmFsdWVzLm1hcCh2ID0+ICh7XG4gICAgICAgICAgbGFiZWw6IHYsXG4gICAgICAgICAgdmFsdWU6IHYsXG4gICAgICAgIH0pKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBjaG9pY2VUb1BkZihmaWVsZCwgc2VsZWN0ZWRDaG9pY2VzLCB0cmFuc2xhdGUsIGNvbnRleHQpO1xuICAgIGNhc2UgQWpmRmllbGRUeXBlLkVtcHR5OlxuICAgICAgY29uc3QgdGV4dCA9IHN0cmlwSFRNTCh0cmFuc2xhdGUoZmllbGQuSFRNTCkpO1xuICAgICAgcmV0dXJuIFtib3JkZXJsZXNzQ2VsbCh0ZXh0LCB0cnVlKV07XG4gICAgY2FzZSBBamZGaWVsZFR5cGUuVGFibGU6XG4gICAgICByZXR1cm4gdGFibGVUb1BkZihmaWVsZCwgbG9va3VwU3RyaW5nLCB0cmFuc2xhdGUpO1xuICAgIGRlZmF1bHQ6XG4gICAgICAvLyB5ZXQgdW5zdXBwb3J0ZWQgZmllbGQgdHlwZVxuICAgICAgcmV0dXJuIFtdO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNob2ljZVRvUGRmKFxuICBmaWVsZDogQWpmRmllbGQsXG4gIGNob2ljZXM6IEFqZkNob2ljZTxhbnk+W10sXG4gIHRyYW5zbGF0ZTogKHM6IHN0cmluZykgPT4gc3RyaW5nLFxuICBjb250ZXh0PzogQWpmQ29udGV4dCxcbik6IENvbnRlbnRbXSB7XG4gIGxldCBjaG9pY2VMYWJlbHM6IHN0cmluZ1tdO1xuICBpZiAoY2hvaWNlcyA9PSBudWxsIHx8IGNob2ljZXMubGVuZ3RoID09PSAwKSB7XG4gICAgY2hvaWNlTGFiZWxzID0gWycgJ107XG4gIH0gZWxzZSB7XG4gICAgY2hvaWNlTGFiZWxzID0gY2hvaWNlcy5tYXAoYyA9PiBjLmxhYmVsKTtcbiAgfVxuICBjb25zdCBib2R5ID0gW107XG4gIGZvciAoY29uc3QgYyBvZiBjaG9pY2VMYWJlbHMpIHtcbiAgICBib2R5LnB1c2goW3RyYW5zbGF0ZShjKV0pO1xuICB9XG4gIGxldCBxdWVzdGlvbiA9IHRyYW5zbGF0ZShmaWVsZC5sYWJlbCk7XG4gIC8vIElmIHRoZSBmb3JtIGlzIGVtcHR5ICh0byBiZSBjb21waWxlZCksXG4gIC8vIGhlbHAgdGhlIHVzZXIgZGlzdGluZ3Vpc2ggYmV0d2VlbiBzaW5nbGUtIGFuZCBtdWx0aXBsZS1jaG9pY2UgcXVlc3Rpb25zOlxuICBpZiAoY29udGV4dCA9PSBudWxsICYmIGZpZWxkLmZpZWxkVHlwZSA9PT0gQWpmRmllbGRUeXBlLlNpbmdsZUNob2ljZSkge1xuICAgIHF1ZXN0aW9uICs9IGAgKCR7dHJhbnNsYXRlKCdzaW5nbGUgY2hvaWNlJyl9KWA7XG4gIH1cbiAgaWYgKGNvbnRleHQgPT0gbnVsbCAmJiBmaWVsZC5maWVsZFR5cGUgPT09IEFqZkZpZWxkVHlwZS5NdWx0aXBsZUNob2ljZSkge1xuICAgIHF1ZXN0aW9uICs9IGAgKCR7dHJhbnNsYXRlKCdtdWx0aXBlIGNob2ljZScpfSlgO1xuICB9XG4gIHJldHVybiBbXG4gICAge1xuICAgICAgY29sdW1uczogW1xuICAgICAgICBib3JkZXJsZXNzQ2VsbChxdWVzdGlvbiksXG4gICAgICAgIHtcbiAgICAgICAgICB0YWJsZToge3dpZHRoczogWycqJ10sIGJvZHl9LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIG1hcmdpbjogWzAsIDAsIDAsIDVdLFxuICAgIH0sXG4gIF07XG59XG5cbmZ1bmN0aW9uIHRhYmxlVG9QZGYoXG4gIHRhYmxlOiBBamZUYWJsZUZpZWxkLFxuICBsb29rdXBTdHJpbmc6IChzOiBzdHJpbmcpID0+IHN0cmluZyxcbiAgdHJhbnNsYXRlOiAoczogc3RyaW5nKSA9PiBzdHJpbmcsXG4pOiBDb250ZW50W10ge1xuICBjb25zdCBib2R5OiBzdHJpbmdbXVtdID0gW1snJywgLi4udGFibGUuY29sdW1uTGFiZWxzLm1hcCh0cmFuc2xhdGUpXV07XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdGFibGUucm93cy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IHJvdyA9IFsuLi50YWJsZS5yb3dzW2ldXTtcbiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJvdy5sZW5ndGg7IGorKykge1xuICAgICAgY29uc3QgY2VsbCA9IHJvd1tqXTtcbiAgICAgIGlmICh0eXBlb2YgY2VsbCAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgcm93W2pdID0gY2VsbC5mb3JtdWxhO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCB2YWxzUm93ID0gKHJvdyBhcyBzdHJpbmdbXSkubWFwKGxvb2t1cFN0cmluZykubWFwKHRyYW5zbGF0ZSk7XG4gICAgYm9keS5wdXNoKFt0cmFuc2xhdGUodGFibGUucm93TGFiZWxzW2ldKSwgLi4udmFsc1Jvd10pO1xuICB9XG4gIHJldHVybiBbXG4gICAgYm9yZGVybGVzc0NlbGwodHJhbnNsYXRlKHRhYmxlLmxhYmVsKSksXG4gICAge3RhYmxlOiB7Ym9keSwgd2lkdGhzOiBBcnJheSh0YWJsZS5jb2x1bW5MYWJlbHMubGVuZ3RoICsgMSkuZmlsbCgnKicpfSwgbWFyZ2luOiBbNSwgMCwgMCwgNV19LFxuICBdO1xufVxuIl19