/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import * as XLSX from 'xlsx';
import { createFormula } from '@ajf/core/models';
import { backgroundColor } from '../report-from-form/styles';
import { indicatorToJs } from './hindikit-parser';
import { htmlWidget, widgetStyle } from './styles';
import { createDataset } from '../utils/dataset/create-dataset';
import { createReportContainer } from '../utils/reports/create-report-container';
import { createWidget } from '../utils/widgets/create-widget';
import { AjfWidgetType } from '../interface/widgets/widget-type';
import { AjfChartType } from '../interface/charts/chart-type';
/**
 * This function returns a basic report for any form passed in input.
 *
 * @param form the form schema
 * @param [id] the id of the form inside the plathform.
 */
export function reportFromXls(file) {
    const workbook = XLSX.read(file, { type: 'binary' });
    const report = {};
    const reportWidgets = [];
    const variables = [];
    workbook.SheetNames.forEach(sheetName => {
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet);
        if (sheetName === 'variables') {
            json
                .filter(e => e != null && e.name != null && e.value != null)
                .forEach(elem => {
                let indicator = elem.value;
                try {
                    indicator = indicatorToJs(elem.value);
                }
                catch (e) {
                    console.log(e);
                }
                variables.push({ name: elem.name, formula: { formula: indicator } });
            });
        }
        else {
            if (sheetName.includes('table')) {
                const tableWidget = _buildTable(json);
                reportWidgets.push(tableWidget);
            }
            else if (sheetName.includes('chart')) {
                const chartWidget = _buildChart(json);
                reportWidgets.push(chartWidget);
            }
            else if (sheetName.includes('html')) {
                const chartWidget = _buildHtml(json);
                reportWidgets.push(chartWidget);
            }
        }
    });
    report.variables = variables;
    report.content = createReportContainer({ content: [...reportWidgets] });
    return report;
}
function _buildChart(json) {
    const optionLabels = ['chartType', 'title'];
    const chartOptions = {};
    const datasetObj = {};
    const dataset = [];
    let labels = { formula: `[]` };
    if (json.length > 0) {
        const firstRow = json[0];
        optionLabels.forEach(optionLabel => {
            if (firstRow[optionLabel] != null) {
                chartOptions[optionLabel] = firstRow[optionLabel];
                delete firstRow[optionLabel];
            }
        });
    }
    json.forEach(row => {
        const rowKeys = Object.keys(row);
        rowKeys.forEach(rowKey => {
            const value = row[rowKey];
            if (datasetObj[rowKey] == null) {
                datasetObj[rowKey] = [value];
            }
            else {
                datasetObj[rowKey].push(value);
            }
        });
    });
    if (datasetObj.labels != null) {
        labels = { formula: `plainArray([${datasetObj.labels}])` };
        delete datasetObj.labels;
    }
    Object.keys(datasetObj).forEach((datasetObjKey, index) => {
        const datasetRow = datasetObj[datasetObjKey].map((r) => indicatorToJs(`${r}`));
        const colorCondition = chartOptions.chartType === 'Pie' ||
            chartOptions.chartType === 'PolarArea' ||
            chartOptions.chartType === 'Doughnut';
        const backColor = colorCondition ? backgroundColor : backgroundColor[index];
        const formula = [
            createFormula({ formula: `plainArray([${datasetRow.toString()}])` }),
        ];
        const datasetOptions = { backgroundColor: backColor };
        dataset.push({
            ...createDataset({ aggregation: { aggregation: 0 }, formula, label: datasetObjKey }),
            options: datasetOptions,
        });
    });
    return _buildWidget({
        widgetType: AjfWidgetType.Chart,
        type: AjfChartType[chartOptions.chartType],
        labels,
        dataset,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: { display: true, position: 'bottom' },
            title: { display: true, text: `${chartOptions.title || ''}`.replace(/"/gi, '') },
        },
        styles: { width: '100%', height: '500px' },
        exportable: true,
    });
}
function _buildHtml(json) {
    const firstRow = json.length > 0 && json[0].html != null ? json[0] : { html: '' };
    return _buildWidget({
        widgetType: AjfWidgetType.Text,
        htmlText: `${firstRow.html}`,
        styles: htmlWidget,
    });
}
function _buildTable(json) {
    const rowspan = 1;
    const dataElements = [];
    const titles = Object.keys(json[0]);
    const colspans = Object.values(json[0]).map(r => +r);
    delete json[0];
    const tableHeader = titles.map((title, index) => ({
        label: '',
        formula: { formula: `\"${title}\"` },
        aggregation: { aggregation: 0 },
        colspan: colspans[index],
        rowspan,
        style: {
            textAlign: 'center',
            fontWeight: 'bold',
            color: 'white',
            backgroundColor: '#3f51b5',
        },
    }));
    json.forEach(row => {
        const elems = [];
        titles.forEach(title => {
            let elem = row[title] || `\"\"`;
            try {
                elem = indicatorToJs(elem);
            }
            catch (err) {
                console.log('erro', elem, title, row);
                console.log(err.message);
                elem = `${row[title]}`;
            }
            elems.push(elem.replace(/[\*\/\r\n]|@[\w-]+/g, ''));
        });
        dataElements.push(elems);
    });
    return _buildWidget({
        widgetType: AjfWidgetType.DynamicTable,
        rowDefinition: {
            formula: `buildDataset([${dataElements}],${JSON.stringify(colspans)})`,
        },
        dataset: tableHeader,
        exportable: true,
        cellStyles: {
            textAlign: 'center',
            color: 'black',
            backgroundColor: 'white',
        },
        styles: {
            borderCollapse: 'collapse',
        },
    });
}
function _buildWidget(widget) {
    return createWidget({
        widgetType: AjfWidgetType.Column,
        columns: [1],
        content: [createWidget(widget)],
        styles: widgetStyle,
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3J0LWZyb20teGxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvcmVwb3J0cy9yZXBvcnQtZnJvbS14bHMvcmVwb3J0LWZyb20teGxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUdILE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBRTdCLE9BQU8sRUFBYSxhQUFhLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUMzRCxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFFM0QsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBQyxVQUFVLEVBQUUsV0FBVyxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQ2pELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxpQ0FBaUMsQ0FBQztBQUM5RCxPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSwwQ0FBMEMsQ0FBQztBQUMvRSxPQUFPLEVBQWtCLFlBQVksRUFBQyxNQUFNLGdDQUFnQyxDQUFDO0FBQzdFLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxrQ0FBa0MsQ0FBQztBQUkvRCxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFNNUQ7Ozs7O0dBS0c7QUFDSCxNQUFNLFVBQVUsYUFBYSxDQUFDLElBQVk7SUFDeEMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBQyxJQUFJLEVBQUUsUUFBUSxFQUFDLENBQUMsQ0FBQztJQUNuRCxNQUFNLE1BQU0sR0FBYyxFQUFFLENBQUM7SUFDN0IsTUFBTSxhQUFhLEdBQWdCLEVBQUUsQ0FBQztJQUN0QyxNQUFNLFNBQVMsR0FBd0IsRUFBRSxDQUFDO0lBRTFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FB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QUFNLEVBQUU7WUFDTixjQUFjLEVBQUUsVUFBVTtTQUMzQjtLQUNpQixDQUFDLENBQUM7QUFDeEIsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLE1BQXVCO0lBQzNDLE9BQU8sWUFBWSxDQUFDO1FBQ2xCLFVBQVUsRUFBRSxhQUFhLENBQUMsTUFBTTtRQUNoQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDWixPQUFPLEVBQUUsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDL0IsTUFBTSxFQUFFLFdBQVc7S0FDRCxDQUFDLENBQUM7QUFDeEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoQykgR251Y29vcCBzb2MuIGNvb3AuXG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3JcbiAqIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhc1xuICogcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsXG4gKiBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VIEFmZmVyb1xuICogR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogYWxvbmcgd2l0aCBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICogSWYgbm90LCBzZWUgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLy5cbiAqXG4gKi9cblxuaW1wb3J0IHtDaGFydENvbG9yfSBmcm9tICdjaGFydC5qcyc7XG5pbXBvcnQgKiBhcyBYTFNYIGZyb20gJ3hsc3gnO1xuXG5pbXBvcnQge0FqZkZvcm11bGEsIGNyZWF0ZUZvcm11bGF9IGZyb20gJ0BhamYvY29yZS9tb2RlbHMnO1xuaW1wb3J0IHtiYWNrZ3JvdW5kQ29sb3J9IGZyb20gJy4uL3JlcG9ydC1mcm9tLWZvcm0vc3R5bGVzJztcblxuaW1wb3J0IHtpbmRpY2F0b3JUb0pzfSBmcm9tICcuL2hpbmRpa2l0LXBhcnNlcic7XG5pbXBvcnQge2h0bWxXaWRnZXQsIHdpZGdldFN0eWxlfSBmcm9tICcuL3N0eWxlcyc7XG5pbXBvcnQge2NyZWF0ZURhdGFzZXR9IGZyb20gJy4uL3V0aWxzL2RhdGFzZXQvY3JlYXRlLWRhdGFzZXQnO1xuaW1wb3J0IHtjcmVhdGVSZXBvcnRDb250YWluZXJ9IGZyb20gJy4uL3V0aWxzL3JlcG9ydHMvY3JlYXRlLXJlcG9ydC1jb250YWluZXInO1xuaW1wb3J0IHtBamZXaWRnZXRDcmVhdGUsIGNyZWF0ZVdpZGdldH0gZnJvbSAnLi4vdXRpbHMvd2lkZ2V0cy9jcmVhdGUtd2lkZ2V0JztcbmltcG9ydCB7QWpmV2lkZ2V0VHlwZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMvd2lkZ2V0LXR5cGUnO1xuaW1wb3J0IHtBamZUYWJsZURhdGFzZXR9IGZyb20gJy4uL2ludGVyZmFjZS9kYXRhc2V0L3RhYmxlLWRhdGFzZXQnO1xuaW1wb3J0IHtBamZDaGFydERhdGFzZXR9IGZyb20gJy4uL2ludGVyZmFjZS9kYXRhc2V0L2NoYXJ0LWRhdGFzZXQnO1xuaW1wb3J0IHtBamZDaGFydERhdGFzZXRPcHRpb25zfSBmcm9tICcuLi9pbnRlcmZhY2UvZGF0YXNldC9jaGFydC1kYXRhc2V0LW9wdGlvbnMnO1xuaW1wb3J0IHtBamZDaGFydFR5cGV9IGZyb20gJy4uL2ludGVyZmFjZS9jaGFydHMvY2hhcnQtdHlwZSc7XG5pbXBvcnQge0FqZldpZGdldH0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMvd2lkZ2V0JztcbmltcG9ydCB7QWpmUmVwb3J0fSBmcm9tICcuLi9pbnRlcmZhY2UvcmVwb3J0cy9yZXBvcnQnO1xuaW1wb3J0IHtBamZSZXBvcnRWYXJpYWJsZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3JlcG9ydHMvcmVwb3J0LXZhcmlhYmxlJztcbmltcG9ydCB7QWpmUmVwb3J0Q29udGFpbmVyfSBmcm9tICcuLi9pbnRlcmZhY2UvcmVwb3J0cy9yZXBvcnQtY29udGFpbmVyJztcblxuLyoqXG4gKiBUaGlzIGZ1bmN0aW9uIHJldHVybnMgYSBiYXNpYyByZXBvcnQgZm9yIGFueSBmb3JtIHBhc3NlZCBpbiBpbnB1dC5cbiAqXG4gKiBAcGFyYW0gZm9ybSB0aGUgZm9ybSBzY2hlbWFcbiAqIEBwYXJhbSBbaWRdIHRoZSBpZCBvZiB0aGUgZm9ybSBpbnNpZGUgdGhlIHBsYXRoZm9ybS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcG9ydEZyb21YbHMoZmlsZTogc3RyaW5nKTogQWpmUmVwb3J0IHtcbiAgY29uc3Qgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZmlsZSwge3R5cGU6ICdiaW5hcnknfSk7XG4gIGNvbnN0IHJlcG9ydDogQWpmUmVwb3J0ID0ge307XG4gIGNvbnN0IHJlcG9ydFdpZGdldHM6IEFqZldpZGdldFtdID0gW107XG4gIGNvbnN0IHZhcmlhYmxlczogQWpmUmVwb3J0VmFyaWFibGVbXSA9IFtdO1xuXG4gIHdvcmtib29rLlNoZWV0TmFtZXMuZm9yRWFjaChzaGVldE5hbWUgPT4ge1xuICAgIGNvbnN0IHNoZWV0OiBYTFNYLldvcmtTaGVldCA9IHdvcmtib29rLlNoZWV0c1tzaGVldE5hbWVdO1xuICAgIGNvbnN0IGpzb24gPSBYTFNYLnV0aWxzLnNoZWV0X3RvX2pzb24oc2hlZXQpIGFzIHtuYW1lOiBzdHJpbmc7IHZhbHVlOiBzdHJpbmd9W107XG5cbiAgICBpZiAoc2hlZXROYW1lID09PSAndmFyaWFibGVzJykge1xuICAgICAganNvblxuICAgICAgICAuZmlsdGVyKGUgPT4gZSAhPSBudWxsICYmIGUubmFtZSAhPSBudWxsICYmIGUudmFsdWUgIT0gbnVsbClcbiAgICAgICAgLmZvckVhY2goZWxlbSA9PiB7XG4gICAgICAgICAgbGV0IGluZGljYXRvciA9IGVsZW0udmFsdWU7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGluZGljYXRvciA9IGluZGljYXRvclRvSnMoZWxlbS52YWx1ZSk7XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHZhcmlhYmxlcy5wdXNoKHtuYW1lOiBlbGVtLm5hbWUsIGZvcm11bGE6IHtmb3JtdWxhOiBpbmRpY2F0b3J9fSBhcyBBamZSZXBvcnRWYXJpYWJsZSk7XG4gICAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoc2hlZXROYW1lLmluY2x1ZGVzKCd0YWJsZScpKSB7XG4gICAgICAgIGNvbnN0IHRhYmxlV2lkZ2V0ID0gX2J1aWxkVGFibGUoanNvbik7XG4gICAgICAgIHJlcG9ydFdpZGdldHMucHVzaCh0YWJsZVdpZGdldCk7XG4gICAgICB9IGVsc2UgaWYgKHNoZWV0TmFtZS5pbmNsdWRlcygnY2hhcnQnKSkge1xuICAgICAgICBjb25zdCBjaGFydFdpZGdldCA9IF9idWlsZENoYXJ0KGpzb24pO1xuICAgICAgICByZXBvcnRXaWRnZXRzLnB1c2goY2hhcnRXaWRnZXQpO1xuICAgICAgfSBlbHNlIGlmIChzaGVldE5hbWUuaW5jbHVkZXMoJ2h0bWwnKSkge1xuICAgICAgICBjb25zdCBjaGFydFdpZGdldCA9IF9idWlsZEh0bWwoanNvbik7XG4gICAgICAgIHJlcG9ydFdpZGdldHMucHVzaChjaGFydFdpZGdldCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICByZXBvcnQudmFyaWFibGVzID0gdmFyaWFibGVzO1xuICByZXBvcnQuY29udGVudCA9IGNyZWF0ZVJlcG9ydENvbnRhaW5lcih7Y29udGVudDogWy4uLnJlcG9ydFdpZGdldHNdfSBhcyBBamZSZXBvcnRDb250YWluZXIpO1xuXG4gIHJldHVybiByZXBvcnQ7XG59XG5cbmZ1bmN0aW9uIF9idWlsZENoYXJ0KGpzb246IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9W10pOiBBamZXaWRnZXQge1xuICBjb25zdCBvcHRpb25MYWJlbHMgPSBbJ2NoYXJ0VHlwZScsICd0aXRsZSddO1xuICBjb25zdCBjaGFydE9wdGlvbnM6IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9ID0ge307XG4gIGNvbnN0IGRhdGFzZXRPYmo6IHtba2V5OiBzdHJpbmddOiBhbnl9ID0ge307XG4gIGNvbnN0IGRhdGFzZXQ6IEFqZkNoYXJ0RGF0YXNldFtdID0gW107XG4gIGxldCBsYWJlbHM6IEFqZkZvcm11bGEgPSB7Zm9ybXVsYTogYFtdYH07XG5cbiAgaWYgKGpzb24ubGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IGZpcnN0Um93ID0ganNvblswXTtcbiAgICBvcHRpb25MYWJlbHMuZm9yRWFjaChvcHRpb25MYWJlbCA9PiB7XG4gICAgICBpZiAoZmlyc3RSb3dbb3B0aW9uTGFiZWxdICE9IG51bGwpIHtcbiAgICAgICAgY2hhcnRPcHRpb25zW29wdGlvbkxhYmVsXSA9IGZpcnN0Um93W29wdGlvbkxhYmVsXTtcbiAgICAgICAgZGVsZXRlIGZpcnN0Um93W29wdGlvbkxhYmVsXTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICBqc29uLmZvckVhY2gocm93ID0+IHtcbiAgICBjb25zdCByb3dLZXlzID0gT2JqZWN0LmtleXMocm93KTtcbiAgICByb3dLZXlzLmZvckVhY2gocm93S2V5ID0+IHtcbiAgICAgIGNvbnN0IHZhbHVlID0gcm93W3Jvd0tleV07XG4gICAgICBpZiAoZGF0YXNldE9ialtyb3dLZXldID09IG51bGwpIHtcbiAgICAgICAgZGF0YXNldE9ialtyb3dLZXldID0gW3ZhbHVlXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGFzZXRPYmpbcm93S2V5XS5wdXNoKHZhbHVlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG4gIGlmIChkYXRhc2V0T2JqLmxhYmVscyAhPSBudWxsKSB7XG4gICAgbGFiZWxzID0ge2Zvcm11bGE6IGBwbGFpbkFycmF5KFske2RhdGFzZXRPYmoubGFiZWxzfV0pYH07XG4gICAgZGVsZXRlIGRhdGFzZXRPYmoubGFiZWxzO1xuICB9XG4gIE9iamVjdC5rZXlzKGRhdGFzZXRPYmopLmZvckVhY2goKGRhdGFzZXRPYmpLZXksIGluZGV4KSA9PiB7XG4gICAgY29uc3QgZGF0YXNldFJvdyA9IGRhdGFzZXRPYmpbZGF0YXNldE9iaktleV0ubWFwKChyOiBzdHJpbmcpID0+IGluZGljYXRvclRvSnMoYCR7cn1gKSk7XG5cbiAgICBjb25zdCBjb2xvckNvbmRpdGlvbiA9XG4gICAgICBjaGFydE9wdGlvbnMuY2hhcnRUeXBlID09PSAnUGllJyB8fFxuICAgICAgY2hhcnRPcHRpb25zLmNoYXJ0VHlwZSA9PT0gJ1BvbGFyQXJlYScgfHxcbiAgICAgIGNoYXJ0T3B0aW9ucy5jaGFydFR5cGUgPT09ICdEb3VnaG51dCc7XG4gICAgY29uc3QgYmFja0NvbG9yID0gY29sb3JDb25kaXRpb24gPyBiYWNrZ3JvdW5kQ29sb3IgOiBiYWNrZ3JvdW5kQ29sb3JbaW5kZXhdO1xuICAgIGNvbnN0IGZvcm11bGE6IEFqZkZvcm11bGFbXSA9IFtcbiAgICAgIGNyZWF0ZUZvcm11bGEoe2Zvcm11bGE6IGBwbGFpbkFycmF5KFske2RhdGFzZXRSb3cudG9TdHJpbmcoKX1dKWB9KSxcbiAgICBdO1xuICAgIGNvbnN0IGRhdGFzZXRPcHRpb25zOiBBamZDaGFydERhdGFzZXRPcHRpb25zID0ge2JhY2tncm91bmRDb2xvcjogYmFja0NvbG9yIGFzIENoYXJ0Q29sb3J9O1xuICAgIGRhdGFzZXQucHVzaCh7XG4gICAgICAuLi5jcmVhdGVEYXRhc2V0KHthZ2dyZWdhdGlvbjoge2FnZ3JlZ2F0aW9uOiAwfSwgZm9ybXVsYSwgbGFiZWw6IGRhdGFzZXRPYmpLZXl9KSxcbiAgICAgIG9wdGlvbnM6IGRhdGFzZXRPcHRpb25zLFxuICAgIH0gYXMgQWpmQ2hhcnREYXRhc2V0KTtcbiAgfSk7XG5cbiAgcmV0dXJuIF9idWlsZFdpZGdldCh7XG4gICAgd2lkZ2V0VHlwZTogQWpmV2lkZ2V0VHlwZS5DaGFydCxcbiAgICB0eXBlOiBBamZDaGFydFR5cGVbY2hhcnRPcHRpb25zLmNoYXJ0VHlwZSBhcyBhbnldIGFzIHVua25vd24gYXMgQWpmQ2hhcnRUeXBlLFxuICAgIGxhYmVscyxcbiAgICBkYXRhc2V0LFxuICAgIG9wdGlvbnM6IHtcbiAgICAgIHJlc3BvbnNpdmU6IHRydWUsXG4gICAgICBtYWludGFpbkFzcGVjdFJhdGlvOiBmYWxzZSxcbiAgICAgIGxlZ2VuZDoge2Rpc3BsYXk6IHRydWUsIHBvc2l0aW9uOiAnYm90dG9tJ30sXG4gICAgICB0aXRsZToge2Rpc3BsYXk6IHRydWUsIHRleHQ6IGAke2NoYXJ0T3B0aW9ucy50aXRsZSB8fCAnJ31gLnJlcGxhY2UoL1wiL2dpLCAnJyl9LFxuICAgIH0sXG4gICAgc3R5bGVzOiB7d2lkdGg6ICcxMDAlJywgaGVpZ2h0OiAnNTAwcHgnfSxcbiAgICBleHBvcnRhYmxlOiB0cnVlLFxuICB9IGFzIEFqZldpZGdldENyZWF0ZSk7XG59XG5cbmZ1bmN0aW9uIF9idWlsZEh0bWwoanNvbjoge1trZXk6IHN0cmluZ106IHN0cmluZ31bXSk6IEFqZldpZGdldCB7XG4gIGNvbnN0IGZpcnN0Um93ID0ganNvbi5sZW5ndGggPiAwICYmIGpzb25bMF0uaHRtbCAhPSBudWxsID8ganNvblswXSA6IHtodG1sOiAnJ307XG5cbiAgcmV0dXJuIF9idWlsZFdpZGdldCh7XG4gICAgd2lkZ2V0VHlwZTogQWpmV2lkZ2V0VHlwZS5UZXh0LFxuICAgIGh0bWxUZXh0OiBgJHtmaXJzdFJvdy5odG1sfWAsXG4gICAgc3R5bGVzOiBodG1sV2lkZ2V0LFxuICB9IGFzIEFqZldpZGdldENyZWF0ZSk7XG59XG5cbmZ1bmN0aW9uIF9idWlsZFRhYmxlKGpzb246IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9W10pOiBBamZXaWRnZXQge1xuICBjb25zdCByb3dzcGFuID0gMTtcbiAgY29uc3QgZGF0YUVsZW1lbnRzOiBhbnlbXVtdID0gW107XG4gIGNvbnN0IHRpdGxlcyA9IE9iamVjdC5rZXlzKGpzb25bMF0pO1xuICBjb25zdCBjb2xzcGFuczogbnVtYmVyW10gPSAoT2JqZWN0LnZhbHVlcyhqc29uWzBdKSBhcyBzdHJpbmdbXSkubWFwKHIgPT4gK3IpO1xuICBkZWxldGUganNvblswXTtcbiAgY29uc3QgdGFibGVIZWFkZXI6IEFqZlRhYmxlRGF0YXNldFtdID0gdGl0bGVzLm1hcChcbiAgICAodGl0bGUsIGluZGV4KSA9PlxuICAgICAgKHtcbiAgICAgICAgbGFiZWw6ICcnLFxuICAgICAgICBmb3JtdWxhOiB7Zm9ybXVsYTogYFxcXCIke3RpdGxlfVxcXCJgfSxcbiAgICAgICAgYWdncmVnYXRpb246IHthZ2dyZWdhdGlvbjogMH0sXG4gICAgICAgIGNvbHNwYW46IGNvbHNwYW5zW2luZGV4XSxcbiAgICAgICAgcm93c3BhbixcbiAgICAgICAgc3R5bGU6IHtcbiAgICAgICAgICB0ZXh0QWxpZ246ICdjZW50ZXInLFxuICAgICAgICAgIGZvbnRXZWlnaHQ6ICdib2xkJyxcbiAgICAgICAgICBjb2xvcjogJ3doaXRlJyxcbiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICcjM2Y1MWI1JyxcbiAgICAgICAgfSxcbiAgICAgIH0gYXMgQWpmVGFibGVEYXRhc2V0KSxcbiAgKTtcblxuICBqc29uLmZvckVhY2gocm93ID0+IHtcbiAgICBjb25zdCBlbGVtczogYW55W10gPSBbXTtcbiAgICB0aXRsZXMuZm9yRWFjaCh0aXRsZSA9PiB7XG4gICAgICBsZXQgZWxlbTogc3RyaW5nID0gcm93W3RpdGxlXSB8fCBgXFxcIlxcXCJgO1xuICAgICAgdHJ5IHtcbiAgICAgICAgZWxlbSA9IGluZGljYXRvclRvSnMoZWxlbSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ2Vycm8nLCBlbGVtLCB0aXRsZSwgcm93KTtcbiAgICAgICAgY29uc29sZS5sb2coZXJyLm1lc3NhZ2UpO1xuICAgICAgICBlbGVtID0gYCR7cm93W3RpdGxlXX1gO1xuICAgICAgfVxuICAgICAgZWxlbXMucHVzaChlbGVtLnJlcGxhY2UoL1tcXCpcXC9cXHJcXG5dfEBbXFx3LV0rL2csICcnKSk7XG4gICAgfSk7XG4gICAgZGF0YUVsZW1lbnRzLnB1c2goZWxlbXMpO1xuICB9KTtcblxuICByZXR1cm4gX2J1aWxkV2lkZ2V0KHtcbiAgICB3aWRnZXRUeXBlOiBBamZXaWRnZXRUeXBlLkR5bmFtaWNUYWJsZSxcbiAgICByb3dEZWZpbml0aW9uOiB7XG4gICAgICBmb3JtdWxhOiBgYnVpbGREYXRhc2V0KFske2RhdGFFbGVtZW50c31dLCR7SlNPTi5zdHJpbmdpZnkoY29sc3BhbnMpfSlgLFxuICAgIH0sXG4gICAgZGF0YXNldDogdGFibGVIZWFkZXIsXG4gICAgZXhwb3J0YWJsZTogdHJ1ZSxcbiAgICBjZWxsU3R5bGVzOiB7XG4gICAgICB0ZXh0QWxpZ246ICdjZW50ZXInLFxuICAgICAgY29sb3I6ICdibGFjaycsXG4gICAgICBiYWNrZ3JvdW5kQ29sb3I6ICd3aGl0ZScsXG4gICAgfSxcbiAgICBzdHlsZXM6IHtcbiAgICAgIGJvcmRlckNvbGxhcHNlOiAnY29sbGFwc2UnLFxuICAgIH0sXG4gIH0gYXMgQWpmV2lkZ2V0Q3JlYXRlKTtcbn1cblxuZnVuY3Rpb24gX2J1aWxkV2lkZ2V0KHdpZGdldDogQWpmV2lkZ2V0Q3JlYXRlKTogQWpmV2lkZ2V0IHtcbiAgcmV0dXJuIGNyZWF0ZVdpZGdldCh7XG4gICAgd2lkZ2V0VHlwZTogQWpmV2lkZ2V0VHlwZS5Db2x1bW4sXG4gICAgY29sdW1uczogWzFdLFxuICAgIGNvbnRlbnQ6IFtjcmVhdGVXaWRnZXQod2lkZ2V0KV0sXG4gICAgc3R5bGVzOiB3aWRnZXRTdHlsZSxcbiAgfSBhcyBBamZXaWRnZXRDcmVhdGUpO1xufVxuIl19