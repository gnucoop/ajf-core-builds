/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { AjfWidgetType } from '../interface/widgets/widget-type';
import { AjfImageType } from '@ajf/core/image';
export function loadReportImages(report) {
    const promises = [];
    if (report.header != null) {
        promises.push(loadContainerImages(report.header));
    }
    if (report.content != null) {
        promises.push(loadContainerImages(report.content));
    }
    if (report.footer != null) {
        promises.push(loadContainerImages(report.footer));
    }
    return new Promise(resolve => {
        Promise.all(promises).then(maps => {
            let map = {};
            for (const m of maps) {
                map = { ...map, ...m };
            }
            resolve(map);
        });
    });
}
function loadContainerImages(container) {
    const promises = [];
    for (let widget of container.content) {
        promises.push(loadWidgetImages(widget));
    }
    return new Promise(resolve => {
        Promise.all(promises).then(maps => {
            let map = {};
            for (const m of maps) {
                map = { ...map, ...m };
            }
            resolve(map);
        });
    });
}
function loadWidgetImages(widget) {
    switch (widget.widgetType) {
        case AjfWidgetType.Layout:
        case AjfWidgetType.Column:
            return loadContainerImages(widget);
        case AjfWidgetType.Image:
            const image = widget;
            if (image.widget.imageType !== AjfImageType.Image) {
                break;
            }
            return new Promise(resolve => {
                const req = new XMLHttpRequest();
                req.onerror = () => resolve({}); // ignore 404's
                req.onload = () => {
                    const r = new FileReader();
                    r.onerror = () => resolve({});
                    r.onloadend = () => {
                        const result = r.result;
                        if (result.startsWith('data:image')) {
                            const map = {};
                            map[image.url] = result;
                            resolve(map);
                        }
                        else {
                            resolve({});
                        }
                    };
                    r.readAsDataURL(req.response);
                };
                req.open('GET', image.url);
                req.responseType = 'blob';
                req.send();
            });
    }
    return new Promise(resolve => resolve({}));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZC1yZXBvcnQtaW1hZ2VzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvcmVwb3J0cy9yZXBvcnQtdG8tcGRmL2xvYWQtcmVwb3J0LWltYWdlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7QUFNSCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sa0NBQWtDLENBQUM7QUFHL0QsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBVTdDLE1BQU0sVUFBVSxnQkFBZ0IsQ0FBQyxNQUF5QjtJQUN4RCxNQUFNLFFBQVEsR0FBd0IsRUFBRSxDQUFDO0lBQ3pDLElBQUksTUFBTSxDQUFDLE1BQU0sSUFBSSxJQUFJLEVBQUU7UUFDekIsUUFBUSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztLQUNuRDtJQUNELElBQUksTUFBTSxDQUFDLE9BQU8sSUFBSSxJQUFJLEVBQUU7UUFDMUIsUUFBUSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztLQUNwRDtJQUNELElBQUksTUFBTSxDQUFDLE1BQU0sSUFBSSxJQUFJLEVBQUU7UUFDekIsUUFBUSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztLQUNuRDtJQUNELE9BQU8sSUFBSSxPQUFPLENBQVcsT0FBTyxDQUFDLEVBQUU7UUFDckMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDaEMsSUFBSSxHQUFHLEdBQWEsRUFBRSxDQUFDO1lBQ3ZCLEtBQUssTUFBTSxDQUFDLElBQUksSUFBSSxFQUFFO2dCQUNwQixHQUFHLEdBQUcsRUFBQyxHQUFHLEdBQUcs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QUFDdkQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoQykgR251Y29vcCBzb2MuIGNvb3AuXG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3JcbiAqIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhc1xuICogcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsXG4gKiBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VIEFmZmVyb1xuICogR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogYWxvbmcgd2l0aCBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICogSWYgbm90LCBzZWUgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLy5cbiAqXG4gKi9cblxuaW1wb3J0IHtBamZJbWFnZVdpZGdldEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvaW1hZ2Utd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmUmVwb3J0Q29udGFpbmVySW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS9yZXBvcnRzLWluc3RhbmNlcy9yZXBvcnQtY29udGFpbmVyLWluc3RhbmNlJztcbmltcG9ydCB7QWpmUmVwb3J0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS9yZXBvcnRzLWluc3RhbmNlcy9yZXBvcnQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL3dpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZldpZGdldFR5cGV9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzL3dpZGdldC10eXBlJztcbmltcG9ydCB7QWpmV2lkZ2V0V2l0aENvbnRlbnRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL3dpZGdldC13aXRoLWNvbnRlbnQtaW5zdGFuY2UnO1xuXG5pbXBvcnQge0FqZkltYWdlVHlwZX0gZnJvbSAnQGFqZi9jb3JlL2ltYWdlJztcblxuLy8gSW1hZ2VNYXAgbWFwcyBpbWFnZSB1cmxzIHRvIGRhdGF1cmxzLCBsaWtlOlxuLy8gJ2h0dHA6Ly93aGF0ZXZlci5jb20vaW1hZ2UucG5nJzogJ2RhdGE6aW1hZ2UvcG5nO2Jhc2U2NCwuLi4nXG4vLyBJdCBjYW4gYWxzbyBiZSB1c2VkIGZvciBpY29ucywgbGlrZTpcbi8vICc8c3BhbiBjbGFzcz1cIm1hdGVyaWFsLWljb25zXCI+cmFkaW9fYnV0dG9uX2NoZWNrZWQ8L3NwYW4+JzogJ1gnXG5leHBvcnQgaW50ZXJmYWNlIEltYWdlTWFwIHtcbiAgW3VybDogc3RyaW5nXTogc3RyaW5nO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbG9hZFJlcG9ydEltYWdlcyhyZXBvcnQ6IEFqZlJlcG9ydEluc3RhbmNlKTogUHJvbWlzZTxJbWFnZU1hcD4ge1xuICBjb25zdCBwcm9taXNlczogUHJvbWlzZTxJbWFnZU1hcD5bXSA9IFtdO1xuICBpZiAocmVwb3J0LmhlYWRlciAhPSBudWxsKSB7XG4gICAgcHJvbWlzZXMucHVzaChsb2FkQ29udGFpbmVySW1hZ2VzKHJlcG9ydC5oZWFkZXIpKTtcbiAgfVxuICBpZiAocmVwb3J0LmNvbnRlbnQgIT0gbnVsbCkge1xuICAgIHByb21pc2VzLnB1c2gobG9hZENvbnRhaW5lckltYWdlcyhyZXBvcnQuY29udGVudCkpO1xuICB9XG4gIGlmIChyZXBvcnQuZm9vdGVyICE9IG51bGwpIHtcbiAgICBwcm9taXNlcy5wdXNoKGxvYWRDb250YWluZXJJbWFnZXMocmVwb3J0LmZvb3RlcikpO1xuICB9XG4gIHJldHVybiBuZXcgUHJvbWlzZTxJbWFnZU1hcD4ocmVzb2x2ZSA9PiB7XG4gICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4obWFwcyA9PiB7XG4gICAgICBsZXQgbWFwOiBJbWFnZU1hcCA9IHt9O1xuICAgICAgZm9yIChjb25zdCBtIG9mIG1hcHMpIHtcbiAgICAgICAgbWFwID0gey4uLm1hcCwgLi4ubX07XG4gICAgICB9XG4gICAgICByZXNvbHZlKG1hcCk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBsb2FkQ29udGFpbmVySW1hZ2VzKFxuICBjb250YWluZXI6IEFqZlJlcG9ydENvbnRhaW5lckluc3RhbmNlIHwgQWpmV2lkZ2V0V2l0aENvbnRlbnRJbnN0YW5jZSxcbik6IFByb21pc2U8SW1hZ2VNYXA+IHtcbiAgY29uc3QgcHJvbWlzZXM6IFByb21pc2U8SW1hZ2VNYXA+W10gPSBbXTtcbiAgZm9yIChsZXQgd2lkZ2V0IG9mIGNvbnRhaW5lci5jb250ZW50KSB7XG4gICAgcHJvbWlzZXMucHVzaChsb2FkV2lkZ2V0SW1hZ2VzKHdpZGdldCkpO1xuICB9XG4gIHJldHVybiBuZXcgUHJvbWlzZTxJbWFnZU1hcD4ocmVzb2x2ZSA9PiB7XG4gICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4obWFwcyA9PiB7XG4gICAgICBsZXQgbWFwOiBJbWFnZU1hcCA9IHt9O1xuICAgICAgZm9yIChjb25zdCBtIG9mIG1hcHMpIHtcbiAgICAgICAgbWFwID0gey4uLm1hcCwgLi4ubX07XG4gICAgICB9XG4gICAgICByZXNvbHZlKG1hcCk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBsb2FkV2lkZ2V0SW1hZ2VzKHdpZGdldDogQWpmV2lkZ2V0SW5zdGFuY2UpOiBQcm9taXNlPEltYWdlTWFwPiB7XG4gIHN3aXRjaCAod2lkZ2V0LndpZGdldFR5cGUpIHtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuTGF5b3V0OlxuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5Db2x1bW46XG4gICAgICByZXR1cm4gbG9hZENvbnRhaW5lckltYWdlcyh3aWRnZXQgYXMgQWpmV2lkZ2V0V2l0aENvbnRlbnRJbnN0YW5jZSk7XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLkltYWdlOlxuICAgICAgY29uc3QgaW1hZ2UgPSB3aWRnZXQgYXMgQWpmSW1hZ2VXaWRnZXRJbnN0YW5jZTtcbiAgICAgIGlmIChpbWFnZS53aWRnZXQuaW1hZ2VUeXBlICE9PSBBamZJbWFnZVR5cGUuSW1hZ2UpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICByZXR1cm4gbmV3IFByb21pc2U8SW1hZ2VNYXA+KHJlc29sdmUgPT4ge1xuICAgICAgICBjb25zdCByZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgICAgcmVxLm9uZXJyb3IgPSAoKSA9PiByZXNvbHZlKHt9KTsgLy8gaWdub3JlIDQwNCdzXG4gICAgICAgIHJlcS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgICAgci5vbmVycm9yID0gKCkgPT4gcmVzb2x2ZSh7fSk7XG4gICAgICAgICAgci5vbmxvYWRlbmQgPSAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSByLnJlc3VsdCBhcyBzdHJpbmc7XG4gICAgICAgICAgICBpZiAocmVzdWx0LnN0YXJ0c1dpdGgoJ2RhdGE6aW1hZ2UnKSkge1xuICAgICAgICAgICAgICBjb25zdCBtYXA6IEltYWdlTWFwID0ge307XG4gICAgICAgICAgICAgIG1hcFtpbWFnZS51cmxdID0gcmVzdWx0O1xuICAgICAgICAgICAgICByZXNvbHZlKG1hcCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXNvbHZlKHt9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9O1xuICAgICAgICAgIHIucmVhZEFzRGF0YVVSTChyZXEucmVzcG9uc2UpO1xuICAgICAgICB9O1xuICAgICAgICByZXEub3BlbignR0VUJywgaW1hZ2UudXJsKTtcbiAgICAgICAgcmVxLnJlc3BvbnNlVHlwZSA9ICdibG9iJztcbiAgICAgICAgcmVxLnNlbmQoKTtcbiAgICAgIH0pO1xuICB9XG4gIHJldHVybiBuZXcgUHJvbWlzZTxJbWFnZU1hcD4ocmVzb2x2ZSA9PiByZXNvbHZlKHt9KSk7XG59XG4iXX0=