/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { AjfImageType } from '@ajf/core/image';
import { deepCopy } from '@ajf/core/utils';
import { vfsFonts, vfsFontsMap } from '@ajf/core/vfs-fonts';
import * as pdfMakeModule from 'pdfmake/build/pdfmake';
import { AjfWidgetType } from '../interface/widgets/widget-type';
import { loadReportImages } from './load-report-images';
const { createPdf } = (pdfMakeModule.default || pdfMakeModule);
const pageWidth = 800;
const pageHeight = pageWidth * 1.4142; // A4 proportions
const pageMargins = [40, 60];
export function openReportPdf(report, orientation = 'portrait', icons = {}) {
    createReportPdf(report, orientation, icons).then(pdf => {
        pdf.open();
    });
}
export function createReportPdf(report, orientation = 'portrait', icons = {}) {
    return new Promise(resolve => {
        loadReportImages(report).then(images => {
            let width = pageWidth - pageMargins[0] * 2;
            if (orientation === 'landscape') {
                width = pageHeight - pageMargins[1] * 2;
            }
            const pdfDef = reportToPdf(report, { ...images, ...icons }, width);
            pdfDef.pageSize = { width: pageWidth, height: pageHeight };
            pdfDef.pageMargins = pageMargins;
            pdfDef.pageOrientation = orientation;
            resolve(createPdf(pdfDef, undefined, vfsFontsMap, vfsFonts));
        });
    });
}
function reportToPdf(report, images, width) {
    const stack = [];
    if (report.header != null) {
        stack.push(containerToPdf(report.header, images, width));
    }
    if (report.content != null) {
        stack.push(containerToPdf(report.content, images, width));
    }
    if (report.footer != null) {
        stack.push(containerToPdf(report.footer, images, width));
    }
    return { content: { stack } };
}
function containerToPdf(container, images, width) {
    return { stack: container.content.map(w => widgetToPdf(w, images, width)) };
}
const marginBetweenWidgets = 10;
function widgetToPdf(widget, images, width) {
    switch (widget.widget.widgetType) {
        case AjfWidgetType.Layout:
            return layoutToPdf(widget, images, width);
        case AjfWidgetType.PageBreak:
            return { text: '', pageBreak: 'after' };
        case AjfWidgetType.Image:
            return imageToPdf(widget, images, width);
        case AjfWidgetType.Text:
            return textToPdf(widget, images);
        case AjfWidgetType.Chart:
            const chart = widget;
            const dataUrl = chart.canvasDataUrl == null ? '' : chart.canvasDataUrl();
            if (dataUrl === '') {
                return { text: '[chart with no attached canvas]' };
            }
            return { image: dataUrl, width, margin: [0, 0, 0, marginBetweenWidgets] };
        case AjfWidgetType.Table:
        case AjfWidgetType.DynamicTable:
            return tableToPdf(widget, images);
        case AjfWidgetType.Column:
            const cw = widget;
            return { stack: cw.content.map(w => widgetToPdf(w, images, width)) };
        case AjfWidgetType.Formula:
            const fw = widget;
            return { text: fw.formula, margin: [0, 0, 0, marginBetweenWidgets] };
        default:
            return { text: '' };
    }
}
function layoutToPdf(lw, images, width) {
    const columns = [...lw.widget.columns];
    while (columns.length < lw.content.length) {
        columns.push(1);
    }
    const childWidth = width / (columns.length || 1);
    const children = [];
    for (let i = 0; i < lw.content.length; i++) {
        let child = widgetToPdf(lw.content[i], images, childWidth);
        // Children of Layout widgets are supposed to be Columns. If they aren't,
        // we must wrap them to avoid problems like images having an 'auto' width.
        if (child.stack == null) {
            child = { stack: [child] };
        }
        child.width = columns[i] === -1 ? 'auto' : '*';
        children.push(child);
    }
    return { columns: children };
}
function imageToPdf(image, images, width) {
    if (image.widget.imageType !== AjfImageType.Image) {
        // Can't get icons to work, pdfs with multiple fonts don't seem to be working
        return { text: '' };
    }
    const dataUrl = images[image.url];
    if (dataUrl == null) {
        return { text: '' };
    }
    const w = image.styles.width;
    if (typeof w === 'string' && w.endsWith('px')) {
        width = Number(w.slice(0, -2));
    }
    return { image: dataUrl, width, margin: [0, 0, 0, marginBetweenWidgets] };
}
function htmlTextToPdfText(htmlText, images) {
    const iconText = images[htmlText];
    if (typeof iconText === 'string') {
        return iconText;
    }
    return stripHTML(htmlText);
}
function textToPdf(tw, images) {
    const text = {
        text: htmlTextToPdfText(tw.htmlText, images),
        margin: [0, 0, 0, marginBetweenWidgets],
    };
    if (tw.htmlText.startsWith('<h1>')) {
        text.fontSize = 20;
        text.margin = [0, 10, 0, marginBetweenWidgets];
    }
    else if (tw.htmlText.startsWith('<h2>')) {
        text.fontSize = 15;
        text.margin = [0, 5, 0, marginBetweenWidgets];
    }
    return text;
}
function tableToPdf(table, images) {
    if (table.data == null || table.data.length === 0) {
        return { text: '' };
    }
    const body = [];
    for (const dataRow of expandColAndRowSpan(table.data)) {
        const bodyRow = [];
        for (const cell of dataRow) {
            let text = '';
            switch (typeof cell.value) {
                case 'number':
                    text = String(cell.value);
                    break;
                case 'string':
                    text = htmlTextToPdfText(cell.value, images);
                    break;
                case 'object':
                    let val = cell.value.changingThisBreaksApplicationSecurity;
                    if (typeof val === 'number') {
                        val = String(val);
                    }
                    text = htmlTextToPdfText(val || '', images);
                    break;
            }
            bodyRow.push({ text, colSpan: cell.colspan, rowSpan: cell.rowspan });
        }
        body.push(bodyRow);
    }
    return { table: { headerRows: 0, body }, margin: [0, 0, 0, marginBetweenWidgets] };
}
// pdfmake wants placeholder cells after cells with col/rowspan > 1
function expandColAndRowSpan(data) {
    data = deepCopy(data);
    // expand colspan:
    for (const row of data) {
        for (let j = 0; j < row.length; j++) {
            const cell = row[j];
            for (let k = 1; k < (cell.colspan || 1); k++) {
                row.splice(j + k, 0, { rowspan: cell.rowspan, value: '', style: {} });
            }
        }
    }
    // expand rowspan:
    for (let i = 0; i < data.length; i++) {
        const row = data[i];
        for (let j = 0; j < row.length; j++) {
            const cell = row[j];
            for (let k = 1; k < (cell.rowspan || 1); k++) {
                data[i + k].splice(j, 0, { value: '', style: {} });
            }
        }
    }
    return data;
}
function stripHTML(s) {
    return s.replace(/<\/?[^>]+(>|$)/g, '');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3J0LXRvLXBkZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3JlcG9ydHMvcmVwb3J0LXRvLXBkZi9yZXBvcnQtdG8tcGRmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUVILE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUU3QyxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUMxRCxPQUFPLEtBQUssYUFBYSxNQUFNLHVCQUF1QixDQUFDO0FBc0J2RCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sa0NBQWtDLENBQUM7QUFFL0QsT0FBTyxFQUFXLGdCQUFnQixFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFFaEUsTUFBTSxFQUFDLFNBQVMsRUFBQyxHQUFHLENBQUUsYUFBcUIsQ0FBQyxPQUFPLElBQUksYUFBYSxDQUF5QixDQUFDO0FBRTlGLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQztBQUN0QixNQUFNLFVBQVUsR0FBRyxTQUFTLEdBQUcsTUFBTSxDQUFDLENBQUMsaUJBQWlCO0FBQ3hELE1BQU0sV0FBVyxHQUFxQixDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUUvQyxNQUFNLFVBQVUsYUFBYSxDQUMzQixNQUF5QixFQUN6QixjQUErQixVQUFVLEVBQ3pDLFFBQWtCLEVBQUU7SUFFcEIsZUFBZSxDQUFDLE1BQU0sRUFBRSxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1FBQ3JELEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNiLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELE1BQU0sVUFBVSxlQUFlLENBQzdCLE1BQXlC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LENBQUM7QUFDMUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoQykgR251Y29vcCBzb2MuIGNvb3AuXG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3JcbiAqIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhc1xuICogcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsXG4gKiBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VIEFmZmVyb1xuICogR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogYWxvbmcgd2l0aCBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICogSWYgbm90LCBzZWUgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLy5cbiAqXG4gKi9cblxuaW1wb3J0IHtBamZJbWFnZVR5cGV9IGZyb20gJ0BhamYvY29yZS9pbWFnZSc7XG5pbXBvcnQge0FqZlRhYmxlQ2VsbH0gZnJvbSAnQGFqZi9jb3JlL3RhYmxlJztcbmltcG9ydCB7ZGVlcENvcHl9IGZyb20gJ0BhamYvY29yZS91dGlscyc7XG5pbXBvcnQge3Zmc0ZvbnRzLCB2ZnNGb250c01hcH0gZnJvbSAnQGFqZi9jb3JlL3Zmcy1mb250cyc7XG5pbXBvcnQgKiBhcyBwZGZNYWtlTW9kdWxlIGZyb20gJ3BkZm1ha2UvYnVpbGQvcGRmbWFrZSc7XG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZHVwbGljYXRlLWltcG9ydHNcbmltcG9ydCB7VENyZWF0ZWRQZGZ9IGZyb20gJ3BkZm1ha2UvYnVpbGQvcGRmbWFrZSc7XG5pbXBvcnQge1xuICBDb2x1bW4sXG4gIENvbnRlbnQsXG4gIENvbnRlbnRTdGFjayxcbiAgUGFnZU9yaWVudGF0aW9uLFxuICBUYWJsZUNlbGwsXG4gIFREb2N1bWVudERlZmluaXRpb25zLFxufSBmcm9tICdwZGZtYWtlL2ludGVyZmFjZXMnO1xuXG5pbXBvcnQge0FqZlJlcG9ydENvbnRhaW5lckluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2UvcmVwb3J0cy1pbnN0YW5jZXMvcmVwb3J0LWNvbnRhaW5lci1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZlJlcG9ydEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2UvcmVwb3J0cy1pbnN0YW5jZXMvcmVwb3J0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmQ2hhcnRXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL2NoYXJ0LXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZkNvbHVtbldpZGdldEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvY29sdW1uLXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZkZvcm11bGFXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL2Zvcm11bGEtd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmSW1hZ2VXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL2ltYWdlLXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZkxheW91dFdpZGdldEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvbGF5b3V0LXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZlRhYmxlV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy90YWJsZS13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZUZXh0V2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy90ZXh0LXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZldpZGdldEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmV2lkZ2V0VHlwZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMvd2lkZ2V0LXR5cGUnO1xuXG5pbXBvcnQge0ltYWdlTWFwLCBsb2FkUmVwb3J0SW1hZ2VzfSBmcm9tICcuL2xvYWQtcmVwb3J0LWltYWdlcyc7XG5cbmNvbnN0IHtjcmVhdGVQZGZ9ID0gKChwZGZNYWtlTW9kdWxlIGFzIGFueSkuZGVmYXVsdCB8fCBwZGZNYWtlTW9kdWxlKSBhcyB0eXBlb2YgcGRmTWFrZU1vZHVsZTtcblxuY29uc3QgcGFnZVdpZHRoID0gODAwO1xuY29uc3QgcGFnZUhlaWdodCA9IHBhZ2VXaWR0aCAqIDEuNDE0MjsgLy8gQTQgcHJvcG9ydGlvbnNcbmNvbnN0IHBhZ2VNYXJnaW5zOiBbbnVtYmVyLCBudW1iZXJdID0gWzQwLCA2MF07XG5cbmV4cG9ydCBmdW5jdGlvbiBvcGVuUmVwb3J0UGRmKFxuICByZXBvcnQ6IEFqZlJlcG9ydEluc3RhbmNlLFxuICBvcmllbnRhdGlvbjogUGFnZU9yaWVudGF0aW9uID0gJ3BvcnRyYWl0JyxcbiAgaWNvbnM6IEltYWdlTWFwID0ge30sXG4pIHtcbiAgY3JlYXRlUmVwb3J0UGRmKHJlcG9ydCwgb3JpZW50YXRpb24sIGljb25zKS50aGVuKHBkZiA9PiB7XG4gICAgcGRmLm9wZW4oKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVSZXBvcnRQZGYoXG4gIHJlcG9ydDogQWpmUmVwb3J0SW5zdGFuY2UsXG4gIG9yaWVudGF0aW9uOiBQYWdlT3JpZW50YXRpb24gPSAncG9ydHJhaXQnLFxuICBpY29uczogSW1hZ2VNYXAgPSB7fSxcbik6IFByb21pc2U8VENyZWF0ZWRQZGY+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPFRDcmVhdGVkUGRmPihyZXNvbHZlID0+IHtcbiAgICBsb2FkUmVwb3J0SW1hZ2VzKHJlcG9ydCkudGhlbihpbWFnZXMgPT4ge1xuICAgICAgbGV0IHdpZHRoID0gcGFnZVdpZHRoIC0gcGFnZU1hcmdpbnNbMF0gKiAyO1xuICAgICAgaWYgKG9yaWVudGF0aW9uID09PSAnbGFuZHNjYXBlJykge1xuICAgICAgICB3aWR0aCA9IHBhZ2VIZWlnaHQgLSBwYWdlTWFyZ2luc1sxXSAqIDI7XG4gICAgICB9XG4gICAgICBjb25zdCBwZGZEZWYgPSByZXBvcnRUb1BkZihyZXBvcnQsIHsuLi5pbWFnZXMsIC4uLmljb25zfSwgd2lkdGgpO1xuICAgICAgcGRmRGVmLnBhZ2VTaXplID0ge3dpZHRoOiBwYWdlV2lkdGgsIGhlaWdodDogcGFnZUhlaWdodH07XG4gICAgICBwZGZEZWYucGFnZU1hcmdpbnMgPSBwYWdlTWFyZ2lucztcbiAgICAgIHBkZkRlZi5wYWdlT3JpZW50YXRpb24gPSBvcmllbnRhdGlvbjtcbiAgICAgIHJlc29sdmUoY3JlYXRlUGRmKHBkZkRlZiwgdW5kZWZpbmVkLCB2ZnNGb250c01hcCwgdmZzRm9udHMpKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlcG9ydFRvUGRmKFxuICByZXBvcnQ6IEFqZlJlcG9ydEluc3RhbmNlLFxuICBpbWFnZXM6IEltYWdlTWFwLFxuICB3aWR0aDogbnVtYmVyLFxuKTogVERvY3VtZW50RGVmaW5pdGlvbnMge1xuICBjb25zdCBzdGFjazogQ29udGVudFtdID0gW107XG4gIGlmIChyZXBvcnQuaGVhZGVyICE9IG51bGwpIHtcbiAgICBzdGFjay5wdXNoKGNvbnRhaW5lclRvUGRmKHJlcG9ydC5oZWFkZXIsIGltYWdlcywgd2lkdGgpKTtcbiAgfVxuICBpZiAocmVwb3J0LmNvbnRlbnQgIT0gbnVsbCkge1xuICAgIHN0YWNrLnB1c2goY29udGFpbmVyVG9QZGYocmVwb3J0LmNvbnRlbnQsIGltYWdlcywgd2lkdGgpKTtcbiAgfVxuICBpZiAocmVwb3J0LmZvb3RlciAhPSBudWxsKSB7XG4gICAgc3RhY2sucHVzaChjb250YWluZXJUb1BkZihyZXBvcnQuZm9vdGVyLCBpbWFnZXMsIHdpZHRoKSk7XG4gIH1cbiAgcmV0dXJuIHtjb250ZW50OiB7c3RhY2t9fTtcbn1cblxuZnVuY3Rpb24gY29udGFpbmVyVG9QZGYoXG4gIGNvbnRhaW5lcjogQWpmUmVwb3J0Q29udGFpbmVySW5zdGFuY2UsXG4gIGltYWdlczogSW1hZ2VNYXAsXG4gIHdpZHRoOiBudW1iZXIsXG4pOiBDb250ZW50IHtcbiAgcmV0dXJuIHtzdGFjazogY29udGFpbmVyLmNvbnRlbnQubWFwKHcgPT4gd2lkZ2V0VG9QZGYodywgaW1hZ2VzLCB3aWR0aCkpfTtcbn1cblxuY29uc3QgbWFyZ2luQmV0d2VlbldpZGdldHMgPSAxMDtcblxuZnVuY3Rpb24gd2lkZ2V0VG9QZGYod2lkZ2V0OiBBamZXaWRnZXRJbnN0YW5jZSwgaW1hZ2VzOiBJbWFnZU1hcCwgd2lkdGg6IG51bWJlcik6IENvbnRlbnQge1xuICBzd2l0Y2ggKHdpZGdldC53aWRnZXQud2lkZ2V0VHlwZSkge1xuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5MYXlvdXQ6XG4gICAgICByZXR1cm4gbGF5b3V0VG9QZGYod2lkZ2V0IGFzIEFqZkxheW91dFdpZGdldEluc3RhbmNlLCBpbWFnZXMsIHdpZHRoKTtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuUGFnZUJyZWFrOlxuICAgICAgcmV0dXJuIHt0ZXh0OiAnJywgcGFnZUJyZWFrOiAnYWZ0ZXInfTtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuSW1hZ2U6XG4gICAgICByZXR1cm4gaW1hZ2VUb1BkZih3aWRnZXQgYXMgQWpmSW1hZ2VXaWRnZXRJbnN0YW5jZSwgaW1hZ2VzLCB3aWR0aCk7XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLlRleHQ6XG4gICAgICByZXR1cm4gdGV4dFRvUGRmKHdpZGdldCBhcyBBamZUZXh0V2lkZ2V0SW5zdGFuY2UsIGltYWdlcyk7XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLkNoYXJ0OlxuICAgICAgY29uc3QgY2hhcnQgPSB3aWRnZXQgYXMgQWpmQ2hhcnRXaWRnZXRJbnN0YW5jZTtcbiAgICAgIGNvbnN0IGRhdGFVcmwgPSBjaGFydC5jYW52YXNEYXRhVXJsID09IG51bGwgPyAnJyA6IGNoYXJ0LmNhbnZhc0RhdGFVcmwoKTtcbiAgICAgIGlmIChkYXRhVXJsID09PSAnJykge1xuICAgICAgICByZXR1cm4ge3RleHQ6ICdbY2hhcnQgd2l0aCBubyBhdHRhY2hlZCBjYW52YXNdJ307XG4gICAgICB9XG4gICAgICByZXR1cm4ge2ltYWdlOiBkYXRhVXJsLCB3aWR0aCwgbWFyZ2luOiBbMCwgMCwgMCwgbWFyZ2luQmV0d2VlbldpZGdldHNdfTtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuVGFibGU6XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLkR5bmFtaWNUYWJsZTpcbiAgICAgIHJldHVybiB0YWJsZVRvUGRmKHdpZGdldCBhcyBBamZUYWJsZVdpZGdldEluc3RhbmNlLCBpbWFnZXMpO1xuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5Db2x1bW46XG4gICAgICBjb25zdCBjdyA9IHdpZGdldCBhcyBBamZDb2x1bW5XaWRnZXRJbnN0YW5jZTtcbiAgICAgIHJldHVybiB7c3RhY2s6IGN3LmNvbnRlbnQubWFwKHcgPT4gd2lkZ2V0VG9QZGYodywgaW1hZ2VzLCB3aWR0aCkpfTtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuRm9ybXVsYTpcbiAgICAgIGNvbnN0IGZ3ID0gd2lkZ2V0IGFzIEFqZkZvcm11bGFXaWRnZXRJbnN0YW5jZTtcbiAgICAgIHJldHVybiB7dGV4dDogZncuZm9ybXVsYSwgbWFyZ2luOiBbMCwgMCwgMCwgbWFyZ2luQmV0d2VlbldpZGdldHNdfTtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIHt0ZXh0OiAnJ307XG4gIH1cbn1cblxuZnVuY3Rpb24gbGF5b3V0VG9QZGYobHc6IEFqZkxheW91dFdpZGdldEluc3RhbmNlLCBpbWFnZXM6IEltYWdlTWFwLCB3aWR0aDogbnVtYmVyKTogQ29udGVudCB7XG4gIGNvbnN0IGNvbHVtbnMgPSBbLi4ubHcud2lkZ2V0LmNvbHVtbnNdO1xuICB3aGlsZSAoY29sdW1ucy5sZW5ndGggPCBsdy5jb250ZW50Lmxlbmd0aCkge1xuICAgIGNvbHVtbnMucHVzaCgxKTtcbiAgfVxuICBjb25zdCBjaGlsZFdpZHRoID0gd2lkdGggLyAoY29sdW1ucy5sZW5ndGggfHwgMSk7XG4gIGNvbnN0IGNoaWxkcmVuID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbHcuY29udGVudC5sZW5ndGg7IGkrKykge1xuICAgIGxldCBjaGlsZCA9IHdpZGdldFRvUGRmKGx3LmNvbnRlbnRbaV0sIGltYWdlcywgY2hpbGRXaWR0aCkgYXMgQ29udGVudFN0YWNrO1xuICAgIC8vIENoaWxkcmVuIG9mIExheW91dCB3aWRnZXRzIGFyZSBzdXBwb3NlZCB0byBiZSBDb2x1bW5zLiBJZiB0aGV5IGFyZW4ndCxcbiAgICAvLyB3ZSBtdXN0IHdyYXAgdGhlbSB0byBhdm9pZCBwcm9ibGVtcyBsaWtlIGltYWdlcyBoYXZpbmcgYW4gJ2F1dG8nIHdpZHRoLlxuICAgIGlmIChjaGlsZC5zdGFjayA9PSBudWxsKSB7XG4gICAgICBjaGlsZCA9IHtzdGFjazogW2NoaWxkXX07XG4gICAgfVxuICAgIChjaGlsZCBhcyBDb2x1bW4pLndpZHRoID0gY29sdW1uc1tpXSA9PT0gLTEgPyAnYXV0bycgOiAnKic7XG4gICAgY2hpbGRyZW4ucHVzaChjaGlsZCk7XG4gIH1cbiAgcmV0dXJuIHtjb2x1bW5zOiBjaGlsZHJlbn07XG59XG5cbmZ1bmN0aW9uIGltYWdlVG9QZGYoaW1hZ2U6IEFqZkltYWdlV2lkZ2V0SW5zdGFuY2UsIGltYWdlczogSW1hZ2VNYXAsIHdpZHRoOiBudW1iZXIpOiBDb250ZW50IHtcbiAgaWYgKGltYWdlLndpZGdldC5pbWFnZVR5cGUgIT09IEFqZkltYWdlVHlwZS5JbWFnZSkge1xuICAgIC8vIENhbid0IGdldCBpY29ucyB0byB3b3JrLCBwZGZzIHdpdGggbXVsdGlwbGUgZm9udHMgZG9uJ3Qgc2VlbSB0byBiZSB3b3JraW5nXG4gICAgcmV0dXJuIHt0ZXh0OiAnJ307XG4gIH1cbiAgY29uc3QgZGF0YVVybCA9IGltYWdlc1tpbWFnZS51cmxdO1xuICBpZiAoZGF0YVVybCA9PSBudWxsKSB7XG4gICAgcmV0dXJuIHt0ZXh0OiAnJ307XG4gIH1cbiAgY29uc3QgdyA9IGltYWdlLnN0eWxlcy53aWR0aDtcbiAgaWYgKHR5cGVvZiB3ID09PSAnc3RyaW5nJyAmJiB3LmVuZHNXaXRoKCdweCcpKSB7XG4gICAgd2lkdGggPSBOdW1iZXIody5zbGljZSgwLCAtMikpO1xuICB9XG4gIHJldHVybiB7aW1hZ2U6IGRhdGFVcmwsIHdpZHRoLCBtYXJnaW46IFswLCAwLCAwLCBtYXJnaW5CZXR3ZWVuV2lkZ2V0c119O1xufVxuXG5mdW5jdGlvbiBodG1sVGV4dFRvUGRmVGV4dChodG1sVGV4dDogc3RyaW5nLCBpbWFnZXM6IEltYWdlTWFwKTogc3RyaW5nIHtcbiAgY29uc3QgaWNvblRleHQgPSBpbWFnZXNbaHRtbFRleHRdO1xuICBpZiAodHlwZW9mIGljb25UZXh0ID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBpY29uVGV4dDtcbiAgfVxuICByZXR1cm4gc3RyaXBIVE1MKGh0bWxUZXh0KTtcbn1cblxuZnVuY3Rpb24gdGV4dFRvUGRmKHR3OiBBamZUZXh0V2lkZ2V0SW5zdGFuY2UsIGltYWdlczogSW1hZ2VNYXApOiBDb250ZW50IHtcbiAgY29uc3QgdGV4dDogQ29udGVudCA9IHtcbiAgICB0ZXh0OiBodG1sVGV4dFRvUGRmVGV4dCh0dy5odG1sVGV4dCwgaW1hZ2VzKSxcbiAgICBtYXJnaW46IFswLCAwLCAwLCBtYXJnaW5CZXR3ZWVuV2lkZ2V0c10sXG4gIH07XG4gIGlmICh0dy5odG1sVGV4dC5zdGFydHNXaXRoKCc8aDE+JykpIHtcbiAgICB0ZXh0LmZvbnRTaXplID0gMjA7XG4gICAgdGV4dC5tYXJnaW4gPSBbMCwgMTAsIDAsIG1hcmdpbkJldHdlZW5XaWRnZXRzXTtcbiAgfSBlbHNlIGlmICh0dy5odG1sVGV4dC5zdGFydHNXaXRoKCc8aDI+JykpIHtcbiAgICB0ZXh0LmZvbnRTaXplID0gMTU7XG4gICAgdGV4dC5tYXJnaW4gPSBbMCwgNSwgMCwgbWFyZ2luQmV0d2VlbldpZGdldHNdO1xuICB9XG4gIHJldHVybiB0ZXh0O1xufVxuXG5mdW5jdGlvbiB0YWJsZVRvUGRmKHRhYmxlOiBBamZUYWJsZVdpZGdldEluc3RhbmNlLCBpbWFnZXM6IEltYWdlTWFwKTogQ29udGVudCB7XG4gIGlmICh0YWJsZS5kYXRhID09IG51bGwgfHwgdGFibGUuZGF0YS5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4ge3RleHQ6ICcnfTtcbiAgfVxuICBjb25zdCBib2R5OiBUYWJsZUNlbGxbXVtdID0gW107XG4gIGZvciAoY29uc3QgZGF0YVJvdyBvZiBleHBhbmRDb2xBbmRSb3dTcGFuKHRhYmxlLmRhdGEpKSB7XG4gICAgY29uc3QgYm9keVJvdzogVGFibGVDZWxsW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IGNlbGwgb2YgZGF0YVJvdykge1xuICAgICAgbGV0IHRleHQgPSAnJztcbiAgICAgIHN3aXRjaCAodHlwZW9mIGNlbGwudmFsdWUpIHtcbiAgICAgICAgY2FzZSAnbnVtYmVyJzpcbiAgICAgICAgICB0ZXh0ID0gU3RyaW5nKGNlbGwudmFsdWUpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICAgIHRleHQgPSBodG1sVGV4dFRvUGRmVGV4dChjZWxsLnZhbHVlLCBpbWFnZXMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdvYmplY3QnOlxuICAgICAgICAgIGxldCB2YWwgPSBjZWxsLnZhbHVlLmNoYW5naW5nVGhpc0JyZWFrc0FwcGxpY2F0aW9uU2VjdXJpdHk7XG4gICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICB2YWwgPSBTdHJpbmcodmFsKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGV4dCA9IGh0bWxUZXh0VG9QZGZUZXh0KHZhbCB8fCAnJywgaW1hZ2VzKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGJvZHlSb3cucHVzaCh7dGV4dCwgY29sU3BhbjogY2VsbC5jb2xzcGFuLCByb3dTcGFuOiBjZWxsLnJvd3NwYW59KTtcbiAgICB9XG4gICAgYm9keS5wdXNoKGJvZHlSb3cpO1xuICB9XG4gIHJldHVybiB7dGFibGU6IHtoZWFkZXJSb3dzOiAwLCBib2R5fSwgbWFyZ2luOiBbMCwgMCwgMCwgbWFyZ2luQmV0d2VlbldpZGdldHNdfTtcbn1cblxuLy8gcGRmbWFrZSB3YW50cyBwbGFjZWhvbGRlciBjZWxscyBhZnRlciBjZWxscyB3aXRoIGNvbC9yb3dzcGFuID4gMVxuZnVuY3Rpb24gZXhwYW5kQ29sQW5kUm93U3BhbihkYXRhOiBBamZUYWJsZUNlbGxbXVtdKTogQWpmVGFibGVDZWxsW11bXSB7XG4gIGRhdGEgPSBkZWVwQ29weShkYXRhKTtcbiAgLy8gZXhwYW5kIGNvbHNwYW46XG4gIGZvciAoY29uc3Qgcm93IG9mIGRhdGEpIHtcbiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJvdy5sZW5ndGg7IGorKykge1xuICAgICAgY29uc3QgY2VsbCA9IHJvd1tqXTtcbiAgICAgIGZvciAobGV0IGsgPSAxOyBrIDwgKGNlbGwuY29sc3BhbiB8fCAxKTsgaysrKSB7XG4gICAgICAgIHJvdy5zcGxpY2UoaiArIGssIDAsIHtyb3dzcGFuOiBjZWxsLnJvd3NwYW4sIHZhbHVlOiAnJywgc3R5bGU6IHt9fSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIC8vIGV4cGFuZCByb3dzcGFuOlxuICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCByb3cgPSBkYXRhW2ldO1xuICAgIGZvciAobGV0IGogPSAwOyBqIDwgcm93Lmxlbmd0aDsgaisrKSB7XG4gICAgICBjb25zdCBjZWxsID0gcm93W2pdO1xuICAgICAgZm9yIChsZXQgayA9IDE7IGsgPCAoY2VsbC5yb3dzcGFuIHx8IDEpOyBrKyspIHtcbiAgICAgICAgZGF0YVtpICsga10uc3BsaWNlKGosIDAsIHt2YWx1ZTogJycsIHN0eWxlOiB7fX0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gc3RyaXBIVE1MKHM6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBzLnJlcGxhY2UoLzxcXC8/W14+XSsoPnwkKS9nLCAnJyk7XG59XG4iXX0=