/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { AjfImageType } from '@ajf/core/image';
import { deepCopy } from '@ajf/core/utils';
import { vfsFonts, vfsFontsMap } from '@ajf/core/vfs-fonts';
import { createPdf } from 'pdfmake/build/pdfmake';
import { AjfWidgetType } from '../interface/widgets/widget-type';
import { loadReportImages } from './load-report-images';
const pageWidth = 800;
const pageHeight = pageWidth * 1.4142; // A4 proportions
const pageMargins = [40, 60];
export function openReportPdf(report, orientation = 'portrait', icons = {}) {
    createReportPdf(report, orientation, icons).then(pdf => {
        pdf.open();
    });
}
export function createReportPdf(report, orientation = 'portrait', icons = {}) {
    return new Promise(resolve => {
        loadReportImages(report).then(images => {
            let width = pageWidth - pageMargins[0] * 2;
            if (orientation === 'landscape') {
                width = pageHeight - pageMargins[1] * 2;
            }
            const pdfDef = reportToPdf(report, { ...images, ...icons }, width);
            pdfDef.pageSize = { width: pageWidth, height: pageHeight };
            pdfDef.pageMargins = pageMargins;
            pdfDef.pageOrientation = orientation;
            resolve(createPdf(pdfDef, undefined, vfsFontsMap, vfsFonts));
        });
    });
}
function reportToPdf(report, images, width) {
    const stack = [];
    if (report.header != null) {
        stack.push(containerToPdf(report.header, images, width));
    }
    if (report.content != null) {
        stack.push(containerToPdf(report.content, images, width));
    }
    if (report.footer != null) {
        stack.push(containerToPdf(report.footer, images, width));
    }
    return { content: { stack } };
}
function containerToPdf(container, images, width) {
    return { stack: container.content.map(w => widgetToPdf(w, images, width)) };
}
const marginBetweenWidgets = 10;
function widgetToPdf(widget, images, width) {
    switch (widget.widget.widgetType) {
        case AjfWidgetType.Layout:
            return layoutToPdf(widget, images, width);
        case AjfWidgetType.PageBreak:
            return { text: '', pageBreak: 'after' };
        case AjfWidgetType.Image:
            return imageToPdf(widget, images, width);
        case AjfWidgetType.Text:
            return textToPdf(widget, images);
        case AjfWidgetType.Chart:
            const chart = widget;
            const dataUrl = chart.canvasDataUrl == null ? '' : chart.canvasDataUrl();
            if (dataUrl === '') {
                return { text: '[chart with no attached canvas]' };
            }
            return { image: dataUrl, width, margin: [0, 0, 0, marginBetweenWidgets] };
        case AjfWidgetType.Table:
        case AjfWidgetType.DynamicTable:
            return tableToPdf(widget, images);
        case AjfWidgetType.Column:
            const cw = widget;
            return { stack: cw.content.map(w => widgetToPdf(w, images, width)) };
        case AjfWidgetType.Formula:
            const fw = widget;
            return { text: fw.formula, margin: [0, 0, 0, marginBetweenWidgets] };
        default:
            return { text: '' };
    }
}
function layoutToPdf(lw, images, width) {
    const columns = [...lw.widget.columns];
    while (columns.length < lw.content.length) {
        columns.push(1);
    }
    const childWidth = width / (columns.length || 1);
    const children = [];
    for (let i = 0; i < lw.content.length; i++) {
        let child = widgetToPdf(lw.content[i], images, childWidth);
        // Children of Layout widgets are supposed to be Columns. If they aren't,
        // we must wrap them to avoid problems like images having an 'auto' width.
        if (child.stack == null) {
            child = { stack: [child] };
        }
        child.width = columns[i] === -1 ? 'auto' : '*';
        children.push(child);
    }
    return { columns: children };
}
function imageToPdf(image, images, width) {
    if (image.widget.imageType !== AjfImageType.Image) {
        // Can't get icons to work, pdfs with multiple fonts don't seem to be working
        return { text: '' };
    }
    const dataUrl = images[image.url];
    if (dataUrl == null) {
        return { text: '' };
    }
    const w = image.styles.width;
    if (typeof (w) === 'string' && w.endsWith('px')) {
        width = Number(w.slice(0, -2));
    }
    return { image: dataUrl, width, margin: [0, 0, 0, marginBetweenWidgets] };
}
function htmlTextToPdfText(htmlText, images) {
    const iconText = images[htmlText];
    if (typeof (iconText) === 'string') {
        return iconText;
    }
    return stripHTML(htmlText);
}
function textToPdf(tw, images) {
    const text = {
        text: htmlTextToPdfText(tw.htmlText, images),
        margin: [0, 0, 0, marginBetweenWidgets],
    };
    if (tw.htmlText.startsWith('<h1>')) {
        text.fontSize = 20;
        text.margin = [0, 10, 0, marginBetweenWidgets];
    }
    else if (tw.htmlText.startsWith('<h2>')) {
        text.fontSize = 15;
        text.margin = [0, 5, 0, marginBetweenWidgets];
    }
    return text;
}
function tableToPdf(table, images) {
    if (table.data == null || table.data.length === 0) {
        return { text: '' };
    }
    const body = [];
    for (const dataRow of expandColAndRowSpan(table.data)) {
        const bodyRow = [];
        for (const cell of dataRow) {
            let text = '';
            switch (typeof (cell.value)) {
                case 'number':
                    text = String(cell.value);
                    break;
                case 'string':
                    text = htmlTextToPdfText(cell.value, images);
                    break;
                case 'object':
                    let val = cell.value.changingThisBreaksApplicationSecurity;
                    if (typeof (val) === 'number') {
                        val = String(val);
                    }
                    text = htmlTextToPdfText(val || '', images);
                    break;
            }
            bodyRow.push({ text, colSpan: cell.colspan, rowSpan: cell.rowspan });
        }
        body.push(bodyRow);
    }
    return { table: { headerRows: 0, body }, margin: [0, 0, 0, marginBetweenWidgets] };
}
// pdfmake wants placeholder cells after cells with col/rowspan > 1
function expandColAndRowSpan(data) {
    data = deepCopy(data);
    // expand colspan:
    for (const row of data) {
        for (let j = 0; j < row.length; j++) {
            const cell = row[j];
            for (let k = 1; k < (cell.colspan || 1); k++) {
                row.splice(j + k, 0, { rowspan: cell.rowspan, value: '', style: {} });
            }
        }
    }
    // expand rowspan:
    for (let i = 0; i < data.length; i++) {
        const row = data[i];
        for (let j = 0; j < row.length; j++) {
            const cell = row[j];
            for (let k = 1; k < (cell.rowspan || 1); k++) {
                data[i + k].splice(j, 0, { value: '', style: {} });
            }
        }
    }
    return data;
}
function stripHTML(s) {
    return s.replace(/<\/?[^>]+(>|$)/g, '');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3J0LXRvLXBkZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3JlcG9ydHMvcmVwb3J0LXRvLXBkZi9yZXBvcnQtdG8tcGRmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUVILE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUU3QyxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUMxRCxPQUFPLEVBQUMsU0FBUyxFQUFjLE1BQU0sdUJBQXVCLENBQUM7QUFvQjdELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxrQ0FBa0MsQ0FBQztBQUUvRCxPQUFPLEVBQVcsZ0JBQWdCLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUVoRSxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUM7QUFDdEIsTUFBTSxVQUFVLEdBQUcsU0FBUyxHQUFHLE1BQU0sQ0FBQyxDQUFDLGlCQUFpQjtBQUN4RCxNQUFNLFdBQVcsR0FBcUIsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFFL0MsTUFBTSxVQUFVLGFBQWEsQ0FDM0IsTUFBeUIsRUFBRSxjQUErQixVQUFVLEVBQUUsUUFBa0IsRUFBRTtJQUUxRixlQUFlLENBQUMsTUFBTSxFQUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDckQsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2IsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsTUFBTSxVQUFVLGVBQWUsQ0FDM0IsTUFBeUIsRUFBRSxjQUErQixVQUFVLEVBQUUsUUFBa0IsRUFBRTtJQUc1RixPQUFPLElBQUksT0FBTyxDQUFjLE9BQU8sQ0FBQyxF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OlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChDKSBHbnVjb29wIHNvYy4gY29vcC5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vclxuICogbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzXG4gKiBwdWJsaXNoZWQgYnkgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSxcbiAqIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlUgQWZmZXJvXG4gKiBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKiBJZiBub3QsIHNlZSBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvLlxuICpcbiAqL1xuXG5pbXBvcnQge0FqZkltYWdlVHlwZX0gZnJvbSAnQGFqZi9jb3JlL2ltYWdlJztcbmltcG9ydCB7QWpmVGFibGVDZWxsfSBmcm9tICdAYWpmL2NvcmUvdGFibGUnO1xuaW1wb3J0IHtkZWVwQ29weX0gZnJvbSAnQGFqZi9jb3JlL3V0aWxzJztcbmltcG9ydCB7dmZzRm9udHMsIHZmc0ZvbnRzTWFwfSBmcm9tICdAYWpmL2NvcmUvdmZzLWZvbnRzJztcbmltcG9ydCB7Y3JlYXRlUGRmLCBUQ3JlYXRlZFBkZn0gZnJvbSAncGRmbWFrZS9idWlsZC9wZGZtYWtlJztcbmltcG9ydCB7XG4gIENvbHVtbixcbiAgQ29udGVudCxcbiAgQ29udGVudFN0YWNrLFxuICBQYWdlT3JpZW50YXRpb24sXG4gIFRhYmxlQ2VsbCxcbiAgVERvY3VtZW50RGVmaW5pdGlvbnNcbn0gZnJvbSAncGRmbWFrZS9pbnRlcmZhY2VzJztcblxuaW1wb3J0IHtBamZSZXBvcnRDb250YWluZXJJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3JlcG9ydHMtaW5zdGFuY2VzL3JlcG9ydC1jb250YWluZXItaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZSZXBvcnRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3JlcG9ydHMtaW5zdGFuY2VzL3JlcG9ydC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZkNoYXJ0V2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9jaGFydC13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZDb2x1bW5XaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL2NvbHVtbi13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZGb3JtdWxhV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9mb3JtdWxhLXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZkltYWdlV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9pbWFnZS13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZMYXlvdXRXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL2xheW91dC13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZUYWJsZVdpZGdldEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvdGFibGUtd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmVGV4dFdpZGdldEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvdGV4dC13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL3dpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZldpZGdldFR5cGV9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzL3dpZGdldC10eXBlJztcblxuaW1wb3J0IHtJbWFnZU1hcCwgbG9hZFJlcG9ydEltYWdlc30gZnJvbSAnLi9sb2FkLXJlcG9ydC1pbWFnZXMnO1xuXG5jb25zdCBwYWdlV2lkdGggPSA4MDA7XG5jb25zdCBwYWdlSGVpZ2h0ID0gcGFnZVdpZHRoICogMS40MTQyOyAvLyBBNCBwcm9wb3J0aW9uc1xuY29uc3QgcGFnZU1hcmdpbnM6IFtudW1iZXIsIG51bWJlcl0gPSBbNDAsIDYwXTtcblxuZXhwb3J0IGZ1bmN0aW9uIG9wZW5SZXBvcnRQZGYoXG4gIHJlcG9ydDogQWpmUmVwb3J0SW5zdGFuY2UsIG9yaWVudGF0aW9uOiBQYWdlT3JpZW50YXRpb24gPSAncG9ydHJhaXQnLCBpY29uczogSW1hZ2VNYXAgPSB7fSkge1xuXG4gIGNyZWF0ZVJlcG9ydFBkZihyZXBvcnQsIG9yaWVudGF0aW9uLCBpY29ucykudGhlbihwZGYgPT4ge1xuICAgIHBkZi5vcGVuKCk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUmVwb3J0UGRmKFxuICAgIHJlcG9ydDogQWpmUmVwb3J0SW5zdGFuY2UsIG9yaWVudGF0aW9uOiBQYWdlT3JpZW50YXRpb24gPSAncG9ydHJhaXQnLCBpY29uczogSW1hZ2VNYXAgPSB7fVxuICApOiBQcm9taXNlPFRDcmVhdGVkUGRmPiB7XG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlPFRDcmVhdGVkUGRmPihyZXNvbHZlID0+IHtcbiAgICBsb2FkUmVwb3J0SW1hZ2VzKHJlcG9ydCkudGhlbihpbWFnZXMgPT4ge1xuICAgICAgbGV0IHdpZHRoID0gcGFnZVdpZHRoIC0gcGFnZU1hcmdpbnNbMF0gKiAyO1xuICAgICAgaWYgKG9yaWVudGF0aW9uID09PSAnbGFuZHNjYXBlJykge1xuICAgICAgICB3aWR0aCA9IHBhZ2VIZWlnaHQgLSBwYWdlTWFyZ2luc1sxXSAqIDI7XG4gICAgICB9XG4gICAgICBjb25zdCBwZGZEZWYgPSByZXBvcnRUb1BkZihyZXBvcnQsIHsuLi5pbWFnZXMsIC4uLmljb25zfSwgd2lkdGgpO1xuICAgICAgcGRmRGVmLnBhZ2VTaXplID0ge3dpZHRoOiBwYWdlV2lkdGgsIGhlaWdodDogcGFnZUhlaWdodH07XG4gICAgICBwZGZEZWYucGFnZU1hcmdpbnMgPSBwYWdlTWFyZ2lucztcbiAgICAgIHBkZkRlZi5wYWdlT3JpZW50YXRpb24gPSBvcmllbnRhdGlvbjtcbiAgICAgIHJlc29sdmUoY3JlYXRlUGRmKHBkZkRlZiwgdW5kZWZpbmVkLCB2ZnNGb250c01hcCwgdmZzRm9udHMpKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlcG9ydFRvUGRmKFxuICAgIHJlcG9ydDogQWpmUmVwb3J0SW5zdGFuY2UsIGltYWdlczogSW1hZ2VNYXAsIHdpZHRoOiBudW1iZXIpOiBURG9jdW1lbnREZWZpbml0aW9ucyB7XG4gIGNvbnN0IHN0YWNrOiBDb250ZW50W10gPSBbXTtcbiAgaWYgKHJlcG9ydC5oZWFkZXIgIT0gbnVsbCkge1xuICAgIHN0YWNrLnB1c2goY29udGFpbmVyVG9QZGYocmVwb3J0LmhlYWRlciwgaW1hZ2VzLCB3aWR0aCkpO1xuICB9XG4gIGlmIChyZXBvcnQuY29udGVudCAhPSBudWxsKSB7XG4gICAgc3RhY2sucHVzaChjb250YWluZXJUb1BkZihyZXBvcnQuY29udGVudCwgaW1hZ2VzLCB3aWR0aCkpO1xuICB9XG4gIGlmIChyZXBvcnQuZm9vdGVyICE9IG51bGwpIHtcbiAgICBzdGFjay5wdXNoKGNvbnRhaW5lclRvUGRmKHJlcG9ydC5mb290ZXIsIGltYWdlcywgd2lkdGgpKTtcbiAgfVxuICByZXR1cm4ge2NvbnRlbnQ6IHtzdGFja319O1xufVxuXG5mdW5jdGlvbiBjb250YWluZXJUb1BkZihcbiAgICBjb250YWluZXI6IEFqZlJlcG9ydENvbnRhaW5lckluc3RhbmNlLCBpbWFnZXM6IEltYWdlTWFwLCB3aWR0aDogbnVtYmVyKTogQ29udGVudCB7XG4gIHJldHVybiB7c3RhY2s6IGNvbnRhaW5lci5jb250ZW50Lm1hcCh3ID0+IHdpZGdldFRvUGRmKHcsIGltYWdlcywgd2lkdGgpKX07XG59XG5cbmNvbnN0IG1hcmdpbkJldHdlZW5XaWRnZXRzID0gMTA7XG5cbmZ1bmN0aW9uIHdpZGdldFRvUGRmKHdpZGdldDogQWpmV2lkZ2V0SW5zdGFuY2UsIGltYWdlczogSW1hZ2VNYXAsIHdpZHRoOiBudW1iZXIpOiBDb250ZW50IHtcbiAgc3dpdGNoICh3aWRnZXQud2lkZ2V0LndpZGdldFR5cGUpIHtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuTGF5b3V0OlxuICAgICAgcmV0dXJuIGxheW91dFRvUGRmKHdpZGdldCBhcyBBamZMYXlvdXRXaWRnZXRJbnN0YW5jZSwgaW1hZ2VzLCB3aWR0aCk7XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLlBhZ2VCcmVhazpcbiAgICAgIHJldHVybiB7dGV4dDogJycsIHBhZ2VCcmVhazogJ2FmdGVyJ307XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLkltYWdlOlxuICAgICAgcmV0dXJuIGltYWdlVG9QZGYod2lkZ2V0IGFzIEFqZkltYWdlV2lkZ2V0SW5zdGFuY2UsIGltYWdlcywgd2lkdGgpO1xuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5UZXh0OlxuICAgICAgcmV0dXJuIHRleHRUb1BkZih3aWRnZXQgYXMgQWpmVGV4dFdpZGdldEluc3RhbmNlLCBpbWFnZXMpO1xuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5DaGFydDpcbiAgICAgIGNvbnN0IGNoYXJ0ID0gd2lkZ2V0IGFzIEFqZkNoYXJ0V2lkZ2V0SW5zdGFuY2U7XG4gICAgICBjb25zdCBkYXRhVXJsID0gY2hhcnQuY2FudmFzRGF0YVVybCA9PSBudWxsID8gJycgOiBjaGFydC5jYW52YXNEYXRhVXJsKCk7XG4gICAgICBpZiAoZGF0YVVybCA9PT0gJycpIHtcbiAgICAgICAgcmV0dXJuIHt0ZXh0OiAnW2NoYXJ0IHdpdGggbm8gYXR0YWNoZWQgY2FudmFzXSd9O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHtpbWFnZTogZGF0YVVybCwgd2lkdGgsIG1hcmdpbjogWzAsIDAsIDAsIG1hcmdpbkJldHdlZW5XaWRnZXRzXX07XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLlRhYmxlOlxuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5EeW5hbWljVGFibGU6XG4gICAgICByZXR1cm4gdGFibGVUb1BkZih3aWRnZXQgYXMgQWpmVGFibGVXaWRnZXRJbnN0YW5jZSwgaW1hZ2VzKTtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuQ29sdW1uOlxuICAgICAgY29uc3QgY3cgPSB3aWRnZXQgYXMgQWpmQ29sdW1uV2lkZ2V0SW5zdGFuY2U7XG4gICAgICByZXR1cm4ge3N0YWNrOiBjdy5jb250ZW50Lm1hcCh3ID0+IHdpZGdldFRvUGRmKHcsIGltYWdlcywgd2lkdGgpKX07XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLkZvcm11bGE6XG4gICAgICBjb25zdCBmdyA9IHdpZGdldCBhcyBBamZGb3JtdWxhV2lkZ2V0SW5zdGFuY2U7XG4gICAgICByZXR1cm4ge3RleHQ6IGZ3LmZvcm11bGEsIG1hcmdpbjogWzAsIDAsIDAsIG1hcmdpbkJldHdlZW5XaWRnZXRzXX07XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiB7dGV4dDogJyd9O1xuICB9XG59XG5cbmZ1bmN0aW9uIGxheW91dFRvUGRmKGx3OiBBamZMYXlvdXRXaWRnZXRJbnN0YW5jZSwgaW1hZ2VzOiBJbWFnZU1hcCwgd2lkdGg6IG51bWJlcik6IENvbnRlbnQge1xuICBjb25zdCBjb2x1bW5zID0gWy4uLmx3LndpZGdldC5jb2x1bW5zXTtcbiAgd2hpbGUgKGNvbHVtbnMubGVuZ3RoIDwgbHcuY29udGVudC5sZW5ndGgpIHtcbiAgICBjb2x1bW5zLnB1c2goMSk7XG4gIH1cbiAgY29uc3QgY2hpbGRXaWR0aCA9IHdpZHRoIC8gKGNvbHVtbnMubGVuZ3RoIHx8IDEpO1xuICBjb25zdCBjaGlsZHJlbiA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGx3LmNvbnRlbnQubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgY2hpbGQgPSB3aWRnZXRUb1BkZihsdy5jb250ZW50W2ldLCBpbWFnZXMsIGNoaWxkV2lkdGgpIGFzIENvbnRlbnRTdGFjaztcbiAgICAvLyBDaGlsZHJlbiBvZiBMYXlvdXQgd2lkZ2V0cyBhcmUgc3VwcG9zZWQgdG8gYmUgQ29sdW1ucy4gSWYgdGhleSBhcmVuJ3QsXG4gICAgLy8gd2UgbXVzdCB3cmFwIHRoZW0gdG8gYXZvaWQgcHJvYmxlbXMgbGlrZSBpbWFnZXMgaGF2aW5nIGFuICdhdXRvJyB3aWR0aC5cbiAgICBpZiAoY2hpbGQuc3RhY2sgPT0gbnVsbCkge1xuICAgICAgY2hpbGQgPSB7c3RhY2s6IFtjaGlsZF19O1xuICAgIH1cbiAgICAoY2hpbGQgYXMgQ29sdW1uKS53aWR0aCA9IGNvbHVtbnNbaV0gPT09IC0xID8gJ2F1dG8nIDogJyonO1xuICAgIGNoaWxkcmVuLnB1c2goY2hpbGQpO1xuICB9XG4gIHJldHVybiB7Y29sdW1uczogY2hpbGRyZW59O1xufVxuXG5mdW5jdGlvbiBpbWFnZVRvUGRmKGltYWdlOiBBamZJbWFnZVdpZGdldEluc3RhbmNlLCBpbWFnZXM6IEltYWdlTWFwLCB3aWR0aDogbnVtYmVyKTogQ29udGVudCB7XG4gIGlmIChpbWFnZS53aWRnZXQuaW1hZ2VUeXBlICE9PSBBamZJbWFnZVR5cGUuSW1hZ2UpIHtcbiAgICAvLyBDYW4ndCBnZXQgaWNvbnMgdG8gd29yaywgcGRmcyB3aXRoIG11bHRpcGxlIGZvbnRzIGRvbid0IHNlZW0gdG8gYmUgd29ya2luZ1xuICAgIHJldHVybiB7dGV4dDogJyd9O1xuICB9XG4gIGNvbnN0IGRhdGFVcmwgPSBpbWFnZXNbaW1hZ2UudXJsXTtcbiAgaWYgKGRhdGFVcmwgPT0gbnVsbCkge1xuICAgIHJldHVybiB7dGV4dDogJyd9O1xuICB9XG4gIGNvbnN0IHcgPSBpbWFnZS5zdHlsZXMud2lkdGg7XG4gIGlmICh0eXBlb2YgKHcpID09PSAnc3RyaW5nJyAmJiB3LmVuZHNXaXRoKCdweCcpKSB7XG4gICAgd2lkdGggPSBOdW1iZXIody5zbGljZSgwLCAtMikpO1xuICB9XG4gIHJldHVybiB7aW1hZ2U6IGRhdGFVcmwsIHdpZHRoLCBtYXJnaW46IFswLCAwLCAwLCBtYXJnaW5CZXR3ZWVuV2lkZ2V0c119O1xufVxuXG5mdW5jdGlvbiBodG1sVGV4dFRvUGRmVGV4dChodG1sVGV4dDogc3RyaW5nLCBpbWFnZXM6IEltYWdlTWFwKTogc3RyaW5nIHtcbiAgY29uc3QgaWNvblRleHQgPSBpbWFnZXNbaHRtbFRleHRdO1xuICBpZiAodHlwZW9mKGljb25UZXh0KSA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gaWNvblRleHQ7XG4gIH1cbiAgcmV0dXJuIHN0cmlwSFRNTChodG1sVGV4dCk7XG59XG5cbmZ1bmN0aW9uIHRleHRUb1BkZih0dzogQWpmVGV4dFdpZGdldEluc3RhbmNlLCBpbWFnZXM6IEltYWdlTWFwKTogQ29udGVudCB7XG4gIGNvbnN0IHRleHQ6IENvbnRlbnQgPSB7XG4gICAgdGV4dDogaHRtbFRleHRUb1BkZlRleHQodHcuaHRtbFRleHQsIGltYWdlcyksXG4gICAgbWFyZ2luOiBbMCwgMCwgMCwgbWFyZ2luQmV0d2VlbldpZGdldHNdLFxuICB9O1xuICBpZiAodHcuaHRtbFRleHQuc3RhcnRzV2l0aCgnPGgxPicpKSB7XG4gICAgdGV4dC5mb250U2l6ZSA9IDIwO1xuICAgIHRleHQubWFyZ2luID0gWzAsIDEwLCAwLCBtYXJnaW5CZXR3ZWVuV2lkZ2V0c107XG4gIH0gZWxzZSBpZiAodHcuaHRtbFRleHQuc3RhcnRzV2l0aCgnPGgyPicpKSB7XG4gICAgdGV4dC5mb250U2l6ZSA9IDE1O1xuICAgIHRleHQubWFyZ2luID0gWzAsIDUsIDAsIG1hcmdpbkJldHdlZW5XaWRnZXRzXTtcbiAgfVxuICByZXR1cm4gdGV4dDtcbn1cblxuZnVuY3Rpb24gdGFibGVUb1BkZih0YWJsZTogQWpmVGFibGVXaWRnZXRJbnN0YW5jZSwgaW1hZ2VzOiBJbWFnZU1hcCk6IENvbnRlbnQge1xuICBpZiAodGFibGUuZGF0YSA9PSBudWxsIHx8IHRhYmxlLmRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHt0ZXh0OiAnJ307XG4gIH1cbiAgY29uc3QgYm9keTogVGFibGVDZWxsW11bXSA9IFtdO1xuICBmb3IgKGNvbnN0IGRhdGFSb3cgb2YgZXhwYW5kQ29sQW5kUm93U3Bhbih0YWJsZS5kYXRhKSkge1xuICAgIGNvbnN0IGJvZHlSb3c6IFRhYmxlQ2VsbFtdID0gW107XG4gICAgZm9yIChjb25zdCBjZWxsIG9mIGRhdGFSb3cpIHtcbiAgICAgIGxldCB0ZXh0ID0gJyc7XG4gICAgICBzd2l0Y2ggKHR5cGVvZihjZWxsLnZhbHVlKSkge1xuICAgICAgICBjYXNlICdudW1iZXInOlxuICAgICAgICAgIHRleHQgPSBTdHJpbmcoY2VsbC52YWx1ZSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgICAgICAgdGV4dCA9IGh0bWxUZXh0VG9QZGZUZXh0KGNlbGwudmFsdWUsIGltYWdlcyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICAgICAgbGV0IHZhbCA9IGNlbGwudmFsdWUuY2hhbmdpbmdUaGlzQnJlYWtzQXBwbGljYXRpb25TZWN1cml0eTtcbiAgICAgICAgICBpZiAodHlwZW9mKHZhbCkgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICB2YWwgPSBTdHJpbmcodmFsKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGV4dCA9IGh0bWxUZXh0VG9QZGZUZXh0KHZhbCB8fCAnJywgaW1hZ2VzKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGJvZHlSb3cucHVzaCh7dGV4dCwgY29sU3BhbjogY2VsbC5jb2xzcGFuLCByb3dTcGFuOiBjZWxsLnJvd3NwYW59KTtcbiAgICB9XG4gICAgYm9keS5wdXNoKGJvZHlSb3cpO1xuICB9XG4gIHJldHVybiB7dGFibGU6IHtoZWFkZXJSb3dzOiAwLCBib2R5fSwgbWFyZ2luOiBbMCwgMCwgMCwgbWFyZ2luQmV0d2VlbldpZGdldHNdfTtcbn1cblxuLy8gcGRmbWFrZSB3YW50cyBwbGFjZWhvbGRlciBjZWxscyBhZnRlciBjZWxscyB3aXRoIGNvbC9yb3dzcGFuID4gMVxuZnVuY3Rpb24gZXhwYW5kQ29sQW5kUm93U3BhbihkYXRhOiBBamZUYWJsZUNlbGxbXVtdKTogQWpmVGFibGVDZWxsW11bXSB7XG4gIGRhdGEgPSBkZWVwQ29weShkYXRhKTtcbiAgLy8gZXhwYW5kIGNvbHNwYW46XG4gIGZvciAoY29uc3Qgcm93IG9mIGRhdGEpIHtcbiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJvdy5sZW5ndGg7IGorKykge1xuICAgICAgY29uc3QgY2VsbCA9IHJvd1tqXTtcbiAgICAgIGZvciAobGV0IGsgPSAxOyBrIDwgKGNlbGwuY29sc3BhbiB8fCAxKTsgaysrKSB7XG4gICAgICAgIHJvdy5zcGxpY2UoaiArIGssIDAsIHtyb3dzcGFuOiBjZWxsLnJvd3NwYW4sIHZhbHVlOiAnJywgc3R5bGU6IHt9fSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIC8vIGV4cGFuZCByb3dzcGFuOlxuICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCByb3cgPSBkYXRhW2ldO1xuICAgIGZvciAobGV0IGogPSAwOyBqIDwgcm93Lmxlbmd0aDsgaisrKSB7XG4gICAgICBjb25zdCBjZWxsID0gcm93W2pdO1xuICAgICAgZm9yIChsZXQgayA9IDE7IGsgPCAoY2VsbC5yb3dzcGFuIHx8IDEpOyBrKyspIHtcbiAgICAgICAgZGF0YVtpICsga10uc3BsaWNlKGosIDAsIHt2YWx1ZTogJycsIHN0eWxlOiB7fX0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gc3RyaXBIVE1MKHM6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBzLnJlcGxhY2UoLzxcXC8/W14+XSsoPnwkKS9nLCAnJyk7XG59XG4iXX0=