/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { AjfImageType } from '@ajf/core/image';
import { deepCopy } from '@ajf/core/utils';
import { vfsFonts, vfsFontsMap } from '@ajf/core/vfs-fonts';
import { createPdf } from 'pdfmake/build/pdfmake';
import { AjfWidgetType } from '../interface/widgets/widget-type';
import { loadReportImages } from './load-report-images';
const pageWidth = 800;
const pageHeight = pageWidth * 1.4142; // A4 proportions
const pageMargins = [40, 60];
export function openReportPdf(report, orientation = 'portrait', icons = {}) {
    createReportPdf(report, orientation, icons).then(pdf => {
        pdf.open();
    });
}
export function createReportPdf(report, orientation = 'portrait', icons = {}) {
    return new Promise(resolve => {
        loadReportImages(report).then(images => {
            let width = pageWidth - pageMargins[0] * 2;
            if (orientation === 'landscape') {
                width = pageHeight - pageMargins[1] * 2;
            }
            const pdfDef = reportToPdf(report, { ...images, ...icons }, width);
            pdfDef.pageSize = { width: pageWidth, height: pageHeight };
            pdfDef.pageMargins = pageMargins;
            pdfDef.pageOrientation = orientation;
            resolve(createPdf(pdfDef, undefined, vfsFontsMap, vfsFonts));
        });
    });
}
function reportToPdf(report, images, width) {
    const stack = [];
    if (report.header != null) {
        stack.push(containerToPdf(report.header, images, width));
    }
    if (report.content != null) {
        stack.push(containerToPdf(report.content, images, width));
    }
    if (report.footer != null) {
        stack.push(containerToPdf(report.footer, images, width));
    }
    return { content: { stack } };
}
function containerToPdf(container, images, width) {
    return { stack: container.content.map(w => widgetToPdf(w, images, width)) };
}
const marginBetweenWidgets = 10;
function widgetToPdf(widget, images, width) {
    switch (widget.widget.widgetType) {
        case AjfWidgetType.Layout:
            return layoutToPdf(widget, images, width);
        case AjfWidgetType.PageBreak:
            return { text: '', pageBreak: 'after' };
        case AjfWidgetType.Image:
            return imageToPdf(widget, images, width);
        case AjfWidgetType.Text:
            return textToPdf(widget, images);
        case AjfWidgetType.Chart:
            const chart = widget;
            const dataUrl = chart.canvasDataUrl == null ? '' : chart.canvasDataUrl();
            if (dataUrl === '') {
                return { text: '[chart with no attached canvas]' };
            }
            return { image: dataUrl, width, margin: [0, 0, 0, marginBetweenWidgets] };
        case AjfWidgetType.Table:
        case AjfWidgetType.DynamicTable:
            return tableToPdf(widget, images);
        case AjfWidgetType.Column:
            const cw = widget;
            return { stack: cw.content.map(w => widgetToPdf(w, images, width)) };
        case AjfWidgetType.Formula:
            const fw = widget;
            return { text: fw.formula, margin: [0, 0, 0, marginBetweenWidgets] };
        default:
            return { text: '' };
    }
}
function layoutToPdf(lw, images, width) {
    const columns = [...lw.widget.columns];
    while (columns.length < lw.content.length) {
        columns.push(1);
    }
    const childWidth = width / (columns.length || 1);
    const children = [];
    for (let i = 0; i < lw.content.length; i++) {
        let child = widgetToPdf(lw.content[i], images, childWidth);
        // Children of Layout widgets are supposed to be Columns. If they aren't,
        // we must wrap them to avoid problems like images having an 'auto' width.
        if (child.stack == null) {
            child = { stack: [child] };
        }
        child.width = columns[i] === -1 ? 'auto' : '*';
        children.push(child);
    }
    return { columns: children };
}
function imageToPdf(image, images, width) {
    if (image.widget.imageType !== AjfImageType.Image) {
        // Can't get icons to work, pdfs with multiple fonts don't seem to be working
        return { text: '' };
    }
    const dataUrl = images[image.url];
    if (dataUrl == null) {
        return { text: '' };
    }
    const w = image.styles.width;
    if (typeof w === 'string' && w.endsWith('px')) {
        width = Number(w.slice(0, -2));
    }
    return { image: dataUrl, width, margin: [0, 0, 0, marginBetweenWidgets] };
}
function htmlTextToPdfText(htmlText, images) {
    const iconText = images[htmlText];
    if (typeof iconText === 'string') {
        return iconText;
    }
    return stripHTML(htmlText);
}
function textToPdf(tw, images) {
    const text = {
        text: htmlTextToPdfText(tw.htmlText, images),
        margin: [0, 0, 0, marginBetweenWidgets],
    };
    if (tw.htmlText.startsWith('<h1>')) {
        text.fontSize = 20;
        text.margin = [0, 10, 0, marginBetweenWidgets];
    }
    else if (tw.htmlText.startsWith('<h2>')) {
        text.fontSize = 15;
        text.margin = [0, 5, 0, marginBetweenWidgets];
    }
    return text;
}
function tableToPdf(table, images) {
    if (table.data == null || table.data.length === 0) {
        return { text: '' };
    }
    const body = [];
    for (const dataRow of expandColAndRowSpan(table.data)) {
        const bodyRow = [];
        for (const cell of dataRow) {
            let text = '';
            switch (typeof cell.value) {
                case 'number':
                    text = String(cell.value);
                    break;
                case 'string':
                    text = htmlTextToPdfText(cell.value, images);
                    break;
                case 'object':
                    let val = cell.value.changingThisBreaksApplicationSecurity;
                    if (typeof val === 'number') {
                        val = String(val);
                    }
                    text = htmlTextToPdfText(val || '', images);
                    break;
            }
            bodyRow.push({ text, colSpan: cell.colspan, rowSpan: cell.rowspan });
        }
        body.push(bodyRow);
    }
    return { table: { headerRows: 0, body }, margin: [0, 0, 0, marginBetweenWidgets] };
}
// pdfmake wants placeholder cells after cells with col/rowspan > 1
function expandColAndRowSpan(data) {
    data = deepCopy(data);
    // expand colspan:
    for (const row of data) {
        for (let j = 0; j < row.length; j++) {
            const cell = row[j];
            for (let k = 1; k < (cell.colspan || 1); k++) {
                row.splice(j + k, 0, { rowspan: cell.rowspan, value: '', style: {} });
            }
        }
    }
    // expand rowspan:
    for (let i = 0; i < data.length; i++) {
        const row = data[i];
        for (let j = 0; j < row.length; j++) {
            const cell = row[j];
            for (let k = 1; k < (cell.rowspan || 1); k++) {
                data[i + k].splice(j, 0, { value: '', style: {} });
            }
        }
    }
    return data;
}
function stripHTML(s) {
    return s.replace(/<\/?[^>]+(>|$)/g, '');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3J0LXRvLXBkZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3JlcG9ydHMvcmVwb3J0LXRvLXBkZi9yZXBvcnQtdG8tcGRmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUVILE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUU3QyxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUMxRCxPQUFPLEVBQUMsU0FBUyxFQUFjLE1BQU0sdUJBQXVCLENBQUM7QUFvQjdELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxrQ0FBa0MsQ0FBQztBQUUvRCxPQUFPLEVBQVcsZ0JBQWdCLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUVoRSxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUM7QUFDdEIsTUFBTSxVQUFVLEdBQUcsU0FBUyxHQUFHLE1BQU0sQ0FBQyxDQUFDLGlCQUFpQjtBQUN4RCxNQUFNLFdBQVcsR0FBcUIsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFFL0MsTUFBTSxVQUFVLGFBQWEsQ0FDM0IsTUFBeUIsRUFDekIsY0FBK0IsVUFBVSxFQUN6QyxRQUFrQixFQUFFO0lBRXBCLGVBQWUsQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUNyRCxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDYixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxNQUFNLFVBQVUsZUFBZSxDQUM3QixNQUF5QixFQUN6QixjQUErQixVQUFVLEVBQ3pDLFFBQWtCLEVBQUU7SUFFcEIsT0FBTyxJQUFJLE9BQU8sQ0FBYyxPQUFPLENB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KEMpIEdudWNvb3Agc29jLiBjb29wLlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yXG4gKiBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXNcbiAqIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLFxuICogb3IgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIEdOVSBBZmZlcm9cbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGFsb25nIHdpdGggQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqIElmIG5vdCwgc2VlIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8uXG4gKlxuICovXG5cbmltcG9ydCB7QWpmSW1hZ2VUeXBlfSBmcm9tICdAYWpmL2NvcmUvaW1hZ2UnO1xuaW1wb3J0IHtBamZUYWJsZUNlbGx9IGZyb20gJ0BhamYvY29yZS90YWJsZSc7XG5pbXBvcnQge2RlZXBDb3B5fSBmcm9tICdAYWpmL2NvcmUvdXRpbHMnO1xuaW1wb3J0IHt2ZnNGb250cywgdmZzRm9udHNNYXB9IGZyb20gJ0BhamYvY29yZS92ZnMtZm9udHMnO1xuaW1wb3J0IHtjcmVhdGVQZGYsIFRDcmVhdGVkUGRmfSBmcm9tICdwZGZtYWtlL2J1aWxkL3BkZm1ha2UnO1xuaW1wb3J0IHtcbiAgQ29sdW1uLFxuICBDb250ZW50LFxuICBDb250ZW50U3RhY2ssXG4gIFBhZ2VPcmllbnRhdGlvbixcbiAgVGFibGVDZWxsLFxuICBURG9jdW1lbnREZWZpbml0aW9ucyxcbn0gZnJvbSAncGRmbWFrZS9pbnRlcmZhY2VzJztcblxuaW1wb3J0IHtBamZSZXBvcnRDb250YWluZXJJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3JlcG9ydHMtaW5zdGFuY2VzL3JlcG9ydC1jb250YWluZXItaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZSZXBvcnRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3JlcG9ydHMtaW5zdGFuY2VzL3JlcG9ydC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZkNoYXJ0V2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9jaGFydC13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZDb2x1bW5XaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL2NvbHVtbi13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZGb3JtdWxhV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9mb3JtdWxhLXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZkltYWdlV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9pbWFnZS13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZMYXlvdXRXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL2xheW91dC13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZUYWJsZVdpZGdldEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvdGFibGUtd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmVGV4dFdpZGdldEluc3RhbmNlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvdGV4dC13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL3dpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZldpZGdldFR5cGV9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzL3dpZGdldC10eXBlJztcblxuaW1wb3J0IHtJbWFnZU1hcCwgbG9hZFJlcG9ydEltYWdlc30gZnJvbSAnLi9sb2FkLXJlcG9ydC1pbWFnZXMnO1xuXG5jb25zdCBwYWdlV2lkdGggPSA4MDA7XG5jb25zdCBwYWdlSGVpZ2h0ID0gcGFnZVdpZHRoICogMS40MTQyOyAvLyBBNCBwcm9wb3J0aW9uc1xuY29uc3QgcGFnZU1hcmdpbnM6IFtudW1iZXIsIG51bWJlcl0gPSBbNDAsIDYwXTtcblxuZXhwb3J0IGZ1bmN0aW9uIG9wZW5SZXBvcnRQZGYoXG4gIHJlcG9ydDogQWpmUmVwb3J0SW5zdGFuY2UsXG4gIG9yaWVudGF0aW9uOiBQYWdlT3JpZW50YXRpb24gPSAncG9ydHJhaXQnLFxuICBpY29uczogSW1hZ2VNYXAgPSB7fSxcbikge1xuICBjcmVhdGVSZXBvcnRQZGYocmVwb3J0LCBvcmllbnRhdGlvbiwgaWNvbnMpLnRoZW4ocGRmID0+IHtcbiAgICBwZGYub3BlbigpO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJlcG9ydFBkZihcbiAgcmVwb3J0OiBBamZSZXBvcnRJbnN0YW5jZSxcbiAgb3JpZW50YXRpb246IFBhZ2VPcmllbnRhdGlvbiA9ICdwb3J0cmFpdCcsXG4gIGljb25zOiBJbWFnZU1hcCA9IHt9LFxuKTogUHJvbWlzZTxUQ3JlYXRlZFBkZj4ge1xuICByZXR1cm4gbmV3IFByb21pc2U8VENyZWF0ZWRQZGY+KHJlc29sdmUgPT4ge1xuICAgIGxvYWRSZXBvcnRJbWFnZXMocmVwb3J0KS50aGVuKGltYWdlcyA9PiB7XG4gICAgICBsZXQgd2lkdGggPSBwYWdlV2lkdGggLSBwYWdlTWFyZ2luc1swXSAqIDI7XG4gICAgICBpZiAob3JpZW50YXRpb24gPT09ICdsYW5kc2NhcGUnKSB7XG4gICAgICAgIHdpZHRoID0gcGFnZUhlaWdodCAtIHBhZ2VNYXJnaW5zWzFdICogMjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHBkZkRlZiA9IHJlcG9ydFRvUGRmKHJlcG9ydCwgey4uLmltYWdlcywgLi4uaWNvbnN9LCB3aWR0aCk7XG4gICAgICBwZGZEZWYucGFnZVNpemUgPSB7d2lkdGg6IHBhZ2VXaWR0aCwgaGVpZ2h0OiBwYWdlSGVpZ2h0fTtcbiAgICAgIHBkZkRlZi5wYWdlTWFyZ2lucyA9IHBhZ2VNYXJnaW5zO1xuICAgICAgcGRmRGVmLnBhZ2VPcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uO1xuICAgICAgcmVzb2x2ZShjcmVhdGVQZGYocGRmRGVmLCB1bmRlZmluZWQsIHZmc0ZvbnRzTWFwLCB2ZnNGb250cykpO1xuICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVwb3J0VG9QZGYoXG4gIHJlcG9ydDogQWpmUmVwb3J0SW5zdGFuY2UsXG4gIGltYWdlczogSW1hZ2VNYXAsXG4gIHdpZHRoOiBudW1iZXIsXG4pOiBURG9jdW1lbnREZWZpbml0aW9ucyB7XG4gIGNvbnN0IHN0YWNrOiBDb250ZW50W10gPSBbXTtcbiAgaWYgKHJlcG9ydC5oZWFkZXIgIT0gbnVsbCkge1xuICAgIHN0YWNrLnB1c2goY29udGFpbmVyVG9QZGYocmVwb3J0LmhlYWRlciwgaW1hZ2VzLCB3aWR0aCkpO1xuICB9XG4gIGlmIChyZXBvcnQuY29udGVudCAhPSBudWxsKSB7XG4gICAgc3RhY2sucHVzaChjb250YWluZXJUb1BkZihyZXBvcnQuY29udGVudCwgaW1hZ2VzLCB3aWR0aCkpO1xuICB9XG4gIGlmIChyZXBvcnQuZm9vdGVyICE9IG51bGwpIHtcbiAgICBzdGFjay5wdXNoKGNvbnRhaW5lclRvUGRmKHJlcG9ydC5mb290ZXIsIGltYWdlcywgd2lkdGgpKTtcbiAgfVxuICByZXR1cm4ge2NvbnRlbnQ6IHtzdGFja319O1xufVxuXG5mdW5jdGlvbiBjb250YWluZXJUb1BkZihcbiAgY29udGFpbmVyOiBBamZSZXBvcnRDb250YWluZXJJbnN0YW5jZSxcbiAgaW1hZ2VzOiBJbWFnZU1hcCxcbiAgd2lkdGg6IG51bWJlcixcbik6IENvbnRlbnQge1xuICByZXR1cm4ge3N0YWNrOiBjb250YWluZXIuY29udGVudC5tYXAodyA9PiB3aWRnZXRUb1BkZih3LCBpbWFnZXMsIHdpZHRoKSl9O1xufVxuXG5jb25zdCBtYXJnaW5CZXR3ZWVuV2lkZ2V0cyA9IDEwO1xuXG5mdW5jdGlvbiB3aWRnZXRUb1BkZih3aWRnZXQ6IEFqZldpZGdldEluc3RhbmNlLCBpbWFnZXM6IEltYWdlTWFwLCB3aWR0aDogbnVtYmVyKTogQ29udGVudCB7XG4gIHN3aXRjaCAod2lkZ2V0LndpZGdldC53aWRnZXRUeXBlKSB7XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLkxheW91dDpcbiAgICAgIHJldHVybiBsYXlvdXRUb1BkZih3aWRnZXQgYXMgQWpmTGF5b3V0V2lkZ2V0SW5zdGFuY2UsIGltYWdlcywgd2lkdGgpO1xuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5QYWdlQnJlYWs6XG4gICAgICByZXR1cm4ge3RleHQ6ICcnLCBwYWdlQnJlYWs6ICdhZnRlcid9O1xuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5JbWFnZTpcbiAgICAgIHJldHVybiBpbWFnZVRvUGRmKHdpZGdldCBhcyBBamZJbWFnZVdpZGdldEluc3RhbmNlLCBpbWFnZXMsIHdpZHRoKTtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuVGV4dDpcbiAgICAgIHJldHVybiB0ZXh0VG9QZGYod2lkZ2V0IGFzIEFqZlRleHRXaWRnZXRJbnN0YW5jZSwgaW1hZ2VzKTtcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuQ2hhcnQ6XG4gICAgICBjb25zdCBjaGFydCA9IHdpZGdldCBhcyBBamZDaGFydFdpZGdldEluc3RhbmNlO1xuICAgICAgY29uc3QgZGF0YVVybCA9IGNoYXJ0LmNhbnZhc0RhdGFVcmwgPT0gbnVsbCA/ICcnIDogY2hhcnQuY2FudmFzRGF0YVVybCgpO1xuICAgICAgaWYgKGRhdGFVcmwgPT09ICcnKSB7XG4gICAgICAgIHJldHVybiB7dGV4dDogJ1tjaGFydCB3aXRoIG5vIGF0dGFjaGVkIGNhbnZhc10nfTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7aW1hZ2U6IGRhdGFVcmwsIHdpZHRoLCBtYXJnaW46IFswLCAwLCAwLCBtYXJnaW5CZXR3ZWVuV2lkZ2V0c119O1xuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5UYWJsZTpcbiAgICBjYXNlIEFqZldpZGdldFR5cGUuRHluYW1pY1RhYmxlOlxuICAgICAgcmV0dXJuIHRhYmxlVG9QZGYod2lkZ2V0IGFzIEFqZlRhYmxlV2lkZ2V0SW5zdGFuY2UsIGltYWdlcyk7XG4gICAgY2FzZSBBamZXaWRnZXRUeXBlLkNvbHVtbjpcbiAgICAgIGNvbnN0IGN3ID0gd2lkZ2V0IGFzIEFqZkNvbHVtbldpZGdldEluc3RhbmNlO1xuICAgICAgcmV0dXJuIHtzdGFjazogY3cuY29udGVudC5tYXAodyA9PiB3aWRnZXRUb1BkZih3LCBpbWFnZXMsIHdpZHRoKSl9O1xuICAgIGNhc2UgQWpmV2lkZ2V0VHlwZS5Gb3JtdWxhOlxuICAgICAgY29uc3QgZncgPSB3aWRnZXQgYXMgQWpmRm9ybXVsYVdpZGdldEluc3RhbmNlO1xuICAgICAgcmV0dXJuIHt0ZXh0OiBmdy5mb3JtdWxhLCBtYXJnaW46IFswLCAwLCAwLCBtYXJnaW5CZXR3ZWVuV2lkZ2V0c119O1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4ge3RleHQ6ICcnfTtcbiAgfVxufVxuXG5mdW5jdGlvbiBsYXlvdXRUb1BkZihsdzogQWpmTGF5b3V0V2lkZ2V0SW5zdGFuY2UsIGltYWdlczogSW1hZ2VNYXAsIHdpZHRoOiBudW1iZXIpOiBDb250ZW50IHtcbiAgY29uc3QgY29sdW1ucyA9IFsuLi5sdy53aWRnZXQuY29sdW1uc107XG4gIHdoaWxlIChjb2x1bW5zLmxlbmd0aCA8IGx3LmNvbnRlbnQubGVuZ3RoKSB7XG4gICAgY29sdW1ucy5wdXNoKDEpO1xuICB9XG4gIGNvbnN0IGNoaWxkV2lkdGggPSB3aWR0aCAvIChjb2x1bW5zLmxlbmd0aCB8fCAxKTtcbiAgY29uc3QgY2hpbGRyZW4gPSBbXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsdy5jb250ZW50Lmxlbmd0aDsgaSsrKSB7XG4gICAgbGV0IGNoaWxkID0gd2lkZ2V0VG9QZGYobHcuY29udGVudFtpXSwgaW1hZ2VzLCBjaGlsZFdpZHRoKSBhcyBDb250ZW50U3RhY2s7XG4gICAgLy8gQ2hpbGRyZW4gb2YgTGF5b3V0IHdpZGdldHMgYXJlIHN1cHBvc2VkIHRvIGJlIENvbHVtbnMuIElmIHRoZXkgYXJlbid0LFxuICAgIC8vIHdlIG11c3Qgd3JhcCB0aGVtIHRvIGF2b2lkIHByb2JsZW1zIGxpa2UgaW1hZ2VzIGhhdmluZyBhbiAnYXV0bycgd2lkdGguXG4gICAgaWYgKGNoaWxkLnN0YWNrID09IG51bGwpIHtcbiAgICAgIGNoaWxkID0ge3N0YWNrOiBbY2hpbGRdfTtcbiAgICB9XG4gICAgKGNoaWxkIGFzIENvbHVtbikud2lkdGggPSBjb2x1bW5zW2ldID09PSAtMSA/ICdhdXRvJyA6ICcqJztcbiAgICBjaGlsZHJlbi5wdXNoKGNoaWxkKTtcbiAgfVxuICByZXR1cm4ge2NvbHVtbnM6IGNoaWxkcmVufTtcbn1cblxuZnVuY3Rpb24gaW1hZ2VUb1BkZihpbWFnZTogQWpmSW1hZ2VXaWRnZXRJbnN0YW5jZSwgaW1hZ2VzOiBJbWFnZU1hcCwgd2lkdGg6IG51bWJlcik6IENvbnRlbnQge1xuICBpZiAoaW1hZ2Uud2lkZ2V0LmltYWdlVHlwZSAhPT0gQWpmSW1hZ2VUeXBlLkltYWdlKSB7XG4gICAgLy8gQ2FuJ3QgZ2V0IGljb25zIHRvIHdvcmssIHBkZnMgd2l0aCBtdWx0aXBsZSBmb250cyBkb24ndCBzZWVtIHRvIGJlIHdvcmtpbmdcbiAgICByZXR1cm4ge3RleHQ6ICcnfTtcbiAgfVxuICBjb25zdCBkYXRhVXJsID0gaW1hZ2VzW2ltYWdlLnVybF07XG4gIGlmIChkYXRhVXJsID09IG51bGwpIHtcbiAgICByZXR1cm4ge3RleHQ6ICcnfTtcbiAgfVxuICBjb25zdCB3ID0gaW1hZ2Uuc3R5bGVzLndpZHRoO1xuICBpZiAodHlwZW9mIHcgPT09ICdzdHJpbmcnICYmIHcuZW5kc1dpdGgoJ3B4JykpIHtcbiAgICB3aWR0aCA9IE51bWJlcih3LnNsaWNlKDAsIC0yKSk7XG4gIH1cbiAgcmV0dXJuIHtpbWFnZTogZGF0YVVybCwgd2lkdGgsIG1hcmdpbjogWzAsIDAsIDAsIG1hcmdpbkJldHdlZW5XaWRnZXRzXX07XG59XG5cbmZ1bmN0aW9uIGh0bWxUZXh0VG9QZGZUZXh0KGh0bWxUZXh0OiBzdHJpbmcsIGltYWdlczogSW1hZ2VNYXApOiBzdHJpbmcge1xuICBjb25zdCBpY29uVGV4dCA9IGltYWdlc1todG1sVGV4dF07XG4gIGlmICh0eXBlb2YgaWNvblRleHQgPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIGljb25UZXh0O1xuICB9XG4gIHJldHVybiBzdHJpcEhUTUwoaHRtbFRleHQpO1xufVxuXG5mdW5jdGlvbiB0ZXh0VG9QZGYodHc6IEFqZlRleHRXaWRnZXRJbnN0YW5jZSwgaW1hZ2VzOiBJbWFnZU1hcCk6IENvbnRlbnQge1xuICBjb25zdCB0ZXh0OiBDb250ZW50ID0ge1xuICAgIHRleHQ6IGh0bWxUZXh0VG9QZGZUZXh0KHR3Lmh0bWxUZXh0LCBpbWFnZXMpLFxuICAgIG1hcmdpbjogWzAsIDAsIDAsIG1hcmdpbkJldHdlZW5XaWRnZXRzXSxcbiAgfTtcbiAgaWYgKHR3Lmh0bWxUZXh0LnN0YXJ0c1dpdGgoJzxoMT4nKSkge1xuICAgIHRleHQuZm9udFNpemUgPSAyMDtcbiAgICB0ZXh0Lm1hcmdpbiA9IFswLCAxMCwgMCwgbWFyZ2luQmV0d2VlbldpZGdldHNdO1xuICB9IGVsc2UgaWYgKHR3Lmh0bWxUZXh0LnN0YXJ0c1dpdGgoJzxoMj4nKSkge1xuICAgIHRleHQuZm9udFNpemUgPSAxNTtcbiAgICB0ZXh0Lm1hcmdpbiA9IFswLCA1LCAwLCBtYXJnaW5CZXR3ZWVuV2lkZ2V0c107XG4gIH1cbiAgcmV0dXJuIHRleHQ7XG59XG5cbmZ1bmN0aW9uIHRhYmxlVG9QZGYodGFibGU6IEFqZlRhYmxlV2lkZ2V0SW5zdGFuY2UsIGltYWdlczogSW1hZ2VNYXApOiBDb250ZW50IHtcbiAgaWYgKHRhYmxlLmRhdGEgPT0gbnVsbCB8fCB0YWJsZS5kYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiB7dGV4dDogJyd9O1xuICB9XG4gIGNvbnN0IGJvZHk6IFRhYmxlQ2VsbFtdW10gPSBbXTtcbiAgZm9yIChjb25zdCBkYXRhUm93IG9mIGV4cGFuZENvbEFuZFJvd1NwYW4odGFibGUuZGF0YSkpIHtcbiAgICBjb25zdCBib2R5Um93OiBUYWJsZUNlbGxbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgY2VsbCBvZiBkYXRhUm93KSB7XG4gICAgICBsZXQgdGV4dCA9ICcnO1xuICAgICAgc3dpdGNoICh0eXBlb2YgY2VsbC52YWx1ZSkge1xuICAgICAgICBjYXNlICdudW1iZXInOlxuICAgICAgICAgIHRleHQgPSBTdHJpbmcoY2VsbC52YWx1ZSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgICAgICAgdGV4dCA9IGh0bWxUZXh0VG9QZGZUZXh0KGNlbGwudmFsdWUsIGltYWdlcyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICAgICAgbGV0IHZhbCA9IGNlbGwudmFsdWUuY2hhbmdpbmdUaGlzQnJlYWtzQXBwbGljYXRpb25TZWN1cml0eTtcbiAgICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgIHZhbCA9IFN0cmluZyh2YWwpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0ZXh0ID0gaHRtbFRleHRUb1BkZlRleHQodmFsIHx8ICcnLCBpbWFnZXMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgYm9keVJvdy5wdXNoKHt0ZXh0LCBjb2xTcGFuOiBjZWxsLmNvbHNwYW4sIHJvd1NwYW46IGNlbGwucm93c3Bhbn0pO1xuICAgIH1cbiAgICBib2R5LnB1c2goYm9keVJvdyk7XG4gIH1cbiAgcmV0dXJuIHt0YWJsZToge2hlYWRlclJvd3M6IDAsIGJvZHl9LCBtYXJnaW46IFswLCAwLCAwLCBtYXJnaW5CZXR3ZWVuV2lkZ2V0c119O1xufVxuXG4vLyBwZGZtYWtlIHdhbnRzIHBsYWNlaG9sZGVyIGNlbGxzIGFmdGVyIGNlbGxzIHdpdGggY29sL3Jvd3NwYW4gPiAxXG5mdW5jdGlvbiBleHBhbmRDb2xBbmRSb3dTcGFuKGRhdGE6IEFqZlRhYmxlQ2VsbFtdW10pOiBBamZUYWJsZUNlbGxbXVtdIHtcbiAgZGF0YSA9IGRlZXBDb3B5KGRhdGEpO1xuICAvLyBleHBhbmQgY29sc3BhbjpcbiAgZm9yIChjb25zdCByb3cgb2YgZGF0YSkge1xuICAgIGZvciAobGV0IGogPSAwOyBqIDwgcm93Lmxlbmd0aDsgaisrKSB7XG4gICAgICBjb25zdCBjZWxsID0gcm93W2pdO1xuICAgICAgZm9yIChsZXQgayA9IDE7IGsgPCAoY2VsbC5jb2xzcGFuIHx8IDEpOyBrKyspIHtcbiAgICAgICAgcm93LnNwbGljZShqICsgaywgMCwge3Jvd3NwYW46IGNlbGwucm93c3BhbiwgdmFsdWU6ICcnLCBzdHlsZToge319KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLy8gZXhwYW5kIHJvd3NwYW46XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IHJvdyA9IGRhdGFbaV07XG4gICAgZm9yIChsZXQgaiA9IDA7IGogPCByb3cubGVuZ3RoOyBqKyspIHtcbiAgICAgIGNvbnN0IGNlbGwgPSByb3dbal07XG4gICAgICBmb3IgKGxldCBrID0gMTsgayA8IChjZWxsLnJvd3NwYW4gfHwgMSk7IGsrKykge1xuICAgICAgICBkYXRhW2kgKyBrXS5zcGxpY2UoaiwgMCwge3ZhbHVlOiAnJywgc3R5bGU6IHt9fSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBzdHJpcEhUTUwoczogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHMucmVwbGFjZSgvPFxcLz9bXj5dKyg+fCQpL2csICcnKTtcbn1cbiJdfQ==