/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { createFormula, evaluateExpression } from '@ajf/core/models';
import { deepCopy } from '@ajf/core/utils';
import { chartToChartJsType } from '../../chart-utils';
import { AjfWidgetType } from '../../interface/widgets/widget-type';
import { evaluateAggregation } from '../aggregation/evaluate-aggregation';
import { componentsMap } from '../widgets/widgets-map';
import { createWidgetInstance } from './create-widget-instance';
import { trFormula } from './widget-instance-utils';
export function widgetToWidgetInstance(widget, context, ts, variables = []) {
    const wi = createWidgetInstance(widget, context, ts, variables);
    if (widget.widgetType === AjfWidgetType.Column || widget.widgetType === AjfWidgetType.Layout) {
        const wwc = widget;
        const wwci = wi;
        let content = [];
        wwc.content.forEach(c => {
            if (wwc.repetitions != null) {
                wwci.repetitions = evaluateExpression(wwc.repetitions.formula, context);
                if (typeof wwci.repetitions === 'number' && wwci.repetitions > 0) {
                    for (let i = 0; i < wwci.repetitions; i++) {
                        content.push(widgetToWidgetInstance(c, { ...context, '$repetition': i }, ts, variables));
                    }
                }
            }
            else {
                content.push(widgetToWidgetInstance(c, context, ts, variables));
            }
            wwci.content = content;
        });
    }
    else if (widget.widgetType === AjfWidgetType.Chart) {
        const cw = { ...{ option: {} }, ...widget };
        const cwi = wi;
        const labels = cw.labels instanceof Array ? cw.labels : [cw.labels];
        const evLabels = labels.map(l => {
            let evf = evaluateExpression(l.formula, context);
            try {
                if (evf instanceof Array) {
                    evf = evf.map(v => v != null && typeof v === 'string' && v.trim().length > 0 ? ts.translate(v) : v);
                }
                else {
                    evf =
                        evf != null && typeof evf === 'string' && evf.trim().length > 0
                            ? ts.translate(evf)
                            : evf;
                }
            }
            catch (_e) { }
            return evf;
        });
        cwi.labels = cw.labels instanceof Array ? evLabels : evLabels[0];
        cwi.datasets = cw.dataset.map(d => {
            let ds = {
                ...(d.options || {}),
                data: evaluateAggregation(d.aggregation, d.formula, context),
            };
            if (d.chartType != null) {
                const ct = chartToChartJsType(d.chartType);
                ds = { ...ds, chartType: ct, type: ct };
            }
            if (d.options != null) {
                ds = { ...ds, options: d.options };
            }
            if (d.label != null) {
                ds = { ...ds, label: d.label.trim().length > 0 ? ts.translate(d.label) : d.label };
            }
            if (d.datalabels != null) {
                ds.datalabels = deepCopy(d.datalabels);
            }
            return ds;
        });
        cwi.data = { labels: cwi.labels, datasets: cwi.datasets };
        cwi.chartType = chartToChartJsType(cw.type || cw.chartType);
        cwi.exportable =
            cw.exportable && (cw.exportable === true || cw.exportable === 'true') ? true : false;
        if (cw.options != null && cw.options.plugins != null) {
            const plugins = cw.options.plugins;
            const pluginNames = Object.keys(plugins);
            pluginNames.forEach(pluginName => {
                const plugin = plugins[pluginName];
                const pluginOptions = Object.keys(plugin);
                pluginOptions.forEach((pluginOptionName) => {
                    const pluginOption = plugin[pluginOptionName];
                    if (typeof pluginOption !== 'string' &&
                        pluginOption != null &&
                        pluginOption.formula != null) {
                        plugin[pluginOptionName] = evaluateExpression(pluginOption.formula, context);
                    }
                });
            });
        }
    }
    else if (widget.widgetType === AjfWidgetType.Table) {
        const tw = widget;
        const twi = wi;
        twi.dataset = tw.dataset.map(row => row.map(cell => {
            return cell.formula instanceof Array
                ? cell.formula.map(f => trFormula(f, context, ts))
                : trFormula(cell.formula, context, ts);
        }));
        twi.exportable =
            tw.exportable && (tw.exportable === true || tw.exportable === 'true') ? true : false;
        twi.data = (tw.dataset || []).map(row => row.map(cell => {
            let evf = '';
            try {
                evf =
                    cell.formula instanceof Array
                        ? cell.formula.map(f => trFormula(f, context, ts))
                        : trFormula(cell.formula, context, ts);
            }
            catch (_e) { }
            return {
                value: evf,
                style: { ...tw.cellStyles, ...cell.style },
                rowspan: cell.rowspan,
                colspan: cell.colspan,
            };
        }));
    }
    else if (widget.widgetType === AjfWidgetType.DynamicTable) {
        const tdw = widget;
        const tdwi = wi;
        tdwi.dataset = tdw.dataset.map((cell) => {
            return cell.formula instanceof Array
                ? cell.formula.map(f => trFormula(f, context, ts))
                : trFormula(cell.formula, context, ts);
        });
        tdwi.exportable =
            tdw.exportable && (tdw.exportable === true || tdw.exportable === 'true') ? true : false;
        let dataset = evaluateExpression(tdw.rowDefinition.formula, context) || [];
        dataset = (dataset || []).map((row) => row.map(cell => {
            let trf = cell.value;
            try {
                if (trf instanceof Array) {
                    trf = trf.map(v => v != null && typeof v === 'string' && v.trim().length > 0 ? ts.translate(v) : v);
                }
                else {
                    trf =
                        trf != null && typeof trf === 'string' && trf.trim().length > 0
                            ? ts.translate(trf)
                            : trf;
                }
            }
            catch (_e) { }
            return { ...cell, value: trf };
        }));
        const header = (tdw.dataset || []).map(cell => {
            let evf = '';
            try {
                evf =
                    cell.formula instanceof Array
                        ? cell.formula.map(f => trFormula(f, context, ts))
                        : trFormula(cell.formula, context, ts);
            }
            catch (_e) { }
            return {
                value: evf,
                style: { ...tdw.cellStyles, ...cell.style },
                rowspan: cell.rowspan,
                colspan: cell.colspan,
            };
        });
        tdwi.data = header.length === 0 ? [...dataset] : [[...header], ...dataset];
    }
    else if (widget.widgetType === AjfWidgetType.Image) {
        const iw = widget;
        const iwi = wi;
        if (iw.flag) {
            iwi.flag = evaluateExpression(iw.flag.formula, context);
        }
        if (iw.icon) {
            iwi.icon = evaluateExpression(iw.icon.formula, context);
        }
        if (iw.url) {
            iwi.url = evaluateExpression(iw.url.formula, context);
        }
    }
    else if (widget.widgetType === AjfWidgetType.ImageContainer) {
        const icw = widget;
        const icwi = wi;
        if (icw.flags) {
            icwi.flags =
                icw.flags instanceof Array
                    ? icw.flags.map(f => evaluateExpression(f.formula, context))
                    : evaluateExpression(icw.flags.formula, context);
        }
        if (icw.icons) {
            icwi.icons =
                icw.icons instanceof Array
                    ? icw.icons.map(f => evaluateExpression(f.formula, context))
                    : evaluateExpression(icw.icons.formula, context);
        }
        if (icw.urls) {
            icwi.urls =
                icw.urls instanceof Array
                    ? icw.urls.map(f => evaluateExpression(f.formula, context))
                    : evaluateExpression(icw.urls.formula, context);
        }
    }
    else if (widget.widgetType === AjfWidgetType.Text) {
        const tew = widget;
        const tewi = wi;
        const formulaRegEx = /\[{2}(.+?)\]{2}/g;
        const matches = [];
        let match;
        let htmlText = tew.htmlText;
        while ((match = formulaRegEx.exec(htmlText))) {
            const idx = match.index;
            const len = match[0].length;
            const formula = createFormula({ formula: match[1] });
            matches.push({ idx, len, formula });
        }
        matches.reverse().forEach(m => {
            let calcValue;
            try {
                calcValue = evaluateExpression(m.formula.formula, context);
            }
            catch (e) {
                calcValue = '';
            }
            htmlText = `${htmlText.substr(0, m.idx)}${calcValue}${htmlText.substr(m.idx + m.len)}`;
        });
        tewi.htmlText = htmlText != null && htmlText.length > 0 ? ts.translate(htmlText) : htmlText;
    }
    else if (widget.widgetType === AjfWidgetType.Formula) {
        const fw = widget;
        const fwi = wi;
        fwi.formula = evaluateExpression(fw.formula.formula, context);
    }
    else if (widget.widgetType === AjfWidgetType.Map) {
        const mw = widget;
        const mwi = wi;
        mwi.coordinate = evaluateExpression(mw.coordinate.formula, context);
    }
    else if (widget.widgetType > 100) {
        const iiFn = componentsMap[widget.widgetType] != null
            ? componentsMap[widget.widgetType].initInstance
            : null;
        if (iiFn != null) {
            return iiFn(wi, context, ts);
        }
    }
    return wi;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LXRvLXdpZGdldC1pbnN0YW5jZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NvcmUvcmVwb3J0cy9zcmMvdXRpbHMvd2lkZ2V0cy1pbnN0YW5jZXMvd2lkZ2V0LXRvLXdpZGdldC1pbnN0YW5jZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7QUFFSCxPQUFPLEVBQXlCLGFBQWEsRUFBRSxrQkFBa0IsRUFBQyxNQUFNLGtCQUFrQixDQUFDO0FBRzNGLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUV6QyxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQXFCckQsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLHFDQUFxQyxDQUFDO0FBRWxFLE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLHFDQUFxQyxDQUFDO0FBQ3hFLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUVyRCxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUM5RCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFFbEQsTUFBTSxVQUFVLHNCQUFzQixDQUNwQyxNQUFpQixFQUNqQixPQUFtQixFQUNuQixFQUFvQixFQUNwQixZQUFpQyxFQUFFO0lBRW5DLE1BQU0sRUFBRSxHQUFHLG9CQUFvQixDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBRWhFLElBQUksTUFBTSxDQUFDLFVBQVUsS0FBSyxhQUFhLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxVQUFVLEtBQUssYUFBYSxDQUFDLE1BQU0sRUFBRTtRQUM1RixNQUFNLEdBQUcsR0FBRyxNQUE4QixDQUFDO1FBQzNDLE1BQU0sSUFBSSxHQUFHLEVBQWtDLENB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QkFBa0IsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztLQUNyRTtTQUFNLElBQUksTUFBTSxDQUFDLFVBQVUsR0FBRyxHQUFHLEVBQUU7UUFDbEMsTUFBTSxJQUFJLEdBQ1IsYUFBYSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxJQUFJO1lBQ3RDLENBQUMsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLFlBQVk7WUFDL0MsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNYLElBQUksSUFBSSxJQUFJLElBQUksRUFBRTtZQUNoQixPQUFPLElBQUksQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQzlCO0tBQ0Y7SUFDRCxPQUFPLEVBQUUsQ0FBQztBQUNaLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKEMpIEdudWNvb3Agc29jLiBjb29wLlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yXG4gKiBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXNcbiAqIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLFxuICogb3IgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIEdOVSBBZmZlcm9cbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGFsb25nIHdpdGggQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqIElmIG5vdCwgc2VlIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8uXG4gKlxuICovXG5cbmltcG9ydCB7QWpmQ29udGV4dCwgQWpmRm9ybXVsYSwgY3JlYXRlRm9ybXVsYSwgZXZhbHVhdGVFeHByZXNzaW9ufSBmcm9tICdAYWpmL2NvcmUvbW9kZWxzJztcbmltcG9ydCB7QWpmVGFibGVDZWxsfSBmcm9tICdAYWpmL2NvcmUvdGFibGUnO1xuaW1wb3J0IHtUcmFuc2xvY29TZXJ2aWNlfSBmcm9tICdAYWpmL2NvcmUvdHJhbnNsb2NvJztcbmltcG9ydCB7ZGVlcENvcHl9IGZyb20gJ0BhamYvY29yZS91dGlscyc7XG5cbmltcG9ydCB7Y2hhcnRUb0NoYXJ0SnNUeXBlfSBmcm9tICcuLi8uLi9jaGFydC11dGlscyc7XG5pbXBvcnQge0FqZlRhYmxlRGF0YXNldH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL2RhdGFzZXQvdGFibGUtZGF0YXNldCc7XG5pbXBvcnQge0FqZlJlcG9ydFZhcmlhYmxlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2UvcmVwb3J0cy9yZXBvcnQtdmFyaWFibGUnO1xuaW1wb3J0IHtBamZDaGFydFdpZGdldEluc3RhbmNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvY2hhcnQtd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmRm9ybXVsYVdpZGdldEluc3RhbmNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvZm9ybXVsYS13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZJbWFnZUNvbnRhaW5lcldpZGdldEluc3RhbmNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvaW1hZ2UtY29udGFpbmVyLXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZkltYWdlV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9pbWFnZS13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZNYXBXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL21hcC13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZUYWJsZVdpZGdldEluc3RhbmNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvdGFibGUtd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmVGV4dFdpZGdldEluc3RhbmNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvdGV4dC13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL3dpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZldpZGdldFdpdGhDb250ZW50SW5zdGFuY2V9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy93aWRnZXQtd2l0aC1jb250ZW50LWluc3RhbmNlJztcbmltcG9ydCB7QWpmQ2hhcnRXaWRnZXR9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzL2NoYXJ0LXdpZGdldCc7XG5pbXBvcnQge0FqZkR5bmFtaWNUYWJsZVdpZGdldH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvZHluYW1pYy10YWJsZS13aWRnZXQnO1xuaW1wb3J0IHtBamZGb3JtdWxhV2lkZ2V0fSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy9mb3JtdWxhLXdpZGdldCc7XG5pbXBvcnQge0FqZkltYWdlQ29udGFpbmVyV2lkZ2V0fSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy9pbWFnZS1jb250YWluZXItd2lkZ2V0JztcbmltcG9ydCB7QWpmSW1hZ2VXaWRnZXR9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzL2ltYWdlLXdpZGdldCc7XG5pbXBvcnQge0FqZk1hcFdpZGdldH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvbWFwLXdpZGdldCc7XG5pbXBvcnQge0FqZlRhYmxlV2lkZ2V0fSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy90YWJsZS13aWRnZXQnO1xuaW1wb3J0IHtBamZUZXh0V2lkZ2V0fSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy90ZXh0LXdpZGdldCc7XG5pbXBvcnQge0FqZldpZGdldH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvd2lkZ2V0JztcbmltcG9ydCB7QWpmV2lkZ2V0VHlwZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvd2lkZ2V0LXR5cGUnO1xuaW1wb3J0IHtBamZXaWRnZXRXaXRoQ29udGVudH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvd2lkZ2V0LXdpdGgtY29udGVudCc7XG5pbXBvcnQge2V2YWx1YXRlQWdncmVnYXRpb259IGZyb20gJy4uL2FnZ3JlZ2F0aW9uL2V2YWx1YXRlLWFnZ3JlZ2F0aW9uJztcbmltcG9ydCB7Y29tcG9uZW50c01hcH0gZnJvbSAnLi4vd2lkZ2V0cy93aWRnZXRzLW1hcCc7XG5cbmltcG9ydCB7Y3JlYXRlV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4vY3JlYXRlLXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge3RyRm9ybXVsYX0gZnJvbSAnLi93aWRnZXQtaW5zdGFuY2UtdXRpbHMnO1xuXG5leHBvcnQgZnVuY3Rpb24gd2lkZ2V0VG9XaWRnZXRJbnN0YW5jZShcbiAgd2lkZ2V0OiBBamZXaWRnZXQsXG4gIGNvbnRleHQ6IEFqZkNvbnRleHQsXG4gIHRzOiBUcmFuc2xvY29TZXJ2aWNlLFxuICB2YXJpYWJsZXM6IEFqZlJlcG9ydFZhcmlhYmxlW10gPSBbXSxcbik6IEFqZldpZGdldEluc3RhbmNlIHtcbiAgY29uc3Qgd2kgPSBjcmVhdGVXaWRnZXRJbnN0YW5jZSh3aWRnZXQsIGNvbnRleHQsIHRzLCB2YXJpYWJsZXMpO1xuXG4gIGlmICh3aWRnZXQud2lkZ2V0VHlwZSA9PT0gQWpmV2lkZ2V0VHlwZS5Db2x1bW4gfHwgd2lkZ2V0LndpZGdldFR5cGUgPT09IEFqZldpZGdldFR5cGUuTGF5b3V0KSB7XG4gICAgY29uc3Qgd3djID0gd2lkZ2V0IGFzIEFqZldpZGdldFdpdGhDb250ZW50O1xuICAgIGNvbnN0IHd3Y2kgPSB3aSBhcyBBamZXaWRnZXRXaXRoQ29udGVudEluc3RhbmNlO1xuICAgIGxldCBjb250ZW50ID0gW10gYXMgQWpmV2lkZ2V0SW5zdGFuY2VbXTtcbiAgICB3d2MuY29udGVudC5mb3JFYWNoKGMgPT4ge1xuICAgICAgaWYgKHd3Yy5yZXBldGl0aW9ucyAhPSBudWxsKSB7XG4gICAgICAgIHd3Y2kucmVwZXRpdGlvbnMgPSBldmFsdWF0ZUV4cHJlc3Npb24od3djLnJlcGV0aXRpb25zLmZvcm11bGEsIGNvbnRleHQpO1xuICAgICAgICBpZiAodHlwZW9mIHd3Y2kucmVwZXRpdGlvbnMgPT09ICdudW1iZXInICYmIHd3Y2kucmVwZXRpdGlvbnMgPiAwKSB7XG4gICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3d2NpLnJlcGV0aXRpb25zOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnRlbnQucHVzaCh3aWRnZXRUb1dpZGdldEluc3RhbmNlKGMsIHsuLi5jb250ZXh0LCAnJHJlcGV0aXRpb24nOiBpfSwgdHMsIHZhcmlhYmxlcykpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29udGVudC5wdXNoKHdpZGdldFRvV2lkZ2V0SW5zdGFuY2UoYywgY29udGV4dCwgdHMsIHZhcmlhYmxlcykpO1xuICAgICAgfVxuICAgICAgd3djaS5jb250ZW50ID0gY29udGVudDtcbiAgICB9KTtcbiAgfSBlbHNlIGlmICh3aWRnZXQud2lkZ2V0VHlwZSA9PT0gQWpmV2lkZ2V0VHlwZS5DaGFydCkge1xuICAgIGNvbnN0IGN3ID0gey4uLntvcHRpb246IHt9fSwgLi4uKHdpZGdldCBhcyBBamZDaGFydFdpZGdldCl9O1xuICAgIGNvbnN0IGN3aSA9IHdpIGFzIEFqZkNoYXJ0V2lkZ2V0SW5zdGFuY2U7XG4gICAgY29uc3QgbGFiZWxzID0gY3cubGFiZWxzIGluc3RhbmNlb2YgQXJyYXkgPyBjdy5sYWJlbHMgOiBbY3cubGFiZWxzXTtcbiAgICBjb25zdCBldkxhYmVscyA9IGxhYmVscy5tYXAobCA9PiB7XG4gICAgICBsZXQgZXZmID0gZXZhbHVhdGVFeHByZXNzaW9uKGwuZm9ybXVsYSwgY29udGV4dCk7XG4gICAgICB0cnkge1xuICAgICAgICBpZiAoZXZmIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICBldmYgPSBldmYubWFwKHYgPT5cbiAgICAgICAgICAgIHYgIT0gbnVsbCAmJiB0eXBlb2YgdiA9PT0gJ3N0cmluZycgJiYgdi50cmltKCkubGVuZ3RoID4gMCA/IHRzLnRyYW5zbGF0ZSh2KSA6IHYsXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBldmYgPVxuICAgICAgICAgICAgZXZmICE9IG51bGwgJiYgdHlwZW9mIGV2ZiA9PT0gJ3N0cmluZycgJiYgZXZmLnRyaW0oKS5sZW5ndGggPiAwXG4gICAgICAgICAgICAgID8gdHMudHJhbnNsYXRlKGV2ZilcbiAgICAgICAgICAgICAgOiBldmY7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKF9lKSB7fVxuICAgICAgcmV0dXJuIGV2ZjtcbiAgICB9KTtcbiAgICBjd2kubGFiZWxzID0gY3cubGFiZWxzIGluc3RhbmNlb2YgQXJyYXkgPyBldkxhYmVscyA6IGV2TGFiZWxzWzBdO1xuICAgIGN3aS5kYXRhc2V0cyA9IGN3LmRhdGFzZXQubWFwKGQgPT4ge1xuICAgICAgbGV0IGRzOiBhbnkgPSB7XG4gICAgICAgIC4uLihkLm9wdGlvbnMgfHwge30pLFxuICAgICAgICBkYXRhOiBldmFsdWF0ZUFnZ3JlZ2F0aW9uKGQuYWdncmVnYXRpb24sIGQuZm9ybXVsYSwgY29udGV4dCksXG4gICAgICB9O1xuICAgICAgaWYgKGQuY2hhcnRUeXBlICE9IG51bGwpIHtcbiAgICAgICAgY29uc3QgY3QgPSBjaGFydFRvQ2hhcnRKc1R5cGUoZC5jaGFydFR5cGUpO1xuICAgICAgICBkcyA9IHsuLi5kcywgY2hhcnRUeXBlOiBjdCwgdHlwZTogY3R9O1xuICAgICAgfVxuICAgICAgaWYgKGQub3B0aW9ucyAhPSBudWxsKSB7XG4gICAgICAgIGRzID0gey4uLmRzLCBvcHRpb25zOiBkLm9wdGlvbnN9O1xuICAgICAgfVxuICAgICAgaWYgKGQubGFiZWwgIT0gbnVsbCkge1xuICAgICAgICBkcyA9IHsuLi5kcywgbGFiZWw6IGQubGFiZWwudHJpbSgpLmxlbmd0aCA+IDAgPyB0cy50cmFuc2xhdGUoZC5sYWJlbCkgOiBkLmxhYmVsfTtcbiAgICAgIH1cbiAgICAgIGlmIChkLmRhdGFsYWJlbHMgIT0gbnVsbCkge1xuICAgICAgICBkcy5kYXRhbGFiZWxzID0gZGVlcENvcHkoZC5kYXRhbGFiZWxzKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBkcztcbiAgICB9KTtcbiAgICBjd2kuZGF0YSA9IHtsYWJlbHM6IGN3aS5sYWJlbHMsIGRhdGFzZXRzOiBjd2kuZGF0YXNldHN9O1xuICAgIGN3aS5jaGFydFR5cGUgPSBjaGFydFRvQ2hhcnRKc1R5cGUoY3cudHlwZSB8fCBjdy5jaGFydFR5cGUpO1xuICAgIGN3aS5leHBvcnRhYmxlID1cbiAgICAgIGN3LmV4cG9ydGFibGUgJiYgKGN3LmV4cG9ydGFibGUgPT09IHRydWUgfHwgY3cuZXhwb3J0YWJsZSA9PT0gJ3RydWUnKSA/IHRydWUgOiBmYWxzZTtcbiAgICBpZiAoY3cub3B0aW9ucyAhPSBudWxsICYmIGN3Lm9wdGlvbnMucGx1Z2lucyAhPSBudWxsKSB7XG4gICAgICBjb25zdCBwbHVnaW5zID0gY3cub3B0aW9ucy5wbHVnaW5zO1xuICAgICAgY29uc3QgcGx1Z2luTmFtZXMgPSBPYmplY3Qua2V5cyhwbHVnaW5zKTtcbiAgICAgIHBsdWdpbk5hbWVzLmZvckVhY2gocGx1Z2luTmFtZSA9PiB7XG4gICAgICAgIGNvbnN0IHBsdWdpbiA9IHBsdWdpbnNbcGx1Z2luTmFtZV07XG4gICAgICAgIGNvbnN0IHBsdWdpbk9wdGlvbnMgPSBPYmplY3Qua2V5cyhwbHVnaW4pO1xuICAgICAgICBwbHVnaW5PcHRpb25zLmZvckVhY2goKHBsdWdpbk9wdGlvbk5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgICAgIGNvbnN0IHBsdWdpbk9wdGlvbiA9IHBsdWdpbltwbHVnaW5PcHRpb25OYW1lXTtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICB0eXBlb2YgcGx1Z2luT3B0aW9uICE9PSAnc3RyaW5nJyAmJlxuICAgICAgICAgICAgcGx1Z2luT3B0aW9uICE9IG51bGwgJiZcbiAgICAgICAgICAgIHBsdWdpbk9wdGlvbi5mb3JtdWxhICE9IG51bGxcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHBsdWdpbltwbHVnaW5PcHRpb25OYW1lXSA9IGV2YWx1YXRlRXhwcmVzc2lvbihwbHVnaW5PcHRpb24uZm9ybXVsYSwgY29udGV4dCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSBlbHNlIGlmICh3aWRnZXQud2lkZ2V0VHlwZSA9PT0gQWpmV2lkZ2V0VHlwZS5UYWJsZSkge1xuICAgIGNvbnN0IHR3ID0gd2lkZ2V0IGFzIEFqZlRhYmxlV2lkZ2V0O1xuICAgIGNvbnN0IHR3aSA9IHdpIGFzIEFqZlRhYmxlV2lkZ2V0SW5zdGFuY2U7XG5cbiAgICB0d2kuZGF0YXNldCA9IHR3LmRhdGFzZXQubWFwKHJvdyA9PlxuICAgICAgcm93Lm1hcChjZWxsID0+IHtcbiAgICAgICAgcmV0dXJuIGNlbGwuZm9ybXVsYSBpbnN0YW5jZW9mIEFycmF5XG4gICAgICAgICAgPyBjZWxsLmZvcm11bGEubWFwKGYgPT4gdHJGb3JtdWxhKGYgYXMgQWpmRm9ybXVsYSwgY29udGV4dCBhcyBBamZDb250ZXh0LCB0cykpXG4gICAgICAgICAgOiB0ckZvcm11bGEoY2VsbC5mb3JtdWxhISwgY29udGV4dCBhcyBBamZDb250ZXh0LCB0cyk7XG4gICAgICB9KSxcbiAgICApO1xuICAgIHR3aS5leHBvcnRhYmxlID1cbiAgICAgIHR3LmV4cG9ydGFibGUgJiYgKHR3LmV4cG9ydGFibGUgPT09IHRydWUgfHwgdHcuZXhwb3J0YWJsZSA9PT0gJ3RydWUnKSA/IHRydWUgOiBmYWxzZTtcbiAgICB0d2kuZGF0YSA9ICh0dy5kYXRhc2V0IHx8IFtdKS5tYXAocm93ID0+XG4gICAgICByb3cubWFwKGNlbGwgPT4ge1xuICAgICAgICBsZXQgZXZmID0gJyc7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgZXZmID1cbiAgICAgICAgICAgIGNlbGwuZm9ybXVsYSBpbnN0YW5jZW9mIEFycmF5XG4gICAgICAgICAgICAgID8gY2VsbC5mb3JtdWxhLm1hcChmID0+IHRyRm9ybXVsYShmIGFzIEFqZkZvcm11bGEsIGNvbnRleHQgYXMgQWpmQ29udGV4dCwgdHMpKVxuICAgICAgICAgICAgICA6IHRyRm9ybXVsYShjZWxsLmZvcm11bGEhLCBjb250ZXh0IGFzIEFqZkNvbnRleHQsIHRzKTtcbiAgICAgICAgfSBjYXRjaCAoX2UpIHt9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdmFsdWU6IGV2ZixcbiAgICAgICAgICBzdHlsZTogey4uLnR3LmNlbGxTdHlsZXMsIC4uLmNlbGwuc3R5bGV9LFxuICAgICAgICAgIHJvd3NwYW46IGNlbGwucm93c3BhbixcbiAgICAgICAgICBjb2xzcGFuOiBjZWxsLmNvbHNwYW4sXG4gICAgICAgIH07XG4gICAgICB9KSxcbiAgICApO1xuICB9IGVsc2UgaWYgKHdpZGdldC53aWRnZXRUeXBlID09PSBBamZXaWRnZXRUeXBlLkR5bmFtaWNUYWJsZSkge1xuICAgIGNvbnN0IHRkdyA9IHdpZGdldCBhcyBBamZEeW5hbWljVGFibGVXaWRnZXQ7XG4gICAgY29uc3QgdGR3aSA9IHdpIGFzIEFqZlRhYmxlV2lkZ2V0SW5zdGFuY2U7XG5cbiAgICB0ZHdpLmRhdGFzZXQgPSB0ZHcuZGF0YXNldC5tYXAoKGNlbGw6IEFqZlRhYmxlRGF0YXNldCkgPT4ge1xuICAgICAgcmV0dXJuIGNlbGwuZm9ybXVsYSBpbnN0YW5jZW9mIEFycmF5XG4gICAgICAgID8gY2VsbC5mb3JtdWxhLm1hcChmID0+IHRyRm9ybXVsYShmIGFzIEFqZkZvcm11bGEsIGNvbnRleHQsIHRzKSlcbiAgICAgICAgOiB0ckZvcm11bGEoY2VsbC5mb3JtdWxhISwgY29udGV4dCwgdHMpO1xuICAgIH0pO1xuICAgIHRkd2kuZXhwb3J0YWJsZSA9XG4gICAgICB0ZHcuZXhwb3J0YWJsZSAmJiAodGR3LmV4cG9ydGFibGUgPT09IHRydWUgfHwgdGR3LmV4cG9ydGFibGUgPT09ICd0cnVlJykgPyB0cnVlIDogZmFsc2U7XG5cbiAgICBsZXQgZGF0YXNldDogQWpmVGFibGVDZWxsW11bXSA9IGV2YWx1YXRlRXhwcmVzc2lvbih0ZHcucm93RGVmaW5pdGlvbi5mb3JtdWxhLCBjb250ZXh0KSB8fCBbXTtcbiAgICBkYXRhc2V0ID0gKGRhdGFzZXQgfHwgW10pLm1hcCgocm93OiBBamZUYWJsZUNlbGxbXSkgPT5cbiAgICAgIHJvdy5tYXAoY2VsbCA9PiB7XG4gICAgICAgIGxldCB0cmYgPSBjZWxsLnZhbHVlO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGlmICh0cmYgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgdHJmID0gdHJmLm1hcCh2ID0+XG4gICAgICAgICAgICAgIHYgIT0gbnVsbCAmJiB0eXBlb2YgdiA9PT0gJ3N0cmluZycgJiYgdi50cmltKCkubGVuZ3RoID4gMCA/IHRzLnRyYW5zbGF0ZSh2KSA6IHYsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0cmYgPVxuICAgICAgICAgICAgICB0cmYgIT0gbnVsbCAmJiB0eXBlb2YgdHJmID09PSAnc3RyaW5nJyAmJiB0cmYudHJpbSgpLmxlbmd0aCA+IDBcbiAgICAgICAgICAgICAgICA/IHRzLnRyYW5zbGF0ZSh0cmYpXG4gICAgICAgICAgICAgICAgOiB0cmY7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChfZSkge31cbiAgICAgICAgcmV0dXJuIHsuLi5jZWxsLCB2YWx1ZTogdHJmfTtcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICBjb25zdCBoZWFkZXIgPSAodGR3LmRhdGFzZXQgfHwgW10pLm1hcChjZWxsID0+IHtcbiAgICAgIGxldCBldmYgPSAnJztcbiAgICAgIHRyeSB7XG4gICAgICAgIGV2ZiA9XG4gICAgICAgICAgY2VsbC5mb3JtdWxhIGluc3RhbmNlb2YgQXJyYXlcbiAgICAgICAgICAgID8gY2VsbC5mb3JtdWxhLm1hcChmID0+IHRyRm9ybXVsYShmIGFzIEFqZkZvcm11bGEsIGNvbnRleHQgYXMgQWpmQ29udGV4dCwgdHMpKVxuICAgICAgICAgICAgOiB0ckZvcm11bGEoY2VsbC5mb3JtdWxhISwgY29udGV4dCBhcyBBamZDb250ZXh0LCB0cyk7XG4gICAgICB9IGNhdGNoIChfZSkge31cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZhbHVlOiBldmYsXG4gICAgICAgIHN0eWxlOiB7Li4udGR3LmNlbGxTdHlsZXMsIC4uLmNlbGwuc3R5bGV9LFxuICAgICAgICByb3dzcGFuOiBjZWxsLnJvd3NwYW4sXG4gICAgICAgIGNvbHNwYW46IGNlbGwuY29sc3BhbixcbiAgICAgIH07XG4gICAgfSk7XG4gICAgdGR3aS5kYXRhID0gaGVhZGVyLmxlbmd0aCA9PT0gMCA/IFsuLi5kYXRhc2V0XSA6IFtbLi4uaGVhZGVyXSwgLi4uZGF0YXNldF07XG4gIH0gZWxzZSBpZiAod2lkZ2V0LndpZGdldFR5cGUgPT09IEFqZldpZGdldFR5cGUuSW1hZ2UpIHtcbiAgICBjb25zdCBpdyA9IHdpZGdldCBhcyBBamZJbWFnZVdpZGdldDtcbiAgICBjb25zdCBpd2kgPSB3aSBhcyBBamZJbWFnZVdpZGdldEluc3RhbmNlO1xuICAgIGlmIChpdy5mbGFnKSB7XG4gICAgICBpd2kuZmxhZyA9IGV2YWx1YXRlRXhwcmVzc2lvbihpdy5mbGFnLmZvcm11bGEsIGNvbnRleHQpO1xuICAgIH1cbiAgICBpZiAoaXcuaWNvbikge1xuICAgICAgaXdpLmljb24gPSBldmFsdWF0ZUV4cHJlc3Npb24oaXcuaWNvbi5mb3JtdWxhLCBjb250ZXh0KTtcbiAgICB9XG4gICAgaWYgKGl3LnVybCkge1xuICAgICAgaXdpLnVybCA9IGV2YWx1YXRlRXhwcmVzc2lvbihpdy51cmwuZm9ybXVsYSwgY29udGV4dCk7XG4gICAgfVxuICB9IGVsc2UgaWYgKHdpZGdldC53aWRnZXRUeXBlID09PSBBamZXaWRnZXRUeXBlLkltYWdlQ29udGFpbmVyKSB7XG4gICAgY29uc3QgaWN3ID0gd2lkZ2V0IGFzIEFqZkltYWdlQ29udGFpbmVyV2lkZ2V0O1xuICAgIGNvbnN0IGljd2kgPSB3aSBhcyBBamZJbWFnZUNvbnRhaW5lcldpZGdldEluc3RhbmNlO1xuICAgIGlmIChpY3cuZmxhZ3MpIHtcbiAgICAgIGljd2kuZmxhZ3MgPVxuICAgICAgICBpY3cuZmxhZ3MgaW5zdGFuY2VvZiBBcnJheVxuICAgICAgICAgID8gaWN3LmZsYWdzLm1hcChmID0+IGV2YWx1YXRlRXhwcmVzc2lvbihmLmZvcm11bGEsIGNvbnRleHQpKVxuICAgICAgICAgIDogZXZhbHVhdGVFeHByZXNzaW9uKGljdy5mbGFncy5mb3JtdWxhLCBjb250ZXh0KTtcbiAgICB9XG4gICAgaWYgKGljdy5pY29ucykge1xuICAgICAgaWN3aS5pY29ucyA9XG4gICAgICAgIGljdy5pY29ucyBpbnN0YW5jZW9mIEFycmF5XG4gICAgICAgICAgPyBpY3cuaWNvbnMubWFwKGYgPT4gZXZhbHVhdGVFeHByZXNzaW9uKGYuZm9ybXVsYSwgY29udGV4dCkpXG4gICAgICAgICAgOiBldmFsdWF0ZUV4cHJlc3Npb24oaWN3Lmljb25zLmZvcm11bGEsIGNvbnRleHQpO1xuICAgIH1cbiAgICBpZiAoaWN3LnVybHMpIHtcbiAgICAgIGljd2kudXJscyA9XG4gICAgICAgIGljdy51cmxzIGluc3RhbmNlb2YgQXJyYXlcbiAgICAgICAgICA/IGljdy51cmxzLm1hcChmID0+IGV2YWx1YXRlRXhwcmVzc2lvbihmLmZvcm11bGEsIGNvbnRleHQpKVxuICAgICAgICAgIDogZXZhbHVhdGVFeHByZXNzaW9uKGljdy51cmxzLmZvcm11bGEsIGNvbnRleHQpO1xuICAgIH1cbiAgfSBlbHNlIGlmICh3aWRnZXQud2lkZ2V0VHlwZSA9PT0gQWpmV2lkZ2V0VHlwZS5UZXh0KSB7XG4gICAgY29uc3QgdGV3ID0gd2lkZ2V0IGFzIEFqZlRleHRXaWRnZXQ7XG4gICAgY29uc3QgdGV3aSA9IHdpIGFzIEFqZlRleHRXaWRnZXRJbnN0YW5jZTtcbiAgICBjb25zdCBmb3JtdWxhUmVnRXg6IFJlZ0V4cCA9IC9cXFt7Mn0oLis/KVxcXXsyfS9nO1xuICAgIGNvbnN0IG1hdGNoZXM6IHtpZHg6IG51bWJlcjsgbGVuOiBudW1iZXI7IGZvcm11bGE6IEFqZkZvcm11bGF9W10gPSBbXTtcbiAgICBsZXQgbWF0Y2g6IFJlZ0V4cEV4ZWNBcnJheSB8IG51bGw7XG4gICAgbGV0IGh0bWxUZXh0ID0gdGV3Lmh0bWxUZXh0O1xuICAgIHdoaWxlICgobWF0Y2ggPSBmb3JtdWxhUmVnRXguZXhlYyhodG1sVGV4dCkpKSB7XG4gICAgICBjb25zdCBpZHggPSBtYXRjaC5pbmRleDtcbiAgICAgIGNvbnN0IGxlbiA9IG1hdGNoWzBdLmxlbmd0aDtcbiAgICAgIGNvbnN0IGZvcm11bGEgPSBjcmVhdGVGb3JtdWxhKHtmb3JtdWxhOiBtYXRjaFsxXX0pO1xuICAgICAgbWF0Y2hlcy5wdXNoKHtpZHgsIGxlbiwgZm9ybXVsYX0pO1xuICAgIH1cbiAgICBtYXRjaGVzLnJldmVyc2UoKS5mb3JFYWNoKG0gPT4ge1xuICAgICAgbGV0IGNhbGNWYWx1ZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNhbGNWYWx1ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihtLmZvcm11bGEuZm9ybXVsYSwgY29udGV4dCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNhbGNWYWx1ZSA9ICcnO1xuICAgICAgfVxuICAgICAgaHRtbFRleHQgPSBgJHtodG1sVGV4dC5zdWJzdHIoMCwgbS5pZHgpfSR7Y2FsY1ZhbHVlfSR7aHRtbFRleHQuc3Vic3RyKG0uaWR4ICsgbS5sZW4pfWA7XG4gICAgfSk7XG4gICAgdGV3aS5odG1sVGV4dCA9IGh0bWxUZXh0ICE9IG51bGwgJiYgaHRtbFRleHQubGVuZ3RoID4gMCA/IHRzLnRyYW5zbGF0ZShodG1sVGV4dCkgOiBodG1sVGV4dDtcbiAgfSBlbHNlIGlmICh3aWRnZXQud2lkZ2V0VHlwZSA9PT0gQWpmV2lkZ2V0VHlwZS5Gb3JtdWxhKSB7XG4gICAgY29uc3QgZncgPSB3aWRnZXQgYXMgQWpmRm9ybXVsYVdpZGdldDtcbiAgICBjb25zdCBmd2kgPSB3aSBhcyBBamZGb3JtdWxhV2lkZ2V0SW5zdGFuY2U7XG4gICAgZndpLmZvcm11bGEgPSBldmFsdWF0ZUV4cHJlc3Npb24oZncuZm9ybXVsYS5mb3JtdWxhLCBjb250ZXh0KTtcbiAgfSBlbHNlIGlmICh3aWRnZXQud2lkZ2V0VHlwZSA9PT0gQWpmV2lkZ2V0VHlwZS5NYXApIHtcbiAgICBjb25zdCBtdyA9IHdpZGdldCBhcyBBamZNYXBXaWRnZXQ7XG4gICAgY29uc3QgbXdpID0gd2kgYXMgQWpmTWFwV2lkZ2V0SW5zdGFuY2U7XG4gICAgbXdpLmNvb3JkaW5hdGUgPSBldmFsdWF0ZUV4cHJlc3Npb24obXcuY29vcmRpbmF0ZS5mb3JtdWxhLCBjb250ZXh0KTtcbiAgfSBlbHNlIGlmICh3aWRnZXQud2lkZ2V0VHlwZSA+IDEwMCkge1xuICAgIGNvbnN0IGlpRm4gPVxuICAgICAgY29tcG9uZW50c01hcFt3aWRnZXQud2lkZ2V0VHlwZV0gIT0gbnVsbFxuICAgICAgICA/IGNvbXBvbmVudHNNYXBbd2lkZ2V0LndpZGdldFR5cGVdLmluaXRJbnN0YW5jZVxuICAgICAgICA6IG51bGw7XG4gICAgaWYgKGlpRm4gIT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGlpRm4od2ksIGNvbnRleHQsIHRzKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHdpO1xufVxuIl19