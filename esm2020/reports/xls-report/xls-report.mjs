/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { createFormula } from '@ajf/core/models';
import { deepCopy } from '@ajf/core/utils';
import { forkJoin } from 'rxjs';
import { map } from 'rxjs/operators';
import * as XLSX from 'xlsx';
import { backgroundColor } from '../automatic-report/styles';
import { indicatorToJs } from './hindikit-parser';
import { htmlWidget, widgetStyle } from './styles';
import { createDataset } from '../utils/dataset/create-dataset';
import { createReportContainer } from '../utils/reports/create-report-container';
import { createWidget } from '../utils/widgets/create-widget';
import { AjfWidgetType } from '../interface/widgets/widget-type';
import { AjfChartType } from '../interface/charts/chart-type';
/**
 * This function returns a basic report for any form passed in input.
 *
 * @param form the form schema
 * @param [id] the id of the form inside the plathform.
 */
export function xlsReport(file, http) {
    const workbook = XLSX.read(file, { type: 'binary' });
    const report = {};
    const reportWidgets = [];
    const variables = [];
    const filters = {};
    // create filters
    workbook.SheetNames.forEach((sheetName, index) => {
        const sheet = workbook.Sheets[sheetName];
        if (sheetName.includes('filter') && index + 1 < workbook.SheetNames.length) {
            const nextSheet = sheetName.includes('global')
                ? 'global_filter'
                : workbook.SheetNames[index + 1];
            filters[nextSheet] = _buildFilter(workbook, sheet, http);
        }
    });
    const obsFilterValues = Object.values(filters);
    const filterNames = Object.keys(filters);
    return forkJoin(obsFilterValues.length > 0 ? obsFilterValues : []).pipe(map(f => {
        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet);
            if (sheetName === 'variables') {
                json
                    .filter(e => e != null && e.name != null && e.value != null)
                    .forEach(elem => {
                    let indicator = elem.value;
                    try {
                        indicator = indicatorToJs(elem.value);
                    }
                    catch (e) {
                        console.log(e);
                    }
                    variables.push({
                        name: elem.name,
                        formula: { formula: indicator },
                    });
                });
            }
            else {
                const idx = filterNames.indexOf(sheetName);
                if (sheetName.includes('table')) {
                    const tableWidget = _buildTable(json);
                    reportWidgets.push(tableWidget);
                }
                else if (sheetName.includes('chart')) {
                    const chartWidget = _buildChart(sheetName, json);
                    reportWidgets.push(chartWidget);
                }
                else if (sheetName.includes('html')) {
                    const chartWidget = _buildHtml(json);
                    reportWidgets.push(chartWidget);
                }
                if (idx >= 0) {
                    reportWidgets[reportWidgets.length - 1].filter = {
                        schema: f[idx],
                    };
                }
            }
        });
        const globalFilterIdx = filterNames.indexOf('global_filter');
        const layoutWidget = {
            widgetType: AjfWidgetType.Layout,
            content: [
                createWidget({
                    widgetType: AjfWidgetType.Column,
                    content: [...reportWidgets],
                    filter: globalFilterIdx >= 0 ? { schema: f[globalFilterIdx] } : undefined,
                }),
            ],
            columns: [1],
            visibility: {
                condition: 'true',
            },
            styles: {},
        };
        report.variables = variables;
        report.content = createReportContainer(layoutWidget);
        return report;
    }));
}
function _buildFilter(wbook, sheet, http) {
    const data = new FormData();
    const filterBook = deepCopy(wbook);
    const filterSheet = deepCopy(sheet);
    const choicesSheet = deepCopy(wbook.Sheets['choices']);
    filterBook.SheetNames = ['survey', 'choices'];
    filterBook.Sheets = { survey: filterSheet, choices: choicesSheet };
    const filterXlsx = XLSX.write(filterBook, {
        bookType: 'xlsx',
        type: 'array',
    });
    const file = new File([filterXlsx], 'filter.xlsx');
    data.append('excelFile', file);
    return http.post('https://formconv.herokuapp.com/result.json', data);
}
function _buildChart(name, json) {
    const optionLabels = ['chartType', 'title'];
    const chartOptions = {};
    const datasetObj = {};
    const dataset = [];
    let labels = { formula: `[]` };
    if (json.length > 0) {
        const firstRow = json[0];
        optionLabels.forEach(optionLabel => {
            if (firstRow[optionLabel] != null) {
                chartOptions[optionLabel] = firstRow[optionLabel];
                delete firstRow[optionLabel];
            }
        });
    }
    json.forEach(row => {
        const rowKeys = Object.keys(row);
        rowKeys.forEach(rowKey => {
            const value = row[rowKey];
            if (datasetObj[rowKey] == null) {
                datasetObj[rowKey] = [value];
            }
            else {
                datasetObj[rowKey].push(value);
            }
        });
    });
    const doLabels = datasetObj['labels'];
    if (doLabels != null) {
        labels = {
            formula: `plainArray([${doLabels.map((label) => indicatorToJs(label))}])`,
        };
        delete datasetObj['labels'];
    }
    Object.keys(datasetObj).forEach((datasetObjKey, index) => {
        const datasetRow = datasetObj[datasetObjKey].map((r) => indicatorToJs(`${r}`));
        const chartType = chartOptions['chartType'];
        const colorCondition = chartType === 'Pie' || chartType === 'PolarArea' || chartType === 'Doughnut';
        const backColor = colorCondition ? backgroundColor : backgroundColor[index];
        const formula = [
            createFormula({ formula: `plainArray([${datasetRow.toString()}])` }),
        ];
        const datasetOptions = {
            backgroundColor: backColor,
        };
        dataset.push({
            ...createDataset({
                aggregation: { aggregation: 0 },
                formula,
                label: datasetObjKey,
            }),
            options: datasetOptions,
        });
    });
    return createWidget({
        name,
        widgetType: AjfWidgetType.Chart,
        type: AjfChartType[chartOptions['chartType']],
        labels,
        dataset,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: { display: true, position: 'bottom' },
            title: {
                display: true,
                text: `${chartOptions['title'] || ''}`.replace(/"/gi, ''),
            },
        },
        styles: {
            ...{ width: '100%', height: '100%', padding: '20px' },
            ...widgetStyle,
        },
        exportable: true,
    });
}
function _buildHtml(json) {
    const firstRow = json.length > 0 && json[0]['html'] != null ? json[0] : { html: '' };
    return createWidget({
        widgetType: AjfWidgetType.Text,
        htmlText: `${firstRow['html']}`,
        styles: htmlWidget,
    });
}
function _buildTable(json) {
    const rowspan = 1;
    const dataElements = [];
    const titles = Object.keys(json[0]);
    const colspans = Object.values(json[0]).map(r => +r);
    delete json[0];
    const tableHeader = titles.map((title, index) => ({
        label: '',
        formula: { formula: `\"${title}\"` },
        aggregation: { aggregation: 0 },
        colspan: colspans[index],
        rowspan,
        style: {
            textAlign: 'center',
            fontWeight: 'bold',
            color: 'white',
            backgroundColor: '#3f51b5',
        },
    }));
    json.forEach(row => {
        const elems = [];
        titles.forEach(title => {
            let elem = row[title] || `\"\"`;
            try {
                elem = indicatorToJs(elem);
            }
            catch (err) {
                elem = `${row[title]}`;
            }
            elems.push(elem.replace(/[\*\/\r\n]|@[\w-]+/g, ''));
        });
        dataElements.push(elems);
    });
    return createWidget({
        widgetType: AjfWidgetType.DynamicTable,
        rowDefinition: {
            formula: `buildDataset([${dataElements}],${JSON.stringify(colspans)})`,
        },
        dataset: tableHeader,
        exportable: true,
        cellStyles: {
            textAlign: 'center',
            color: 'black',
            backgroundColor: 'white',
        },
        styles: {
            borderCollapse: 'collapse',
        },
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieGxzLXJlcG9ydC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NvcmUvcmVwb3J0cy9zcmMveGxzLXJlcG9ydC94bHMtcmVwb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUVILE9BQU8sRUFBYSxhQUFhLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUMzRCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFHekMsT0FBTyxFQUFDLFFBQVEsRUFBYSxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkMsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFFN0IsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLDRCQUE0QixDQUFDO0FBRTNELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUNoRCxPQUFPLEVBQUMsVUFBVSxFQUFFLFdBQVcsRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUNqRCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0saUNBQWlDLENBQUM7QUFDOUQsT0FBTyxFQUFDLHFCQUFxQixFQUFDLE1BQU0sMENBQTBDLENBQUM7QUFDL0UsT0FBTyxFQUFrQixZQUFZLEVBQUMsTUFBTSxnQ0FBZ0MsQ0FBQztBQUM3RSxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sa0NBQWtDLENBQUM7QUFJL0QsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLGdDQUFnQyxDQUFDO0FBTzVEOzs7OztHQUtHO0FBQ0gsTUFBTSxVQUFVLFNBQVMsQ0FBQyxJQUFZLEVBQUUsSUFBZ0I7SUFDdEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBQyxJQUFJLEVBQUUsUUFBUSxFQUFDLENBQUMsQ0FBQztJQUNuRCxNQUFNLE1B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QUNaLElBQUksR0FBRyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO2FBQ3hCO1lBQ0QsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLHFCQUFxQixFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdEQsQ0FBQyxDQUFDLENBQUM7UUFDSCxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzNCLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxZQUFZLENBQUM7UUFDbEIsVUFBVSxFQUFFLGFBQWEsQ0FBQyxZQUFZO1FBQ3RDLGFBQWEsRUFBRTtZQUNiLE9BQU8sRUFBRSxpQkFBaUIsWUFBWSxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEdBQUc7U0FDdkU7UUFDRCxPQUFPLEVBQUUsV0FBVztRQUNwQixVQUFVLEVBQUUsSUFBSTtRQUNoQixVQUFVLEVBQUU7WUFDVixTQUFTLEVBQUUsUUFBUTtZQUNuQixLQUFLLEVBQUUsT0FBTztZQUNkLGVBQWUsRUFBRSxPQUFPO1NBQ3pCO1FBQ0QsTUFBTSxFQUFFO1lBQ04sY0FBYyxFQUFFLFVBQVU7U0FDM0I7S0FDRixDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChDKSBHbnVjb29wIHNvYy4gY29vcC5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vclxuICogbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzXG4gKiBwdWJsaXNoZWQgYnkgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSxcbiAqIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlUgQWZmZXJvXG4gKiBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKiBJZiBub3QsIHNlZSBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvLlxuICpcbiAqL1xuXG5pbXBvcnQge0FqZkZvcm11bGEsIGNyZWF0ZUZvcm11bGF9IGZyb20gJ0BhamYvY29yZS9tb2RlbHMnO1xuaW1wb3J0IHtkZWVwQ29weX0gZnJvbSAnQGFqZi9jb3JlL3V0aWxzJztcbmltcG9ydCB7SHR0cENsaWVudH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtDaGFydENvbG9yfSBmcm9tICdjaGFydC5qcyc7XG5pbXBvcnQge2ZvcmtKb2luLCBPYnNlcnZhYmxlfSBmcm9tICdyeGpzJztcbmltcG9ydCB7bWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgKiBhcyBYTFNYIGZyb20gJ3hsc3gnO1xuXG5pbXBvcnQge2JhY2tncm91bmRDb2xvcn0gZnJvbSAnLi4vYXV0b21hdGljLXJlcG9ydC9zdHlsZXMnO1xuXG5pbXBvcnQge2luZGljYXRvclRvSnN9IGZyb20gJy4vaGluZGlraXQtcGFyc2VyJztcbmltcG9ydCB7aHRtbFdpZGdldCwgd2lkZ2V0U3R5bGV9IGZyb20gJy4vc3R5bGVzJztcbmltcG9ydCB7Y3JlYXRlRGF0YXNldH0gZnJvbSAnLi4vdXRpbHMvZGF0YXNldC9jcmVhdGUtZGF0YXNldCc7XG5pbXBvcnQge2NyZWF0ZVJlcG9ydENvbnRhaW5lcn0gZnJvbSAnLi4vdXRpbHMvcmVwb3J0cy9jcmVhdGUtcmVwb3J0LWNvbnRhaW5lcic7XG5pbXBvcnQge0FqZldpZGdldENyZWF0ZSwgY3JlYXRlV2lkZ2V0fSBmcm9tICcuLi91dGlscy93aWRnZXRzL2NyZWF0ZS13aWRnZXQnO1xuaW1wb3J0IHtBamZXaWRnZXRUeXBlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy93aWRnZXQtdHlwZSc7XG5pbXBvcnQge0FqZlRhYmxlRGF0YXNldH0gZnJvbSAnLi4vaW50ZXJmYWNlL2RhdGFzZXQvdGFibGUtZGF0YXNldCc7XG5pbXBvcnQge0FqZkNoYXJ0RGF0YXNldH0gZnJvbSAnLi4vaW50ZXJmYWNlL2RhdGFzZXQvY2hhcnQtZGF0YXNldCc7XG5pbXBvcnQge0FqZkNoYXJ0RGF0YXNldE9wdGlvbnN9IGZyb20gJy4uL2ludGVyZmFjZS9kYXRhc2V0L2NoYXJ0LWRhdGFzZXQtb3B0aW9ucyc7XG5pbXBvcnQge0FqZkNoYXJ0VHlwZX0gZnJvbSAnLi4vaW50ZXJmYWNlL2NoYXJ0cy9jaGFydC10eXBlJztcbmltcG9ydCB7QWpmV2lkZ2V0fSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy93aWRnZXQnO1xuaW1wb3J0IHtBamZSZXBvcnR9IGZyb20gJy4uL2ludGVyZmFjZS9yZXBvcnRzL3JlcG9ydCc7XG5pbXBvcnQge0FqZlJlcG9ydFZhcmlhYmxlfSBmcm9tICcuLi9pbnRlcmZhY2UvcmVwb3J0cy9yZXBvcnQtdmFyaWFibGUnO1xuaW1wb3J0IHtBamZMYXlvdXRXaWRnZXR9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzL2xheW91dC13aWRnZXQnO1xuaW1wb3J0IHtBamZDb2x1bW5XaWRnZXR9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzL2NvbHVtbi13aWRnZXQnO1xuXG4vKipcbiAqIFRoaXMgZnVuY3Rpb24gcmV0dXJucyBhIGJhc2ljIHJlcG9ydCBmb3IgYW55IGZvcm0gcGFzc2VkIGluIGlucHV0LlxuICpcbiAqIEBwYXJhbSBmb3JtIHRoZSBmb3JtIHNjaGVtYVxuICogQHBhcmFtIFtpZF0gdGhlIGlkIG9mIHRoZSBmb3JtIGluc2lkZSB0aGUgcGxhdGhmb3JtLlxuICovXG5leHBvcnQgZnVuY3Rpb24geGxzUmVwb3J0KGZpbGU6IHN0cmluZywgaHR0cDogSHR0cENsaWVudCk6IE9ic2VydmFibGU8QWpmUmVwb3J0PiB7XG4gIGNvbnN0IHdvcmtib29rID0gWExTWC5yZWFkKGZpbGUsIHt0eXBlOiAnYmluYXJ5J30pO1xuICBjb25zdCByZXBvcnQ6IEFqZlJlcG9ydCA9IHt9O1xuICBjb25zdCByZXBvcnRXaWRnZXRzOiBBamZXaWRnZXRbXSA9IFtdO1xuXG4gIGNvbnN0IHZhcmlhYmxlczogQWpmUmVwb3J0VmFyaWFibGVbXSA9IFtdO1xuICBjb25zdCBmaWx0ZXJzOiB7W3NoZWV0TmFtZTogc3RyaW5nXTogT2JzZXJ2YWJsZTxhbnk+fSA9IHt9O1xuICAvLyBjcmVhdGUgZmlsdGVyc1xuICB3b3JrYm9vay5TaGVldE5hbWVzLmZvckVhY2goKHNoZWV0TmFtZSwgaW5kZXgpID0+IHtcbiAgICBjb25zdCBzaGVldDogWExTWC5Xb3JrU2hlZXQgPSB3b3JrYm9vay5TaGVldHNbc2hlZXROYW1lXTtcbiAgICBpZiAoc2hlZXROYW1lLmluY2x1ZGVzKCdmaWx0ZXInKSAmJiBpbmRleCArIDEgPCB3b3JrYm9vay5TaGVldE5hbWVzLmxlbmd0aCkge1xuICAgICAgY29uc3QgbmV4dFNoZWV0ID0gc2hlZXROYW1lLmluY2x1ZGVzKCdnbG9iYWwnKVxuICAgICAgICA/ICdnbG9iYWxfZmlsdGVyJ1xuICAgICAgICA6IHdvcmtib29rLlNoZWV0TmFtZXNbaW5kZXggKyAxXTtcbiAgICAgIGZpbHRlcnNbbmV4dFNoZWV0XSA9IF9idWlsZEZpbHRlcih3b3JrYm9vaywgc2hlZXQsIGh0dHApO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3Qgb2JzRmlsdGVyVmFsdWVzOiBPYnNlcnZhYmxlPGFueT5bXSA9IE9iamVjdC52YWx1ZXMoZmlsdGVycyk7XG4gIGNvbnN0IGZpbHRlck5hbWVzOiBzdHJpbmdbXSA9IE9iamVjdC5rZXlzKGZpbHRlcnMpO1xuXG4gIHJldHVybiBmb3JrSm9pbihvYnNGaWx0ZXJWYWx1ZXMubGVuZ3RoID4gMCA/IG9ic0ZpbHRlclZhbHVlcyA6IFtdKS5waXBlKFxuICAgIG1hcChmID0+IHtcbiAgICAgIHdvcmtib29rLlNoZWV0TmFtZXMuZm9yRWFjaChzaGVldE5hbWUgPT4ge1xuICAgICAgICBjb25zdCBzaGVldDogWExTWC5Xb3JrU2hlZXQgPSB3b3JrYm9vay5TaGVldHNbc2hlZXROYW1lXTtcbiAgICAgICAgY29uc3QganNvbiA9IFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCkgYXMge1xuICAgICAgICAgIG5hbWU6IHN0cmluZztcbiAgICAgICAgICB2YWx1ZTogc3RyaW5nO1xuICAgICAgICB9W107XG5cbiAgICAgICAgaWYgKHNoZWV0TmFtZSA9PT0gJ3ZhcmlhYmxlcycpIHtcbiAgICAgICAgICBqc29uXG4gICAgICAgICAgICAuZmlsdGVyKGUgPT4gZSAhPSBudWxsICYmIGUubmFtZSAhPSBudWxsICYmIGUudmFsdWUgIT0gbnVsbClcbiAgICAgICAgICAgIC5mb3JFYWNoKGVsZW0gPT4ge1xuICAgICAgICAgICAgICBsZXQgaW5kaWNhdG9yID0gZWxlbS52YWx1ZTtcbiAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBpbmRpY2F0b3IgPSBpbmRpY2F0b3JUb0pzKGVsZW0udmFsdWUpO1xuICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgdmFyaWFibGVzLnB1c2goe1xuICAgICAgICAgICAgICAgIG5hbWU6IGVsZW0ubmFtZSxcbiAgICAgICAgICAgICAgICBmb3JtdWxhOiB7Zm9ybXVsYTogaW5kaWNhdG9yfSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBpZHggPSBmaWx0ZXJOYW1lcy5pbmRleE9mKHNoZWV0TmFtZSk7XG5cbiAgICAgICAgICBpZiAoc2hlZXROYW1lLmluY2x1ZGVzKCd0YWJsZScpKSB7XG4gICAgICAgICAgICBjb25zdCB0YWJsZVdpZGdldCA9IF9idWlsZFRhYmxlKGpzb24pO1xuICAgICAgICAgICAgcmVwb3J0V2lkZ2V0cy5wdXNoKHRhYmxlV2lkZ2V0KTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHNoZWV0TmFtZS5pbmNsdWRlcygnY2hhcnQnKSkge1xuICAgICAgICAgICAgY29uc3QgY2hhcnRXaWRnZXQgPSBfYnVpbGRDaGFydChzaGVldE5hbWUsIGpzb24pO1xuICAgICAgICAgICAgcmVwb3J0V2lkZ2V0cy5wdXNoKGNoYXJ0V2lkZ2V0KTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHNoZWV0TmFtZS5pbmNsdWRlcygnaHRtbCcpKSB7XG4gICAgICAgICAgICBjb25zdCBjaGFydFdpZGdldCA9IF9idWlsZEh0bWwoanNvbik7XG4gICAgICAgICAgICByZXBvcnRXaWRnZXRzLnB1c2goY2hhcnRXaWRnZXQpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChpZHggPj0gMCkge1xuICAgICAgICAgICAgcmVwb3J0V2lkZ2V0c1tyZXBvcnRXaWRnZXRzLmxlbmd0aCAtIDFdLmZpbHRlciA9IHtcbiAgICAgICAgICAgICAgc2NoZW1hOiBmW2lkeF0gYXMgYW55LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgY29uc3QgZ2xvYmFsRmlsdGVySWR4ID0gZmlsdGVyTmFtZXMuaW5kZXhPZignZ2xvYmFsX2ZpbHRlcicpO1xuICAgICAgY29uc3QgbGF5b3V0V2lkZ2V0OiBBamZMYXlvdXRXaWRnZXQgPSB7XG4gICAgICAgIHdpZGdldFR5cGU6IEFqZldpZGdldFR5cGUuTGF5b3V0LFxuICAgICAgICBjb250ZW50OiBbXG4gICAgICAgICAgY3JlYXRlV2lkZ2V0KHtcbiAgICAgICAgICAgIHdpZGdldFR5cGU6IEFqZldpZGdldFR5cGUuQ29sdW1uLFxuICAgICAgICAgICAgY29udGVudDogWy4uLnJlcG9ydFdpZGdldHNdLFxuICAgICAgICAgICAgZmlsdGVyOiBnbG9iYWxGaWx0ZXJJZHggPj0gMCA/IHtzY2hlbWE6IGZbZ2xvYmFsRmlsdGVySWR4XX0gOiB1bmRlZmluZWQsXG4gICAgICAgICAgfSBhcyBBamZDb2x1bW5XaWRnZXQpLFxuICAgICAgICBdLFxuICAgICAgICBjb2x1bW5zOiBbMV0sXG4gICAgICAgIHZpc2liaWxpdHk6IHtcbiAgICAgICAgICBjb25kaXRpb246ICd0cnVlJyxcbiAgICAgICAgfSxcbiAgICAgICAgc3R5bGVzOiB7fSxcbiAgICAgIH07XG5cbiAgICAgIHJlcG9ydC52YXJpYWJsZXMgPSB2YXJpYWJsZXM7XG4gICAgICByZXBvcnQuY29udGVudCA9IGNyZWF0ZVJlcG9ydENvbnRhaW5lcihsYXlvdXRXaWRnZXQpO1xuXG4gICAgICByZXR1cm4gcmVwb3J0O1xuICAgIH0pLFxuICApO1xufVxuXG5mdW5jdGlvbiBfYnVpbGRGaWx0ZXIoXG4gIHdib29rOiBYTFNYLldvcmtCb29rLFxuICBzaGVldDogWExTWC5Xb3JrU2hlZXQsXG4gIGh0dHA6IEh0dHBDbGllbnQsXG4pOiBPYnNlcnZhYmxlPGFueT4ge1xuICBjb25zdCBkYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gIGNvbnN0IGZpbHRlckJvb2s6IFhMU1guV29ya0Jvb2sgPSBkZWVwQ29weSh3Ym9vayk7XG4gIGNvbnN0IGZpbHRlclNoZWV0OiBYTFNYLldvcmtTaGVldCA9IGRlZXBDb3B5KHNoZWV0KTtcbiAgY29uc3QgY2hvaWNlc1NoZWV0OiBYTFNYLldvcmtTaGVldCA9IGRlZXBDb3B5KHdib29rLlNoZWV0c1snY2hvaWNlcyddKTtcbiAgZmlsdGVyQm9vay5TaGVldE5hbWVzID0gWydzdXJ2ZXknLCAnY2hvaWNlcyddO1xuICBmaWx0ZXJCb29rLlNoZWV0cyA9IHtzdXJ2ZXk6IGZpbHRlclNoZWV0LCBjaG9pY2VzOiBjaG9pY2VzU2hlZXR9O1xuICBjb25zdCBmaWx0ZXJYbHN4ID0gWExTWC53cml0ZShmaWx0ZXJCb29rLCB7XG4gICAgYm9va1R5cGU6ICd4bHN4JyxcbiAgICB0eXBlOiAnYXJyYXknLFxuICB9KTtcbiAgY29uc3QgZmlsZSA9IG5ldyBGaWxlKFtmaWx0ZXJYbHN4XSwgJ2ZpbHRlci54bHN4Jyk7XG4gIGRhdGEuYXBwZW5kKCdleGNlbEZpbGUnLCBmaWxlKTtcblxuICByZXR1cm4gaHR0cC5wb3N0KCdodHRwczovL2Zvcm1jb252Lmhlcm9rdWFwcC5jb20vcmVzdWx0Lmpzb24nLCBkYXRhKTtcbn1cblxuZnVuY3Rpb24gX2J1aWxkQ2hhcnQobmFtZTogc3RyaW5nLCBqc29uOiB7W2tleTogc3RyaW5nXTogc3RyaW5nfVtdKTogQWpmV2lkZ2V0IHtcbiAgY29uc3Qgb3B0aW9uTGFiZWxzID0gWydjaGFydFR5cGUnLCAndGl0bGUnXTtcbiAgY29uc3QgY2hhcnRPcHRpb25zOiB7W2tleTogc3RyaW5nXTogc3RyaW5nfSA9IHt9O1xuICBjb25zdCBkYXRhc2V0T2JqOiB7W2tleTogc3RyaW5nXTogYW55fSA9IHt9O1xuICBjb25zdCBkYXRhc2V0OiBBamZDaGFydERhdGFzZXRbXSA9IFtdO1xuICBsZXQgbGFiZWxzOiBBamZGb3JtdWxhID0ge2Zvcm11bGE6IGBbXWB9O1xuXG4gIGlmIChqc29uLmxlbmd0aCA+IDApIHtcbiAgICBjb25zdCBmaXJzdFJvdyA9IGpzb25bMF07XG4gICAgb3B0aW9uTGFiZWxzLmZvckVhY2gob3B0aW9uTGFiZWwgPT4ge1xuICAgICAgaWYgKGZpcnN0Um93W29wdGlvbkxhYmVsXSAhPSBudWxsKSB7XG4gICAgICAgIGNoYXJ0T3B0aW9uc1tvcHRpb25MYWJlbF0gPSBmaXJzdFJvd1tvcHRpb25MYWJlbF07XG4gICAgICAgIGRlbGV0ZSBmaXJzdFJvd1tvcHRpb25MYWJlbF07XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAganNvbi5mb3JFYWNoKHJvdyA9PiB7XG4gICAgY29uc3Qgcm93S2V5cyA9IE9iamVjdC5rZXlzKHJvdyk7XG4gICAgcm93S2V5cy5mb3JFYWNoKHJvd0tleSA9PiB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHJvd1tyb3dLZXldO1xuICAgICAgaWYgKGRhdGFzZXRPYmpbcm93S2V5XSA9PSBudWxsKSB7XG4gICAgICAgIGRhdGFzZXRPYmpbcm93S2V5XSA9IFt2YWx1ZV07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkYXRhc2V0T2JqW3Jvd0tleV0ucHVzaCh2YWx1ZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuICBjb25zdCBkb0xhYmVscyA9IGRhdGFzZXRPYmpbJ2xhYmVscyddO1xuICBpZiAoZG9MYWJlbHMgIT0gbnVsbCkge1xuICAgIGxhYmVscyA9IHtcbiAgICAgIGZvcm11bGE6IGBwbGFpbkFycmF5KFske2RvTGFiZWxzLm1hcCgobGFiZWw6IHN0cmluZykgPT4gaW5kaWNhdG9yVG9KcyhsYWJlbCkpfV0pYCxcbiAgICB9O1xuICAgIGRlbGV0ZSBkYXRhc2V0T2JqWydsYWJlbHMnXTtcbiAgfVxuICBPYmplY3Qua2V5cyhkYXRhc2V0T2JqKS5mb3JFYWNoKChkYXRhc2V0T2JqS2V5LCBpbmRleCkgPT4ge1xuICAgIGNvbnN0IGRhdGFzZXRSb3cgPSBkYXRhc2V0T2JqW2RhdGFzZXRPYmpLZXldLm1hcCgocjogc3RyaW5nKSA9PiBpbmRpY2F0b3JUb0pzKGAke3J9YCkpO1xuXG4gICAgY29uc3QgY2hhcnRUeXBlID0gY2hhcnRPcHRpb25zWydjaGFydFR5cGUnXTtcbiAgICBjb25zdCBjb2xvckNvbmRpdGlvbiA9XG4gICAgICBjaGFydFR5cGUgPT09ICdQaWUnIHx8IGNoYXJ0VHlwZSA9PT0gJ1BvbGFyQXJlYScgfHwgY2hhcnRUeXBlID09PSAnRG91Z2hudXQnO1xuICAgIGNvbnN0IGJhY2tDb2xvciA9IGNvbG9yQ29uZGl0aW9uID8gYmFja2dyb3VuZENvbG9yIDogYmFja2dyb3VuZENvbG9yW2luZGV4XTtcbiAgICBjb25zdCBmb3JtdWxhOiBBamZGb3JtdWxhW10gPSBbXG4gICAgICBjcmVhdGVGb3JtdWxhKHtmb3JtdWxhOiBgcGxhaW5BcnJheShbJHtkYXRhc2V0Um93LnRvU3RyaW5nKCl9XSlgfSksXG4gICAgXTtcbiAgICBjb25zdCBkYXRhc2V0T3B0aW9uczogQWpmQ2hhcnREYXRhc2V0T3B0aW9ucyA9IHtcbiAgICAgIGJhY2tncm91bmRDb2xvcjogYmFja0NvbG9yIGFzIENoYXJ0Q29sb3IsXG4gICAgfTtcbiAgICBkYXRhc2V0LnB1c2goe1xuICAgICAgLi4uY3JlYXRlRGF0YXNldCh7XG4gICAgICAgIGFnZ3JlZ2F0aW9uOiB7YWdncmVnYXRpb246IDB9LFxuICAgICAgICBmb3JtdWxhLFxuICAgICAgICBsYWJlbDogZGF0YXNldE9iaktleSxcbiAgICAgIH0pLFxuICAgICAgb3B0aW9uczogZGF0YXNldE9wdGlvbnMsXG4gICAgfSBhcyBBamZDaGFydERhdGFzZXQpO1xuICB9KTtcblxuICByZXR1cm4gY3JlYXRlV2lkZ2V0KHtcbiAgICBuYW1lLFxuICAgIHdpZGdldFR5cGU6IEFqZldpZGdldFR5cGUuQ2hhcnQsXG4gICAgdHlwZTogQWpmQ2hhcnRUeXBlW2NoYXJ0T3B0aW9uc1snY2hhcnRUeXBlJ10gYXMgYW55XSBhcyB1bmtub3duIGFzIEFqZkNoYXJ0VHlwZSxcbiAgICBsYWJlbHMsXG4gICAgZGF0YXNldCxcbiAgICBvcHRpb25zOiB7XG4gICAgICByZXNwb25zaXZlOiB0cnVlLFxuICAgICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsXG4gICAgICBsZWdlbmQ6IHtkaXNwbGF5OiB0cnVlLCBwb3NpdGlvbjogJ2JvdHRvbSd9LFxuICAgICAgdGl0bGU6IHtcbiAgICAgICAgZGlzcGxheTogdHJ1ZSxcbiAgICAgICAgdGV4dDogYCR7Y2hhcnRPcHRpb25zWyd0aXRsZSddIHx8ICcnfWAucmVwbGFjZSgvXCIvZ2ksICcnKSxcbiAgICAgIH0sXG4gICAgfSxcbiAgICBzdHlsZXM6IHtcbiAgICAgIC4uLnt3aWR0aDogJzEwMCUnLCBoZWlnaHQ6ICcxMDAlJywgcGFkZGluZzogJzIwcHgnfSxcbiAgICAgIC4uLndpZGdldFN0eWxlLFxuICAgIH0sXG4gICAgZXhwb3J0YWJsZTogdHJ1ZSxcbiAgfSBhcyBBamZXaWRnZXRDcmVhdGUpO1xufVxuXG5mdW5jdGlvbiBfYnVpbGRIdG1sKGpzb246IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9W10pOiBBamZXaWRnZXQge1xuICBjb25zdCBmaXJzdFJvdyA9IGpzb24ubGVuZ3RoID4gMCAmJiBqc29uWzBdWydodG1sJ10gIT0gbnVsbCA/IGpzb25bMF0gOiB7aHRtbDogJyd9O1xuXG4gIHJldHVybiBjcmVhdGVXaWRnZXQoe1xuICAgIHdpZGdldFR5cGU6IEFqZldpZGdldFR5cGUuVGV4dCxcbiAgICBodG1sVGV4dDogYCR7Zmlyc3RSb3dbJ2h0bWwnXX1gLFxuICAgIHN0eWxlczogaHRtbFdpZGdldCxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIF9idWlsZFRhYmxlKGpzb246IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9W10pOiBBamZXaWRnZXQge1xuICBjb25zdCByb3dzcGFuID0gMTtcbiAgY29uc3QgZGF0YUVsZW1lbnRzOiBhbnlbXVtdID0gW107XG4gIGNvbnN0IHRpdGxlcyA9IE9iamVjdC5rZXlzKGpzb25bMF0pO1xuICBjb25zdCBjb2xzcGFuczogbnVtYmVyW10gPSAoT2JqZWN0LnZhbHVlcyhqc29uWzBdKSBhcyBzdHJpbmdbXSkubWFwKHIgPT4gK3IpO1xuICBkZWxldGUganNvblswXTtcbiAgY29uc3QgdGFibGVIZWFkZXI6IEFqZlRhYmxlRGF0YXNldFtdID0gdGl0bGVzLm1hcCgodGl0bGUsIGluZGV4KSA9PiAoe1xuICAgIGxhYmVsOiAnJyxcbiAgICBmb3JtdWxhOiB7Zm9ybXVsYTogYFxcXCIke3RpdGxlfVxcXCJgfSxcbiAgICBhZ2dyZWdhdGlvbjoge2FnZ3JlZ2F0aW9uOiAwfSxcbiAgICBjb2xzcGFuOiBjb2xzcGFuc1tpbmRleF0sXG4gICAgcm93c3BhbixcbiAgICBzdHlsZToge1xuICAgICAgdGV4dEFsaWduOiAnY2VudGVyJyxcbiAgICAgIGZvbnRXZWlnaHQ6ICdib2xkJyxcbiAgICAgIGNvbG9yOiAnd2hpdGUnLFxuICAgICAgYmFja2dyb3VuZENvbG9yOiAnIzNmNTFiNScsXG4gICAgfSxcbiAgfSkpO1xuXG4gIGpzb24uZm9yRWFjaChyb3cgPT4ge1xuICAgIGNvbnN0IGVsZW1zOiBhbnlbXSA9IFtdO1xuICAgIHRpdGxlcy5mb3JFYWNoKHRpdGxlID0+IHtcbiAgICAgIGxldCBlbGVtOiBzdHJpbmcgPSByb3dbdGl0bGVdIHx8IGBcXFwiXFxcImA7XG4gICAgICB0cnkge1xuICAgICAgICBlbGVtID0gaW5kaWNhdG9yVG9KcyhlbGVtKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBlbGVtID0gYCR7cm93W3RpdGxlXX1gO1xuICAgICAgfVxuICAgICAgZWxlbXMucHVzaChlbGVtLnJlcGxhY2UoL1tcXCpcXC9cXHJcXG5dfEBbXFx3LV0rL2csICcnKSk7XG4gICAgfSk7XG4gICAgZGF0YUVsZW1lbnRzLnB1c2goZWxlbXMpO1xuICB9KTtcblxuICByZXR1cm4gY3JlYXRlV2lkZ2V0KHtcbiAgICB3aWRnZXRUeXBlOiBBamZXaWRnZXRUeXBlLkR5bmFtaWNUYWJsZSxcbiAgICByb3dEZWZpbml0aW9uOiB7XG4gICAgICBmb3JtdWxhOiBgYnVpbGREYXRhc2V0KFske2RhdGFFbGVtZW50c31dLCR7SlNPTi5zdHJpbmdpZnkoY29sc3BhbnMpfSlgLFxuICAgIH0sXG4gICAgZGF0YXNldDogdGFibGVIZWFkZXIsXG4gICAgZXhwb3J0YWJsZTogdHJ1ZSxcbiAgICBjZWxsU3R5bGVzOiB7XG4gICAgICB0ZXh0QWxpZ246ICdjZW50ZXInLFxuICAgICAgY29sb3I6ICdibGFjaycsXG4gICAgICBiYWNrZ3JvdW5kQ29sb3I6ICd3aGl0ZScsXG4gICAgfSxcbiAgICBzdHlsZXM6IHtcbiAgICAgIGJvcmRlckNvbGxhcHNlOiAnY29sbGFwc2UnLFxuICAgIH0sXG4gIH0pO1xufVxuIl19