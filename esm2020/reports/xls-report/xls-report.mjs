/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { createFormula } from '@ajf/core/models';
import { deepCopy } from '@ajf/core/utils';
import { forkJoin, of } from 'rxjs';
import { map } from 'rxjs/operators';
import * as XLSX from 'xlsx';
import { backgroundColor } from '../automatic-report/styles';
import { indicatorToJs } from './hindikit-parser';
import { htmlWidget, widgetStyle } from './styles';
import { createDataset } from '../utils/dataset/create-dataset';
import { createReportContainer } from '../utils/reports/create-report-container';
import { createWidget } from '../utils/widgets/create-widget';
import { AjfWidgetType } from '../interface/widgets/widget-type';
import { AjfChartType } from '../interface/charts/chart-type';
/**
 * This function builds a report from an excel file.
 */
export function xlsReport(file, http) {
    const workbook = XLSX.read(file, { type: 'binary' });
    const report = {};
    const reportWidgets = [];
    const variables = [];
    const filters = {};
    // create filters
    workbook.SheetNames.forEach((sheetName, index) => {
        const sheet = workbook.Sheets[sheetName];
        if (sheetName.includes('filter') && index + 1 < workbook.SheetNames.length) {
            const nextSheet = sheetName.includes('global')
                ? 'global_filter'
                : workbook.SheetNames[index + 1];
            filters[nextSheet] = _buildFilter(workbook, sheet, http);
        }
    });
    const obsFilterValues = Object.values(filters).length
        ? Object.values(filters)
        : [of({})];
    const filterNames = Object.keys(filters);
    return forkJoin(obsFilterValues).pipe(map(f => {
        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet);
            if (sheetName === 'variables') {
                json
                    .filter(e => e != null && e.name != null && e.name !== '')
                    .forEach(elem => {
                    let js;
                    try {
                        js = indicatorToJs(elem.value);
                    }
                    catch (err) {
                        const r = elem.__rowNum__;
                        err = new Error(`Error in variable "${elem.name}" (row ${r}): ${err.message}`);
                        window.alert(err.message);
                        throw err;
                    }
                    variables.push({
                        name: elem.name,
                        formula: { formula: js },
                    });
                });
            }
            else {
                const idx = filterNames.indexOf(sheetName);
                if (sheetName.includes('table')) {
                    const tableWidget = _buildTable(sheetName, json);
                    reportWidgets.push(tableWidget);
                }
                else if (sheetName.includes('chart')) {
                    const chartWidget = _buildChart(sheetName, json);
                    reportWidgets.push(chartWidget);
                }
                else if (sheetName.includes('html')) {
                    const chartWidget = _buildHtml(json);
                    reportWidgets.push(chartWidget);
                }
                else if (sheetName.includes('graph')) {
                    const graphWidget = _buildGraph(sheetName, json);
                    reportWidgets.push(graphWidget);
                }
                if (idx >= 0) {
                    reportWidgets[reportWidgets.length - 1].filter = {
                        schema: f[idx],
                    };
                }
            }
        });
        const globalFilterIdx = filterNames.indexOf('global_filter');
        const layoutWidget = {
            widgetType: AjfWidgetType.Layout,
            content: [
                createWidget({
                    widgetType: AjfWidgetType.Column,
                    content: [...reportWidgets],
                    filter: globalFilterIdx >= 0 ? { schema: f[globalFilterIdx] } : undefined,
                }),
            ],
            columns: [1],
            visibility: {
                condition: 'true',
            },
            styles: {},
        };
        report.variables = variables;
        report.content = createReportContainer(layoutWidget);
        return report;
    }));
}
function _buildFilter(wbook, sheet, http) {
    const data = new FormData();
    const filterBook = deepCopy(wbook);
    const filterSheet = deepCopy(sheet);
    const choicesSheet = deepCopy(wbook.Sheets['choices']);
    filterBook.SheetNames = ['survey', 'choices'];
    filterBook.Sheets = { survey: filterSheet, choices: choicesSheet };
    const filterXlsx = XLSX.write(filterBook, {
        bookType: 'xlsx',
        type: 'array',
    });
    const file = new File([filterXlsx], 'filter.xlsx');
    data.append('excelFile', file);
    return http.post('https://formconv.herokuapp.com/result.json', data);
}
function _buildChart(name, json) {
    const optionLabels = ['chartType', 'title'];
    const chartOptions = {};
    const datasetObj = {};
    const dataset = [];
    let labels = { formula: '[]' };
    if (json.length > 0) {
        const firstRow = json[0];
        optionLabels.forEach(optionLabel => {
            if (firstRow[optionLabel] != null) {
                chartOptions[optionLabel] = firstRow[optionLabel];
                delete firstRow[optionLabel];
            }
        });
    }
    json.forEach(row => {
        const rowKeys = Object.keys(row);
        rowKeys.forEach(rowKey => {
            const value = row[rowKey];
            if (datasetObj[rowKey] == null) {
                datasetObj[rowKey] = [value];
            }
            else {
                datasetObj[rowKey].push(value);
            }
        });
    });
    const doLabels = datasetObj['labels'];
    if (doLabels != null) {
        let labelsJs;
        try {
            labelsJs = indicatorToJs('[' + doLabels.join() + ']');
        }
        catch (err) {
            err = new Error(`Error in "labels" of chart "${chartOptions['title']}": ${err.message}`);
            window.alert(err.message);
            throw err;
        }
        labels = { formula: `plainArray(${labelsJs})` };
        delete datasetObj['labels'];
    }
    Object.keys(datasetObj).forEach((datasetObjKey, index) => {
        let datasetJs;
        try {
            datasetJs = indicatorToJs('[' + datasetObj[datasetObjKey].join() + ']');
        }
        catch (err) {
            err = new Error(`Error in "${datasetObjKey}" of chart "${chartOptions['title']}": ${err.message}`);
            window.alert(err.message);
            throw err;
        }
        const chartType = chartOptions['chartType'];
        const colorCondition = chartType === 'Pie' || chartType === 'PolarArea' || chartType === 'Doughnut';
        const backColor = colorCondition ? backgroundColor : backgroundColor[index];
        const formula = [createFormula({
                formula: `plainArray(${datasetJs})`
            })];
        const datasetOptions = {
            backgroundColor: backColor,
        };
        dataset.push({
            ...createDataset({
                aggregation: { aggregation: 0 },
                formula,
                label: datasetObjKey,
            }),
            options: datasetOptions,
        });
    });
    return createWidget({
        name,
        widgetType: AjfWidgetType.Chart,
        type: AjfChartType[chartOptions['chartType']],
        labels,
        dataset,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: { display: true, position: 'bottom' },
            title: {
                display: true,
                text: chartOptions['title'] || '',
            },
        },
        styles: {
            ...{ width: '100%', height: '100%', padding: '20px' },
            ...widgetStyle,
        },
        exportable: true,
    });
}
function _buildGraph(name, json) {
    const nodes = [];
    json.forEach(row => {
        const rowKeys = Object.keys(row);
        if (rowKeys.includes('id') && row['id']) {
            const rowId = row['id'].trim().replace(/"/g, '');
            if (rowId && rowId.length) {
                let graphNodeObj = {};
                rowKeys.forEach(rowKey => {
                    let js;
                    try {
                        js = indicatorToJs(row[rowKey]);
                    }
                    catch (err) {
                        const rowNum = row['__rowNum__'];
                        err = new Error(`Error in "${name}", row ${rowNum}, column "${rowKey}": ${err.message}`);
                        window.alert(err.message);
                        throw err;
                    }
                    graphNodeObj[rowKey] = js;
                });
                graphNodeObj['id'] = rowId;
                nodes.push(graphNodeObj);
            }
        }
    });
    return createWidget({
        widgetType: AjfWidgetType.Graph,
        nodes,
        styles: {},
    });
}
function _buildHtml(json) {
    const firstRow = json.length > 0 && json[0]['html'] != null ? json[0] : { html: '' };
    return createWidget({
        widgetType: AjfWidgetType.Text,
        htmlText: String(firstRow['html']),
        styles: htmlWidget,
    });
}
function _buildTable(sheetName, json) {
    const rowspan = 1;
    const titles = Object.keys(json[0]);
    const colspans = Object.values(json[0]).map(r => +r);
    delete json[0];
    const tableHeader = titles.map((title, index) => ({
        label: '',
        formula: { formula: `"${title}"` },
        aggregation: { aggregation: 0 },
        colspan: colspans[index],
        rowspan,
        style: {
            textAlign: 'center',
            fontWeight: 'bold',
            color: 'white',
            backgroundColor: '#3f51b5',
        },
    }));
    console.log(json);
    let dataRows = '[';
    json.forEach(row => {
        let dataRow = '[';
        titles.forEach(title => {
            let elem = row[title] || `''`;
            try {
                elem = indicatorToJs(elem);
            }
            catch (err) {
                const rowNum = row['__rowNum__'];
                err = new Error(`Error in "${sheetName}", row ${rowNum}, column "${title}": ${err.message}`);
                window.alert(err.message);
                throw err;
            }
            dataRow += elem + ',';
        });
        dataRow += ']';
        dataRows += dataRow + ',';
    });
    dataRows += ']';
    return createWidget({
        widgetType: AjfWidgetType.DynamicTable,
        rowDefinition: {
            formula: `buildDataset(${dataRows},${JSON.stringify(colspans)})`,
        },
        dataset: tableHeader,
        exportable: true,
        cellStyles: {
            textAlign: 'center',
            color: 'black',
            backgroundColor: 'white',
        },
        styles: {
            borderCollapse: 'collapse',
        },
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieGxzLXJlcG9ydC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NvcmUvcmVwb3J0cy9zcmMveGxzLXJlcG9ydC94bHMtcmVwb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUVILE9BQU8sRUFBYSxhQUFhLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUMzRCxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFHekMsT0FBTyxFQUFDLFFBQVEsRUFBYyxFQUFFLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDOUMsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBRTdCLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQUUzRCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFDaEQsT0FBTyxFQUFDLFVBQVUsRUFBRSxXQUFXLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFDakQsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLGlDQUFpQyxDQUFDO0FBQzlELE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLDBDQUEwQyxDQUFDO0FBQy9FLE9BQU8sRUFBa0IsWUFBWSxFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFDN0UsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLGtDQUFrQyxDQUFDO0FBSS9ELE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxnQ0FBZ0MsQ0FBQztBQVE1RDs7R0FFRztBQUNILE1BQU0sVUFBVSxTQUFTLENBQUMsSUFBWSxFQUFFLElBQWdCO0lBQ3RELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUMsSUFBSSxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUM7SUFDbkQs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QzlCLElBQUk7Z0JBQ0YsSUFBSSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUM1QjtZQUFDLE9BQU8sR0FBUSxFQUFFO2dCQUNqQixNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQ2pDLEdBQUcsR0FBRyxJQUFJLEtBQUssQ0FDYixhQUFhLFNBQVMsVUFBVSxNQUFNLGFBQWEsS0FBSyxNQUFNLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FDNUUsQ0FBQztnQkFDRixNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDMUIsTUFBTSxHQUFHLENBQUM7YUFDWDtZQUNELE9BQU8sSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxJQUFJLEdBQUcsQ0FBQztRQUNmLFFBQVEsSUFBSSxPQUFPLEdBQUcsR0FBRyxDQUFDO0lBQzVCLENBQUMsQ0FBQyxDQUFDO0lBQ0gsUUFBUSxJQUFJLEdBQUcsQ0FBQztJQUVoQixPQUFPLFlBQVksQ0FBQztRQUNsQixVQUFVLEVBQUUsYUFBYSxDQUFDLFlBQVk7UUFDdEMsYUFBYSxFQUFFO1lBQ2IsT0FBTyxFQUFFLGdCQUFnQixRQUFRLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsR0FBRztTQUNqRTtRQUNELE9BQU8sRUFBRSxXQUFXO1FBQ3BCLFVBQVUsRUFBRSxJQUFJO1FBQ2hCLFVBQVUsRUFBRTtZQUNWLFNBQVMsRUFBRSxRQUFRO1lBQ25CLEtBQUssRUFBRSxPQUFPO1lBQ2QsZUFBZSxFQUFFLE9BQU87U0FDekI7UUFDRCxNQUFNLEVBQUU7WUFDTixjQUFjLEVBQUUsVUFBVTtTQUMzQjtLQUNGLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKEMpIEdudWNvb3Agc29jLiBjb29wLlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yXG4gKiBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXNcbiAqIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLFxuICogb3IgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIEdOVSBBZmZlcm9cbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGFsb25nIHdpdGggQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqIElmIG5vdCwgc2VlIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8uXG4gKlxuICovXG5cbmltcG9ydCB7QWpmRm9ybXVsYSwgY3JlYXRlRm9ybXVsYX0gZnJvbSAnQGFqZi9jb3JlL21vZGVscyc7XG5pbXBvcnQge2RlZXBDb3B5fSBmcm9tICdAYWpmL2NvcmUvdXRpbHMnO1xuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge0NoYXJ0Q29sb3J9IGZyb20gJ2NoYXJ0LmpzJztcbmltcG9ydCB7Zm9ya0pvaW4sIE9ic2VydmFibGUsIG9mfSBmcm9tICdyeGpzJztcbmltcG9ydCB7bWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgKiBhcyBYTFNYIGZyb20gJ3hsc3gnO1xuXG5pbXBvcnQge2JhY2tncm91bmRDb2xvcn0gZnJvbSAnLi4vYXV0b21hdGljLXJlcG9ydC9zdHlsZXMnO1xuXG5pbXBvcnQge2luZGljYXRvclRvSnN9IGZyb20gJy4vaGluZGlraXQtcGFyc2VyJztcbmltcG9ydCB7aHRtbFdpZGdldCwgd2lkZ2V0U3R5bGV9IGZyb20gJy4vc3R5bGVzJztcbmltcG9ydCB7Y3JlYXRlRGF0YXNldH0gZnJvbSAnLi4vdXRpbHMvZGF0YXNldC9jcmVhdGUtZGF0YXNldCc7XG5pbXBvcnQge2NyZWF0ZVJlcG9ydENvbnRhaW5lcn0gZnJvbSAnLi4vdXRpbHMvcmVwb3J0cy9jcmVhdGUtcmVwb3J0LWNvbnRhaW5lcic7XG5pbXBvcnQge0FqZldpZGdldENyZWF0ZSwgY3JlYXRlV2lkZ2V0fSBmcm9tICcuLi91dGlscy93aWRnZXRzL2NyZWF0ZS13aWRnZXQnO1xuaW1wb3J0IHtBamZXaWRnZXRUeXBlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy93aWRnZXQtdHlwZSc7XG5pbXBvcnQge0FqZlRhYmxlRGF0YXNldH0gZnJvbSAnLi4vaW50ZXJmYWNlL2RhdGFzZXQvdGFibGUtZGF0YXNldCc7XG5pbXBvcnQge0FqZkNoYXJ0RGF0YXNldH0gZnJvbSAnLi4vaW50ZXJmYWNlL2RhdGFzZXQvY2hhcnQtZGF0YXNldCc7XG5pbXBvcnQge0FqZkNoYXJ0RGF0YXNldE9wdGlvbnN9IGZyb20gJy4uL2ludGVyZmFjZS9kYXRhc2V0L2NoYXJ0LWRhdGFzZXQtb3B0aW9ucyc7XG5pbXBvcnQge0FqZkNoYXJ0VHlwZX0gZnJvbSAnLi4vaW50ZXJmYWNlL2NoYXJ0cy9jaGFydC10eXBlJztcbmltcG9ydCB7QWpmV2lkZ2V0fSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy93aWRnZXQnO1xuaW1wb3J0IHtBamZSZXBvcnR9IGZyb20gJy4uL2ludGVyZmFjZS9yZXBvcnRzL3JlcG9ydCc7XG5pbXBvcnQge0FqZlJlcG9ydFZhcmlhYmxlfSBmcm9tICcuLi9pbnRlcmZhY2UvcmVwb3J0cy9yZXBvcnQtdmFyaWFibGUnO1xuaW1wb3J0IHtBamZMYXlvdXRXaWRnZXR9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzL2xheW91dC13aWRnZXQnO1xuaW1wb3J0IHtBamZDb2x1bW5XaWRnZXR9IGZyb20gJy4uL2ludGVyZmFjZS93aWRnZXRzL2NvbHVtbi13aWRnZXQnO1xuaW1wb3J0IHtBamZHcmFwaE5vZGVEYXRhc2V0fSBmcm9tICcuLi9pbnRlcmZhY2UvZGF0YXNldC9ncmFwaC1kYXRhc2V0JztcblxuLyoqXG4gKiBUaGlzIGZ1bmN0aW9uIGJ1aWxkcyBhIHJlcG9ydCBmcm9tIGFuIGV4Y2VsIGZpbGUuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB4bHNSZXBvcnQoZmlsZTogc3RyaW5nLCBodHRwOiBIdHRwQ2xpZW50KTogT2JzZXJ2YWJsZTxBamZSZXBvcnQ+IHtcbiAgY29uc3Qgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZmlsZSwge3R5cGU6ICdiaW5hcnknfSk7XG4gIGNvbnN0IHJlcG9ydDogQWpmUmVwb3J0ID0ge307XG4gIGNvbnN0IHJlcG9ydFdpZGdldHM6IEFqZldpZGdldFtdID0gW107XG5cbiAgY29uc3QgdmFyaWFibGVzOiBBamZSZXBvcnRWYXJpYWJsZVtdID0gW107XG4gIGNvbnN0IGZpbHRlcnM6IHtbc2hlZXROYW1lOiBzdHJpbmddOiBPYnNlcnZhYmxlPGFueT59ID0ge307XG4gIC8vIGNyZWF0ZSBmaWx0ZXJzXG4gIHdvcmtib29rLlNoZWV0TmFtZXMuZm9yRWFjaCgoc2hlZXROYW1lLCBpbmRleCkgPT4ge1xuICAgIGNvbnN0IHNoZWV0OiBYTFNYLldvcmtTaGVldCA9IHdvcmtib29rLlNoZWV0c1tzaGVldE5hbWVdO1xuICAgIGlmIChzaGVldE5hbWUuaW5jbHVkZXMoJ2ZpbHRlcicpICYmIGluZGV4ICsgMSA8IHdvcmtib29rLlNoZWV0TmFtZXMubGVuZ3RoKSB7XG4gICAgICBjb25zdCBuZXh0U2hlZXQgPSBzaGVldE5hbWUuaW5jbHVkZXMoJ2dsb2JhbCcpXG4gICAgICAgID8gJ2dsb2JhbF9maWx0ZXInXG4gICAgICAgIDogd29ya2Jvb2suU2hlZXROYW1lc1tpbmRleCArIDFdO1xuICAgICAgZmlsdGVyc1tuZXh0U2hlZXRdID0gX2J1aWxkRmlsdGVyKHdvcmtib29rLCBzaGVldCwgaHR0cCk7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCBvYnNGaWx0ZXJWYWx1ZXM6IE9ic2VydmFibGU8YW55PltdID0gT2JqZWN0LnZhbHVlcyhmaWx0ZXJzKS5sZW5ndGhcbiAgICA/IE9iamVjdC52YWx1ZXMoZmlsdGVycylcbiAgICA6IFtvZih7fSldO1xuICBjb25zdCBmaWx0ZXJOYW1lczogc3RyaW5nW10gPSBPYmplY3Qua2V5cyhmaWx0ZXJzKTtcblxuICByZXR1cm4gZm9ya0pvaW4ob2JzRmlsdGVyVmFsdWVzKS5waXBlKFxuICAgIG1hcChmID0+IHtcbiAgICAgIHdvcmtib29rLlNoZWV0TmFtZXMuZm9yRWFjaChzaGVldE5hbWUgPT4ge1xuICAgICAgICBjb25zdCBzaGVldDogWExTWC5Xb3JrU2hlZXQgPSB3b3JrYm9vay5TaGVldHNbc2hlZXROYW1lXTtcbiAgICAgICAgY29uc3QganNvbiA9IFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbihzaGVldCkgYXMge1xuICAgICAgICAgIG5hbWU6IHN0cmluZztcbiAgICAgICAgICB2YWx1ZTogc3RyaW5nO1xuICAgICAgICAgIF9fcm93TnVtX186IHN0cmluZztcbiAgICAgICAgfVtdO1xuXG4gICAgICAgIGlmIChzaGVldE5hbWUgPT09ICd2YXJpYWJsZXMnKSB7XG4gICAgICAgICAganNvblxuICAgICAgICAgICAgLmZpbHRlcihlID0+IGUgIT0gbnVsbCAmJiBlLm5hbWUgIT0gbnVsbCAmJiBlLm5hbWUgIT09ICcnKVxuICAgICAgICAgICAgLmZvckVhY2goZWxlbSA9PiB7XG4gICAgICAgICAgICAgIGxldCBqczogc3RyaW5nO1xuICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGpzID0gaW5kaWNhdG9yVG9KcyhlbGVtLnZhbHVlKTtcbiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCByID0gZWxlbS5fX3Jvd051bV9fO1xuICAgICAgICAgICAgICAgIGVyciA9IG5ldyBFcnJvcihgRXJyb3IgaW4gdmFyaWFibGUgXCIke2VsZW0ubmFtZX1cIiAocm93ICR7cn0pOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICAgICAgICAgIHdpbmRvdy5hbGVydChlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHZhcmlhYmxlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICBuYW1lOiBlbGVtLm5hbWUsXG4gICAgICAgICAgICAgICAgZm9ybXVsYToge2Zvcm11bGE6IGpzfSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBpZHggPSBmaWx0ZXJOYW1lcy5pbmRleE9mKHNoZWV0TmFtZSk7XG5cbiAgICAgICAgICBpZiAoc2hlZXROYW1lLmluY2x1ZGVzKCd0YWJsZScpKSB7XG4gICAgICAgICAgICBjb25zdCB0YWJsZVdpZGdldCA9IF9idWlsZFRhYmxlKHNoZWV0TmFtZSwganNvbik7XG4gICAgICAgICAgICByZXBvcnRXaWRnZXRzLnB1c2godGFibGVXaWRnZXQpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoc2hlZXROYW1lLmluY2x1ZGVzKCdjaGFydCcpKSB7XG4gICAgICAgICAgICBjb25zdCBjaGFydFdpZGdldCA9IF9idWlsZENoYXJ0KHNoZWV0TmFtZSwganNvbik7XG4gICAgICAgICAgICByZXBvcnRXaWRnZXRzLnB1c2goY2hhcnRXaWRnZXQpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoc2hlZXROYW1lLmluY2x1ZGVzKCdodG1sJykpIHtcbiAgICAgICAgICAgIGNvbnN0IGNoYXJ0V2lkZ2V0ID0gX2J1aWxkSHRtbChqc29uKTtcbiAgICAgICAgICAgIHJlcG9ydFdpZGdldHMucHVzaChjaGFydFdpZGdldCk7XG4gICAgICAgICAgfSBlbHNlIGlmIChzaGVldE5hbWUuaW5jbHVkZXMoJ2dyYXBoJykpIHtcbiAgICAgICAgICAgIGNvbnN0IGdyYXBoV2lkZ2V0ID0gX2J1aWxkR3JhcGgoc2hlZXROYW1lLCBqc29uKTtcbiAgICAgICAgICAgIHJlcG9ydFdpZGdldHMucHVzaChncmFwaFdpZGdldCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKGlkeCA+PSAwKSB7XG4gICAgICAgICAgICByZXBvcnRXaWRnZXRzW3JlcG9ydFdpZGdldHMubGVuZ3RoIC0gMV0uZmlsdGVyID0ge1xuICAgICAgICAgICAgICBzY2hlbWE6IGZbaWR4XSBhcyBhbnksXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBjb25zdCBnbG9iYWxGaWx0ZXJJZHggPSBmaWx0ZXJOYW1lcy5pbmRleE9mKCdnbG9iYWxfZmlsdGVyJyk7XG4gICAgICBjb25zdCBsYXlvdXRXaWRnZXQ6IEFqZkxheW91dFdpZGdldCA9IHtcbiAgICAgICAgd2lkZ2V0VHlwZTogQWpmV2lkZ2V0VHlwZS5MYXlvdXQsXG4gICAgICAgIGNvbnRlbnQ6IFtcbiAgICAgICAgICBjcmVhdGVXaWRnZXQoe1xuICAgICAgICAgICAgd2lkZ2V0VHlwZTogQWpmV2lkZ2V0VHlwZS5Db2x1bW4sXG4gICAgICAgICAgICBjb250ZW50OiBbLi4ucmVwb3J0V2lkZ2V0c10sXG4gICAgICAgICAgICBmaWx0ZXI6IGdsb2JhbEZpbHRlcklkeCA+PSAwID8ge3NjaGVtYTogZltnbG9iYWxGaWx0ZXJJZHhdfSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICB9IGFzIEFqZkNvbHVtbldpZGdldCksXG4gICAgICAgIF0sXG4gICAgICAgIGNvbHVtbnM6IFsxXSxcbiAgICAgICAgdmlzaWJpbGl0eToge1xuICAgICAgICAgIGNvbmRpdGlvbjogJ3RydWUnLFxuICAgICAgICB9LFxuICAgICAgICBzdHlsZXM6IHt9LFxuICAgICAgfTtcblxuICAgICAgcmVwb3J0LnZhcmlhYmxlcyA9IHZhcmlhYmxlcztcbiAgICAgIHJlcG9ydC5jb250ZW50ID0gY3JlYXRlUmVwb3J0Q29udGFpbmVyKGxheW91dFdpZGdldCk7XG5cbiAgICAgIHJldHVybiByZXBvcnQ7XG4gICAgfSksXG4gICk7XG59XG5cbmZ1bmN0aW9uIF9idWlsZEZpbHRlcihcbiAgd2Jvb2s6IFhMU1guV29ya0Jvb2ssXG4gIHNoZWV0OiBYTFNYLldvcmtTaGVldCxcbiAgaHR0cDogSHR0cENsaWVudCxcbik6IE9ic2VydmFibGU8YW55PiB7XG4gIGNvbnN0IGRhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgY29uc3QgZmlsdGVyQm9vazogWExTWC5Xb3JrQm9vayA9IGRlZXBDb3B5KHdib29rKTtcbiAgY29uc3QgZmlsdGVyU2hlZXQ6IFhMU1guV29ya1NoZWV0ID0gZGVlcENvcHkoc2hlZXQpO1xuICBjb25zdCBjaG9pY2VzU2hlZXQ6IFhMU1guV29ya1NoZWV0ID0gZGVlcENvcHkod2Jvb2suU2hlZXRzWydjaG9pY2VzJ10pO1xuICBmaWx0ZXJCb29rLlNoZWV0TmFtZXMgPSBbJ3N1cnZleScsICdjaG9pY2VzJ107XG4gIGZpbHRlckJvb2suU2hlZXRzID0ge3N1cnZleTogZmlsdGVyU2hlZXQsIGNob2ljZXM6IGNob2ljZXNTaGVldH07XG4gIGNvbnN0IGZpbHRlclhsc3ggPSBYTFNYLndyaXRlKGZpbHRlckJvb2ssIHtcbiAgICBib29rVHlwZTogJ3hsc3gnLFxuICAgIHR5cGU6ICdhcnJheScsXG4gIH0pO1xuICBjb25zdCBmaWxlID0gbmV3IEZpbGUoW2ZpbHRlclhsc3hdLCAnZmlsdGVyLnhsc3gnKTtcbiAgZGF0YS5hcHBlbmQoJ2V4Y2VsRmlsZScsIGZpbGUpO1xuXG4gIHJldHVybiBodHRwLnBvc3QoJ2h0dHBzOi8vZm9ybWNvbnYuaGVyb2t1YXBwLmNvbS9yZXN1bHQuanNvbicsIGRhdGEpO1xufVxuXG5mdW5jdGlvbiBfYnVpbGRDaGFydChuYW1lOiBzdHJpbmcsIGpzb246IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9W10pOiBBamZXaWRnZXQge1xuICBjb25zdCBvcHRpb25MYWJlbHMgPSBbJ2NoYXJ0VHlwZScsICd0aXRsZSddO1xuICBjb25zdCBjaGFydE9wdGlvbnM6IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9ID0ge307XG4gIGNvbnN0IGRhdGFzZXRPYmo6IHtba2V5OiBzdHJpbmddOiBhbnl9ID0ge307XG4gIGNvbnN0IGRhdGFzZXQ6IEFqZkNoYXJ0RGF0YXNldFtdID0gW107XG4gIGxldCBsYWJlbHM6IEFqZkZvcm11bGEgPSB7Zm9ybXVsYTogJ1tdJ307XG5cbiAgaWYgKGpzb24ubGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IGZpcnN0Um93ID0ganNvblswXTtcbiAgICBvcHRpb25MYWJlbHMuZm9yRWFjaChvcHRpb25MYWJlbCA9PiB7XG4gICAgICBpZiAoZmlyc3RSb3dbb3B0aW9uTGFiZWxdICE9IG51bGwpIHtcbiAgICAgICAgY2hhcnRPcHRpb25zW29wdGlvbkxhYmVsXSA9IGZpcnN0Um93W29wdGlvbkxhYmVsXTtcbiAgICAgICAgZGVsZXRlIGZpcnN0Um93W29wdGlvbkxhYmVsXTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICBqc29uLmZvckVhY2gocm93ID0+IHtcbiAgICBjb25zdCByb3dLZXlzID0gT2JqZWN0LmtleXMocm93KTtcbiAgICByb3dLZXlzLmZvckVhY2gocm93S2V5ID0+IHtcbiAgICAgIGNvbnN0IHZhbHVlID0gcm93W3Jvd0tleV07XG4gICAgICBpZiAoZGF0YXNldE9ialtyb3dLZXldID09IG51bGwpIHtcbiAgICAgICAgZGF0YXNldE9ialtyb3dLZXldID0gW3ZhbHVlXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGFzZXRPYmpbcm93S2V5XS5wdXNoKHZhbHVlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG4gIGNvbnN0IGRvTGFiZWxzID0gZGF0YXNldE9ialsnbGFiZWxzJ107XG4gIGlmIChkb0xhYmVscyAhPSBudWxsKSB7XG4gICAgbGV0IGxhYmVsc0pzOiBzdHJpbmc7XG4gICAgdHJ5IHtcbiAgICAgIGxhYmVsc0pzID0gaW5kaWNhdG9yVG9KcygnWycgKyBkb0xhYmVscy5qb2luKCkgKyAnXScpO1xuICAgIH0gY2F0Y2ggKGVycjogYW55KSB7XG4gICAgICBlcnIgPSBuZXcgRXJyb3IoYEVycm9yIGluIFwibGFiZWxzXCIgb2YgY2hhcnQgXCIke2NoYXJ0T3B0aW9uc1sndGl0bGUnXX1cIjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIHdpbmRvdy5hbGVydChlcnIubWVzc2FnZSk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICAgIGxhYmVscyA9IHtmb3JtdWxhOiBgcGxhaW5BcnJheSgke2xhYmVsc0pzfSlgfTtcbiAgICBkZWxldGUgZGF0YXNldE9ialsnbGFiZWxzJ107XG4gIH1cbiAgT2JqZWN0LmtleXMoZGF0YXNldE9iaikuZm9yRWFjaCgoZGF0YXNldE9iaktleSwgaW5kZXgpID0+IHtcbiAgICBsZXQgZGF0YXNldEpzOiBzdHJpbmc7XG4gICAgdHJ5IHtcbiAgICAgIGRhdGFzZXRKcyA9IGluZGljYXRvclRvSnMoJ1snICsgZGF0YXNldE9ialtkYXRhc2V0T2JqS2V5XS5qb2luKCkgKyAnXScpO1xuICAgIH0gY2F0Y2ggKGVycjogYW55KSB7XG4gICAgICBlcnIgPSBuZXcgRXJyb3IoYEVycm9yIGluIFwiJHtkYXRhc2V0T2JqS2V5fVwiIG9mIGNoYXJ0IFwiJHtjaGFydE9wdGlvbnNbJ3RpdGxlJ119XCI6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB3aW5kb3cuYWxlcnQoZXJyLm1lc3NhZ2UpO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cblxuICAgIGNvbnN0IGNoYXJ0VHlwZSA9IGNoYXJ0T3B0aW9uc1snY2hhcnRUeXBlJ107XG4gICAgY29uc3QgY29sb3JDb25kaXRpb24gPVxuICAgICAgY2hhcnRUeXBlID09PSAnUGllJyB8fCBjaGFydFR5cGUgPT09ICdQb2xhckFyZWEnIHx8IGNoYXJ0VHlwZSA9PT0gJ0RvdWdobnV0JztcbiAgICBjb25zdCBiYWNrQ29sb3IgPSBjb2xvckNvbmRpdGlvbiA/IGJhY2tncm91bmRDb2xvciA6IGJhY2tncm91bmRDb2xvcltpbmRleF07XG4gICAgY29uc3QgZm9ybXVsYTogQWpmRm9ybXVsYVtdID0gW2NyZWF0ZUZvcm11bGEoe1xuICAgICAgZm9ybXVsYTogYHBsYWluQXJyYXkoJHtkYXRhc2V0SnN9KWBcbiAgICB9KV07XG4gICAgY29uc3QgZGF0YXNldE9wdGlvbnM6IEFqZkNoYXJ0RGF0YXNldE9wdGlvbnMgPSB7XG4gICAgICBiYWNrZ3JvdW5kQ29sb3I6IGJhY2tDb2xvciBhcyBDaGFydENvbG9yLFxuICAgIH07XG4gICAgZGF0YXNldC5wdXNoKHtcbiAgICAgIC4uLmNyZWF0ZURhdGFzZXQoe1xuICAgICAgICBhZ2dyZWdhdGlvbjoge2FnZ3JlZ2F0aW9uOiAwfSxcbiAgICAgICAgZm9ybXVsYSxcbiAgICAgICAgbGFiZWw6IGRhdGFzZXRPYmpLZXksXG4gICAgICB9KSxcbiAgICAgIG9wdGlvbnM6IGRhdGFzZXRPcHRpb25zLFxuICAgIH0gYXMgQWpmQ2hhcnREYXRhc2V0KTtcbiAgfSk7XG5cbiAgcmV0dXJuIGNyZWF0ZVdpZGdldCh7XG4gICAgbmFtZSxcbiAgICB3aWRnZXRUeXBlOiBBamZXaWRnZXRUeXBlLkNoYXJ0LFxuICAgIHR5cGU6IEFqZkNoYXJ0VHlwZVtjaGFydE9wdGlvbnNbJ2NoYXJ0VHlwZSddIGFzIGFueV0gYXMgdW5rbm93biBhcyBBamZDaGFydFR5cGUsXG4gICAgbGFiZWxzLFxuICAgIGRhdGFzZXQsXG4gICAgb3B0aW9uczoge1xuICAgICAgcmVzcG9uc2l2ZTogdHJ1ZSxcbiAgICAgIG1haW50YWluQXNwZWN0UmF0aW86IGZhbHNlLFxuICAgICAgbGVnZW5kOiB7ZGlzcGxheTogdHJ1ZSwgcG9zaXRpb246ICdib3R0b20nfSxcbiAgICAgIHRpdGxlOiB7XG4gICAgICAgIGRpc3BsYXk6IHRydWUsXG4gICAgICAgIHRleHQ6IGNoYXJ0T3B0aW9uc1sndGl0bGUnXSB8fCAnJyxcbiAgICAgIH0sXG4gICAgfSxcbiAgICBzdHlsZXM6IHtcbiAgICAgIC4uLnt3aWR0aDogJzEwMCUnLCBoZWlnaHQ6ICcxMDAlJywgcGFkZGluZzogJzIwcHgnfSxcbiAgICAgIC4uLndpZGdldFN0eWxlLFxuICAgIH0sXG4gICAgZXhwb3J0YWJsZTogdHJ1ZSxcbiAgfSBhcyBBamZXaWRnZXRDcmVhdGUpO1xufVxuXG5mdW5jdGlvbiBfYnVpbGRHcmFwaChuYW1lOiBzdHJpbmcsIGpzb246IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9W10pOiBBamZXaWRnZXQge1xuICBjb25zdCBub2RlczogQWpmR3JhcGhOb2RlRGF0YXNldFtdID0gW107XG5cbiAganNvbi5mb3JFYWNoKHJvdyA9PiB7XG4gICAgY29uc3Qgcm93S2V5cyA9IE9iamVjdC5rZXlzKHJvdyk7XG4gICAgaWYgKHJvd0tleXMuaW5jbHVkZXMoJ2lkJykgJiYgcm93WydpZCddKSB7XG4gICAgICBjb25zdCByb3dJZCA9IHJvd1snaWQnXS50cmltKCkucmVwbGFjZSgvXCIvZywgJycpO1xuICAgICAgaWYgKHJvd0lkICYmIHJvd0lkLmxlbmd0aCkge1xuICAgICAgICBsZXQgZ3JhcGhOb2RlT2JqOiB7W2tleTogc3RyaW5nXTogYW55fSA9IHt9O1xuICAgICAgICByb3dLZXlzLmZvckVhY2gocm93S2V5ID0+IHtcbiAgICAgICAgICBsZXQganM6IHN0cmluZztcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAganMgPSBpbmRpY2F0b3JUb0pzKHJvd1tyb3dLZXldKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgICAgICAgICAgY29uc3Qgcm93TnVtID0gcm93WydfX3Jvd051bV9fJ107XG4gICAgICAgICAgICBlcnIgPSBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgIGBFcnJvciBpbiBcIiR7bmFtZX1cIiwgcm93ICR7cm93TnVtfSwgY29sdW1uIFwiJHtyb3dLZXl9XCI6ICR7ZXJyLm1lc3NhZ2V9YFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHdpbmRvdy5hbGVydChlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgfVxuICAgICAgICAgIGdyYXBoTm9kZU9ialtyb3dLZXldID0ganM7XG4gICAgICAgIH0pO1xuICAgICAgICBncmFwaE5vZGVPYmpbJ2lkJ10gPSByb3dJZDtcbiAgICAgICAgbm9kZXMucHVzaChncmFwaE5vZGVPYmogYXMgQWpmR3JhcGhOb2RlRGF0YXNldCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gY3JlYXRlV2lkZ2V0KHtcbiAgICB3aWRnZXRUeXBlOiBBamZXaWRnZXRUeXBlLkdyYXBoLFxuICAgIG5vZGVzLFxuICAgIHN0eWxlczoge30sXG4gIH0gYXMgQWpmV2lkZ2V0Q3JlYXRlKTtcbn1cblxuZnVuY3Rpb24gX2J1aWxkSHRtbChqc29uOiB7W2tleTogc3RyaW5nXTogc3RyaW5nfVtdKTogQWpmV2lkZ2V0IHtcbiAgY29uc3QgZmlyc3RSb3cgPSBqc29uLmxlbmd0aCA+IDAgJiYganNvblswXVsnaHRtbCddICE9IG51bGwgPyBqc29uWzBdIDoge2h0bWw6ICcnfTtcblxuICByZXR1cm4gY3JlYXRlV2lkZ2V0KHtcbiAgICB3aWRnZXRUeXBlOiBBamZXaWRnZXRUeXBlLlRleHQsXG4gICAgaHRtbFRleHQ6IFN0cmluZyhmaXJzdFJvd1snaHRtbCddKSxcbiAgICBzdHlsZXM6IGh0bWxXaWRnZXQsXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBfYnVpbGRUYWJsZShzaGVldE5hbWU6IHN0cmluZywganNvbjoge1trZXk6IHN0cmluZ106IHN0cmluZ31bXSk6IEFqZldpZGdldCB7XG4gIGNvbnN0IHJvd3NwYW4gPSAxO1xuICBjb25zdCB0aXRsZXMgPSBPYmplY3Qua2V5cyhqc29uWzBdKTtcbiAgY29uc3QgY29sc3BhbnM6IG51bWJlcltdID0gKE9iamVjdC52YWx1ZXMoanNvblswXSkgYXMgc3RyaW5nW10pLm1hcChyID0+ICtyKTtcbiAgZGVsZXRlIGpzb25bMF07XG4gIGNvbnN0IHRhYmxlSGVhZGVyOiBBamZUYWJsZURhdGFzZXRbXSA9IHRpdGxlcy5tYXAoKHRpdGxlLCBpbmRleCkgPT4gKHtcbiAgICBsYWJlbDogJycsXG4gICAgZm9ybXVsYToge2Zvcm11bGE6IGBcIiR7dGl0bGV9XCJgfSxcbiAgICBhZ2dyZWdhdGlvbjoge2FnZ3JlZ2F0aW9uOiAwfSxcbiAgICBjb2xzcGFuOiBjb2xzcGFuc1tpbmRleF0sXG4gICAgcm93c3BhbixcbiAgICBzdHlsZToge1xuICAgICAgdGV4dEFsaWduOiAnY2VudGVyJyxcbiAgICAgIGZvbnRXZWlnaHQ6ICdib2xkJyxcbiAgICAgIGNvbG9yOiAnd2hpdGUnLFxuICAgICAgYmFja2dyb3VuZENvbG9yOiAnIzNmNTFiNScsXG4gICAgfSxcbiAgfSkpO1xuXG4gIGNvbnNvbGUubG9nKGpzb24pO1xuICBsZXQgZGF0YVJvd3MgPSAnWyc7XG4gIGpzb24uZm9yRWFjaChyb3cgPT4ge1xuICAgIGxldCBkYXRhUm93ID0gJ1snO1xuICAgIHRpdGxlcy5mb3JFYWNoKHRpdGxlID0+IHtcbiAgICAgIGxldCBlbGVtID0gcm93W3RpdGxlXSB8fCBgJydgO1xuICAgICAgdHJ5IHtcbiAgICAgICAgZWxlbSA9IGluZGljYXRvclRvSnMoZWxlbSk7XG4gICAgICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgICAgICBjb25zdCByb3dOdW0gPSByb3dbJ19fcm93TnVtX18nXTtcbiAgICAgICAgZXJyID0gbmV3IEVycm9yKFxuICAgICAgICAgIGBFcnJvciBpbiBcIiR7c2hlZXROYW1lfVwiLCByb3cgJHtyb3dOdW19LCBjb2x1bW4gXCIke3RpdGxlfVwiOiAke2Vyci5tZXNzYWdlfWBcbiAgICAgICAgKTtcbiAgICAgICAgd2luZG93LmFsZXJ0KGVyci5tZXNzYWdlKTtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgICAgZGF0YVJvdyArPSBlbGVtICsgJywnO1xuICAgIH0pO1xuICAgIGRhdGFSb3cgKz0gJ10nO1xuICAgIGRhdGFSb3dzICs9IGRhdGFSb3cgKyAnLCc7XG4gIH0pO1xuICBkYXRhUm93cyArPSAnXSc7XG5cbiAgcmV0dXJuIGNyZWF0ZVdpZGdldCh7XG4gICAgd2lkZ2V0VHlwZTogQWpmV2lkZ2V0VHlwZS5EeW5hbWljVGFibGUsXG4gICAgcm93RGVmaW5pdGlvbjoge1xuICAgICAgZm9ybXVsYTogYGJ1aWxkRGF0YXNldCgke2RhdGFSb3dzfSwke0pTT04uc3RyaW5naWZ5KGNvbHNwYW5zKX0pYCxcbiAgICB9LFxuICAgIGRhdGFzZXQ6IHRhYmxlSGVhZGVyLFxuICAgIGV4cG9ydGFibGU6IHRydWUsXG4gICAgY2VsbFN0eWxlczoge1xuICAgICAgdGV4dEFsaWduOiAnY2VudGVyJyxcbiAgICAgIGNvbG9yOiAnYmxhY2snLFxuICAgICAgYmFja2dyb3VuZENvbG9yOiAnd2hpdGUnLFxuICAgIH0sXG4gICAgc3R5bGVzOiB7XG4gICAgICBib3JkZXJDb2xsYXBzZTogJ2NvbGxhcHNlJyxcbiAgICB9LFxuICB9KTtcbn1cbiJdfQ==