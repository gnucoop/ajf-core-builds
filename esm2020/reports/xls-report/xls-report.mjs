/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import * as XLSX from 'xlsx';
import { createFormula } from '@ajf/core/models';
import { backgroundColor } from '../automatic-report/styles';
import { indicatorToJs } from './hindikit-parser';
import { htmlWidget, widgetStyle } from './styles';
import { createDataset } from '../utils/dataset/create-dataset';
import { createReportContainer } from '../utils/reports/create-report-container';
import { createWidget } from '../utils/widgets/create-widget';
import { AjfWidgetType } from '../interface/widgets/widget-type';
import { AjfChartType } from '../interface/charts/chart-type';
import { deepCopy } from '@ajf/core/utils';
import { forkJoin, of } from 'rxjs';
import { map } from 'rxjs/operators';
/**
 * This function returns a basic report for any form passed in input.
 *
 * @param form the form schema
 * @param [id] the id of the form inside the plathform.
 */
export function xlsReport(file, http) {
    const workbook = XLSX.read(file, { type: 'binary' });
    const report = {};
    const reportWidgets = [];
    const variables = [];
    const filters = {};
    // create filters
    workbook.SheetNames.forEach((sheetName, index) => {
        const sheet = workbook.Sheets[sheetName];
        if (sheetName.includes('filter') && index + 1 < workbook.SheetNames.length) {
            const nextSheet = sheetName.includes('global')
                ? 'global_filter'
                : workbook.SheetNames[index + 1];
            filters[nextSheet] = _buildFilter(workbook, sheet, http);
        }
    });
    const obsFilterValues = Object.values(filters);
    const filterNames = Object.keys(filters);
    return forkJoin(obsFilterValues.length > 0 ? obsFilterValues : of([])).pipe(map(f => {
        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet);
            if (sheetName === 'variables') {
                json
                    .filter(e => e != null && e.name != null && e.value != null)
                    .forEach(elem => {
                    let indicator = elem.value;
                    try {
                        indicator = indicatorToJs(elem.value);
                    }
                    catch (e) {
                        console.log(e);
                    }
                    variables.push({ name: elem.name, formula: { formula: indicator } });
                });
            }
            else {
                const idx = filterNames.indexOf(sheetName);
                if (sheetName.includes('table')) {
                    const tableWidget = _buildTable(json);
                    reportWidgets.push(tableWidget);
                }
                else if (sheetName.includes('chart')) {
                    const chartWidget = _buildChart(sheetName, json);
                    reportWidgets.push(chartWidget);
                }
                else if (sheetName.includes('html')) {
                    const chartWidget = _buildHtml(json);
                    reportWidgets.push(chartWidget);
                }
                if (idx >= 0) {
                    reportWidgets[reportWidgets.length - 1].filter = { schema: f[idx] };
                }
            }
        });
        const globalFilterIdx = filterNames.indexOf('global_filter');
        const layoutWidget = {
            widgetType: AjfWidgetType.Layout,
            content: [
                createWidget({
                    widgetType: AjfWidgetType.Column,
                    content: [...reportWidgets],
                    filter: globalFilterIdx >= 0 ? { schema: f[globalFilterIdx] } : undefined,
                }),
            ],
            columns: [1],
            visibility: {
                condition: 'true',
            },
            styles: {},
        };
        report.variables = variables;
        report.content = createReportContainer(layoutWidget);
        return report;
    }));
}
function _buildFilter(wbook, sheet, http) {
    const data = new FormData();
    const filterBook = deepCopy(wbook);
    const filterSheet = deepCopy(sheet);
    const choicesSheet = deepCopy(wbook.Sheets['choices']);
    filterBook.SheetNames = ['survey', 'choices'];
    filterBook.Sheets = { survey: filterSheet, choices: choicesSheet };
    const filterXlsx = XLSX.write(filterBook, {
        bookType: 'xlsx',
        type: 'array',
    });
    const file = new File([filterXlsx], 'filter.xlsx');
    data.append('excelFile', file);
    return http.post('https://formconv.herokuapp.com/result.json', data);
}
function _buildChart(name, json) {
    const optionLabels = ['chartType', 'title'];
    const chartOptions = {};
    const datasetObj = {};
    const dataset = [];
    let labels = { formula: `[]` };
    if (json.length > 0) {
        const firstRow = json[0];
        optionLabels.forEach(optionLabel => {
            if (firstRow[optionLabel] != null) {
                chartOptions[optionLabel] = firstRow[optionLabel];
                delete firstRow[optionLabel];
            }
        });
    }
    json.forEach(row => {
        const rowKeys = Object.keys(row);
        rowKeys.forEach(rowKey => {
            const value = row[rowKey];
            if (datasetObj[rowKey] == null) {
                datasetObj[rowKey] = [value];
            }
            else {
                datasetObj[rowKey].push(value);
            }
        });
    });
    if (datasetObj.labels != null) {
        labels = {
            formula: `plainArray([${datasetObj.labels.map((label) => indicatorToJs(label))}])`,
        };
        delete datasetObj.labels;
    }
    Object.keys(datasetObj).forEach((datasetObjKey, index) => {
        const datasetRow = datasetObj[datasetObjKey].map((r) => indicatorToJs(`${r}`));
        const colorCondition = chartOptions.chartType === 'Pie' ||
            chartOptions.chartType === 'PolarArea' ||
            chartOptions.chartType === 'Doughnut';
        const backColor = colorCondition ? backgroundColor : backgroundColor[index];
        const formula = [
            createFormula({ formula: `plainArray([${datasetRow.toString()}])` }),
        ];
        const datasetOptions = { backgroundColor: backColor };
        dataset.push({
            ...createDataset({ aggregation: { aggregation: 0 }, formula, label: datasetObjKey }),
            options: datasetOptions,
        });
    });
    return createWidget({
        name,
        widgetType: AjfWidgetType.Chart,
        type: AjfChartType[chartOptions.chartType],
        labels,
        dataset,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: { display: true, position: 'bottom' },
            title: { display: true, text: `${chartOptions.title || ''}`.replace(/"/gi, '') },
        },
        styles: { ...{ width: '100%', height: '100%', padding: '20px' }, ...widgetStyle },
        exportable: true,
    });
}
function _buildHtml(json) {
    const firstRow = json.length > 0 && json[0].html != null ? json[0] : { html: '' };
    return createWidget({
        widgetType: AjfWidgetType.Text,
        htmlText: `${firstRow.html}`,
        styles: htmlWidget,
    });
}
function _buildTable(json) {
    const rowspan = 1;
    const dataElements = [];
    const titles = Object.keys(json[0]);
    const colspans = Object.values(json[0]).map(r => +r);
    delete json[0];
    const tableHeader = titles.map((title, index) => ({
        label: '',
        formula: { formula: `\"${title}\"` },
        aggregation: { aggregation: 0 },
        colspan: colspans[index],
        rowspan,
        style: {
            textAlign: 'center',
            fontWeight: 'bold',
            color: 'white',
            backgroundColor: '#3f51b5',
        },
    }));
    json.forEach(row => {
        const elems = [];
        titles.forEach(title => {
            let elem = row[title] || `\"\"`;
            try {
                elem = indicatorToJs(elem);
            }
            catch (err) {
                console.log('erro', elem, title, row);
                console.log(err.message);
                elem = `${row[title]}`;
            }
            elems.push(elem.replace(/[\*\/\r\n]|@[\w-]+/g, ''));
        });
        dataElements.push(elems);
    });
    return createWidget({
        widgetType: AjfWidgetType.DynamicTable,
        rowDefinition: {
            formula: `buildDataset([${dataElements}],${JSON.stringify(colspans)})`,
        },
        dataset: tableHeader,
        exportable: true,
        cellStyles: {
            textAlign: 'center',
            color: 'black',
            backgroundColor: 'white',
        },
        styles: {
            borderCollapse: 'collapse',
        },
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieGxzLXJlcG9ydC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3JlcG9ydHMveGxzLXJlcG9ydC94bHMtcmVwb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUdILE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBRTdCLE9BQU8sRUFBYSxhQUFhLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUMzRCxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFFM0QsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBQyxVQUFVLEVBQUUsV0FBVyxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQ2pELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxpQ0FBaUMsQ0FBQztBQUM5RCxPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSwwQ0FBMEMsQ0FBQztBQUMvRSxPQUFPLEVBQWtCLFlBQVksRUFBQyxNQUFNLGdDQUFnQyxDQUFDO0FBQzdFLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxrQ0FBa0MsQ0FBQztBQUkvRCxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFJNUQsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBRXpDLE9BQU8sRUFBQyxRQUFRLEVBQWMsRUFBRSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQzlDLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUluQzs7Ozs7R0FLRztBQUNILE1BQU0sVUFBVSxTQUFTLENBQUMsSUFBWSxFQUFFLElBQWdCO0lBQ3RELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUMsSUFBSSxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUM7SUFDbkQs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QUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3RDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUN6QixJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQzthQUN4QjtZQUNELEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3RELENBQUMsQ0FBQyxDQUFDO1FBQ0gsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMzQixDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sWUFBWSxDQUFDO1FBQ2xCLFVBQVUsRUFBRSxhQUFhLENBQUMsWUFBWTtRQUN0QyxhQUFhLEVBQUU7WUFDYixPQUFPLEVBQUUsaUJBQWlCLFlBQVksS0FBSyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxHQUFHO1NBQ3ZFO1FBQ0QsT0FBTyxFQUFFLFdBQVc7UUFDcEIsVUFBVSxFQUFFLElBQUk7UUFDaEIsVUFBVSxFQUFFO1lBQ1YsU0FBUyxFQUFFLFFBQVE7WUFDbkIsS0FBSyxFQUFFLE9BQU87WUFDZCxlQUFlLEVBQUUsT0FBTztTQUN6QjtRQUNELE1BQU0sRUFBRTtZQUNOLGNBQWMsRUFBRSxVQUFVO1NBQzNCO0tBQ2lCLENBQUMsQ0FBQztBQUN4QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChDKSBHbnVjb29wIHNvYy4gY29vcC5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vclxuICogbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzXG4gKiBwdWJsaXNoZWQgYnkgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSxcbiAqIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlUgQWZmZXJvXG4gKiBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKiBJZiBub3QsIHNlZSBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvLlxuICpcbiAqL1xuXG5pbXBvcnQge0NoYXJ0Q29sb3J9IGZyb20gJ2NoYXJ0LmpzJztcbmltcG9ydCAqIGFzIFhMU1ggZnJvbSAneGxzeCc7XG5cbmltcG9ydCB7QWpmRm9ybXVsYSwgY3JlYXRlRm9ybXVsYX0gZnJvbSAnQGFqZi9jb3JlL21vZGVscyc7XG5pbXBvcnQge2JhY2tncm91bmRDb2xvcn0gZnJvbSAnLi4vYXV0b21hdGljLXJlcG9ydC9zdHlsZXMnO1xuXG5pbXBvcnQge2luZGljYXRvclRvSnN9IGZyb20gJy4vaGluZGlraXQtcGFyc2VyJztcbmltcG9ydCB7aHRtbFdpZGdldCwgd2lkZ2V0U3R5bGV9IGZyb20gJy4vc3R5bGVzJztcbmltcG9ydCB7Y3JlYXRlRGF0YXNldH0gZnJvbSAnLi4vdXRpbHMvZGF0YXNldC9jcmVhdGUtZGF0YXNldCc7XG5pbXBvcnQge2NyZWF0ZVJlcG9ydENvbnRhaW5lcn0gZnJvbSAnLi4vdXRpbHMvcmVwb3J0cy9jcmVhdGUtcmVwb3J0LWNvbnRhaW5lcic7XG5pbXBvcnQge0FqZldpZGdldENyZWF0ZSwgY3JlYXRlV2lkZ2V0fSBmcm9tICcuLi91dGlscy93aWRnZXRzL2NyZWF0ZS13aWRnZXQnO1xuaW1wb3J0IHtBamZXaWRnZXRUeXBlfSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy93aWRnZXQtdHlwZSc7XG5pbXBvcnQge0FqZlRhYmxlRGF0YXNldH0gZnJvbSAnLi4vaW50ZXJmYWNlL2RhdGFzZXQvdGFibGUtZGF0YXNldCc7XG5pbXBvcnQge0FqZkNoYXJ0RGF0YXNldH0gZnJvbSAnLi4vaW50ZXJmYWNlL2RhdGFzZXQvY2hhcnQtZGF0YXNldCc7XG5pbXBvcnQge0FqZkNoYXJ0RGF0YXNldE9wdGlvbnN9IGZyb20gJy4uL2ludGVyZmFjZS9kYXRhc2V0L2NoYXJ0LWRhdGFzZXQtb3B0aW9ucyc7XG5pbXBvcnQge0FqZkNoYXJ0VHlwZX0gZnJvbSAnLi4vaW50ZXJmYWNlL2NoYXJ0cy9jaGFydC10eXBlJztcbmltcG9ydCB7QWpmV2lkZ2V0fSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy93aWRnZXQnO1xuaW1wb3J0IHtBamZSZXBvcnR9IGZyb20gJy4uL2ludGVyZmFjZS9yZXBvcnRzL3JlcG9ydCc7XG5pbXBvcnQge0FqZlJlcG9ydFZhcmlhYmxlfSBmcm9tICcuLi9pbnRlcmZhY2UvcmVwb3J0cy9yZXBvcnQtdmFyaWFibGUnO1xuaW1wb3J0IHtkZWVwQ29weX0gZnJvbSAnQGFqZi9jb3JlL3V0aWxzJztcbmltcG9ydCB7SHR0cENsaWVudH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtmb3JrSm9pbiwgT2JzZXJ2YWJsZSwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttYXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7QWpmTGF5b3V0V2lkZ2V0fSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy9sYXlvdXQtd2lkZ2V0JztcbmltcG9ydCB7QWpmQ29sdW1uV2lkZ2V0fSBmcm9tICcuLi9pbnRlcmZhY2Uvd2lkZ2V0cy9jb2x1bW4td2lkZ2V0JztcblxuLyoqXG4gKiBUaGlzIGZ1bmN0aW9uIHJldHVybnMgYSBiYXNpYyByZXBvcnQgZm9yIGFueSBmb3JtIHBhc3NlZCBpbiBpbnB1dC5cbiAqXG4gKiBAcGFyYW0gZm9ybSB0aGUgZm9ybSBzY2hlbWFcbiAqIEBwYXJhbSBbaWRdIHRoZSBpZCBvZiB0aGUgZm9ybSBpbnNpZGUgdGhlIHBsYXRoZm9ybS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHhsc1JlcG9ydChmaWxlOiBzdHJpbmcsIGh0dHA6IEh0dHBDbGllbnQpOiBPYnNlcnZhYmxlPEFqZlJlcG9ydD4ge1xuICBjb25zdCB3b3JrYm9vayA9IFhMU1gucmVhZChmaWxlLCB7dHlwZTogJ2JpbmFyeSd9KTtcbiAgY29uc3QgcmVwb3J0OiBBamZSZXBvcnQgPSB7fTtcbiAgY29uc3QgcmVwb3J0V2lkZ2V0czogQWpmV2lkZ2V0W10gPSBbXTtcblxuICBjb25zdCB2YXJpYWJsZXM6IEFqZlJlcG9ydFZhcmlhYmxlW10gPSBbXTtcbiAgY29uc3QgZmlsdGVyczoge1tzaGVldE5hbWU6IHN0cmluZ106IE9ic2VydmFibGU8YW55Pn0gPSB7fTtcbiAgLy8gY3JlYXRlIGZpbHRlcnNcbiAgd29ya2Jvb2suU2hlZXROYW1lcy5mb3JFYWNoKChzaGVldE5hbWUsIGluZGV4KSA9PiB7XG4gICAgY29uc3Qgc2hlZXQ6IFhMU1guV29ya1NoZWV0ID0gd29ya2Jvb2suU2hlZXRzW3NoZWV0TmFtZV07XG4gICAgaWYgKHNoZWV0TmFtZS5pbmNsdWRlcygnZmlsdGVyJykgJiYgaW5kZXggKyAxIDwgd29ya2Jvb2suU2hlZXROYW1lcy5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IG5leHRTaGVldCA9IHNoZWV0TmFtZS5pbmNsdWRlcygnZ2xvYmFsJylcbiAgICAgICAgPyAnZ2xvYmFsX2ZpbHRlcidcbiAgICAgICAgOiB3b3JrYm9vay5TaGVldE5hbWVzW2luZGV4ICsgMV07XG4gICAgICBmaWx0ZXJzW25leHRTaGVldF0gPSBfYnVpbGRGaWx0ZXIod29ya2Jvb2ssIHNoZWV0LCBodHRwKTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IG9ic0ZpbHRlclZhbHVlczogT2JzZXJ2YWJsZTxhbnk+W10gPSBPYmplY3QudmFsdWVzKGZpbHRlcnMpO1xuICBjb25zdCBmaWx0ZXJOYW1lczogc3RyaW5nW10gPSBPYmplY3Qua2V5cyhmaWx0ZXJzKTtcblxuICByZXR1cm4gZm9ya0pvaW4ob2JzRmlsdGVyVmFsdWVzLmxlbmd0aCA+IDAgPyBvYnNGaWx0ZXJWYWx1ZXMgOiBvZihbXSkpLnBpcGUoXG4gICAgbWFwKGYgPT4ge1xuICAgICAgd29ya2Jvb2suU2hlZXROYW1lcy5mb3JFYWNoKHNoZWV0TmFtZSA9PiB7XG4gICAgICAgIGNvbnN0IHNoZWV0OiBYTFNYLldvcmtTaGVldCA9IHdvcmtib29rLlNoZWV0c1tzaGVldE5hbWVdO1xuICAgICAgICBjb25zdCBqc29uID0gWExTWC51dGlscy5zaGVldF90b19qc29uKHNoZWV0KSBhcyB7bmFtZTogc3RyaW5nOyB2YWx1ZTogc3RyaW5nfVtdO1xuXG4gICAgICAgIGlmIChzaGVldE5hbWUgPT09ICd2YXJpYWJsZXMnKSB7XG4gICAgICAgICAganNvblxuICAgICAgICAgICAgLmZpbHRlcihlID0+IGUgIT0gbnVsbCAmJiBlLm5hbWUgIT0gbnVsbCAmJiBlLnZhbHVlICE9IG51bGwpXG4gICAgICAgICAgICAuZm9yRWFjaChlbGVtID0+IHtcbiAgICAgICAgICAgICAgbGV0IGluZGljYXRvciA9IGVsZW0udmFsdWU7XG4gICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgaW5kaWNhdG9yID0gaW5kaWNhdG9yVG9KcyhlbGVtLnZhbHVlKTtcbiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHZhcmlhYmxlcy5wdXNoKHtuYW1lOiBlbGVtLm5hbWUsIGZvcm11bGE6IHtmb3JtdWxhOiBpbmRpY2F0b3J9fSBhcyBBamZSZXBvcnRWYXJpYWJsZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBpZHggPSBmaWx0ZXJOYW1lcy5pbmRleE9mKHNoZWV0TmFtZSk7XG5cbiAgICAgICAgICBpZiAoc2hlZXROYW1lLmluY2x1ZGVzKCd0YWJsZScpKSB7XG4gICAgICAgICAgICBjb25zdCB0YWJsZVdpZGdldCA9IF9idWlsZFRhYmxlKGpzb24pO1xuICAgICAgICAgICAgcmVwb3J0V2lkZ2V0cy5wdXNoKHRhYmxlV2lkZ2V0KTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHNoZWV0TmFtZS5pbmNsdWRlcygnY2hhcnQnKSkge1xuICAgICAgICAgICAgY29uc3QgY2hhcnRXaWRnZXQgPSBfYnVpbGRDaGFydChzaGVldE5hbWUsIGpzb24pO1xuICAgICAgICAgICAgcmVwb3J0V2lkZ2V0cy5wdXNoKGNoYXJ0V2lkZ2V0KTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHNoZWV0TmFtZS5pbmNsdWRlcygnaHRtbCcpKSB7XG4gICAgICAgICAgICBjb25zdCBjaGFydFdpZGdldCA9IF9idWlsZEh0bWwoanNvbik7XG4gICAgICAgICAgICByZXBvcnRXaWRnZXRzLnB1c2goY2hhcnRXaWRnZXQpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChpZHggPj0gMCkge1xuICAgICAgICAgICAgcmVwb3J0V2lkZ2V0c1tyZXBvcnRXaWRnZXRzLmxlbmd0aCAtIDFdLmZpbHRlciA9IHtzY2hlbWE6IGZbaWR4XX07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGdsb2JhbEZpbHRlcklkeCA9IGZpbHRlck5hbWVzLmluZGV4T2YoJ2dsb2JhbF9maWx0ZXInKTtcbiAgICAgIGNvbnN0IGxheW91dFdpZGdldDogQWpmTGF5b3V0V2lkZ2V0ID0ge1xuICAgICAgICB3aWRnZXRUeXBlOiBBamZXaWRnZXRUeXBlLkxheW91dCxcbiAgICAgICAgY29udGVudDogW1xuICAgICAgICAgIGNyZWF0ZVdpZGdldCh7XG4gICAgICAgICAgICB3aWRnZXRUeXBlOiBBamZXaWRnZXRUeXBlLkNvbHVtbixcbiAgICAgICAgICAgIGNvbnRlbnQ6IFsuLi5yZXBvcnRXaWRnZXRzXSxcbiAgICAgICAgICAgIGZpbHRlcjogZ2xvYmFsRmlsdGVySWR4ID49IDAgPyB7c2NoZW1hOiBmW2dsb2JhbEZpbHRlcklkeF19IDogdW5kZWZpbmVkLFxuICAgICAgICAgIH0gYXMgQWpmQ29sdW1uV2lkZ2V0KSxcbiAgICAgICAgXSxcbiAgICAgICAgY29sdW1uczogWzFdLFxuICAgICAgICB2aXNpYmlsaXR5OiB7XG4gICAgICAgICAgY29uZGl0aW9uOiAndHJ1ZScsXG4gICAgICAgIH0sXG4gICAgICAgIHN0eWxlczoge30sXG4gICAgICB9O1xuXG4gICAgICByZXBvcnQudmFyaWFibGVzID0gdmFyaWFibGVzO1xuICAgICAgcmVwb3J0LmNvbnRlbnQgPSBjcmVhdGVSZXBvcnRDb250YWluZXIobGF5b3V0V2lkZ2V0KTtcblxuICAgICAgcmV0dXJuIHJlcG9ydDtcbiAgICB9KSxcbiAgKTtcbn1cblxuZnVuY3Rpb24gX2J1aWxkRmlsdGVyKFxuICB3Ym9vazogWExTWC5Xb3JrQm9vayxcbiAgc2hlZXQ6IFhMU1guV29ya1NoZWV0LFxuICBodHRwOiBIdHRwQ2xpZW50LFxuKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgY29uc3QgZGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICBjb25zdCBmaWx0ZXJCb29rOiBYTFNYLldvcmtCb29rID0gZGVlcENvcHkod2Jvb2spO1xuICBjb25zdCBmaWx0ZXJTaGVldDogWExTWC5Xb3JrU2hlZXQgPSBkZWVwQ29weShzaGVldCk7XG4gIGNvbnN0IGNob2ljZXNTaGVldDogWExTWC5Xb3JrU2hlZXQgPSBkZWVwQ29weSh3Ym9vay5TaGVldHNbJ2Nob2ljZXMnXSk7XG4gIGZpbHRlckJvb2suU2hlZXROYW1lcyA9IFsnc3VydmV5JywgJ2Nob2ljZXMnXTtcbiAgZmlsdGVyQm9vay5TaGVldHMgPSB7c3VydmV5OiBmaWx0ZXJTaGVldCwgY2hvaWNlczogY2hvaWNlc1NoZWV0fTtcbiAgY29uc3QgZmlsdGVyWGxzeCA9IFhMU1gud3JpdGUoZmlsdGVyQm9vaywge1xuICAgIGJvb2tUeXBlOiAneGxzeCcsXG4gICAgdHlwZTogJ2FycmF5JyxcbiAgfSk7XG4gIGNvbnN0IGZpbGUgPSBuZXcgRmlsZShbZmlsdGVyWGxzeF0sICdmaWx0ZXIueGxzeCcpO1xuICBkYXRhLmFwcGVuZCgnZXhjZWxGaWxlJywgZmlsZSk7XG5cbiAgcmV0dXJuIGh0dHAucG9zdCgnaHR0cHM6Ly9mb3JtY29udi5oZXJva3VhcHAuY29tL3Jlc3VsdC5qc29uJywgZGF0YSk7XG59XG5cbmZ1bmN0aW9uIF9idWlsZENoYXJ0KG5hbWU6IHN0cmluZywganNvbjoge1trZXk6IHN0cmluZ106IHN0cmluZ31bXSk6IEFqZldpZGdldCB7XG4gIGNvbnN0IG9wdGlvbkxhYmVscyA9IFsnY2hhcnRUeXBlJywgJ3RpdGxlJ107XG4gIGNvbnN0IGNoYXJ0T3B0aW9uczoge1trZXk6IHN0cmluZ106IHN0cmluZ30gPSB7fTtcbiAgY29uc3QgZGF0YXNldE9iajoge1trZXk6IHN0cmluZ106IGFueX0gPSB7fTtcbiAgY29uc3QgZGF0YXNldDogQWpmQ2hhcnREYXRhc2V0W10gPSBbXTtcbiAgbGV0IGxhYmVsczogQWpmRm9ybXVsYSA9IHtmb3JtdWxhOiBgW11gfTtcblxuICBpZiAoanNvbi5sZW5ndGggPiAwKSB7XG4gICAgY29uc3QgZmlyc3RSb3cgPSBqc29uWzBdO1xuICAgIG9wdGlvbkxhYmVscy5mb3JFYWNoKG9wdGlvbkxhYmVsID0+IHtcbiAgICAgIGlmIChmaXJzdFJvd1tvcHRpb25MYWJlbF0gIT0gbnVsbCkge1xuICAgICAgICBjaGFydE9wdGlvbnNbb3B0aW9uTGFiZWxdID0gZmlyc3RSb3dbb3B0aW9uTGFiZWxdO1xuICAgICAgICBkZWxldGUgZmlyc3RSb3dbb3B0aW9uTGFiZWxdO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIGpzb24uZm9yRWFjaChyb3cgPT4ge1xuICAgIGNvbnN0IHJvd0tleXMgPSBPYmplY3Qua2V5cyhyb3cpO1xuICAgIHJvd0tleXMuZm9yRWFjaChyb3dLZXkgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSByb3dbcm93S2V5XTtcbiAgICAgIGlmIChkYXRhc2V0T2JqW3Jvd0tleV0gPT0gbnVsbCkge1xuICAgICAgICBkYXRhc2V0T2JqW3Jvd0tleV0gPSBbdmFsdWVdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGF0YXNldE9ialtyb3dLZXldLnB1c2godmFsdWUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbiAgaWYgKGRhdGFzZXRPYmoubGFiZWxzICE9IG51bGwpIHtcbiAgICBsYWJlbHMgPSB7XG4gICAgICBmb3JtdWxhOiBgcGxhaW5BcnJheShbJHtkYXRhc2V0T2JqLmxhYmVscy5tYXAoKGxhYmVsOiBzdHJpbmcpID0+IGluZGljYXRvclRvSnMobGFiZWwpKX1dKWAsXG4gICAgfTtcbiAgICBkZWxldGUgZGF0YXNldE9iai5sYWJlbHM7XG4gIH1cbiAgT2JqZWN0LmtleXMoZGF0YXNldE9iaikuZm9yRWFjaCgoZGF0YXNldE9iaktleSwgaW5kZXgpID0+IHtcbiAgICBjb25zdCBkYXRhc2V0Um93ID0gZGF0YXNldE9ialtkYXRhc2V0T2JqS2V5XS5tYXAoKHI6IHN0cmluZykgPT4gaW5kaWNhdG9yVG9KcyhgJHtyfWApKTtcblxuICAgIGNvbnN0IGNvbG9yQ29uZGl0aW9uID1cbiAgICAgIGNoYXJ0T3B0aW9ucy5jaGFydFR5cGUgPT09ICdQaWUnIHx8XG4gICAgICBjaGFydE9wdGlvbnMuY2hhcnRUeXBlID09PSAnUG9sYXJBcmVhJyB8fFxuICAgICAgY2hhcnRPcHRpb25zLmNoYXJ0VHlwZSA9PT0gJ0RvdWdobnV0JztcbiAgICBjb25zdCBiYWNrQ29sb3IgPSBjb2xvckNvbmRpdGlvbiA/IGJhY2tncm91bmRDb2xvciA6IGJhY2tncm91bmRDb2xvcltpbmRleF07XG4gICAgY29uc3QgZm9ybXVsYTogQWpmRm9ybXVsYVtdID0gW1xuICAgICAgY3JlYXRlRm9ybXVsYSh7Zm9ybXVsYTogYHBsYWluQXJyYXkoWyR7ZGF0YXNldFJvdy50b1N0cmluZygpfV0pYH0pLFxuICAgIF07XG4gICAgY29uc3QgZGF0YXNldE9wdGlvbnM6IEFqZkNoYXJ0RGF0YXNldE9wdGlvbnMgPSB7YmFja2dyb3VuZENvbG9yOiBiYWNrQ29sb3IgYXMgQ2hhcnRDb2xvcn07XG4gICAgZGF0YXNldC5wdXNoKHtcbiAgICAgIC4uLmNyZWF0ZURhdGFzZXQoe2FnZ3JlZ2F0aW9uOiB7YWdncmVnYXRpb246IDB9LCBmb3JtdWxhLCBsYWJlbDogZGF0YXNldE9iaktleX0pLFxuICAgICAgb3B0aW9uczogZGF0YXNldE9wdGlvbnMsXG4gICAgfSBhcyBBamZDaGFydERhdGFzZXQpO1xuICB9KTtcblxuICByZXR1cm4gY3JlYXRlV2lkZ2V0KHtcbiAgICBuYW1lLFxuICAgIHdpZGdldFR5cGU6IEFqZldpZGdldFR5cGUuQ2hhcnQsXG4gICAgdHlwZTogQWpmQ2hhcnRUeXBlW2NoYXJ0T3B0aW9ucy5jaGFydFR5cGUgYXMgYW55XSBhcyB1bmtub3duIGFzIEFqZkNoYXJ0VHlwZSxcbiAgICBsYWJlbHMsXG4gICAgZGF0YXNldCxcbiAgICBvcHRpb25zOiB7XG4gICAgICByZXNwb25zaXZlOiB0cnVlLFxuICAgICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsXG4gICAgICBsZWdlbmQ6IHtkaXNwbGF5OiB0cnVlLCBwb3NpdGlvbjogJ2JvdHRvbSd9LFxuICAgICAgdGl0bGU6IHtkaXNwbGF5OiB0cnVlLCB0ZXh0OiBgJHtjaGFydE9wdGlvbnMudGl0bGUgfHwgJyd9YC5yZXBsYWNlKC9cIi9naSwgJycpfSxcbiAgICB9LFxuICAgIHN0eWxlczogey4uLnt3aWR0aDogJzEwMCUnLCBoZWlnaHQ6ICcxMDAlJywgcGFkZGluZzogJzIwcHgnfSwgLi4ud2lkZ2V0U3R5bGV9LFxuICAgIGV4cG9ydGFibGU6IHRydWUsXG4gIH0gYXMgQWpmV2lkZ2V0Q3JlYXRlKTtcbn1cblxuZnVuY3Rpb24gX2J1aWxkSHRtbChqc29uOiB7W2tleTogc3RyaW5nXTogc3RyaW5nfVtdKTogQWpmV2lkZ2V0IHtcbiAgY29uc3QgZmlyc3RSb3cgPSBqc29uLmxlbmd0aCA+IDAgJiYganNvblswXS5odG1sICE9IG51bGwgPyBqc29uWzBdIDoge2h0bWw6ICcnfTtcblxuICByZXR1cm4gY3JlYXRlV2lkZ2V0KHtcbiAgICB3aWRnZXRUeXBlOiBBamZXaWRnZXRUeXBlLlRleHQsXG4gICAgaHRtbFRleHQ6IGAke2ZpcnN0Um93Lmh0bWx9YCxcbiAgICBzdHlsZXM6IGh0bWxXaWRnZXQsXG4gIH0gYXMgQWpmV2lkZ2V0Q3JlYXRlKTtcbn1cblxuZnVuY3Rpb24gX2J1aWxkVGFibGUoanNvbjoge1trZXk6IHN0cmluZ106IHN0cmluZ31bXSk6IEFqZldpZGdldCB7XG4gIGNvbnN0IHJvd3NwYW4gPSAxO1xuICBjb25zdCBkYXRhRWxlbWVudHM6IGFueVtdW10gPSBbXTtcbiAgY29uc3QgdGl0bGVzID0gT2JqZWN0LmtleXMoanNvblswXSk7XG4gIGNvbnN0IGNvbHNwYW5zOiBudW1iZXJbXSA9IChPYmplY3QudmFsdWVzKGpzb25bMF0pIGFzIHN0cmluZ1tdKS5tYXAociA9PiArcik7XG4gIGRlbGV0ZSBqc29uWzBdO1xuICBjb25zdCB0YWJsZUhlYWRlcjogQWpmVGFibGVEYXRhc2V0W10gPSB0aXRsZXMubWFwKFxuICAgICh0aXRsZSwgaW5kZXgpID0+XG4gICAgICAoe1xuICAgICAgICBsYWJlbDogJycsXG4gICAgICAgIGZvcm11bGE6IHtmb3JtdWxhOiBgXFxcIiR7dGl0bGV9XFxcImB9LFxuICAgICAgICBhZ2dyZWdhdGlvbjoge2FnZ3JlZ2F0aW9uOiAwfSxcbiAgICAgICAgY29sc3BhbjogY29sc3BhbnNbaW5kZXhdLFxuICAgICAgICByb3dzcGFuLFxuICAgICAgICBzdHlsZToge1xuICAgICAgICAgIHRleHRBbGlnbjogJ2NlbnRlcicsXG4gICAgICAgICAgZm9udFdlaWdodDogJ2JvbGQnLFxuICAgICAgICAgIGNvbG9yOiAnd2hpdGUnLFxuICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogJyMzZjUxYjUnLFxuICAgICAgICB9LFxuICAgICAgfSBhcyBBamZUYWJsZURhdGFzZXQpLFxuICApO1xuXG4gIGpzb24uZm9yRWFjaChyb3cgPT4ge1xuICAgIGNvbnN0IGVsZW1zOiBhbnlbXSA9IFtdO1xuICAgIHRpdGxlcy5mb3JFYWNoKHRpdGxlID0+IHtcbiAgICAgIGxldCBlbGVtOiBzdHJpbmcgPSByb3dbdGl0bGVdIHx8IGBcXFwiXFxcImA7XG4gICAgICB0cnkge1xuICAgICAgICBlbGVtID0gaW5kaWNhdG9yVG9KcyhlbGVtKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zb2xlLmxvZygnZXJybycsIGVsZW0sIHRpdGxlLCByb3cpO1xuICAgICAgICBjb25zb2xlLmxvZyhlcnIubWVzc2FnZSk7XG4gICAgICAgIGVsZW0gPSBgJHtyb3dbdGl0bGVdfWA7XG4gICAgICB9XG4gICAgICBlbGVtcy5wdXNoKGVsZW0ucmVwbGFjZSgvW1xcKlxcL1xcclxcbl18QFtcXHctXSsvZywgJycpKTtcbiAgICB9KTtcbiAgICBkYXRhRWxlbWVudHMucHVzaChlbGVtcyk7XG4gIH0pO1xuXG4gIHJldHVybiBjcmVhdGVXaWRnZXQoe1xuICAgIHdpZGdldFR5cGU6IEFqZldpZGdldFR5cGUuRHluYW1pY1RhYmxlLFxuICAgIHJvd0RlZmluaXRpb246IHtcbiAgICAgIGZvcm11bGE6IGBidWlsZERhdGFzZXQoWyR7ZGF0YUVsZW1lbnRzfV0sJHtKU09OLnN0cmluZ2lmeShjb2xzcGFucyl9KWAsXG4gICAgfSxcbiAgICBkYXRhc2V0OiB0YWJsZUhlYWRlcixcbiAgICBleHBvcnRhYmxlOiB0cnVlLFxuICAgIGNlbGxTdHlsZXM6IHtcbiAgICAgIHRleHRBbGlnbjogJ2NlbnRlcicsXG4gICAgICBjb2xvcjogJ2JsYWNrJyxcbiAgICAgIGJhY2tncm91bmRDb2xvcjogJ3doaXRlJyxcbiAgICB9LFxuICAgIHN0eWxlczoge1xuICAgICAgYm9yZGVyQ29sbGFwc2U6ICdjb2xsYXBzZScsXG4gICAgfSxcbiAgfSBhcyBBamZXaWRnZXRDcmVhdGUpO1xufVxuIl19