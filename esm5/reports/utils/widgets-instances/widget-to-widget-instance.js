/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { __assign } from "tslib";
import { createFormula, evaluateExpression } from '@ajf/core/models';
import { deepCopy } from '@ajf/core/utils';
import { chartToChartJsType } from '../../chart-utils';
import { AjfWidgetType } from '../../interface/widgets/widget-type';
import { evaluateAggregation } from '../aggregation/evaluate-aggregation';
import { createWidgetInstance } from './create-widget-instance';
export function widgetToWidgetInstance(widget, context, ts) {
    var wi = createWidgetInstance(widget, context, ts);
    if (widget.widgetType === AjfWidgetType.Column || widget.widgetType === AjfWidgetType.Layout) {
        var wwc_1 = widget;
        var wwci_1 = wi;
        var content_1 = [];
        wwc_1.content.forEach(function (c) {
            if (wwc_1.repetitions != null) {
                wwci_1.repetitions = evaluateExpression(wwc_1.repetitions.formula, context);
                if (typeof wwci_1.repetitions === 'number' && wwci_1.repetitions > 0) {
                    for (var i = 0; i < wwci_1.repetitions; i++) {
                        content_1.push(widgetToWidgetInstance(c, __assign(__assign({}, context), { '$repetition': i }), ts));
                    }
                }
            }
            else {
                content_1.push(widgetToWidgetInstance(c, context, ts));
            }
            wwci_1.content = content_1;
        });
    }
    else if (widget.widgetType === AjfWidgetType.Chart) {
        var cw = widget;
        var cwi = wi;
        var labels = cw.labels instanceof Array ? cw.labels : [cw.labels];
        var evLabels = labels.map(function (l) {
            var evf = evaluateExpression(l.formula, context);
            try {
                if (evf instanceof Array) {
                    evf = evf.map(function (v) { return v != null && typeof v === 'string' && v.trim().length > 0
                        ? ts.instant(v) : v; });
                }
                else {
                    evf = evf != null && typeof evf === 'string' && evf.trim().length > 0
                        ? ts.instant(evf) : evf;
                }
            }
            catch (_e) {
            }
            return evf;
        });
        cwi.labels = cw.labels instanceof Array ? evLabels : evLabels[0];
        cwi.datasets = cw.dataset.map(function (d) {
            var ds = __assign(__assign({}, d.options || {}), { data: evaluateAggregation(d.aggregation, d.formula, context) });
            if (d.chartType != null) {
                var ct = chartToChartJsType(d.chartType);
                ds = __assign(__assign({}, ds), { chartType: ct, type: ct });
            }
            if (d.options != null) {
                ds = __assign(__assign({}, ds), { options: d.options });
            }
            if (d.label != null) {
                ds = __assign(__assign({}, ds), { label: d.label });
            }
            if (d.datalabels != null) {
                ds.datalabels = deepCopy(d.datalabels);
            }
            return ds;
        });
        cwi.data = { labels: cwi.labels, datasets: cwi.datasets };
        cwi.chartType = chartToChartJsType(cw.type || cw.chartType);
        if (cw.options != null && cw.options.plugins != null) {
            var plugins_1 = cw.options.plugins;
            var pluginNames = Object.keys(plugins_1);
            pluginNames.forEach(function (pluginName) {
                var plugin = plugins_1[pluginName];
                var pluginOptions = Object.keys(plugin);
                pluginOptions.forEach(function (pluginOptionName) {
                    var pluginOption = plugin[pluginOptionName];
                    if (typeof pluginOption !== 'string' &&
                        pluginOption != null &&
                        pluginOption.formula != null) {
                        plugin[pluginOptionName] = evaluateExpression(pluginOption.formula, context);
                    }
                });
            });
        }
    }
    else if (widget.widgetType === AjfWidgetType.Table) {
        var tw_1 = widget;
        var twi = wi;
        var trFormula_1 = function (f) {
            var formula = f.formula;
            if (formula.substr(0, 1) === '"') {
                var ft = formula.slice(1, -1);
                var transFt = ft != null && typeof ft === 'string' && ft.trim().length > 0
                    ? ts.instant(ft) : ft;
                if (ft.length > 0) {
                    formula = "\"" + transFt + "\"";
                }
            }
            else {
                formula = formula != null && typeof formula === 'string' && formula.trim().length > 0
                    ? ts.instant(formula) : formula;
            }
            return evaluateExpression(formula, context);
        };
        twi.dataset = tw_1.dataset.map(function (row) { return row.map(function (cell) {
            return cell.formula instanceof Array ? cell.formula.map(function (f) { return trFormula_1(f); }) :
                trFormula_1(cell.formula);
        }); });
        twi.data = (tw_1.dataset ||
            []).map(function (row) { return row.map(function (cell) { return ({
            value: evaluateExpression(cell.formula.formula, context),
            style: __assign(__assign({}, tw_1.cellStyles), cell.style),
            rowspan: cell.rowspan,
            colspan: cell.colspan,
        }); }); });
    }
    else if (widget.widgetType === AjfWidgetType.Image) {
        var iw = widget;
        var iwi = wi;
        if (iw.flag) {
            iwi.flag = evaluateExpression(iw.flag.formula, context);
        }
        if (iw.icon) {
            iwi.icon = evaluateExpression(iw.icon.formula, context);
        }
        if (iw.url) {
            iwi.url = evaluateExpression(iw.url.formula, context);
        }
    }
    else if (widget.widgetType === AjfWidgetType.ImageContainer) {
        var icw = widget;
        var icwi = wi;
        if (icw.flags) {
            icwi.flags = icw.flags instanceof Array
                ? icw.flags.map(function (f) { return evaluateExpression(f.formula, context); })
                : evaluateExpression(icw.flags.formula, context);
        }
        if (icw.icons) {
            icwi.icons = icw.icons instanceof Array
                ? icw.icons.map(function (f) { return evaluateExpression(f.formula, context); })
                : evaluateExpression(icw.icons.formula, context);
        }
        if (icw.urls) {
            icwi.urls = icw.urls instanceof Array
                ? icw.urls.map(function (f) { return evaluateExpression(f.formula, context); })
                : evaluateExpression(icw.urls.formula, context);
        }
    }
    else if (widget.widgetType === AjfWidgetType.Text) {
        var tew = widget;
        var tewi = wi;
        var formulaRegEx = /\[{2}(.+?)\]{2}/g;
        var matches = [];
        var match = void 0;
        var htmlText_1 = tew.htmlText;
        while (match = formulaRegEx.exec(htmlText_1)) {
            var idx = match.index;
            var len = match[0].length;
            var formula = createFormula({ formula: match[1] });
            matches.push({ idx: idx, len: len, formula: formula });
        }
        matches.reverse().forEach(function (m) {
            var calcValue;
            try {
                calcValue = evaluateExpression(m.formula.formula, context);
            }
            catch (e) {
                calcValue = '';
            }
            htmlText_1 = "" + htmlText_1.substr(0, m.idx) + calcValue + htmlText_1.substr(m.idx + m.len);
        });
        tewi.htmlText = htmlText_1 != null && htmlText_1.length > 0 ? ts.instant(htmlText_1) : htmlText_1;
    }
    else if (widget.widgetType === AjfWidgetType.Formula) {
        var fw = widget;
        var fwi = wi;
        fwi.formula = evaluateExpression(fw.formula.formula, context);
    }
    else if (widget.widgetType === AjfWidgetType.Map) {
        var mw = widget;
        var mwi = wi;
        mwi.coordinate = evaluateExpression(mw.coordinate.formula, context);
    }
    return wi;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LXRvLXdpZGdldC1pbnN0YW5jZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3JlcG9ydHMvdXRpbHMvd2lkZ2V0cy1pbnN0YW5jZXMvd2lkZ2V0LXRvLXdpZGdldC1pbnN0YW5jZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7O0FBRUgsT0FBTyxFQUF5QixhQUFhLEVBQUUsa0JBQWtCLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUMzRixPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFHekMsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFzQnJELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUVsRSxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUV4RSxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUU5RCxNQUFNLFVBQVUsc0JBQXNCLENBQ2xDLE1BQWlCLEVBQUUsT0FBbUIsRUFBRSxFQUFvQjtJQUM5RCxJQUFNLEVBQUUsR0FBRyxvQkFBb0IsQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3JELElBQUksTUFBTSxDQUFDLFVBQVUsS0FBSyxhQUFhLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxVQUFVLEtBQUssYUFBYSxDQUFDLE1BQU0sRUFBRTtRQUM1RixJQUFNLEtBQUcsR0FBRyxNQUE4QixDQUFDO1FBQzNDLElBQU0sTUFBSSxHQUFHLEVBQWtDLENBQUM7UUFDaEQsSUFBSSxTQUFPLEdBQUcsRUFBeUIsQ0FBQztRQUN4QyxLQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFBLENBQUM7WUFDbkIsSUFBSSxLQUFHLENBQUMsV0FB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QzNGO1NBQU0sSUFBSSxNQUFNLENBQUMsVUFBVSxLQUFLLGFBQWEsQ0FBQyxPQUFPLEVBQUU7UUFDdEQsSUFBTSxFQUFFLEdBQUcsTUFBMEIsQ0FBQztRQUN0QyxJQUFNLEdBQUcsR0FBRyxFQUE4QixDQUFDO1FBQzNDLEdBQUcsQ0FBQyxPQUFPLEdBQUcsa0JBQWtCLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7S0FDL0Q7U0FBTSxJQUFJLE1BQU0sQ0FBQyxVQUFVLEtBQUssYUFBYSxDQUFDLEdBQUcsRUFBRTtRQUNsRCxJQUFNLEVBQUUsR0FBRyxNQUFzQixDQUFDO1FBQ2xDLElBQU0sR0FBRyxHQUFHLEVBQTBCLENBQUM7UUFDdkMsR0FBRyxDQUFDLFVBQVUsR0FBRyxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztLQUNyRTtJQUNELE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoQykgR251Y29vcCBzb2MuIGNvb3AuXG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3JcbiAqIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhc1xuICogcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsXG4gKiBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VIEFmZmVyb1xuICogR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogYWxvbmcgd2l0aCBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpLlxuICogSWYgbm90LCBzZWUgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLy5cbiAqXG4gKi9cblxuaW1wb3J0IHtBamZDb250ZXh0LCBBamZGb3JtdWxhLCBjcmVhdGVGb3JtdWxhLCBldmFsdWF0ZUV4cHJlc3Npb259IGZyb20gJ0BhamYvY29yZS9tb2RlbHMnO1xuaW1wb3J0IHtkZWVwQ29weX0gZnJvbSAnQGFqZi9jb3JlL3V0aWxzJztcbmltcG9ydCB7VHJhbnNsYXRlU2VydmljZX0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5cbmltcG9ydCB7Y2hhcnRUb0NoYXJ0SnNUeXBlfSBmcm9tICcuLi8uLi9jaGFydC11dGlscyc7XG5pbXBvcnQge0FqZkNoYXJ0V2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9jaGFydC13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZGb3JtdWxhV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9mb3JtdWxhLXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge1xuICBBamZJbWFnZUNvbnRhaW5lcldpZGdldEluc3RhbmNlXG59IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9pbWFnZS1jb250YWluZXItd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmSW1hZ2VXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL2ltYWdlLXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZk1hcFdpZGdldEluc3RhbmNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvbWFwLXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZlRhYmxlV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy90YWJsZS13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZUZXh0V2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy90ZXh0LXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZldpZGdldEluc3RhbmNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7XG4gIEFqZldpZGdldFdpdGhDb250ZW50SW5zdGFuY2Vcbn0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL3dpZGdldC13aXRoLWNvbnRlbnQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZDaGFydFdpZGdldH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvY2hhcnQtd2lkZ2V0JztcbmltcG9ydCB7QWpmRm9ybXVsYVdpZGdldH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvZm9ybXVsYS13aWRnZXQnO1xuaW1wb3J0IHtBamZJbWFnZUNvbnRhaW5lcldpZGdldH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvaW1hZ2UtY29udGFpbmVyLXdpZGdldCc7XG5pbXBvcnQge0FqZkltYWdlV2lkZ2V0fSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy9pbWFnZS13aWRnZXQnO1xuaW1wb3J0IHtBamZNYXBXaWRnZXR9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzL21hcC13aWRnZXQnO1xuaW1wb3J0IHtBamZUYWJsZVdpZGdldH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvdGFibGUtd2lkZ2V0JztcbmltcG9ydCB7QWpmVGV4dFdpZGdldH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvdGV4dC13aWRnZXQnO1xuaW1wb3J0IHtBamZXaWRnZXR9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzL3dpZGdldCc7XG5pbXBvcnQge0FqZldpZGdldFR5cGV9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzL3dpZGdldC10eXBlJztcbmltcG9ydCB7QWpmV2lkZ2V0V2l0aENvbnRlbnR9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzL3dpZGdldC13aXRoLWNvbnRlbnQnO1xuaW1wb3J0IHtldmFsdWF0ZUFnZ3JlZ2F0aW9ufSBmcm9tICcuLi9hZ2dyZWdhdGlvbi9ldmFsdWF0ZS1hZ2dyZWdhdGlvbic7XG5cbmltcG9ydCB7Y3JlYXRlV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4vY3JlYXRlLXdpZGdldC1pbnN0YW5jZSc7XG5cbmV4cG9ydCBmdW5jdGlvbiB3aWRnZXRUb1dpZGdldEluc3RhbmNlKFxuICAgIHdpZGdldDogQWpmV2lkZ2V0LCBjb250ZXh0OiBBamZDb250ZXh0LCB0czogVHJhbnNsYXRlU2VydmljZSk6IEFqZldpZGdldEluc3RhbmNlIHtcbiAgY29uc3Qgd2kgPSBjcmVhdGVXaWRnZXRJbnN0YW5jZSh3aWRnZXQsIGNvbnRleHQsIHRzKTtcbiAgaWYgKHdpZGdldC53aWRnZXRUeXBlID09PSBBamZXaWRnZXRUeXBlLkNvbHVtbiB8fCB3aWRnZXQud2lkZ2V0VHlwZSA9PT0gQWpmV2lkZ2V0VHlwZS5MYXlvdXQpIHtcbiAgICBjb25zdCB3d2MgPSB3aWRnZXQgYXMgQWpmV2lkZ2V0V2l0aENvbnRlbnQ7XG4gICAgY29uc3Qgd3djaSA9IHdpIGFzIEFqZldpZGdldFdpdGhDb250ZW50SW5zdGFuY2U7XG4gICAgbGV0IGNvbnRlbnQgPSBbXSBhcyBBamZXaWRnZXRJbnN0YW5jZVtdO1xuICAgIHd3Yy5jb250ZW50LmZvckVhY2goYyA9PiB7XG4gICAgICBpZiAod3djLnJlcGV0aXRpb25zICE9IG51bGwpIHtcbiAgICAgICAgd3djaS5yZXBldGl0aW9ucyA9IGV2YWx1YXRlRXhwcmVzc2lvbih3d2MucmVwZXRpdGlvbnMuZm9ybXVsYSwgY29udGV4dCk7XG4gICAgICAgIGlmICh0eXBlb2Ygd3djaS5yZXBldGl0aW9ucyA9PT0gJ251bWJlcicgJiYgd3djaS5yZXBldGl0aW9ucyA+IDApIHtcbiAgICAgICAgICBmb3IgKGxldCBpID0gMCA7IGkgPCB3d2NpLnJlcGV0aXRpb25zIDsgaSsrKSB7XG4gICAgICAgICAgICBjb250ZW50LnB1c2god2lkZ2V0VG9XaWRnZXRJbnN0YW5jZShjLCB7Li4uY29udGV4dCwgJyRyZXBldGl0aW9uJzogaX0sIHRzKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb250ZW50LnB1c2god2lkZ2V0VG9XaWRnZXRJbnN0YW5jZShjLCBjb250ZXh0LCB0cykpO1xuICAgICAgfVxuICAgICAgd3djaS5jb250ZW50ID0gY29udGVudDtcbiAgICB9KTtcbiAgfSBlbHNlIGlmICh3aWRnZXQud2lkZ2V0VHlwZSA9PT0gQWpmV2lkZ2V0VHlwZS5DaGFydCkge1xuICAgIGNvbnN0IGN3ID0gd2lkZ2V0IGFzIEFqZkNoYXJ0V2lkZ2V0O1xuICAgIGNvbnN0IGN3aSA9IHdpIGFzIEFqZkNoYXJ0V2lkZ2V0SW5zdGFuY2U7XG4gICAgY29uc3QgbGFiZWxzID0gY3cubGFiZWxzIGluc3RhbmNlb2YgQXJyYXkgPyBjdy5sYWJlbHMgOiBbY3cubGFiZWxzXTtcbiAgICBjb25zdCBldkxhYmVscyA9IGxhYmVscy5tYXAobCA9PiB7XG4gICAgICBsZXQgZXZmID0gZXZhbHVhdGVFeHByZXNzaW9uKGwuZm9ybXVsYSwgY29udGV4dCk7XG4gICAgICB0cnkge1xuICAgICAgICBpZiAoZXZmIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICBldmYgPSBldmYubWFwKHYgPT4gdiAhPSBudWxsICYmIHR5cGVvZiB2ID09PSAnc3RyaW5nJyAmJiB2LnRyaW0oKS5sZW5ndGggPiAwXG4gICAgICAgICAgICA/IHRzLmluc3RhbnQodikgOiB2KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBldmYgPSBldmYgIT0gbnVsbCAmJiB0eXBlb2YgZXZmID09PSAnc3RyaW5nJyAmJiBldmYudHJpbSgpLmxlbmd0aCA+IDBcbiAgICAgICAgICAgID8gdHMuaW5zdGFudChldmYpIDogZXZmO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChfZSkge1xuICAgICAgfVxuICAgICAgcmV0dXJuIGV2ZjtcbiAgICB9KTtcbiAgICBjd2kubGFiZWxzID0gY3cubGFiZWxzIGluc3RhbmNlb2YgQXJyYXkgPyBldkxhYmVscyA6IGV2TGFiZWxzWzBdO1xuICAgIGN3aS5kYXRhc2V0cyA9IGN3LmRhdGFzZXQubWFwKGQgPT4ge1xuICAgICAgbGV0IGRzOiBhbnkgPSB7XG4gICAgICAgIC4uLmQub3B0aW9ucyB8fCB7fSxcbiAgICAgICAgZGF0YTogZXZhbHVhdGVBZ2dyZWdhdGlvbihkLmFnZ3JlZ2F0aW9uLCBkLmZvcm11bGEsIGNvbnRleHQpLFxuICAgICAgfTtcbiAgICAgIGlmIChkLmNoYXJ0VHlwZSAhPSBudWxsKSB7XG4gICAgICAgIGNvbnN0IGN0ID0gY2hhcnRUb0NoYXJ0SnNUeXBlKGQuY2hhcnRUeXBlKTtcbiAgICAgICAgZHMgPSB7Li4uZHMsIGNoYXJ0VHlwZTogY3QsIHR5cGU6IGN0IH07XG4gICAgICB9XG4gICAgICBpZiAoZC5vcHRpb25zICE9IG51bGwpIHtcbiAgICAgICAgZHMgPSB7Li4uZHMsIG9wdGlvbnM6IGQub3B0aW9uc307XG4gICAgICB9XG4gICAgICBpZiAoZC5sYWJlbCAhPSBudWxsKSB7XG4gICAgICAgIGRzID0gey4uLmRzLCBsYWJlbDogZC5sYWJlbH07XG4gICAgICB9XG4gICAgICBpZiAoZC5kYXRhbGFiZWxzICE9IG51bGwpIHtcbiAgICAgICAgZHMuZGF0YWxhYmVscyA9IGRlZXBDb3B5KGQuZGF0YWxhYmVscyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZHM7XG4gICAgfSk7XG4gICAgY3dpLmRhdGEgPSB7bGFiZWxzOiBjd2kubGFiZWxzLCBkYXRhc2V0czogY3dpLmRhdGFzZXRzfTtcbiAgICBjd2kuY2hhcnRUeXBlID0gY2hhcnRUb0NoYXJ0SnNUeXBlKGN3LnR5cGUgfHwgY3cuY2hhcnRUeXBlKTtcbiAgICBpZiAoY3cub3B0aW9ucyAhPSBudWxsICYmIGN3Lm9wdGlvbnMucGx1Z2lucyAhPSBudWxsKSB7XG4gICAgICBjb25zdCBwbHVnaW5zID0gY3cub3B0aW9ucy5wbHVnaW5zO1xuICAgICAgY29uc3QgcGx1Z2luTmFtZXMgPSBPYmplY3Qua2V5cyhwbHVnaW5zKTtcbiAgICAgIHBsdWdpbk5hbWVzLmZvckVhY2goKHBsdWdpbk5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcGx1Z2luID0gcGx1Z2luc1twbHVnaW5OYW1lXTtcbiAgICAgICAgY29uc3QgcGx1Z2luT3B0aW9ucyA9IE9iamVjdC5rZXlzKHBsdWdpbik7XG4gICAgICAgIHBsdWdpbk9wdGlvbnMuZm9yRWFjaCgocGx1Z2luT3B0aW9uTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgY29uc3QgcGx1Z2luT3B0aW9uID0gcGx1Z2luW3BsdWdpbk9wdGlvbk5hbWVdO1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIHR5cGVvZiBwbHVnaW5PcHRpb24gIT09ICdzdHJpbmcnICYmXG4gICAgICAgICAgICBwbHVnaW5PcHRpb24gIT0gbnVsbCAmJlxuICAgICAgICAgICAgcGx1Z2luT3B0aW9uLmZvcm11bGEgIT0gbnVsbFxuICAgICAgICAgICkge1xuICAgICAgICAgICAgcGx1Z2luW3BsdWdpbk9wdGlvbk5hbWVdID0gZXZhbHVhdGVFeHByZXNzaW9uKHBsdWdpbk9wdGlvbi5mb3JtdWxhLCBjb250ZXh0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9IGVsc2UgaWYgKHdpZGdldC53aWRnZXRUeXBlID09PSBBamZXaWRnZXRUeXBlLlRhYmxlKSB7XG4gICAgY29uc3QgdHcgPSB3aWRnZXQgYXMgQWpmVGFibGVXaWRnZXQ7XG4gICAgY29uc3QgdHdpID0gd2kgYXMgQWpmVGFibGVXaWRnZXRJbnN0YW5jZTtcbiAgICBjb25zdCB0ckZvcm11bGEgPSAoZjogQWpmRm9ybXVsYSkgPT4ge1xuICAgICAgbGV0IGZvcm11bGEgPSBmLmZvcm11bGE7XG4gICAgICBpZiAoZm9ybXVsYS5zdWJzdHIoMCwgMSkgPT09ICdcIicpIHtcbiAgICAgICAgY29uc3QgZnQgPSBmb3JtdWxhLnNsaWNlKDEsIC0xKTtcbiAgICAgICAgY29uc3QgdHJhbnNGdCA9IGZ0ICE9IG51bGwgJiYgdHlwZW9mIGZ0ID09PSAnc3RyaW5nJyAmJiBmdC50cmltKCkubGVuZ3RoID4gMFxuICAgICAgICAgID8gdHMuaW5zdGFudChmdCkgOiBmdDtcbiAgICAgICAgaWYgKGZ0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBmb3JtdWxhID0gYFwiJHt0cmFuc0Z0fVwiYDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZm9ybXVsYSA9IGZvcm11bGEgIT0gbnVsbCAmJiB0eXBlb2YgZm9ybXVsYSA9PT0gJ3N0cmluZycgJiYgZm9ybXVsYS50cmltKCkubGVuZ3RoID4gMFxuICAgICAgICAgID8gdHMuaW5zdGFudChmb3JtdWxhKSA6IGZvcm11bGE7XG4gICAgICB9XG4gICAgICByZXR1cm4gZXZhbHVhdGVFeHByZXNzaW9uKGZvcm11bGEsIGNvbnRleHQpO1xuICAgIH07XG4gICAgdHdpLmRhdGFzZXQgPSB0dy5kYXRhc2V0Lm1hcChyb3cgPT4gcm93Lm1hcChjZWxsID0+IHtcbiAgICAgIHJldHVybiBjZWxsLmZvcm11bGEgaW5zdGFuY2VvZiBBcnJheSA/IGNlbGwuZm9ybXVsYS5tYXAoZiA9PiB0ckZvcm11bGEoZiBhcyBBamZGb3JtdWxhKSkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJGb3JtdWxhKGNlbGwuZm9ybXVsYSEpO1xuICAgIH0pKTtcbiAgICB0d2kuZGF0YSA9ICh0dy5kYXRhc2V0IHx8XG4gICAgICAgICAgICAgICAgW10pLm1hcChyb3cgPT4gcm93Lm1hcChjZWxsID0+ICh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBldmFsdWF0ZUV4cHJlc3Npb24oY2VsbC5mb3JtdWxhLmZvcm11bGEsIGNvbnRleHQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogey4uLnR3LmNlbGxTdHlsZXMsIC4uLmNlbGwuc3R5bGV9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3dzcGFuOiBjZWxsLnJvd3NwYW4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHNwYW46IGNlbGwuY29sc3BhbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKSk7XG4gIH0gZWxzZSBpZiAod2lkZ2V0LndpZGdldFR5cGUgPT09IEFqZldpZGdldFR5cGUuSW1hZ2UpIHtcbiAgICBjb25zdCBpdyA9IHdpZGdldCBhcyBBamZJbWFnZVdpZGdldDtcbiAgICBjb25zdCBpd2kgPSB3aSBhcyBBamZJbWFnZVdpZGdldEluc3RhbmNlO1xuICAgIGlmIChpdy5mbGFnKSB7XG4gICAgICBpd2kuZmxhZyA9IGV2YWx1YXRlRXhwcmVzc2lvbihpdy5mbGFnLmZvcm11bGEsIGNvbnRleHQpO1xuICAgIH1cbiAgICBpZiAoaXcuaWNvbikge1xuICAgICAgaXdpLmljb24gPSBldmFsdWF0ZUV4cHJlc3Npb24oaXcuaWNvbi5mb3JtdWxhLCBjb250ZXh0KTtcbiAgICB9XG4gICAgaWYgKGl3LnVybCkge1xuICAgICAgaXdpLnVybCA9IGV2YWx1YXRlRXhwcmVzc2lvbihpdy51cmwuZm9ybXVsYSwgY29udGV4dCk7XG4gICAgfVxuICB9IGVsc2UgaWYgKHdpZGdldC53aWRnZXRUeXBlID09PSBBamZXaWRnZXRUeXBlLkltYWdlQ29udGFpbmVyKSB7XG4gICAgY29uc3QgaWN3ID0gd2lkZ2V0IGFzIEFqZkltYWdlQ29udGFpbmVyV2lkZ2V0O1xuICAgIGNvbnN0IGljd2kgPSB3aSBhcyBBamZJbWFnZUNvbnRhaW5lcldpZGdldEluc3RhbmNlO1xuICAgIGlmIChpY3cuZmxhZ3MpIHtcbiAgICAgIGljd2kuZmxhZ3MgPSBpY3cuZmxhZ3MgaW5zdGFuY2VvZiBBcnJheVxuICAgICAgICA/IGljdy5mbGFncy5tYXAoZiA9PiBldmFsdWF0ZUV4cHJlc3Npb24oZi5mb3JtdWxhLCBjb250ZXh0KSlcbiAgICAgICAgOiBldmFsdWF0ZUV4cHJlc3Npb24oaWN3LmZsYWdzLmZvcm11bGEsIGNvbnRleHQpO1xuICAgIH1cbiAgICBpZiAoaWN3Lmljb25zKSB7XG4gICAgICBpY3dpLmljb25zID0gaWN3Lmljb25zIGluc3RhbmNlb2YgQXJyYXlcbiAgICAgICAgPyBpY3cuaWNvbnMubWFwKGYgPT4gZXZhbHVhdGVFeHByZXNzaW9uKGYuZm9ybXVsYSwgY29udGV4dCkpXG4gICAgICAgIDogZXZhbHVhdGVFeHByZXNzaW9uKGljdy5pY29ucy5mb3JtdWxhLCBjb250ZXh0KTtcbiAgICB9XG4gICAgaWYgKGljdy51cmxzKSB7XG4gICAgICBpY3dpLnVybHMgPSBpY3cudXJscyBpbnN0YW5jZW9mIEFycmF5XG4gICAgICAgID8gaWN3LnVybHMubWFwKGYgPT4gZXZhbHVhdGVFeHByZXNzaW9uKGYuZm9ybXVsYSwgY29udGV4dCkpXG4gICAgICAgIDogZXZhbHVhdGVFeHByZXNzaW9uKGljdy51cmxzLmZvcm11bGEsIGNvbnRleHQpO1xuICAgIH1cbiAgfSBlbHNlIGlmICh3aWRnZXQud2lkZ2V0VHlwZSA9PT0gQWpmV2lkZ2V0VHlwZS5UZXh0KSB7XG4gICAgY29uc3QgdGV3ID0gd2lkZ2V0IGFzIEFqZlRleHRXaWRnZXQ7XG4gICAgY29uc3QgdGV3aSA9IHdpIGFzIEFqZlRleHRXaWRnZXRJbnN0YW5jZTtcbiAgICBjb25zdCBmb3JtdWxhUmVnRXg6IFJlZ0V4cCA9IC9cXFt7Mn0oLis/KVxcXXsyfS9nO1xuICAgIGNvbnN0IG1hdGNoZXM6IHtpZHg6IG51bWJlciwgbGVuOiBudW1iZXIsIGZvcm11bGE6IEFqZkZvcm11bGF9W10gPSBbXTtcbiAgICBsZXQgbWF0Y2g6IFJlZ0V4cEV4ZWNBcnJheXxudWxsO1xuICAgIGxldCBodG1sVGV4dCA9IHRldy5odG1sVGV4dDtcbiAgICB3aGlsZSAobWF0Y2ggPSBmb3JtdWxhUmVnRXguZXhlYyhodG1sVGV4dCkpIHtcbiAgICAgIGNvbnN0IGlkeCA9IG1hdGNoLmluZGV4O1xuICAgICAgY29uc3QgbGVuID0gbWF0Y2hbMF0ubGVuZ3RoO1xuICAgICAgY29uc3QgZm9ybXVsYSA9IGNyZWF0ZUZvcm11bGEoe2Zvcm11bGE6IG1hdGNoWzFdfSk7XG4gICAgICBtYXRjaGVzLnB1c2goe2lkeCwgbGVuLCBmb3JtdWxhfSk7XG4gICAgfVxuICAgIG1hdGNoZXMucmV2ZXJzZSgpLmZvckVhY2goKG0pID0+IHtcbiAgICAgIGxldCBjYWxjVmFsdWU7XG4gICAgICB0cnkge1xuICAgICAgICBjYWxjVmFsdWUgPSBldmFsdWF0ZUV4cHJlc3Npb24obS5mb3JtdWxhLmZvcm11bGEsIGNvbnRleHQpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjYWxjVmFsdWUgPSAnJztcbiAgICAgIH1cbiAgICAgIGh0bWxUZXh0ID0gYCR7aHRtbFRleHQuc3Vic3RyKDAsIG0uaWR4KX0ke2NhbGNWYWx1ZX0ke2h0bWxUZXh0LnN1YnN0cihtLmlkeCArIG0ubGVuKX1gO1xuICAgIH0pO1xuICAgIHRld2kuaHRtbFRleHQgPSBodG1sVGV4dCAhPSBudWxsICYmIGh0bWxUZXh0Lmxlbmd0aCA+IDAgPyB0cy5pbnN0YW50KGh0bWxUZXh0KSA6IGh0bWxUZXh0O1xuICB9IGVsc2UgaWYgKHdpZGdldC53aWRnZXRUeXBlID09PSBBamZXaWRnZXRUeXBlLkZvcm11bGEpIHtcbiAgICBjb25zdCBmdyA9IHdpZGdldCBhcyBBamZGb3JtdWxhV2lkZ2V0O1xuICAgIGNvbnN0IGZ3aSA9IHdpIGFzIEFqZkZvcm11bGFXaWRnZXRJbnN0YW5jZTtcbiAgICBmd2kuZm9ybXVsYSA9IGV2YWx1YXRlRXhwcmVzc2lvbihmdy5mb3JtdWxhLmZvcm11bGEsIGNvbnRleHQpO1xuICB9IGVsc2UgaWYgKHdpZGdldC53aWRnZXRUeXBlID09PSBBamZXaWRnZXRUeXBlLk1hcCkge1xuICAgIGNvbnN0IG13ID0gd2lkZ2V0IGFzIEFqZk1hcFdpZGdldDtcbiAgICBjb25zdCBtd2kgPSB3aSBhcyBBamZNYXBXaWRnZXRJbnN0YW5jZTtcbiAgICBtd2kuY29vcmRpbmF0ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihtdy5jb29yZGluYXRlLmZvcm11bGEsIGNvbnRleHQpO1xuICB9XG4gIHJldHVybiB3aTtcbn1cbiJdfQ==