/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Advanced JSON forms (ajf).
 *
 * Advanced JSON forms (ajf) is free software: you can redistribute it and/or
 * modify it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 *
 * Advanced JSON forms (ajf) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
 * General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Advanced JSON forms (ajf).
 * If not, see http://www.gnu.org/licenses/.
 *
 */
import { __assign } from "tslib";
import { createFormula, evaluateExpression } from '@ajf/core/models';
import { deepCopy } from '@ajf/core/utils';
import { chartToChartJsType } from '../../chart-utils';
import { AjfWidgetType } from '../../interface/widgets/widget-type';
import { evaluateAggregation } from '../aggregation/evaluate-aggregation';
import { createWidgetInstance } from './create-widget-instance';
export function widgetToWidgetInstance(widget, context, ts) {
    var wi = createWidgetInstance(widget, context, ts);
    if (widget.widgetType === AjfWidgetType.Column || widget.widgetType === AjfWidgetType.Layout) {
        var wwc_1 = widget;
        var wwci_1 = wi;
        var content_1 = [];
        wwc_1.content.forEach(function (c) {
            if (wwc_1.repetitions != null) {
                wwci_1.repetitions = evaluateExpression(wwc_1.repetitions.formula, context);
                if (typeof wwci_1.repetitions === 'number' && wwci_1.repetitions > 0) {
                    for (var i = 0; i < wwci_1.repetitions; i++) {
                        content_1.push(widgetToWidgetInstance(c, __assign(__assign({}, context), { '$repetition': i }), ts));
                    }
                }
            }
            else {
                content_1.push(widgetToWidgetInstance(c, context, ts));
            }
            wwci_1.content = content_1;
        });
    }
    else if (widget.widgetType === AjfWidgetType.Chart) {
        var cw = widget;
        var cwi = wi;
        var labels = cw.labels instanceof Array ? cw.labels : [cw.labels];
        var evLabels = labels.map(function (l) {
            var evf = evaluateExpression(l.formula, context);
            try {
                if (evf instanceof Array) {
                    evf = evf.map(function (v) { return v != null && typeof v === 'string' && v.trim().length > 0
                        ? ts.instant(v) : v; });
                }
                else {
                    evf = evf != null && typeof evf === 'string' && evf.trim().length > 0
                        ? ts.instant(evf) : evf;
                }
            }
            catch (_e) {
            }
            return evf;
        });
        cwi.labels = cw.labels instanceof Array ? evLabels : evLabels[0];
        cwi.datasets = cw.dataset.map(function (d) {
            var ds = __assign(__assign({}, d.options || {}), { data: evaluateAggregation(d.aggregation, d.formula, context) });
            if (d.chartType != null) {
                var ct = chartToChartJsType(d.chartType);
                ds = __assign(__assign({}, ds), { chartType: ct, type: ct });
            }
            if (d.options != null) {
                ds = __assign(__assign({}, ds), { options: d.options });
            }
            if (d.label != null) {
                ds = __assign(__assign({}, ds), { label: d.label });
            }
            if (d.datalabels != null) {
                ds.datalabels = deepCopy(d.datalabels);
            }
            return ds;
        });
        cwi.data = { labels: cwi.labels, datasets: cwi.datasets };
        cwi.chartType = chartToChartJsType(cw.type || cw.chartType);
        if (cw.options != null && cw.options.plugins != null) {
            var plugins_1 = cw.options.plugins;
            var pluginNames = Object.keys(plugins_1);
            pluginNames.forEach(function (pluginName) {
                var plugin = plugins_1[pluginName];
                var pluginOptions = Object.keys(plugin);
                pluginOptions.forEach(function (pluginOptionName) {
                    var pluginOption = plugin[pluginOptionName];
                    if (typeof pluginOption !== 'string' &&
                        pluginOption != null &&
                        pluginOption.formula != null) {
                        plugin[pluginOptionName] = evaluateExpression(pluginOption.formula, context);
                    }
                });
            });
        }
    }
    else if (widget.widgetType === AjfWidgetType.Table) {
        var tw_1 = widget;
        var twi = wi;
        var trFormula_1 = function (f) {
            var formula = f.formula;
            if (formula.substr(0, 1) === '"') {
                var ft = formula.slice(1, -1);
                var transFt = ft != null && typeof ft === 'string' && ft.trim().length > 0
                    ? ts.instant(ft) : ft;
                if (ft.length > 0) {
                    formula = "\"" + transFt + "\"";
                }
            }
            else {
                formula = formula != null && typeof formula === 'string' && formula.trim().length > 0
                    ? ts.instant(formula) : formula;
            }
            return evaluateExpression(formula, context);
        };
        twi.dataset = tw_1.dataset.map(function (row) { return row.map(function (cell) {
            return cell.formula instanceof Array ? cell.formula.map(function (f) { return trFormula_1(f); }) :
                trFormula_1(cell.formula);
        }); });
        twi.data = (tw_1.dataset ||
            []).map(function (row) { return row.map(function (cell) { return ({
            value: evaluateExpression(cell.formula.formula, context),
            style: __assign(__assign({}, tw_1.cellStyles), cell.style),
            rowspan: cell.rowspan,
            colspan: cell.colspan,
        }); }); });
    }
    else if (widget.widgetType === AjfWidgetType.Image) {
        var iw = widget;
        var iwi = wi;
        if (iw.flag) {
            iwi.flag = evaluateExpression(iw.flag.formula, context);
        }
        if (iw.icon) {
            iwi.icon = evaluateExpression(iw.icon.formula, context);
        }
        if (iw.url) {
            iwi.url = evaluateExpression(iw.url.formula, context);
        }
    }
    else if (widget.widgetType === AjfWidgetType.ImageContainer) {
        var icw = widget;
        var icwi = wi;
        if (icw.flags) {
            icwi.flags = icw.flags instanceof Array
                ? icw.flags.map(function (f) { return evaluateExpression(f.formula, context); })
                : evaluateExpression(icw.flags.formula, context);
        }
        if (icw.icons) {
            icwi.icons = icw.icons instanceof Array
                ? icw.icons.map(function (f) { return evaluateExpression(f.formula, context); })
                : evaluateExpression(icw.icons.formula, context);
        }
        if (icw.urls) {
            icwi.urls = icw.urls instanceof Array
                ? icw.urls.map(function (f) { return evaluateExpression(f.formula, context); })
                : evaluateExpression(icw.urls.formula, context);
        }
    }
    else if (widget.widgetType === AjfWidgetType.Text) {
        var tew = widget;
        var tewi = wi;
        var formulaRegEx = /\[{2}(.+?)\]{2}/g;
        var matches = [];
        var match = void 0;
        var htmlText_1 = tew.htmlText;
        while (match = formulaRegEx.exec(htmlText_1)) {
            var idx = match.index;
            var len = match[0].length;
            var formula = createFormula({ formula: match[1] });
            matches.push({ idx: idx, len: len, formula: formula });
        }
        matches.reverse().forEach(function (m) {
            var calcValue;
            try {
                calcValue = evaluateExpression(m.formula.formula, context);
            }
            catch (e) {
                calcValue = '';
            }
            htmlText_1 = "" + htmlText_1.substr(0, m.idx) + calcValue + htmlText_1.substr(m.idx + m.len);
        });
        tewi.htmlText = htmlText_1 != null && htmlText_1.length > 0 ? ts.instant(htmlText_1) : htmlText_1;
    }
    else if (widget.widgetType === AjfWidgetType.Formula) {
        var fw = widget;
        var fwi = wi;
        fwi.formula = evaluateExpression(fw.formula.formula, context);
    }
    else if (widget.widgetType === AjfWidgetType.Map) {
        var mw = widget;
        var mwi = wi;
        mwi.coordinate = evaluateExpression(mw.coordinate.formula, context);
    }
    return wi;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LXRvLXdpZGdldC1pbnN0YW5jZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3JlcG9ydHMvdXRpbHMvd2lkZ2V0cy1pbnN0YW5jZXMvd2lkZ2V0LXRvLXdpZGdldC1pbnN0YW5jZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7O0FBRUgsT0FBTyxFQUF5QixhQUFhLEVBQUUsa0JBQWtCLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUMzRixPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFHekMsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFzQnJELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUVsRSxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUV4RSxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUU5RCxNQUFNLFVBQVUsc0JBQXNCLENBQ2xDLE1BQWlCLEVBQUUsT0FBbUIsRUFBRSxFQUFvQjtJQUM5RCxJQUFNLEVBQUUsR0FBRyxvQkFBb0IsQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3JELElBQUksTUFBTSxDQUFDLFVBQVUsS0FBSyxhQUFhLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxVQUFVLEtBQUssYUFBYSxDQUFDLE1BQU0sRUFBRTtRQUM1RixJQUFNLEtBQUcsR0FBRyxNQUE4QixDQUFDO1FBQzNDLElBQU0sTUFBSSxHQUFHLEVBQWtDLENBQUM7UUFDaEQsSUFBSSxTQUFPLEdBQUcsRUFBeUIsQ0FBQztRQUN4QyxLQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFBLENBQUM7WUFDbkIsSUFBSSxLQUFHLENBQUMsV0FB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QzNGO1NBQU0sSUFBSSxNQUFNLENBQUMsVUFBVSxLQUFLLGFBQWEsQ0FBQyxPQUFPLEVBQUU7UUFDdEQsSUFBTSxFQUFFLEdBQUcsTUFBMEIsQ0FBQztRQUN0QyxJQUFNLEdBQUcsR0FBRyxFQUE4QixDQUFDO1FBQzNDLEdBQUcsQ0FBQyxPQUFPLEdBQUcsa0JBQWtCLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7S0FDL0Q7U0FBTSxJQUFJLE1BQU0sQ0FBQyxVQUFVLEtBQUssYUFBYSxDQUFDLEdBQUcsRUFBRTtRQUNsRCxJQUFNLEVBQUUsR0FBRyxNQUFzQixDQUFDO1FBQ2xDLElBQU0sR0FBRyxHQUFHLEVBQTBCLENBQUM7UUFDdkMsR0FBRyxDQUFDLFVBQVUsR0FBRyxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztLQUNyRTtJQUNELE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoQykgMjAxOCBHbnVjb29wIHNvYy4gY29vcC5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKS5cbiAqXG4gKiBBZHZhbmNlZCBKU09OIGZvcm1zIChhamYpIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vclxuICogbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzXG4gKiBwdWJsaXNoZWQgYnkgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSxcbiAqIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogQWR2YW5jZWQgSlNPTiBmb3JtcyAoYWpmKSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlUgQWZmZXJvXG4gKiBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIEFkdmFuY2VkIEpTT04gZm9ybXMgKGFqZikuXG4gKiBJZiBub3QsIHNlZSBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvLlxuICpcbiAqL1xuXG5pbXBvcnQge0FqZkNvbnRleHQsIEFqZkZvcm11bGEsIGNyZWF0ZUZvcm11bGEsIGV2YWx1YXRlRXhwcmVzc2lvbn0gZnJvbSAnQGFqZi9jb3JlL21vZGVscyc7XG5pbXBvcnQge2RlZXBDb3B5fSBmcm9tICdAYWpmL2NvcmUvdXRpbHMnO1xuaW1wb3J0IHtUcmFuc2xhdGVTZXJ2aWNlfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcblxuaW1wb3J0IHtjaGFydFRvQ2hhcnRKc1R5cGV9IGZyb20gJy4uLy4uL2NoYXJ0LXV0aWxzJztcbmltcG9ydCB7QWpmQ2hhcnRXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL2NoYXJ0LXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZkZvcm11bGFXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL2Zvcm11bGEtd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7XG4gIEFqZkltYWdlQ29udGFpbmVyV2lkZ2V0SW5zdGFuY2Vcbn0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL2ltYWdlLWNvbnRhaW5lci13aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtBamZJbWFnZVdpZGdldEluc3RhbmNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvaW1hZ2Utd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmTWFwV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy9tYXAtd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmVGFibGVXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL3RhYmxlLXdpZGdldC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZlRleHRXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMtaW5zdGFuY2VzL3RleHQtd2lkZ2V0LWluc3RhbmNlJztcbmltcG9ydCB7QWpmV2lkZ2V0SW5zdGFuY2V9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzLWluc3RhbmNlcy93aWRnZXQtaW5zdGFuY2UnO1xuaW1wb3J0IHtcbiAgQWpmV2lkZ2V0V2l0aENvbnRlbnRJbnN0YW5jZVxufSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy1pbnN0YW5jZXMvd2lkZ2V0LXdpdGgtY29udGVudC1pbnN0YW5jZSc7XG5pbXBvcnQge0FqZkNoYXJ0V2lkZ2V0fSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy9jaGFydC13aWRnZXQnO1xuaW1wb3J0IHtBamZGb3JtdWxhV2lkZ2V0fSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy9mb3JtdWxhLXdpZGdldCc7XG5pbXBvcnQge0FqZkltYWdlQ29udGFpbmVyV2lkZ2V0fSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy9pbWFnZS1jb250YWluZXItd2lkZ2V0JztcbmltcG9ydCB7QWpmSW1hZ2VXaWRnZXR9IGZyb20gJy4uLy4uL2ludGVyZmFjZS93aWRnZXRzL2ltYWdlLXdpZGdldCc7XG5pbXBvcnQge0FqZk1hcFdpZGdldH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvbWFwLXdpZGdldCc7XG5pbXBvcnQge0FqZlRhYmxlV2lkZ2V0fSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy90YWJsZS13aWRnZXQnO1xuaW1wb3J0IHtBamZUZXh0V2lkZ2V0fSBmcm9tICcuLi8uLi9pbnRlcmZhY2Uvd2lkZ2V0cy90ZXh0LXdpZGdldCc7XG5pbXBvcnQge0FqZldpZGdldH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvd2lkZ2V0JztcbmltcG9ydCB7QWpmV2lkZ2V0VHlwZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvd2lkZ2V0LXR5cGUnO1xuaW1wb3J0IHtBamZXaWRnZXRXaXRoQ29udGVudH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlL3dpZGdldHMvd2lkZ2V0LXdpdGgtY29udGVudCc7XG5pbXBvcnQge2V2YWx1YXRlQWdncmVnYXRpb259IGZyb20gJy4uL2FnZ3JlZ2F0aW9uL2V2YWx1YXRlLWFnZ3JlZ2F0aW9uJztcblxuaW1wb3J0IHtjcmVhdGVXaWRnZXRJbnN0YW5jZX0gZnJvbSAnLi9jcmVhdGUtd2lkZ2V0LWluc3RhbmNlJztcblxuZXhwb3J0IGZ1bmN0aW9uIHdpZGdldFRvV2lkZ2V0SW5zdGFuY2UoXG4gICAgd2lkZ2V0OiBBamZXaWRnZXQsIGNvbnRleHQ6IEFqZkNvbnRleHQsIHRzOiBUcmFuc2xhdGVTZXJ2aWNlKTogQWpmV2lkZ2V0SW5zdGFuY2Uge1xuICBjb25zdCB3aSA9IGNyZWF0ZVdpZGdldEluc3RhbmNlKHdpZGdldCwgY29udGV4dCwgdHMpO1xuICBpZiAod2lkZ2V0LndpZGdldFR5cGUgPT09IEFqZldpZGdldFR5cGUuQ29sdW1uIHx8IHdpZGdldC53aWRnZXRUeXBlID09PSBBamZXaWRnZXRUeXBlLkxheW91dCkge1xuICAgIGNvbnN0IHd3YyA9IHdpZGdldCBhcyBBamZXaWRnZXRXaXRoQ29udGVudDtcbiAgICBjb25zdCB3d2NpID0gd2kgYXMgQWpmV2lkZ2V0V2l0aENvbnRlbnRJbnN0YW5jZTtcbiAgICBsZXQgY29udGVudCA9IFtdIGFzIEFqZldpZGdldEluc3RhbmNlW107XG4gICAgd3djLmNvbnRlbnQuZm9yRWFjaChjID0+IHtcbiAgICAgIGlmICh3d2MucmVwZXRpdGlvbnMgIT0gbnVsbCkge1xuICAgICAgICB3d2NpLnJlcGV0aXRpb25zID0gZXZhbHVhdGVFeHByZXNzaW9uKHd3Yy5yZXBldGl0aW9ucy5mb3JtdWxhLCBjb250ZXh0KTtcbiAgICAgICAgaWYgKHR5cGVvZiB3d2NpLnJlcGV0aXRpb25zID09PSAnbnVtYmVyJyAmJiB3d2NpLnJlcGV0aXRpb25zID4gMCkge1xuICAgICAgICAgIGZvciAobGV0IGkgPSAwIDsgaSA8IHd3Y2kucmVwZXRpdGlvbnMgOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnRlbnQucHVzaCh3aWRnZXRUb1dpZGdldEluc3RhbmNlKGMsIHsuLi5jb250ZXh0LCAnJHJlcGV0aXRpb24nOiBpfSwgdHMpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnRlbnQucHVzaCh3aWRnZXRUb1dpZGdldEluc3RhbmNlKGMsIGNvbnRleHQsIHRzKSk7XG4gICAgICB9XG4gICAgICB3d2NpLmNvbnRlbnQgPSBjb250ZW50O1xuICAgIH0pO1xuICB9IGVsc2UgaWYgKHdpZGdldC53aWRnZXRUeXBlID09PSBBamZXaWRnZXRUeXBlLkNoYXJ0KSB7XG4gICAgY29uc3QgY3cgPSB3aWRnZXQgYXMgQWpmQ2hhcnRXaWRnZXQ7XG4gICAgY29uc3QgY3dpID0gd2kgYXMgQWpmQ2hhcnRXaWRnZXRJbnN0YW5jZTtcbiAgICBjb25zdCBsYWJlbHMgPSBjdy5sYWJlbHMgaW5zdGFuY2VvZiBBcnJheSA/IGN3LmxhYmVscyA6IFtjdy5sYWJlbHNdO1xuICAgIGNvbnN0IGV2TGFiZWxzID0gbGFiZWxzLm1hcChsID0+IHtcbiAgICAgIGxldCBldmYgPSBldmFsdWF0ZUV4cHJlc3Npb24obC5mb3JtdWxhLCBjb250ZXh0KTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGlmIChldmYgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgIGV2ZiA9IGV2Zi5tYXAodiA9PiB2ICE9IG51bGwgJiYgdHlwZW9mIHYgPT09ICdzdHJpbmcnICYmIHYudHJpbSgpLmxlbmd0aCA+IDBcbiAgICAgICAgICAgID8gdHMuaW5zdGFudCh2KSA6IHYpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGV2ZiA9IGV2ZiAhPSBudWxsICYmIHR5cGVvZiBldmYgPT09ICdzdHJpbmcnICYmIGV2Zi50cmltKCkubGVuZ3RoID4gMFxuICAgICAgICAgICAgPyB0cy5pbnN0YW50KGV2ZikgOiBldmY7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKF9lKSB7XG4gICAgICB9XG4gICAgICByZXR1cm4gZXZmO1xuICAgIH0pO1xuICAgIGN3aS5sYWJlbHMgPSBjdy5sYWJlbHMgaW5zdGFuY2VvZiBBcnJheSA/IGV2TGFiZWxzIDogZXZMYWJlbHNbMF07XG4gICAgY3dpLmRhdGFzZXRzID0gY3cuZGF0YXNldC5tYXAoZCA9PiB7XG4gICAgICBsZXQgZHM6IGFueSA9IHtcbiAgICAgICAgLi4uZC5vcHRpb25zIHx8IHt9LFxuICAgICAgICBkYXRhOiBldmFsdWF0ZUFnZ3JlZ2F0aW9uKGQuYWdncmVnYXRpb24sIGQuZm9ybXVsYSwgY29udGV4dCksXG4gICAgICB9O1xuICAgICAgaWYgKGQuY2hhcnRUeXBlICE9IG51bGwpIHtcbiAgICAgICAgY29uc3QgY3QgPSBjaGFydFRvQ2hhcnRKc1R5cGUoZC5jaGFydFR5cGUpO1xuICAgICAgICBkcyA9IHsuLi5kcywgY2hhcnRUeXBlOiBjdCwgdHlwZTogY3QgfTtcbiAgICAgIH1cbiAgICAgIGlmIChkLm9wdGlvbnMgIT0gbnVsbCkge1xuICAgICAgICBkcyA9IHsuLi5kcywgb3B0aW9uczogZC5vcHRpb25zfTtcbiAgICAgIH1cbiAgICAgIGlmIChkLmxhYmVsICE9IG51bGwpIHtcbiAgICAgICAgZHMgPSB7Li4uZHMsIGxhYmVsOiBkLmxhYmVsfTtcbiAgICAgIH1cbiAgICAgIGlmIChkLmRhdGFsYWJlbHMgIT0gbnVsbCkge1xuICAgICAgICBkcy5kYXRhbGFiZWxzID0gZGVlcENvcHkoZC5kYXRhbGFiZWxzKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBkcztcbiAgICB9KTtcbiAgICBjd2kuZGF0YSA9IHtsYWJlbHM6IGN3aS5sYWJlbHMsIGRhdGFzZXRzOiBjd2kuZGF0YXNldHN9O1xuICAgIGN3aS5jaGFydFR5cGUgPSBjaGFydFRvQ2hhcnRKc1R5cGUoY3cudHlwZSB8fCBjdy5jaGFydFR5cGUpO1xuICAgIGlmIChjdy5vcHRpb25zICE9IG51bGwgJiYgY3cub3B0aW9ucy5wbHVnaW5zICE9IG51bGwpIHtcbiAgICAgIGNvbnN0IHBsdWdpbnMgPSBjdy5vcHRpb25zLnBsdWdpbnM7XG4gICAgICBjb25zdCBwbHVnaW5OYW1lcyA9IE9iamVjdC5rZXlzKHBsdWdpbnMpO1xuICAgICAgcGx1Z2luTmFtZXMuZm9yRWFjaCgocGx1Z2luTmFtZSkgPT4ge1xuICAgICAgICBjb25zdCBwbHVnaW4gPSBwbHVnaW5zW3BsdWdpbk5hbWVdO1xuICAgICAgICBjb25zdCBwbHVnaW5PcHRpb25zID0gT2JqZWN0LmtleXMocGx1Z2luKTtcbiAgICAgICAgcGx1Z2luT3B0aW9ucy5mb3JFYWNoKChwbHVnaW5PcHRpb25OYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICBjb25zdCBwbHVnaW5PcHRpb24gPSBwbHVnaW5bcGx1Z2luT3B0aW9uTmFtZV07XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgdHlwZW9mIHBsdWdpbk9wdGlvbiAhPT0gJ3N0cmluZycgJiZcbiAgICAgICAgICAgIHBsdWdpbk9wdGlvbiAhPSBudWxsICYmXG4gICAgICAgICAgICBwbHVnaW5PcHRpb24uZm9ybXVsYSAhPSBudWxsXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBwbHVnaW5bcGx1Z2luT3B0aW9uTmFtZV0gPSBldmFsdWF0ZUV4cHJlc3Npb24ocGx1Z2luT3B0aW9uLmZvcm11bGEsIGNvbnRleHQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0gZWxzZSBpZiAod2lkZ2V0LndpZGdldFR5cGUgPT09IEFqZldpZGdldFR5cGUuVGFibGUpIHtcbiAgICBjb25zdCB0dyA9IHdpZGdldCBhcyBBamZUYWJsZVdpZGdldDtcbiAgICBjb25zdCB0d2kgPSB3aSBhcyBBamZUYWJsZVdpZGdldEluc3RhbmNlO1xuICAgIGNvbnN0IHRyRm9ybXVsYSA9IChmOiBBamZGb3JtdWxhKSA9PiB7XG4gICAgICBsZXQgZm9ybXVsYSA9IGYuZm9ybXVsYTtcbiAgICAgIGlmIChmb3JtdWxhLnN1YnN0cigwLCAxKSA9PT0gJ1wiJykge1xuICAgICAgICBjb25zdCBmdCA9IGZvcm11bGEuc2xpY2UoMSwgLTEpO1xuICAgICAgICBjb25zdCB0cmFuc0Z0ID0gZnQgIT0gbnVsbCAmJiB0eXBlb2YgZnQgPT09ICdzdHJpbmcnICYmIGZ0LnRyaW0oKS5sZW5ndGggPiAwXG4gICAgICAgICAgPyB0cy5pbnN0YW50KGZ0KSA6IGZ0O1xuICAgICAgICBpZiAoZnQubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGZvcm11bGEgPSBgXCIke3RyYW5zRnR9XCJgO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmb3JtdWxhID0gZm9ybXVsYSAhPSBudWxsICYmIHR5cGVvZiBmb3JtdWxhID09PSAnc3RyaW5nJyAmJiBmb3JtdWxhLnRyaW0oKS5sZW5ndGggPiAwXG4gICAgICAgICAgPyB0cy5pbnN0YW50KGZvcm11bGEpIDogZm9ybXVsYTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBldmFsdWF0ZUV4cHJlc3Npb24oZm9ybXVsYSwgY29udGV4dCk7XG4gICAgfTtcbiAgICB0d2kuZGF0YXNldCA9IHR3LmRhdGFzZXQubWFwKHJvdyA9PiByb3cubWFwKGNlbGwgPT4ge1xuICAgICAgcmV0dXJuIGNlbGwuZm9ybXVsYSBpbnN0YW5jZW9mIEFycmF5ID8gY2VsbC5mb3JtdWxhLm1hcChmID0+IHRyRm9ybXVsYShmIGFzIEFqZkZvcm11bGEpKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ckZvcm11bGEoY2VsbC5mb3JtdWxhISk7XG4gICAgfSkpO1xuICAgIHR3aS5kYXRhID0gKHR3LmRhdGFzZXQgfHxcbiAgICAgICAgICAgICAgICBbXSkubWFwKHJvdyA9PiByb3cubWFwKGNlbGwgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGV2YWx1YXRlRXhwcmVzc2lvbihjZWxsLmZvcm11bGEuZm9ybXVsYSwgY29udGV4dCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7Li4udHcuY2VsbFN0eWxlcywgLi4uY2VsbC5zdHlsZX0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvd3NwYW46IGNlbGwucm93c3BhbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sc3BhbjogY2VsbC5jb2xzcGFuLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpKTtcbiAgfSBlbHNlIGlmICh3aWRnZXQud2lkZ2V0VHlwZSA9PT0gQWpmV2lkZ2V0VHlwZS5JbWFnZSkge1xuICAgIGNvbnN0IGl3ID0gd2lkZ2V0IGFzIEFqZkltYWdlV2lkZ2V0O1xuICAgIGNvbnN0IGl3aSA9IHdpIGFzIEFqZkltYWdlV2lkZ2V0SW5zdGFuY2U7XG4gICAgaWYgKGl3LmZsYWcpIHtcbiAgICAgIGl3aS5mbGFnID0gZXZhbHVhdGVFeHByZXNzaW9uKGl3LmZsYWcuZm9ybXVsYSwgY29udGV4dCk7XG4gICAgfVxuICAgIGlmIChpdy5pY29uKSB7XG4gICAgICBpd2kuaWNvbiA9IGV2YWx1YXRlRXhwcmVzc2lvbihpdy5pY29uLmZvcm11bGEsIGNvbnRleHQpO1xuICAgIH1cbiAgICBpZiAoaXcudXJsKSB7XG4gICAgICBpd2kudXJsID0gZXZhbHVhdGVFeHByZXNzaW9uKGl3LnVybC5mb3JtdWxhLCBjb250ZXh0KTtcbiAgICB9XG4gIH0gZWxzZSBpZiAod2lkZ2V0LndpZGdldFR5cGUgPT09IEFqZldpZGdldFR5cGUuSW1hZ2VDb250YWluZXIpIHtcbiAgICBjb25zdCBpY3cgPSB3aWRnZXQgYXMgQWpmSW1hZ2VDb250YWluZXJXaWRnZXQ7XG4gICAgY29uc3QgaWN3aSA9IHdpIGFzIEFqZkltYWdlQ29udGFpbmVyV2lkZ2V0SW5zdGFuY2U7XG4gICAgaWYgKGljdy5mbGFncykge1xuICAgICAgaWN3aS5mbGFncyA9IGljdy5mbGFncyBpbnN0YW5jZW9mIEFycmF5XG4gICAgICAgID8gaWN3LmZsYWdzLm1hcChmID0+IGV2YWx1YXRlRXhwcmVzc2lvbihmLmZvcm11bGEsIGNvbnRleHQpKVxuICAgICAgICA6IGV2YWx1YXRlRXhwcmVzc2lvbihpY3cuZmxhZ3MuZm9ybXVsYSwgY29udGV4dCk7XG4gICAgfVxuICAgIGlmIChpY3cuaWNvbnMpIHtcbiAgICAgIGljd2kuaWNvbnMgPSBpY3cuaWNvbnMgaW5zdGFuY2VvZiBBcnJheVxuICAgICAgICA/IGljdy5pY29ucy5tYXAoZiA9PiBldmFsdWF0ZUV4cHJlc3Npb24oZi5mb3JtdWxhLCBjb250ZXh0KSlcbiAgICAgICAgOiBldmFsdWF0ZUV4cHJlc3Npb24oaWN3Lmljb25zLmZvcm11bGEsIGNvbnRleHQpO1xuICAgIH1cbiAgICBpZiAoaWN3LnVybHMpIHtcbiAgICAgIGljd2kudXJscyA9IGljdy51cmxzIGluc3RhbmNlb2YgQXJyYXlcbiAgICAgICAgPyBpY3cudXJscy5tYXAoZiA9PiBldmFsdWF0ZUV4cHJlc3Npb24oZi5mb3JtdWxhLCBjb250ZXh0KSlcbiAgICAgICAgOiBldmFsdWF0ZUV4cHJlc3Npb24oaWN3LnVybHMuZm9ybXVsYSwgY29udGV4dCk7XG4gICAgfVxuICB9IGVsc2UgaWYgKHdpZGdldC53aWRnZXRUeXBlID09PSBBamZXaWRnZXRUeXBlLlRleHQpIHtcbiAgICBjb25zdCB0ZXcgPSB3aWRnZXQgYXMgQWpmVGV4dFdpZGdldDtcbiAgICBjb25zdCB0ZXdpID0gd2kgYXMgQWpmVGV4dFdpZGdldEluc3RhbmNlO1xuICAgIGNvbnN0IGZvcm11bGFSZWdFeDogUmVnRXhwID0gL1xcW3syfSguKz8pXFxdezJ9L2c7XG4gICAgY29uc3QgbWF0Y2hlczoge2lkeDogbnVtYmVyLCBsZW46IG51bWJlciwgZm9ybXVsYTogQWpmRm9ybXVsYX1bXSA9IFtdO1xuICAgIGxldCBtYXRjaDogUmVnRXhwRXhlY0FycmF5fG51bGw7XG4gICAgbGV0IGh0bWxUZXh0ID0gdGV3Lmh0bWxUZXh0O1xuICAgIHdoaWxlIChtYXRjaCA9IGZvcm11bGFSZWdFeC5leGVjKGh0bWxUZXh0KSkge1xuICAgICAgY29uc3QgaWR4ID0gbWF0Y2guaW5kZXg7XG4gICAgICBjb25zdCBsZW4gPSBtYXRjaFswXS5sZW5ndGg7XG4gICAgICBjb25zdCBmb3JtdWxhID0gY3JlYXRlRm9ybXVsYSh7Zm9ybXVsYTogbWF0Y2hbMV19KTtcbiAgICAgIG1hdGNoZXMucHVzaCh7aWR4LCBsZW4sIGZvcm11bGF9KTtcbiAgICB9XG4gICAgbWF0Y2hlcy5yZXZlcnNlKCkuZm9yRWFjaCgobSkgPT4ge1xuICAgICAgbGV0IGNhbGNWYWx1ZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNhbGNWYWx1ZSA9IGV2YWx1YXRlRXhwcmVzc2lvbihtLmZvcm11bGEuZm9ybXVsYSwgY29udGV4dCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNhbGNWYWx1ZSA9ICcnO1xuICAgICAgfVxuICAgICAgaHRtbFRleHQgPSBgJHtodG1sVGV4dC5zdWJzdHIoMCwgbS5pZHgpfSR7Y2FsY1ZhbHVlfSR7aHRtbFRleHQuc3Vic3RyKG0uaWR4ICsgbS5sZW4pfWA7XG4gICAgfSk7XG4gICAgdGV3aS5odG1sVGV4dCA9IGh0bWxUZXh0ICE9IG51bGwgJiYgaHRtbFRleHQubGVuZ3RoID4gMCA/IHRzLmluc3RhbnQoaHRtbFRleHQpIDogaHRtbFRleHQ7XG4gIH0gZWxzZSBpZiAod2lkZ2V0LndpZGdldFR5cGUgPT09IEFqZldpZGdldFR5cGUuRm9ybXVsYSkge1xuICAgIGNvbnN0IGZ3ID0gd2lkZ2V0IGFzIEFqZkZvcm11bGFXaWRnZXQ7XG4gICAgY29uc3QgZndpID0gd2kgYXMgQWpmRm9ybXVsYVdpZGdldEluc3RhbmNlO1xuICAgIGZ3aS5mb3JtdWxhID0gZXZhbHVhdGVFeHByZXNzaW9uKGZ3LmZvcm11bGEuZm9ybXVsYSwgY29udGV4dCk7XG4gIH0gZWxzZSBpZiAod2lkZ2V0LndpZGdldFR5cGUgPT09IEFqZldpZGdldFR5cGUuTWFwKSB7XG4gICAgY29uc3QgbXcgPSB3aWRnZXQgYXMgQWpmTWFwV2lkZ2V0O1xuICAgIGNvbnN0IG13aSA9IHdpIGFzIEFqZk1hcFdpZGdldEluc3RhbmNlO1xuICAgIG13aS5jb29yZGluYXRlID0gZXZhbHVhdGVFeHByZXNzaW9uKG13LmNvb3JkaW5hdGUuZm9ybXVsYSwgY29udGV4dCk7XG4gIH1cbiAgcmV0dXJuIHdpO1xufVxuIl19